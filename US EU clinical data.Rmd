---
title: "US EU clinical data"
output: html_document
date: "2024-09-24"
---

```{r}
#install and load necessary packages
#install.packages("stringdist")
library(readr)
library(tidyverse)
library(jsonlite)
library(stringr)
library(stringdist)
library(readxl)
library(janitor)
library(data.table)
library(ggplot2)
library(naniar)
library(purrr)

```

# Loading and Clean the Datasets

First, we load the dataset from both sources of EU and US database.  From both database, we want to extract the key variables, which are: 

  Phase, # of patients, Start and end dates, disease, country, sponsor (firm), collaborators (firms/orgs), status (completion, termination)

Finally we want to construct a  firm-disease-start_year-country panel

## EU data

### Import the Data

```{r eval=FALSE}
#Load the EU data
# Initial dump
# temp = read_csv("EU data/euctr_euctr_dump-2024-09-07-092059.csv")

# Full EU dump
#eu1 = lapply(list.files(path = "EU data/all_euctr", pattern = "*.csv", full.names = TRUE), read_csv)
#eu1 = lapply(eu1, function(df) {
#  df = df[ , !(names(df) %in% "trial_version")]  # Remove the "trial_version" column due to type discrepancy
#  return(df)
#})
#eu1 = bind_rows(eu1) %>% 
#  distinct(eudract_number_with_country, .keep_all = TRUE)
#nrow(eu1)

# Notice that the newest csv file(2024-10-05) in the whole folder contains all unique EU trials, I'm guessing this is because each dataset renewal is an update of all trials, with some addition of new trials.

eu1 = read_csv("EU data/all_euctr/euctr_euctr_dump-2024-10-05-060856.csv")
nrow(eu1)
```

```{r}
# Create column covid, taking value 1 when the trial is COVID-19 related
eu1_covid = eu1 %>% 
  select(eudract_number_with_country, trial_secondary_objectives_of_the_trial, trial_medical_condition_s_being_investigated, full_title_of_the_trial, trial_main_objective_of_the_trial, name_or_abbreviated_title_of_the_trial_where_available, trial_medical_condition_in_easily_understood_language, title_of_the_trial_for_lay_people_in_easily_understood_i_e_non_) %>%
  filter(if_any(everything(), ~ str_detect(., str_c(c("COVID", "Covid", "covid", "SARS-CoV-2"), collapse = "|")))) %>% 
  mutate(covid = 1) %>% 
  select(eudract_number_with_country, covid)

eu1 = eu1 %>% left_join(eu1_covid, by = "eudract_number_with_country")


eu6 %>% filter(start_year < 2020) %>% filter(covid == 1)
```

Since the datasets consists more than 100 columns, we extract only the column with relevant informations, the mapping to the column name and the information is as follows: 

  eudract_number_with_country - id
  us_nct_clinicaltrials_gov_registry_number - nct_id
  
  sponsors - sponsors, collaborators
  trial_term - disease
  trial_therapeutic_area - disease
  date_on_which_this_record_was_first_entered_in_the_eudract_data - start date
  member_state_concerned - country
  
  trial_human_pharmacology_phase_i - phase 1
  trial_therapeutic_exploratory_phase_ii - phase 2
  trial_therapeutic_confirmatory_phase_iii - phase 3
  trial_therapeutic_use_phase_iv - phase 4
  subject_in_the_whole_clinical_trial - # of patients
  trial_status - status
  date_of_the_global_end_of_the_trial -  end date

Notes: 
  1. cannot find exact start date, use first record date instead
  2. trial_therapeutic_area has 30% missing values, and trial_term has 20% missing values, together they have 12% missing values
  
### Clean the Data

Now, we want to construct a dataset with only the mentioned columns

```{r}
#Select only the useful columns from the eu1 dataset
eu2 = eu1 %>% select("eudract_number_with_country", "us_nct_clinicaltrials_gov_registry_number", "sponsors", "trial_term", "trial_therapeutic_area", "date_on_which_this_record_was_first_entered_in_the_eudract_data", "member_state_concerned", "trial_human_pharmacology_phase_i", "trial_therapeutic_exploratory_phase_ii", "trial_therapeutic_confirmatory_phase_iii", "trial_therapeutic_use_phase_iv", "subject_in_the_whole_clinical_trial", "trial_status", "date_of_the_global_end_of_the_trial", "trial_randomised", "trial_parallel_group", "trial_cross_over", "trial_controlled", "covid")
```


#### sponsors, collaborators - sponsors

```{r eval=FALSE}
# Create columns name_of_sponsor, country, and name_of_organisation_providing_support from the sponsors column
# Transfer the column sponsor to a data frame sponsors_df
sponsors_df = data.frame()

for (i in seq_along(eu2$sponsors)){
  id = eu2$eudract_number_with_country[i]
  observation = eu2$sponsors[i]
  
  if(observation == "[]"){     #observations with value "[]" (missing values) returns an empty list instead of a data frame with fromJSON()
    sponsors_df = bind_rows(sponsors_df, fromJSON("[{}]") %>% mutate(id = id)) 
  }else{
    sponsors_df = bind_rows(sponsors_df, fromJSON(observation) %>% mutate(id = id))
  }
}

# Select the columns needed from sponsors_df, including id, name_of_sponsor, and status_of_the_sponsor(which will later be used to determine if the sponsor is in industry or not)
# Ignore organization providing support for now
selected_sponsors_df = sponsors_df[, c("id", "name_of_sponsor", "status_of_the_sponsor")]

# Combine selected_sponsors_df to eu2 and discard the column sponsor
eu3 = left_join(selected_sponsors_df, eu2, by = c("id" = "eudract_number_with_country"))

eu3 = eu3 %>% select(-"sponsors")

# Change the column status_of_the_sponsor into another dummy variable column industry_dummy
eu3 = eu3 %>% mutate(industry_dummy = case_when(
  status_of_the_sponsor == "Commercial" ~ 1,
  status_of_the_sponsor == "Non-Commercial" ~ 0,
  )) %>% 
  select(-"status_of_the_sponsor")

# Add column collab_num counting the number of collaborators for each trial
eu_collab_num_name = eu3 %>% 
  mutate(industry_collab = ifelse(industry_dummy == 1, name_of_sponsor, NA),
         non_industry_collab = ifelse(industry_dummy == 0, name_of_sponsor, NA)) %>% 
  group_by(id) %>% 
  reframe(collab_num = n()-1, 
          collaborator = list(unique(name_of_sponsor)),
          industry_collab = list(unique(industry_collab[!is.na(industry_collab)])),
          non_industry_collab = list(unique(non_industry_collab[!is.na(non_industry_collab)]))) 

eu3 = eu3 %>% 
  left_join(eu_collab_num_name, by = "id") %>% 
  mutate(collaborator = map2(collaborator, name_of_sponsor, ~ .x[.x != .y]),
         industry_collab = map2(industry_collab, name_of_sponsor, ~ .x[.x != .y]),
         non_industry_collab = map2(non_industry_collab, name_of_sponsor, ~ .x[.x != .y]))
```

Note: 
  1. Some observations have multiple sponsor information, some are duplicates and some are different sponsor information. What is the best solution? For now I use only the first one 
  2. Whats the difference between sponsor and organization providing support?

```{r}
# Note: some observations have multiple sponsors, for now the values are stored in multiple_sponsors_per_obsv
# Exploratory code
multiple_sponsors_per_obsv = data.frame()

for (observation in eu2$sponsors){
  if (!is.null(nrow(fromJSON(observation))) && nrow(fromJSON(observation)) > 1){
    multiple_sponsors_per_obsv = bind_rows(sponsors_df, fromJSON(observation))
  }
}

head(multiple_sponsors_per_obsv, 100)

# show the distribution of number of rows each JSON text converts to 
temp = c()
for (observation in eu2$sponsors){
  temp = c(temp, nrow(fromJSON(observation)))
}
table(temp)
```

#### start_year, start_date, end_date

Create `start_year`, `start_date` from `date_on_which_this_record_was_first_entered_in_the_eudract_data`,
and `end_date` form `date_of_the_global_end_of_the_trial`

```{r eval=FALSE}
#Create variable start_year, start_date, end_date
eu3 = eu3 %>% 
  rename(start_date = date_on_which_this_record_was_first_entered_in_the_eudract_data) %>% 
  mutate(start_year = year(start_date)) %>% 
  rename(end_date = date_of_the_global_end_of_the_trial)
```

#### country

Create the variable `country` base on `member_state_concerned`

```{r}
#Exam the values of member_state_concerned
#table(eu3$member_state_concerned)

#Notice every observation follows the form "country - agency" except Bulgaria
#Change the observations with value "Bulgarian Drug Agency" into "Bulgaria - temp"
eu4 = eu3 %>%
  mutate(member_state_concerned = ifelse(member_state_concerned == "Bulgarian Drug Agency", "Bulgaria - temp", member_state_concerned))

#Create variable country
eu4 = eu4 %>% separate(member_state_concerned, into = c("country", "agency"), sep = " - ") %>% 
  select(-"agency")
```

#### disease

We want to create a column disease indicating the research area the clinical trial targets. The closest standardized variable is "trial_therapeutic_area", which we will be using the level 1 area code (CXX) to represent the disease.

Note: These are the potential columns from eu1 that we can use, but none of these use mesh terms:
"trial_medical_condition_s_being_investigated", "trial_term", "trial_medical_condition_in_easily_understood_language"

```{r}
#Create disease from trial_therapeutic_area
eu5 = eu4 %>% 
  mutate(disease_code = substr(trial_therapeutic_area, nchar(eu4$trial_therapeutic_area)-3,nchar(eu4$trial_therapeutic_area)-1)) %>% 
  select(-trial_term, -trial_therapeutic_area) #remove trial_term and trial_therapeutic_area

```

#### randomized,  single_group, parallel, and covid

  This is related to the design of the trial, randomized takes values of 1 and 0 denoting TRUE and FALSE, single_group takes value of 1 if trial_parallel_group, trial_cross_over, trial_controlled are all FALSE.
  
##### Note: since the raw dataset is missing a single_group column, we define a trial as single group if trial_parallel_group, trial_cross_over, trial_controlled are all FALSE.

```{r}
eu5 = eu5 %>% 
  mutate(randomized = ifelse(trial_randomised == TRUE, 1, 0)) %>% 
  mutate(single_group = ifelse(trial_parallel_group == FALSE & trial_cross_over == FALSE & trial_controlled == FALSE, 1, 0)) %>% 
  mutate(parallel_group = ifelse(trial_parallel_group == TRUE, 1, 0)) %>% 
  mutate(covid = ifelse(is.na(covid), 0, covid)) %>% 
  select(-c(trial_randomised, trial_parallel_group, trial_cross_over, trial_controlled))

```

#### (other variables)

#### change variable names

Change `id` to `eudract_id`,
`subject_in_the_whole_clinical_trial` to `patient_num`,
`us_nct_clinicaltrials_gov_registry_number` to `nct_id`,
`trial_human_pharmacology_phase_i` to `phase_1`,
`trial_therapeutic_exploratory_phase_ii` to `phase_2`,
`trial_therapeutic_confirmatory_phase_iii` to `phase_3`,
`trial_therapeutic_use_phase_iv` to `phase_4`,
`subject_in_the_whole_clinical_trial` to `patient_num`,
`trial_status` to `status`,
`name_of_sponsor` to `sponsor`

```{r}
#Code here 
eu6 = eu5 %>% 
  rename(
    eudract_id = id,
    patient_num = subject_in_the_whole_clinical_trial,
    nct_id = us_nct_clinicaltrials_gov_registry_number,
    phase_1 = trial_human_pharmacology_phase_i,
    phase_2 = trial_therapeutic_exploratory_phase_ii,
    phase_3 = trial_therapeutic_confirmatory_phase_iii,
    phase_4 = trial_therapeutic_use_phase_iv,
    status = trial_status,
    sponsor = name_of_sponsor
  )

```


Note: the classification of the area of study follows the MeSH tree classification, so for standardization we should use the browse_conditions table from AACT database, which also name their conditions based on MeSH tree classification.

## US data

### Import the Data

```{r}
#Load the US data sets, from the "Pipe-Delimited Files" from the AACT website with the most up-to-date version

us_browse_conditions = read_csv("US data/delimited data/browse_conditions.txt")
us_conditions = read_csv("US data/delimited data/conditions.txt")
us_countries = read_csv("US data/delimited data/countries.txt")
us_sponsors = read_csv("US data/delimited data/sponsors.txt")
us_studies = read_csv("US data/delimited data/studies.txt")
us_designs = read_csv("US data/delimited data/designs.txt")

#Notice that the data set is only with one column with "|" separating the different variables
#Separate the data into different variables in different columns

us_browse_conditions = separate(us_browse_conditions, col = "id|nct_id|mesh_term|downcase_mesh_term|mesh_type", into = c("id", "nct_id", "mesh_term", "downcase_mesh_term", "mesh_type"), sep = "\\|")
us_conditions = separate(us_conditions, col = "id|nct_id|name|downcase_name", into = c("id", "nct_id", "name", "downcase_name"), sep = "\\|")
us_countries = separate(us_countries, col = "id|nct_id|name|removed", into = c("id", "nct_id", "name", "removed"), sep = "\\|")
us_sponsors = separate(us_sponsors, col = "id|nct_id|agency_class|lead_or_collaborator|name", into = c("id", "nct_id", "agency_class", "lead_or_collaborator", "name"), sep = "\\|")
us_studies = separate(us_studies, col = colnames(us_studies)[1], into = unlist(strsplit(colnames(us_studies)[1], "\\|")), sep = "\\|")
us_designs = separate(us_designs, col = colnames(us_designs)[1], into = unlist(strsplit(colnames(us_designs)[1], "\\|")), sep = "\\|")

```



Since the US data scatters in multiple datasets, here's the mapping from each datasets to the key variables they provide:

  studies - start and end date, Phase, status, # of patients
  browse_conditions - disease (MeSH)
  conditions - disease
  countries - country
  sponsors - lead: sponsors, collaborators: collaborators
  designs - allocation, intervention_model
  
### Combine Datasets

Here, we want to select only the useful variables from each dataset and combine them

```{r}
#Extract only the necessary column from each dataset

#Select start_date, end_date, phase, status from us_studies, also select enrollment to compare to patient_num acquired from us_baseline_counts
us_studies_reduced = us_studies %>% 
  rename(end_date = completion_date, status = overall_status, patient_num = enrollment) %>% 
  select(nct_id, start_date, end_date, phase, status, patient_num)

# Mark the trials that are COVID-19 related
us_covid = us_studies %>% 
  filter(str_detect(official_title, str_c(c("COVID", "Covid", "covid", "SARS-CoV-2"), collapse = "|"))) %>% 
  mutate(covid = 1) %>% 
  select(nct_id, covid)

#Collapse the different diseases for the same trial into one observation and select disease from us_conditions

#use us_browse_conditions instead

#us_conditions_reduced = us_conditions %>%
#  rename(disease = downcase_name) %>% 
#  group_by(nct_id) %>%
#  summarize(disease = paste(unique(disease), collapse = ", ")) %>%
#  ungroup() %>% 
#  select(nct_id, disease)

#Select country from us_countries
#Note: what do we do if a trial has multiple country value
us_countries_reduced = us_countries %>% 
  rename(country = name) %>% 
  distinct(nct_id, country)

#Separate us_sponsors in to us_collaborator(collaborator) and us_sponsor(lead), and then select and count collaborator from us_collaborator and sponsors from us_sponsors
us_collaborator = us_sponsors %>% filter(lead_or_collaborator == "collaborator")
us_sponsor = us_sponsors %>% filter(lead_or_collaborator == "lead")

us_collaborator_reduced = us_collaborator %>% 
  rename(collaborator = name) %>%
  mutate(industry_collab = ifelse(agency_class == "INDUSTRY", collaborator, NA),
         non_industry_collab = ifelse(agency_class != "INDUSTRY", collaborator, NA)) %>% 
  group_by(nct_id) %>%
  summarize(collab_num = n(), 
            collaborator = list(unique(collaborator)),
            industry_collab = list(unique(industry_collab[!is.na(industry_collab)])),
            non_industry_collab = list(unique(non_industry_collab[!is.na(non_industry_collab)]))) %>%
  ungroup() %>% 
  select(nct_id, collab_num, collaborator, industry_collab, non_industry_collab)

us_sponsor_reduced = us_sponsor %>% 
  rename(sponsor = name) %>% 
  mutate(industry_dummy = ifelse(agency_class == "INDUSTRY", 1, 0)) %>% 
  select(nct_id, sponsor, industry_dummy)

us_designs_reduced = us_designs %>% 
  mutate(randomized = ifelse(allocation == "RANDOMIZED", 1, 0)) %>% 
  mutate(single_group = ifelse(intervention_model == "SINGLE_GROUP", 1, 0)) %>% 
  mutate(parallel_group = ifelse(intervention_model == "PARALLEL", 1, 0)) %>% 
  select(nct_id, randomized, single_group, parallel_group)
  
```


```{r}
#Combine the datasets into us1

#Create a list consisting all datasets
us_datasets = list(us_studies_reduced, us_conditions_reduced, us_countries_reduced, us_sponsor_reduced, us_collaborator_reduced, us_designs_reduced, us_covid)

#Combine US datasets
us1 = reduce(us_datasets, full_join, by = "nct_id")

#Check the unique nct_id
length(unique(us1$nct_id))
```

### Clean the Data

#### phase_0, phase_1, phase_2, phase_3, phase_4

Create phase_0, phase_1, phase_2, phase_3, phase_4 from phase

```{r}
#Create five one-hot coded variable for phase 0 through 4
us1 = us1 %>% 
  mutate(phase_0 = phase %in% c("EARLY_PHASE1")) %>% 
  mutate(phase_1 = phase %in% c("PHASE1", "PHASE1/PHASE2")) %>%
  mutate(phase_2 = phase %in% c("PHASE1/PHASE2", "PHASE2", "PHASE2/PHASE3")) %>%
  mutate(phase_3 = phase %in% c("PHASE2/PHASE3", "PHASE3")) %>%
  mutate(phase_4 = phase %in% c("PHASE4")) %>% 
  select(-"phase")
```

#### start_year

Create start_year from start_date

```{r}
#Convert start_date and end_date into type date
us1 = us1 %>% 
  mutate(start_date = as_date(start_date),
         end_date = as_date(end_date)) %>% 
  mutate(start_year = year(start_date))

```

#### disease

To standardize disease, we will be using separate dataset us_browse_conditions which maps each unique US trials to multiple disease mesh terms. In order to map from the mesh terms to the mesh_code, we will be using the mesh_trees dataset. 

Then, we create a dataset mapping each unique trial to one mesh_code by selecting the level 1 code with the most occurrences for each unique trials.


```{r}
#View us_browse_conditions to see the related area per nct_id
us_browse_conditions = read_csv("US data/delimited data/browse_conditions.txt")

us_browse_conditions = separate(us_browse_conditions, col = "id|nct_id|mesh_term|downcase_mesh_term|mesh_type", into = c("id", "nct_id", "mesh_term", "downcase_mesh_term", "mesh_type"), sep = "\\|")

#There's multiple diseases per trial
#Use the mesh_trees dataset to create mapping from nct_id to mesh_term to mesh_code which is a one-to-many relation
mesh_trees = read_csv("US data/mesh_trees_2017.csv")
```

```{r}
nct_id_mesh_term_disease_code = left_join(us_browse_conditions, mesh_trees, by = c("mesh_term" = "dscrptr")) %>% select(nct_id, mesh_term, tree2level)

```

```{r}
# Exploratory code
# Count amount of one-to-many relationship
many_to_many_us_disease = nct_id_mesh_term_disease_code %>% 
  group_by(nct_id, mesh_term) %>%
  summarize(count = n()) %>% 
  filter(count > 1)

nrow(many_to_many_us_disease)
```

```{r}

#Create a dataset nct_id_mesh_code mapping each unique nct_id to the level 1 mesh_code with the most occurrences 
nct_id_mesh_term_disease_code = nct_id_mesh_term_disease_code %>% 
  mutate(disease_code = substr(tree2level, 1, 3))

nct_id_disease_code = data.frame()

nct_id_disease_code = nct_id_mesh_term_disease_code %>% 
  group_by(nct_id, disease_code) %>%  # Group by both nct_id and mesh_code
  summarize(count = n()) %>%       # Count occurrences of each mesh_code per nct_id
  ungroup() %>%                    # Ungroup to work with the data freely
  group_by(nct_id) %>%             # Group by nct_id to find the most frequent mesh_code
  filter(count == max(count)) %>%  # Filter the rows with the most frequent mesh_code
  slice(1) %>%                     # In case of ties, take the first occurrence
  select(nct_id, disease_code) 


```

Now, with the mapping dataset nct_id_mesh_code, we can create the column disease_code in the US dataset

```{r}
#Left join nct_id_disease_code to us1 so that each unique trial has a disease_code
us2 = left_join(us1, nct_id_disease_code, by = "nct_id")

#Note that 13.6% of US trials have missing value for disease_code
sum(is.na(us2$disease_code)) / nrow(us2)
```


## Combine US&EU Data

Note that the latest version of EU dataset is eu5, and the latest version of the US dataset is us1.
Now, we want to select the columns needed for both datasets and combine them

```{r}
#Select the columns needed for both datasets 
eu7 = eu6 %>% 
  rename(disease_code_eu = disease_code) %>% 
  select("nct_id", "eudract_id", "sponsor", "industry_dummy", "country", "disease_code_eu", "start_year", "phase_1", "phase_2", "phase_3", "phase_4", "patient_num", "end_date", "status", "randomized", "single_group", "parallel_group", "start_date", "end_date", "collab_num", "collaborator", "industry_collab", "non_industry_collab", "covid")
  
us3 = us2 %>% 
  rename(disease_code_us = disease_code) %>% 
  mutate(patient_num = as.numeric(patient_num)) %>% 
  select("nct_id", "sponsor", "industry_dummy", "country", "disease_code_us", "start_year", "phase_1", "phase_2", "phase_3", "phase_4", "patient_num", "end_date", "status", "randomized", "single_group", "parallel_group", "start_date", "end_date", "collab_num", "collaborator", "industry_collab", "non_industry_collab", "covid")

#For trial in eu6 having nct_id, us the corresponding start_year from us2
eu7 = eu7 %>%
  left_join(us2 %>% distinct(nct_id, start_year), by = "nct_id", suffix = c("_eu", "_us")) %>%
  mutate(start_year = coalesce(start_year_us, start_year_eu)) %>%
  select(-start_year_us, -start_year_eu)

```


```{r}
#Combine two datasets
clinical_trials_1 = bind_rows(us3, eu7)

```

### Clean Variables

#### disease

What we have now is only disease_code, we also want to create disease_term based on the mesh_tree dataset, as well as creating an index for each disease_code.

```{r}
# Create column disease_code based on disease_code_eu and disease_code_us
clinical_trials_1 = clinical_trials_1 %>% 
  mutate(disease_code = coalesce(disease_code_eu, disease_code_us))

#Create mapping from each disease_code to level 1 disease_term
disease_code_to_term =  mesh_trees %>% 
  filter(level == 1) %>% 
  select(mesh_tree, dscrptr)

#Map each disease_term to each disease_code in clinical_trials_2
clinical_trials_2 = clinical_trials_1 %>% 
  left_join(disease_code_to_term, by = c("disease_code" = "mesh_tree")) %>% 
  rename(disease_term = dscrptr)

```

```{r}
#Create a mapping from each disease_code to disease_id
disease_code_to_id = clinical_trials_2 %>% 
  distinct(disease_code) %>% 
  arrange(disease_code) %>% 
  mutate(disease_id = ifelse(is.na(disease_code), NA, row_number()))

# Create mapping table disease_id_code_term for future use
disease_id_code_name = disease_code_to_id %>% 
  left_join(disease_code_to_term, by = c("disease_code" = "mesh_tree")) %>% 
  select(disease_id, mesh_code = disease_code, disease_name = dscrptr)

#Map each disease_index to each disease_code in clinical_trials_2
clinical_trials_2 = clinical_trials_2 %>% 
  left_join(disease_code_to_id, by = c("disease_code" = "disease_code"))
```



#### sponsor

We wish to standardize the companies by changing them all into lowercase and only keep the alphanumeric characters. In addition, we want to create an unique index for each companies, for companies names that belong to the same company but have slightly different names, we want them to share the same index. 

We will be performing fuzzy match using the stringdist package.

```{r}
#Standardize sponsor, and then group and arrange the combined dataset, also unlist and clean the collaborator columns
clinical_trials_3 = clinical_trials_2 %>%
  mutate(sponsor = str_to_lower(sponsor)) %>%  # Convert to lowercase
  mutate(sponsor = str_replace_all(sponsor, "[^a-z0-9\\s]", "")) %>%  # Remove non-alphanumeric characters
  mutate(sponsor = str_trim(sponsor)) %>%   
  mutate(collaborator = as.character(map(collaborator, ~ .x %>%                  # Clean collaborator names
                         str_to_lower() %>%                         # Convert to lowercase
                         str_replace_all("[^a-z0-9\\s]", "") %>%    # Remove non-alphanumeric characters
                         str_trim() %>%                             # Trim whitespace
                         str_c(collapse = ", ")))) %>%                # collapse the list of collaborator names
  mutate(industry_collab = as.character(map(industry_collab, ~ .x %>%                  # Clean collaborator names
                         str_to_lower() %>%                         # Convert to lowercase
                         str_replace_all("[^a-z0-9\\s]", "") %>%    # Remove non-alphanumeric characters
                         str_trim() %>%                             # Trim whitespace
                         str_c(collapse = ", ")))) %>% 
  mutate(non_industry_collab = as.character(map(non_industry_collab, ~ .x %>%                  # Clean collaborator names
                         str_to_lower() %>%                         # Convert to lowercase
                         str_replace_all("[^a-z0-9\\s]", "") %>%    # Remove non-alphanumeric characters
                         str_trim() %>%                             # Trim whitespace
                         str_c(collapse = ", ")))) %>% 
  group_by(sponsor, disease_code, start_year, country) %>%
  arrange(sponsor, disease_code, start_year) %>% 
  ungroup() %>% 
  rename(sponsor_name = sponsor)
```

```{r}
# Clean company and sponsor suffixes
suffixes = c("llc", "inc", "corp", "corporation", "limited", "co", "company", "ltd", "nasdaq\\w*")

clinical_trials_4 = clinical_trials_3 %>%
  mutate(sponsor_name = str_remove_all(sponsor_name, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>%
  mutate(sponsor_name = str_trim(sponsor_name)) %>% 
  mutate(collaborator = str_remove_all(collaborator, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>%
  mutate(collaborator = str_trim(collaborator)) %>% 
  mutate(industry_collab = str_remove_all(industry_collab, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>%
  mutate(industry_collab = str_trim(industry_collab)) %>% 
  mutate(non_industry_collab = str_remove_all(non_industry_collab, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>%
  mutate(non_industry_collab = str_trim(non_industry_collab))
```


**This following section is the original method to create sponsor name matching. The matching dataset is then being refined and we will updated the false negatives from the matched dataset**

```{r, eval=FALSE}
# Assign index to each unique sponsors, use Jaro-Winkler distance to determine if different sponsor names are the same organization

# Following code from ChatGPT
# Function to calculate Jaro-Winkler distance in batches
distance_matrix = function(company_names, batch_size = 1000, method = "jw") {
  n = length(company_names)  # Get the total number of company names
  dist_list = list()         # Create an empty list to store distance matrix chunks
  
  # Loop through the data in batches
  for (i in seq(1, n, by = batch_size)) {
    end = min(i + batch_size - 1, n)  # Define the end of the current batch
    dist_chunk = stringdistmatrix(company_names[i:end], company_names, method = method)  # Calculate the distance
    dist_list[[length(dist_list) + 1]] <- dist_chunk  # Store the chunk in the list
  }
  
  # Combine the distance matrix chunks back together
  dist_matrix = do.call(rbind, dist_list)
  return(dist_matrix)
}

# Apply hierarchical clustering and assign indices based on the distance matrix
assign_fuzzy_index = function(company_names, batch_size = 1000, method = "jw", cut_height = 0.1) {
  # Get the distance matrix in batches
  dist_matrix = distance_matrix(company_names, batch_size, method)
  
  # Perform hierarchical clustering
  clusters = hclust(as.dist(dist_matrix))
  
  # Cut the dendrogram to define clusters
  cluster_groups = cutree(clusters, h = cut_height)
  
  return(cluster_groups)  # Return the cluster group indices
}

# 865051 observations in clinical_trials_4
```

  Before we fuzzy match, we want to also match with the names in the firm_founding_year2 dataset, which is a list of companies with their year founded information. 
  
  We want to create a mapping list, firm_name_founding_year_id, which include all company names from clinical_trials_4 and firm_founding_year2, along with their unique matched id and the year_founded information from firm_founding_year2.
  
  Note that the hyperparamter cut_height has value 0.09 as a result of tuning in order to reach 90% distinctness for company names in firm_founding_year2 which is already unique.
  
```{r, eval=FALSE}
# Load and Create firm_founding_year2
# Load the company_found_year datasets and fix the formatting 
biotech1 = row_to_names(read_excel("FoundingYear/biotech1.xls"), row_number = 2)
biotech2 = row_to_names(read_excel("FoundingYear/biotech2.xls"), row_number = 2)
biotech3 = row_to_names(read_excel("FoundingYear/biotech3.xls"), row_number = 2)
pharma1 = row_to_names(read_excel("FoundingYear/pharma1.xls"), row_number = 2)
pharma2 = row_to_names(read_excel("FoundingYear/pharma2.xls"), row_number = 2)
pharma3 = row_to_names(read_excel("FoundingYear/pharma3.xls"), row_number = 2)
pharma4 = row_to_names(read_excel("FoundingYear/pharma4.xls"), row_number = 2)

#Combine all of the datasets into firm_founding_year
datasets = list(biotech1, biotech2, biotech3, pharma1, pharma2, pharma3, pharma4)
firm_founding_year1 = do.call(rbind, datasets) %>% distinct(`Excel Company ID`, .keep_all = TRUE)

# Clean the company names and only select the useful columns
firm_founding_year2 = firm_founding_year1 %>%
  rename(company_name = `Company Name`) %>% 
  rename(year_founded = `Year Founded`) %>% 
  mutate(company_name = str_to_lower(company_name)) %>%  # Convert to lowercase
  mutate(company_name = str_replace_all(company_name, "[^a-z0-9\\s]", "")) %>%  # Remove non-alphanumeric characters
  mutate(company_name = str_remove_all(company_name, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>%
  mutate(company_name = str_trim(company_name))  %>% 
  rename(sponsor_name = company_name) %>% 
  mutate(year_founded = ifelse(year_founded == "-", NA, year_founded)) %>%
  select(sponsor_name, year_founded) %>% 
  filter(!is.na(year_founded)) # The purpose of this dataset is to map year_founded, so there's no need using observations without year_founded

# 45437 companies in firm_founding_year2
clinical_trials_4
```

 Now we want to apply fuzzy match on the combined list of company names from clinical_trials_4 and firm_founding_year2, in order to maximize the results, we want to separate the company names in the following groups:
 
  - Companies with names starting with numbers
  - Companies with name shorter than 10 characters
  - Companies with long names starting with a-g
  - Companies with long names starting with h-q
  - Companies with long names starting with r-z


```{r, eval=FALSE, fuzzy mapping}
# Create the mapping dataset firm_name_founding_year_id and perform fuzzy match to assign unique sponsor_id
firm_name_founding_year_id = bind_rows(firm_founding_year2 %>% select(sponsor_name), clinical_trials_4 %>% select(sponsor_name)) %>%
  distinct(sponsor_name) %>% 
  left_join(firm_founding_year2, by = join_by(sponsor_name)) %>% 
  arrange(sponsor_name) # 96224 unique company names

# Check the distribution of company name lengths and starting letters
firm_name_founding_year_id %>% ggplot(aes(x = nchar(sponsor_name))) + geom_histogram(bins = 50) + xlim(0, 50)
firm_name_founding_year_id %>% filter(!str_detect(sponsor_name, "^\\d")) %>% ggplot(aes(x = substr(sponsor_name, 1, 1))) + geom_bar()

# filter out and fuzzy match company names starting with (numbers, a-g, h-q, r-z)
firm_name_founding_year_id_numeric_start = firm_name_founding_year_id %>%
  filter(str_detect(sponsor_name, "^\\d")) %>% 
  mutate(sponsor_id = assign_fuzzy_index(sponsor_name, batch_size = 1000, cut_height = 0.01))
firm_name_founding_year_id_numeric_start$sponsor_id %>% max() # max sponsor_id 276

firm_name_founding_year_id_short = firm_name_founding_year_id %>%
  distinct(sponsor_name, .keep_all = TRUE) %>% 
  filter(!str_detect(sponsor_name, "^\\d")) %>% 
  filter(nchar(sponsor_name) <= 10) %>% 
  mutate(sponsor_id = assign_fuzzy_index(sponsor_name, batch_size = 1000, cut_height = 0.03))
firm_name_founding_year_id_short$sponsor_id %>% max() # max sponsor_id 13345

firm_name_founding_year_id_long_a_to_g = firm_name_founding_year_id %>% 
  distinct(sponsor_name, .keep_all = TRUE) %>% 
  filter(nchar(sponsor_name) > 10) %>% 
  filter(str_detect(sponsor_name, "^[A-Ga-g]")) %>% 
  mutate(sponsor_id = assign_fuzzy_index(sponsor_name, batch_size = 1000, cut_height = 0.1)) %>% 
  distinct(sponsor_name, .keep_all = TRUE)
firm_name_founding_year_id_long_a_to_g$sponsor_id %>% max() # max sponsor_id 27185

firm_name_founding_year_id_long_h_to_q = firm_name_founding_year_id %>% 
  distinct(sponsor_name, .keep_all = TRUE) %>% 
  filter(str_detect(sponsor_name, "^[H-Qh-q]")) %>% 
  filter(nchar(sponsor_name) > 10) %>%
  mutate(sponsor_id = assign_fuzzy_index(sponsor_name, batch_size = 1000, cut_height = 0.1)) %>% 
  distinct(sponsor_name, .keep_all = TRUE)
firm_name_founding_year_id_long_h_to_q$sponsor_id %>% max() # max sponsor_id 27151

firm_name_founding_year_id_long_r_to_z = firm_name_founding_year_id %>%
  distinct(sponsor_name, .keep_all = TRUE) %>% 
  filter(str_detect(sponsor_name, "^[R-Zr-z]")) %>% 
  filter(nchar(sponsor_name) > 10) %>%
  mutate(sponsor_id = assign_fuzzy_index(sponsor_name, batch_size = 1000, cut_height = 0.1)) %>% 
  distinct(sponsor_name, .keep_all = TRUE)
firm_name_founding_year_id_long_r_to_z$sponsor_id %>% max() # max sponsor_id 19205

# Combine the four indexed dataset to the complete firm_name_founding_year_id, by shifting indexes
firm_name_founding_year_id = firm_name_founding_year_id_numeric_start %>% 
  rbind(firm_name_founding_year_id_short %>% mutate(sponsor_id = 276 + sponsor_id)) %>% 
  rbind(firm_name_founding_year_id_long_a_to_g %>% mutate(sponsor_id = 276 + 13345 + sponsor_id)) %>% 
  rbind(firm_name_founding_year_id_long_h_to_q %>% mutate(sponsor_id = 276 + 13345 + 27185 + sponsor_id)) %>% 
  rbind(firm_name_founding_year_id_long_r_to_z %>% mutate(sponsor_id = 276 + 13345 + 27185 + 27151 + sponsor_id)) # 95853 observations

# Exploratory code
firm_name_founding_year_id %>% filter(str_detect(sponsor_name, "bayer"))
firm_name_founding_year_id %>% filter(str_detect(sponsor_name, "novartis"))
```

**End of sponsor name matching section**

```{r}
# Import the refined sponsor_name_found_year_id dataset
library(readxl)
company_matching_false_negative = read_excel("Sponsors/sponsor_founding_matching_1112.xlsx")
company_matching_false_negative = company_matching_false_negative %>% select(sponsor_name, sponsor_id, false_negative)

# Update firm_name_founding_year_id with identified false negatives
firm_name_founding_year_id_new = firm_name_founding_year_id %>% 
  left_join(company_matching_false_negative, by = c("sponsor_name" = "sponsor_name", "sponsor_id" = "sponsor_id")) %>% 
  mutate(sponsor_id = ifelse(is.na(false_negative), sponsor_id, false_negative))



sponsor_name_id = firm_name_founding_year_id_new %>% select(sponsor_name, sponsor_id) # only sponsor name and id

clinical_trials_5 = clinical_trials_4 %>% 
  left_join(sponsor_name_id, by = c("sponsor_name" = "sponsor_name")) %>% 
  select("nct_id", "eudract_id", "sponsor_name", "industry_dummy", "sponsor_id", "disease_code", "disease_code_eu", "disease_code_us", "disease_term", "disease_id", "start_year",  "country", "phase_1", "phase_2", "phase_3", "phase_4", "patient_num", "end_date", "status", "randomized", "single_group", "parallel_group", "start_date", "end_date", "collab_num", "collaborator", "industry_collab", "non_industry_collab", "covid")

# 865051 observations
```

#### country

Standardize country names

```{r}
# Create a mapping list from names of countries used in our dataset to distinct and non-repeating country names in the world
# Load a list of all countries in the world, with another row distinct country
countries = read_csv("Countries/countries.csv") %>% 
  mutate(distinct_name = Country) %>% 
  select(Country, distinct_name)

# Extract the distinct list of names of countries in our dataset, then left join the list of countries from the previous step. Create a dataset distinct_country
standardized_country = clinical_trials_5 %>% 
  distinct(country) %>% 
  arrange(country) %>% 
  left_join(countries, by = c("country" = "Country")) 

# Check the number of names of countries not in the distinct list
standardized_country %>% filter(is.na(distinct_name)) # There are 46 names not in the distinct list

# For each name of countries not having a distinct name, map them to an existing name or create a distinct name
# Mapping based on research of region/country names 
standardized_country = standardized_country %>% mutate(distinct_name = case_when(
  !is.na(distinct_name) ~ distinct_name,
  country == "Aland Islands" ~ "Finland",
  country == "Antarctica" ~ "Antarctica",
  country == "Antigua and Barbuda" ~ "Antigua and Barbuda",
  country == "Bahamas" ~ "Bahamas",
  country == "Bonaire, Sint Eustatius and Saba" ~ "Netherlands",
  country == "Bosnia and Herzegovina" ~ "Bosnia and Herzegovina",
  country == "Brunei Darussalam" ~ "Brunei Darussalam",
  country == "CZECHIA" ~ "Czech Republic",
  country == "Central African Republic" ~ "Central African Republic",
  country == "Congo" ~ "Congo",
  country == "Congo, The Democratic Republic of the" ~ "Congo",
  country == "Czechia" ~ "Czech Republic",
  country == "Côte D'Ivoire" ~ "Ivory Coast",
  country == "Federated States of Micronesia" ~ "Federated States of Micronesia",
  country == "Former Serbia and Montenegro" ~ "Former Serbia and Montenegro",
  country == "Former Yugoslavia" ~ "Former Yugoslavia",
  country == "Gambia" ~ "Gambia",
  country == "Holy See (Vatican City State)" ~ "Vatican City State",
  country == "Iran, Islamic Republic of" ~ "Iran",
  country == "Korea, Republic of" ~ "South Korea",
  country == "Kosovo" ~ "Kosovo",
  country == "Lao People's Democratic Republic" ~ "Laos",
  country == "Libyan Arab Jamahiriya" ~ "Libya",
  country == "Macedonia, The Former Yugoslav Republic of" ~ "Macedonia",
  country == "Moldova, Republic of" ~ "Moldova",
  country == "Montenegro" ~ "Montenegro",
  country == "Myanmar" ~ "Myanmar",
  country == "North Macedonia" ~ "North Macedonia",
  country == "Northern Mariana Islands" ~ "United States",
  country == "Palestinian Territories, Occupied" ~ "Palestine",
  country == "Palestinian Territory, occupied" ~ "Palestine",
  country == "Russian Federation" ~ "Russia",
  country == "Réunion" ~ "France",
  country == "Saint Kitts and Nevis" ~ "Saint Kitts and Nevis",
  country == "Saint Martin" ~ "Saint Martin",
  country == "South Georgia and the South Sandwich Islands" ~ "United Kingdom",
  country == "South Sudan" ~ "South Sudan",
  country == "Syrian Arab Republic" ~ "Syria",
  country == "The Democratic Republic of the Congo" ~ "Congo",
  country == "Timor-Leste" ~ "Timor-Leste",
  country == "Trinidad and Tobago" ~ "Trinidad and Tobago",
  country == "UK" ~ "United Kingdom",
  country == "United States Minor Outlying Islands" ~ "United States",
  country == "Virgin Islands (U.S.)" ~ "United States"
))

```


```{r}
# Map the country values to the standardized names 
clinical_trials_5 = clinical_trials_5 %>% 
  left_join(standardized_country, by = "country") %>% 
  mutate(country = distinct_name) %>% 
  select(-distinct_name)

# 865051
```


We want to also add an index for countries

```{r}
# Create column country_id 
# Create a mapping from each country to country_id
country_name_to_id = clinical_trials_5 %>% 
  distinct(country) %>% 
  arrange(country) %>% 
  mutate(country_id = ifelse(is.na(country), NA, row_number()))

#Map each disease_index to each disease_code in clinical_trials_2
clinical_trials_6 = clinical_trials_5 %>% 
  left_join(country_name_to_id, by = "country") %>% 
  select("nct_id", "eudract_id", "sponsor_name", "industry_dummy", "sponsor_id", "disease_code", "disease_code_eu", "disease_code_us", "disease_term", "disease_id", "start_year",  "country", "country_id", "phase_1", "phase_2", "phase_3", "phase_4", "patient_num", "status", "randomized", "single_group", "parallel_group", "start_date", "end_date", "collab_num", "collaborator", "industry_collab", "non_industry_collab", "covid")

# 865051
```

#### status

```{r}
# Look at the distinct values of status
#clinical_trials_6 %>% distinct(status)

# reclassify the statuses into "ongoing", "completed", "terminated", and "" for invalid input
# Classification might be subject to change 
clinical_trials_6 = clinical_trials_6 %>% mutate(status = case_when(
  status %in% c("Ongoing", "NOT_YET_RECRUITING", "ACTIVE_NOT_RECRUITING", "RECRUITING", "ENROLLING_BY_INVITATION") ~ "ongoing",
  status %in% c("Completed", "COMPLETED", "APPROVED_FOR_MARKETING") ~ "completed",
  status %in% c("TERMINATED", "WITHDRAWN", "Prematurely Ended", "Trial now transitioned", "Restarted", "Temporarily Halted", "SUSPENDED", "Prohibited by CA", "Suspended by CA", "WITHHELD") ~ "terminated",
  TRUE ~ ""
)) 

# 81702/865051 trials have invalid status value
```
#### Note: Classification might be subject to change 


### Change NA values to blank, TRUE/FALSE to 1/0

```{r}
# Change NA values to blank, TRUE/FALSE to 1/0, also change end_data to end_year

clinical_trials_7 = clinical_trials_6 %>% 
  mutate(nct_id = ifelse(is.na(nct_id), "", nct_id)) %>% 
  mutate(eudract_id = ifelse(is.na(eudract_id), "", eudract_id)) %>% 
  mutate(sponsor_name = ifelse(is.na(sponsor_name), "", sponsor_name)) %>% 
  mutate(industry_dummy = ifelse(is.na(industry_dummy), "", industry_dummy)) %>% 
  mutate(sponsor_id = ifelse(is.na(sponsor_id), "", sponsor_id)) %>% 
  mutate(disease_code = ifelse(is.na(disease_code), "", disease_code)) %>% 
  mutate(disease_code_eu = ifelse(is.na(disease_code_eu), "", disease_code_eu)) %>% 
  mutate(disease_code_us = ifelse(is.na(disease_code_us), "", disease_code_us)) %>% 
  mutate(disease_term = ifelse(is.na(disease_term), "", disease_term)) %>% 
  mutate(disease_id = ifelse(is.na(disease_id), "", disease_id)) %>% 
  mutate(start_year = ifelse(is.na(start_year), "", start_year)) %>% 
  mutate(country = ifelse(is.na(country), "", country)) %>% 
  mutate(country_id = ifelse(is.na(country_id), "", country_id)) %>% 
  mutate(patient_num = ifelse(is.na(patient_num), "", patient_num)) %>%
  mutate(randomized = ifelse(is.na(randomized), "", randomized)) %>%
  mutate(single_group = ifelse(is.na(single_group), "", single_group)) %>%
  mutate(parallel_group = ifelse(is.na(parallel_group), "", parallel_group)) %>%
  mutate(end_year = ifelse(is.na(end_date), "", year(end_date))) %>% 
  mutate(collab_num = ifelse(is.na(collab_num), 0, collab_num)) %>% 
  mutate(collaborator = ifelse(is.na(collaborator), "", collaborator)) %>% 
  mutate(industry_collab = ifelse(is.na(industry_collab), "", industry_collab)) %>% 
  mutate(non_industry_collab = ifelse(is.na(non_industry_collab), "", non_industry_collab)) %>% 
  mutate(covid = ifelse(is.na(covid), 0, covid)) %>% 
  mutate(phase_1 = ifelse(phase_1 == TRUE, 1, 0)) %>% 
  mutate(phase_2 = ifelse(phase_2 == TRUE, 1, 0)) %>% 
  mutate(phase_3 = ifelse(phase_3 == TRUE, 1, 0)) %>% 
  mutate(phase_4 = ifelse(phase_4 == TRUE, 1, 0)) 

# 865051
```

### Remove Duplicates

We want to remove the duplicates observations. First, we check them on the sponsor, country, nct_id, eudract_id level, then we look for EU trials also recorded in US dataset

```{r}
# Frist, check at the sponsor, country, nct_id, eudract_id level, since we have different trials with the same nct_id due to country, and different trials with the same eudract_id due to sponsor
clinical_trials_7 %>% 
  group_by(sponsor_id, country_id, nct_id, eudract_id) %>% 
  count() %>% 
  nrow()
```

```{r}
# Notice that there are 862993 unique trials where there are 865051 rows, we remove these obvious duplicates first
clinical_trials_8 = clinical_trials_7 %>% 
  distinct(sponsor_id, country_id, nct_id, eudract_id, .keep_all=TRUE)

# From 865051 to 862993 observations
```

Moving on, we want to make sure there's no overlap in EU data and the US data, on the sponsor-disease-start_year-country level.
First, we single out a subset, eu_with_nct_id, with trials in EU data that has an nct_id (potentially in US data).
Then, we remove the eudract_id in eu_with_nct_id, and also remove this subset from clinical_trials_7.
Lastly, we select the unique trials on the nct_id-sponsor-disease-start_year-country level.

```{r}
# Create subset, eu_with_nct_id
eu_with_nct_id = clinical_trials_8 %>% 
  filter(nct_id != "") %>% 
  filter(eudract_id != "")

# Remove eu_with_nct_id from clinical_trials_8
clinical_trials_9 = clinical_trials_8 %>% 
  anti_join(eu_with_nct_id, by = names(eu_with_nct_id))

# Erase the eudract_id in eu_with_nct_id to "impersonate" a US trial
eu_with_nct_id = eu_with_nct_id %>% mutate(eudract_id = "")

# Add the modified eu_with_nct_id back to clinical_trials_8 and select unique trials on the nct_id-eudract_id-sponsor-disease-start_year-country level
# Note we also want to include eudract_id because we might mistake distinct trials with missing values in other variables as the same trial
clinical_trials_9 = clinical_trials_9 %>% 
  bind_rows(eu_with_nct_id) %>% 
  distinct(nct_id, eudract_id, sponsor_id, disease_id, start_year, country_id, .keep_all=TRUE)

# From 862993 to 855991
```

## Construct datasets for easier use

### main_raw_dataset, trial_country_dataset, trial_disease_firm_dataset

```{r}
# rearrange the trials and assign a unique id to them, call the dataset main_raw_dataset
main_raw_dataset = clinical_trials_9 %>% 
  group_by(sponsor_name, disease_id, start_year) %>% 
  arrange(sponsor_name, disease_id, start_year, country_id) %>% 
  ungroup() %>% 
  mutate(trial_id = row_number()) %>% 
  mutate(source = ifelse(eudract_id == "", "AACT", "EU"))

main_raw_dataset = main_raw_dataset %>% 
  select(trial_id, names(main_raw_dataset)) # 858602

# fix one minor sponsor name error for one observation
main_raw_dataset = main_raw_dataset %>% mutate(sponsor_name = ifelse(sponsor_name == "department of \ngynaecology helse finnmark klinikk \nhammerfest", "department of gynaecology helse finnmark klinikk hammerfest", sponsor_name)) 


# Create trial_country_dataset and trial_disease_firm_dataset from main_raw_dataset
trial_country_dataset = main_raw_dataset %>% 
  select(trial_id, nct_id, eudract_id, country, country_id) # 858602

trial_disease_firm_dataset = main_raw_dataset %>% 
  select(trial_id, nct_id, eudract_id, sponsor_name, industry_dummy, sponsor_id, disease_code, disease_code_eu, disease_code_us, disease_term, disease_id, start_year, phase_1, phase_2, phase_3, phase_4, patient_num, end_year, status) # 858602


```


### firm_year_dataset

#### Create trial_firm_detail 

Use main_raw_dataset as a starting point, create a dataset firm_year_dataset with unit of analysis being firm(sponsor) and year.
Recall in the "sponsor" section in "Combine US&EU Data", we have a dataset, firm_name_founding_year_id, with all company names, company ids, and year founded for some of the companies.

```{r}
# Create dataset trial_firm_detail
# map year_founded to each company id in main_raw_dataset (with selected rows)
trial_firm_detail_1 = main_raw_dataset %>% 
  left_join(firm_name_founding_year_id %>% 
              mutate(sponsor_found_year = ifelse(is.na(year_founded), "", year_founded)) %>% 
              mutate(sponsor_id = as.character(sponsor_id)) %>% 
              select(sponsor_name, sponsor_id, sponsor_found_year), by = c("sponsor_name" = "sponsor_name", "sponsor_id" = "sponsor_id")) %>% 
  select(trial_id, sponsor_name, sponsor_id, sponsor_found_year, start_year, country, phase_1, phase_2, phase_3, phase_4, patient_num, status, end_year, industry_dummy, source, disease_id, nct_id, eudract_id, randomized, single_group, parallel_group, start_date, end_date, collab_num, collaborator, industry_collab, non_industry_collab, covid) %>% 
  mutate(sponsor_found_year = ifelse(is.na(sponsor_found_year), "", sponsor_found_year))


# create variable matched_capiq indicating the company matched their founded year from firm_name_founding_year_id
trial_firm_detail_1 = trial_firm_detail_1 %>% 
  mutate(matched_capiq = ifelse(sponsor_found_year == "", 0, 1))


# 855991
```

#### Define valid trials

Before we complete the construction of the datsset, which includes a lot of interation between variables, we want to set definitions of what defines a "valid" observation, here;s how I can think of to define a "valid" trial:

 - A trial needs to have a valid sponsor name
 - A trial needs to have at least one phase
 - A trial needs to have a start year
 - A trial's start year cannot be earlier than its sponsor's founded year
 - Since the scope of this project is up to 2024, any end_year after 2024 will be dropped
 - A trial not having an end_year:
   - if the status is "completed" or "terminated", then the trial should be discarded
   - if the status is missing, we assume the trial is still ongoing
 - A trial having an end year but not a status will be excluded
 - A trial having start_year larger than end_year will be excluded
 - An ongoing trial does not need end_year 
 
For companies missing sponsor_found_year, we will use their earliest trial start year as their founded year.
Also, we want to add a region classifier, taking values from "EU", "US", or "Others".
Additionally, for trials classifies as multiple phases, we define it as the latter phase.


```{r}
# Trim the dataset based on the aforementioned rules
trial_firm_detail_2 = trial_firm_detail_1 %>% # 858602
  filter(sponsor_name != "") %>% # 858368
  filter(!(phase_1 == 0 & phase_2 == 0 & phase_3 == 0 & phase_4 == 0)) %>% # 506440, big cut
  filter(start_year != "") %>% # 503891
  filter(start_year > sponsor_found_year) %>% # 501663
  mutate(end_year = ifelse(end_year > "2024", "", end_year)) %>% 
  mutate(end_date = as.Date(ifelse(end_date > as.Date("2024-12-31"), NA, end_date))) %>% 
  filter(!(end_year == "" & (status == "completed" | status == "terminated"))) %>% # 466691, big cut
  mutate(status = ifelse(status == "" & end_year == "", "ongoing", status)) %>% 
  filter(!(status == "" & !(end_year == ""))) %>% # 446258
  mutate(end_year = ifelse(end_year == "", "3000", end_year)) %>% 
  filter(start_year <= end_year) %>% # 445663
  mutate(end_year = ifelse(end_year == "3000", "", end_year)) %>% 
  mutate(end_year = ifelse(status == "ongoing", "", end_year)) # 445663

# fill in sponsor_found_year with minimum start_year
trial_firm_detail_2 = trial_firm_detail_2 %>%
  group_by(sponsor_id) %>%
  mutate(sponsor_found_year = ifelse(sponsor_found_year == "", min(start_year), sponsor_found_year)) %>% 
  ungroup() %>% 
  mutate(sponsor_id = as.numeric(sponsor_id))

# Classify each trial's phase as the latest one
trial_firm_detail_2 = trial_firm_detail_2 %>% 
  mutate(phase_1 = ifelse(phase_2 == 1|phase_3 == 1|phase_4 == 1, 0, phase_1)) %>% 
  mutate(phase_2 = ifelse(phase_3 == 1|phase_4 == 1, 0, phase_2)) %>% 
  mutate(phase_3 = ifelse(phase_4 == 1, 0, phase_3))
  
# exploratory code
unmatched_companies_with_industry_dummy = trial_firm_detail_2 %>% distinct(sponsor_id, .keep_all = TRUE) %>% select(sponsor_name, sponsor_id, matched_capiq, industry_dummy) %>% filter(matched_capiq == 0)

# 443403
```

```{r}
# Create the region variable
eu_countries = c("Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", "Czech Republic", "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", "Ireland", "Italy", "Latvia", "Lithuania", "Luxembourg", "Malta", "Netherlands", "Poland", "Portugal", "Romania", "Slovakia", "Slovenia", "Spain", "Sweden", "United Kingdom") 

trial_firm_detail_3 = trial_firm_detail_2 %>% mutate(region = case_when(
  country == "United States" ~ "US",
  country %in% eu_countries ~ "EU",
  TRUE ~ "Others"
))

# 443403
```

#### Zombie trials

  Through future steps investigating phase 2 trials, we found out that some trials has weirdly long trial length, inflatind the counts on ongoing trials oer year. Therefore we investigated the distribution of trial length and define the ongoing trials with unusual length as "zombie_trials". 
  
  We use two methods to classify zombie trials:
   - trial length longer than 75 percentile of industry finished (competed/terminated) trials
   - trial length as outliar of ongoing trials (beyond 1.5 times the interquartile range (IQR) over 3rd quartile)
   
```{r}
# calculate phase 2 trial length in days
p2trial_length_unique_trial_id_days = trial_firm_detail_3 %>% 
  filter(phase_2 == TRUE) %>% # 146130
  mutate(end_date = as.Date(ifelse(is.na(end_date), "3000-12-31", as.character(end_date)))) %>% 
  filter(start_date <= end_date) %>% # 145997
  mutate(end_date = as.Date(ifelse(end_date == as.Date("3000-12-31"), NA, end_date))) %>% 
  mutate(end_date = as.Date(ifelse(status == "ongoing", NA, end_date))) %>% # 145997
  mutate(status = ifelse(is.na(status), "ongoing", status)) %>% 
  mutate(end_date = as.Date(ifelse(is.na(end_date), "2024-11-13", as.character(end_date)))) %>% 
  mutate(trial_length_days = as.numeric(end_date - start_date)) %>% 
  select(trial_id, status, start_date, end_date, country, trial_length_days, industry_dummy, nct_id, eudract_id) %>% 
  mutate(across(everything(), ~ replace_na(., "")))



# Define zombie trials with first method
p2trial_length_unique_trial_id_days %>% 
  filter(industry_dummy == 1) %>% 
  filter(status != "ongoing") %>% summary() # Find that 75% percentile is 1277 for finished trials
phase_2_zombie_75percent = p2trial_length_unique_trial_id_days %>% 
  filter(status == "ongoing") %>% 
  mutate(phase_2_zombie_75percent = ifelse(trial_length_days > 1277, 1, 0)) %>% 
  select(trial_id, phase_2_zombie_75percent)

# Define zombie trials with second method
p2trial_length_unique_trial_id_days %>% 
  filter(status == "ongoing") %>% summary() # find outliar cutoff = 2177 + 1.5*(2177-603) = 4538
phase_2_zombie_outliar = p2trial_length_unique_trial_id_days %>% 
  filter(status == "ongoing") %>% 
  mutate(phase_2_zombie_outliar = ifelse(trial_length_days > 4538, 1, 0)) %>% 
  select(trial_id, phase_2_zombie_outliar)


# Merge the zombie trials obtained with both methods into trial_firm_detail_3
trial_firm_detail_3 = trial_firm_detail_3 %>% 
  left_join(phase_2_zombie_75percent) %>% 
  left_join(phase_2_zombie_outliar) %>% 
  select(-start_date, -end_date) %>% 
  mutate(sponsor_id = ifelse(is.na(sponsor_id), "", sponsor_id)) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

# 443403
```

   
#### Consturct firm_year_dataset

  Construct the firm_year_dataset from trial_firm_detail sponsor-year panel

```{r}
# Create variable year, which spans from founded year to 2024 for each company
firm_year_dataset_1 = trial_firm_detail_3 %>% 
  distinct(sponsor_id, sponsor_found_year, .keep_all = TRUE) %>% 
  select(sponsor_id, sponsor_name, sponsor_found_year, industry_dummy) %>% 
  rowwise() %>%
  mutate(year = list(seq(sponsor_found_year, 2024))) %>%
  unnest(year) %>% 
  select(-sponsor_found_year) %>% 
  mutate(year = as.character(year))

# Note that some companies share different names but have the same sponsor_id, we want to make sure all sponsor_id year combination is unique
firm_year_dataset_1 = firm_year_dataset_1 %>% distinct(sponsor_id, year, .keep_all = TRUE) %>% arrange(sponsor_id, year)

# 319741
```

##### Add trial counts for each start/end year and phase

  For each phase, create phase_x_start, phase_x_start_eu, phase_x_start_us, phase_x_start_others, which covers overall and regional start information. As for end date, create phase_x_enddate_comp, phase_x_enddate_term, phase_x_startdate_comp, phase_x_startdate_term, pointing out the end date and the start date of complete/terminated trials.
  
  This would create 8 column per trials, total 32 columnd.

```{r}
# phase 1 start, start_eu, start_us, start_others, complete, terminate
phase_1_start = trial_firm_detail_3 %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_1_start = n(), .groups = 'drop') 
phase_1_start_eu = trial_firm_detail_3 %>% 
  filter(region == "EU") %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_1_start_eu = n(), .groups = 'drop')
phase_1_start_us = trial_firm_detail_3 %>% 
  filter(region == "US") %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_1_start_us = n(), .groups = 'drop')
phase_1_start_others = trial_firm_detail_3 %>% 
  filter(region == "Others") %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_1_start_others = n(), .groups = 'drop')
phase_1_enddate_comp = trial_firm_detail_3 %>% 
  filter(status == "completed") %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_1_enddate_comp = n(), .groups = 'drop') 
phase_1_enddate_term = trial_firm_detail_3 %>% 
  filter(status == "terminated") %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_1_enddate_term = n(), .groups = 'drop') 
phase_1_startdate_comp = trial_firm_detail_3 %>% 
  filter(status == "completed") %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_1_startdate_comp = n(), .groups = 'drop') 
phase_1_startdate_term = trial_firm_detail_3 %>% 
  filter(status == "terminated") %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_1_startdate_term = n(), .groups = 'drop') 


# phase 2 start, start_eu, start_us, start_others, complete, terminate
phase_2_start = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_start = n(), .groups = 'drop') 
phase_2_start_eu = trial_firm_detail_3 %>% 
  filter(region == "EU") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_start_eu = n(), .groups = 'drop')
phase_2_start_us = trial_firm_detail_3 %>% 
  filter(region == "US") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_start_us = n(), .groups = 'drop')
phase_2_start_others = trial_firm_detail_3 %>% 
  filter(region == "Others") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_start_others = n(), .groups = 'drop')
phase_2_enddate_comp = trial_firm_detail_3 %>% 
  filter(status == "completed") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_2_enddate_comp = n(), .groups = 'drop') 
phase_2_enddate_term = trial_firm_detail_3 %>% 
  filter(status == "terminated") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_2_enddate_term = n(), .groups = 'drop') 
phase_2_startdate_comp = trial_firm_detail_3 %>% 
  filter(status == "completed") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_startdate_comp = n(), .groups = 'drop') 
phase_2_startdate_term = trial_firm_detail_3 %>% 
  filter(status == "terminated") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_startdate_term = n(), .groups = 'drop') 


# phase 3 start, start_eu, start_us, start_others, complete, terminate
phase_3_start = trial_firm_detail_3 %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_3_start = n(), .groups = 'drop') 
phase_3_start_eu = trial_firm_detail_3 %>% 
  filter(region == "EU") %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_3_start_eu = n(), .groups = 'drop')
phase_3_start_us = trial_firm_detail_3 %>% 
  filter(region == "US") %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_3_start_us = n(), .groups = 'drop')
phase_3_start_others = trial_firm_detail_3 %>% 
  filter(region == "Others") %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_3_start_others = n(), .groups = 'drop')
phase_3_enddate_comp = trial_firm_detail_3 %>% 
  filter(status == "completed") %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_3_enddate_comp = n(), .groups = 'drop') 
phase_3_enddate_term = trial_firm_detail_3 %>% 
  filter(status == "terminated") %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_3_enddate_term = n(), .groups = 'drop') 
phase_3_startdate_comp = trial_firm_detail_3 %>% 
  filter(status == "completed") %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_3_startdate_comp = n(), .groups = 'drop') 
phase_3_startdate_term = trial_firm_detail_3 %>% 
  filter(status == "terminated") %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_3_startdate_term = n(), .groups = 'drop') 


# phase 4 start, start_eu, start_us, start_others, complete, terminate
phase_4_start = trial_firm_detail_3 %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_4_start = n(), .groups = 'drop') 
phase_4_start_eu = trial_firm_detail_3 %>% 
  filter(region == "EU") %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_4_start_eu = n(), .groups = 'drop')
phase_4_start_us = trial_firm_detail_3 %>% 
  filter(region == "US") %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_4_start_us = n(), .groups = 'drop')
phase_4_start_others = trial_firm_detail_3 %>% 
  filter(region == "Others") %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_4_start_others = n(), .groups = 'drop')
phase_4_enddate_comp = trial_firm_detail_3 %>% 
  filter(status == "completed") %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_4_enddate_comp = n(), .groups = 'drop') 
phase_4_enddate_term = trial_firm_detail_3 %>% 
  filter(status == "terminated") %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_4_enddate_term = n(), .groups = 'drop') 
phase_4_startdate_comp = trial_firm_detail_3 %>% 
  filter(status == "completed") %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_4_startdate_comp = n(), .groups = 'drop') 
phase_4_startdate_term = trial_firm_detail_3 %>% 
  filter(status == "terminated") %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_4_startdate_term = n(), .groups = 'drop') 

firm_year_dataset_2 = firm_year_dataset_1 %>% 
  left_join(phase_1_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_1_start_eu, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_1_start_us, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_1_start_others, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_1_enddate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_1_enddate_term, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_1_startdate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_1_startdate_term, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_eu, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_us, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_others, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_enddate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_2_enddate_term, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_2_startdate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_startdate_term, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_3_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_3_start_eu, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_3_start_us, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_3_start_others, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_3_enddate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_3_enddate_term, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_3_startdate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_3_startdate_term, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_4_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>%
  left_join(phase_4_start_eu, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_4_start_us, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_4_start_others, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_4_enddate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_4_enddate_term, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_4_startdate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_4_startdate_term, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

# 319741
```


##### Add EU exposure variables

any_eu_pre_2016: coded as 1 if a company has at least 1 trial in GDPR affected countries (EU countries) before 2016
eu_porp_pre_2016: the proportion of a company's trial that took place in EU before 2018
above_median_eu_pre_2016: coded as 1 if eu_porp_pre_2016 is above median

any_eu_pre_2018: Same as any_eu_pre_2016 but 2018 instead
eu_porp_pre_2018: Same as eu_porp_pre_2016 but 2018 instead
above_median_eu_pre_2018: Same as above_median_eu_pre_2016 but 2018 instead

Also, We want to create the separated counts of all 6 categories for each phases as well, total 6*5=30 new variables

Note: We have missing values for country

```{r}
# Add the column any_eu_pre_2016 and above_median_eu_pre_2016 to firm_year_dataset_2
eu_countries = c("Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", "Czech Republic", "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", "Ireland", "Italy", "Latvia", "Lithuania", "Luxembourg", "Malta", "Netherlands", "Poland", "Portugal", "Romania", "Slovakia", "Slovenia", "Spain", "Sweden", "United Kingdom")   # Should we include UK since UK is in EU before 2016

# 2016 cutoff
# All phases
eu_expose_pre_2016 = trial_firm_detail_3 %>% 
  filter(start_year < "2016") %>% 
  mutate(any_eu_pre_2016 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2016 = round(mean(any_eu_pre_2016), 3), # calculate proportion of eu trials
            any_eu_pre_2016 = max(any_eu_pre_2016)) # 1 if any trial is in EU
eu_prop_median_pre_2016 = median(eu_expose_pre_2016$eu_porp_pre_2016) # Calculate the median of EU proportion, 0.864
eu_expose_pre_2016 = eu_expose_pre_2016 %>% 
  mutate(above_median_eu_pre_2016 = ifelse(eu_porp_pre_2016>eu_prop_median_pre_2016, 1, 0)) # 1 if EU proportion > median

# Phase 1
eu_expose_pre_2016_p1 = trial_firm_detail_3 %>% 
  filter(phase_1 == 1) %>% 
  filter(start_year < "2016") %>% 
  mutate(any_eu_pre_2016_p1 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2016_p1 = round(mean(any_eu_pre_2016_p1), 3), 
            any_eu_pre_2016_p1 = max(any_eu_pre_2016_p1)) 
eu_prop_median_pre_2016_p1 = median(eu_expose_pre_2016_p1$eu_porp_pre_2016_p1) # eu_prop_median_pre_2016_p1 = 0
eu_expose_pre_2016_p1 = eu_expose_pre_2016_p1 %>% 
  mutate(above_median_eu_pre_2016_p1 = ifelse(eu_porp_pre_2016_p1>eu_prop_median_pre_2016_p1, 1, 0)) 

# Phase 2
eu_expose_pre_2016_p2 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(start_year < "2016") %>% 
  mutate(any_eu_pre_2016_p2 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2016_p2 = round(mean(any_eu_pre_2016_p2), 3), 
            any_eu_pre_2016_p2 = max(any_eu_pre_2016_p2)) 
eu_prop_median_pre_2016_p2 = median(eu_expose_pre_2016_p2$eu_porp_pre_2016_p2) # eu_prop_median_pre_2016_p2 = 0.6
eu_expose_pre_2016_p2 = eu_expose_pre_2016_p2 %>% 
  mutate(above_median_eu_pre_2016_p2 = ifelse(eu_porp_pre_2016_p2>eu_prop_median_pre_2016_p2, 1, 0)) 

# Phase 3
eu_expose_pre_2016_p3 = trial_firm_detail_3 %>% 
  filter(phase_3 == 1) %>% 
  filter(start_year < "2016") %>% 
  mutate(any_eu_pre_2016_p3 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2016_p3 = round(mean(any_eu_pre_2016_p3), 3), 
            any_eu_pre_2016_p3 = max(any_eu_pre_2016_p3)) 
eu_prop_median_pre_2016_p3 = median(eu_expose_pre_2016_p3$eu_porp_pre_2016_p3) # eu_prop_median_pre_2016_p3 = 0.936
eu_expose_pre_2016_p3 = eu_expose_pre_2016_p3 %>% 
  mutate(above_median_eu_pre_2016_p3 = ifelse(eu_porp_pre_2016_p3>eu_prop_median_pre_2016_p3, 1, 0)) 

# Phase 4
eu_expose_pre_2016_p4 = trial_firm_detail_3 %>% 
  filter(phase_4 == 1) %>% 
  filter(start_year < "2016") %>% 
  mutate(any_eu_pre_2016_p4 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2016_p4 = round(mean(any_eu_pre_2016_p4), 3), 
            any_eu_pre_2016_p4 = max(any_eu_pre_2016_p4)) 
eu_prop_median_pre_2016_p4 = median(eu_expose_pre_2016_p4$eu_porp_pre_2016_p4) # eu_prop_median_pre_2016_p2 = 1
eu_expose_pre_2016_p4 = eu_expose_pre_2016_p4 %>% 
  mutate(above_median_eu_pre_2016_p4 = ifelse(eu_porp_pre_2016_p4>eu_prop_median_pre_2016_p4, 1, 0)) 




# 2018 cutoff
# All phases
eu_expose_pre_2018 = trial_firm_detail_3 %>% 
  filter(start_year < "2018") %>% 
  mutate(any_eu_pre_2018 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2018 = round(mean(any_eu_pre_2018), 3), # calculate proportion of eu trials
            any_eu_pre_2018 = max(any_eu_pre_2018)) # 1 if any trial is in EU
eu_prop_median_pre_2018 = median(eu_expose_pre_2018$eu_porp_pre_2018) # Calculate the median of EU proportion, 0.778
eu_expose_pre_2018 = eu_expose_pre_2018 %>% 
  mutate(above_median_eu_pre_2018 = ifelse(eu_porp_pre_2018>eu_prop_median_pre_2018, 1, 0)) # 1 if EU proportion > median

# Phase 1
eu_expose_pre_2018_p1 = trial_firm_detail_3 %>% 
  filter(phase_1 == 1) %>% 
  filter(start_year < "2018") %>% 
  mutate(any_eu_pre_2018_p1 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2018_p1 = round(mean(any_eu_pre_2018_p1), 3), 
            any_eu_pre_2018_p1 = max(any_eu_pre_2018_p1)) 
eu_prop_median_pre_2018_p1 = median(eu_expose_pre_2018_p1$eu_porp_pre_2018_p1) # eu_prop_median_pre_2018_p1 = 0
eu_expose_pre_2018_p1 = eu_expose_pre_2018_p1 %>% 
  mutate(above_median_eu_pre_2018_p1 = ifelse(eu_porp_pre_2018_p1>eu_prop_median_pre_2018_p1, 1, 0)) 

# Phase 2
eu_expose_pre_2018_p2 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(start_year < "2018") %>% 
  mutate(any_eu_pre_2018_p2 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2018_p2 = round(mean(any_eu_pre_2018_p2), 3), 
            any_eu_pre_2018_p2 = max(any_eu_pre_2018_p2)) 
eu_prop_median_pre_2018_p2 = median(eu_expose_pre_2018_p2$eu_porp_pre_2018_p2) # eu_prop_median_pre_2018_p2 = 0.4
eu_expose_pre_2018_p2 = eu_expose_pre_2018_p2 %>% 
  mutate(above_median_eu_pre_2018_p2 = ifelse(eu_porp_pre_2018_p2>eu_prop_median_pre_2018_p2, 1, 0)) 

# Phase 3
eu_expose_pre_2018_p3 = trial_firm_detail_3 %>% 
  filter(phase_3 == 1) %>% 
  filter(start_year < "2018") %>% 
  mutate(any_eu_pre_2018_p3 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2018_p3 = round(mean(any_eu_pre_2018_p3), 3), 
            any_eu_pre_2018_p3 = max(any_eu_pre_2018_p3)) 
eu_prop_median_pre_2018_p3 = median(eu_expose_pre_2018_p3$eu_porp_pre_2018_p3) # eu_prop_median_pre_2018_p3 = 0.875
eu_expose_pre_2018_p3 = eu_expose_pre_2018_p3 %>% 
  mutate(above_median_eu_pre_2018_p3 = ifelse(eu_porp_pre_2018_p3>eu_prop_median_pre_2018_p3, 1, 0)) 

# Phase 4
eu_expose_pre_2018_p4 = trial_firm_detail_3 %>% 
  filter(phase_4 == 1) %>% 
  filter(start_year < "2018") %>% 
  mutate(any_eu_pre_2018_p4 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2018_p4 = round(mean(any_eu_pre_2018_p4), 3), 
            any_eu_pre_2018_p4 = max(any_eu_pre_2018_p4)) 
eu_prop_median_pre_2018_p4 = median(eu_expose_pre_2018_p4$eu_porp_pre_2018_p4) # eu_prop_median_pre_2018_p2 = 1
eu_expose_pre_2018_p4 = eu_expose_pre_2018_p4 %>% 
  mutate(above_median_eu_pre_2018_p4 = ifelse(eu_porp_pre_2018_p4>eu_prop_median_pre_2018_p4, 1, 0)) 



# Combine all 30 columns
firm_year_dataset_3 = firm_year_dataset_2 %>% 
  left_join(eu_expose_pre_2016, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2016_p1, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2016_p2, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2016_p3, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2016_p4, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2018, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2018_p1, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2018_p2, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2018_p3, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2018_p4, by = "sponsor_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0))) # Notice companies founded after 2016 will have NA values

# 319741

# Use this code to obtain exposure on company level, independent of time
firm_year_dataset_3 %>% distinct(sponsor_id, .keep_all = TRUE) %>% 
  select(sponsor_id, sponsor_name, any_eu_pre_2016, above_median_eu_pre_2016)
```

##### Add patient counts

  We also want to assess the patient numbers in each sector of measures. We want to include the following combination: (starting/ending)x(mean)x(all_regions/us/eu/others)x(all_phases/phase1/phase2/phase3/phase4) + (starting/ending)x(min/max/median)x(all_regions)x(all_phases)
  Totaling with 46 new columns

```{r}
# Only consider trials with a valid patient count number
trial_firm_detail_valid_patient = trial_firm_detail_3 %>% 
  filter(patient_num != "") %>% 
  mutate(patient_num = as.numeric(patient_num))


# Obtain the (mean/min/max/median) of (starting/ending)*(all_regions)*(all_phases)
patient_stat_starting_allregion_allphases = trial_firm_detail_valid_patient %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(patient_avg_start_all = mean(patient_num),
            patient_min_start_all = min(patient_num),
            patient_max_start_all = max(patient_num),
            patient_med_start_all = median(patient_num))
patient_stat_ending_allregion_allphases = trial_firm_detail_valid_patient %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(patient_avg_end_all = mean(patient_num),
            patient_min_end_all = min(patient_num),
            patient_max_end_all = max(patient_num),
            patient_med_end_all = median(patient_num))


# Obtain the mean of (starting/ending)*(all_regions)*(phase1/phase2/phase3/phase4)
patient_mean_starting_allregion_phase1 = trial_firm_detail_valid_patient %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(patient_avg_start_allregion_p1 = mean(patient_num))
patient_mean_starting_allregion_phase2 = trial_firm_detail_valid_patient %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(patient_avg_start_allregion_p2 = mean(patient_num))
patient_mean_starting_allregion_phase3 = trial_firm_detail_valid_patient %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(patient_avg_start_allregion_p3 = mean(patient_num))
patient_mean_starting_allregion_phase4 = trial_firm_detail_valid_patient %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(patient_avg_start_allregion_p4 = mean(patient_num))

patient_mean_ending_allregion_phase1 = trial_firm_detail_valid_patient %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(patient_avg_end_allregion_p1 = mean(patient_num))
patient_mean_ending_allregion_phase2 = trial_firm_detail_valid_patient %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(patient_avg_end_allregion_p2 = mean(patient_num))
patient_mean_ending_allregion_phase3 = trial_firm_detail_valid_patient %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(patient_avg_end_allregion_p3 = mean(patient_num))
patient_mean_ending_allregion_phase4 = trial_firm_detail_valid_patient %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(patient_avg_end_allregion_p4 = mean(patient_num))


# Obtain the mean of (starting/ending)*(us/eu/others)*(all_phases)
patient_mean_starting_us.eu.others_allphases = trial_firm_detail_valid_patient %>% 
  group_by(sponsor_id, start_year, region) %>% 
  summarize(patient_avg_start_us_allphases = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_start_eu_allphases = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_start_others_allphases = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(
    patient_avg_start_us_allphases = ifelse(any(!is.na(patient_avg_start_us_allphases)),
                                                first(na.omit(patient_avg_start_us_allphases)), NaN),
    patient_avg_start_eu_allphases = ifelse(any(!is.na(patient_avg_start_eu_allphases)),
                                                first(na.omit(patient_avg_start_eu_allphases)), NaN),
    patient_avg_start_others_allphases = ifelse(any(!is.na(patient_avg_start_others_allphases)),
                                                    first(na.omit(patient_avg_start_others_allphases)), NaN)
    )
patient_mean_ending_us.eu.others_allphases = trial_firm_detail_valid_patient %>% 
  group_by(sponsor_id, end_year, region) %>% 
  summarize(patient_avg_end_us_allphases = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_end_eu_allphases = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_end_others_allphases = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(
    patient_avg_end_us_allphases = ifelse(any(!is.na(patient_avg_end_us_allphases)),
                                                first(na.omit(patient_avg_end_us_allphases)), NaN),
    patient_avg_end_eu_allphases = ifelse(any(!is.na(patient_avg_end_eu_allphases)),
                                                first(na.omit(patient_avg_end_eu_allphases)), NaN),
    patient_avg_end_others_allphases = ifelse(any(!is.na(patient_avg_end_others_allphases)),
                                                    first(na.omit(patient_avg_end_others_allphases)), NaN)
    )


# Obtain the mean of (starting/ending)*(us/eu/others)*(phase1)
patient_mean_starting_us.eu.others_phase1 = trial_firm_detail_valid_patient %>%
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, start_year, region) %>% 
  summarize(patient_avg_start_us_p1 = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_start_eu_p1 = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_start_others_p1 = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(
    patient_avg_start_us_p1 = ifelse(any(!is.na(patient_avg_start_us_p1)),
                                                first(na.omit(patient_avg_start_us_p1)), NaN),
    patient_avg_start_eu_p1 = ifelse(any(!is.na(patient_avg_start_eu_p1)),
                                                first(na.omit(patient_avg_start_eu_p1)), NaN),
    patient_avg_start_others_p1 = ifelse(any(!is.na(patient_avg_start_others_p1)),
                                                    first(na.omit(patient_avg_start_others_p1)), NaN)
    )
patient_mean_ending_us.eu.others_phase1 = trial_firm_detail_valid_patient %>%
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, end_year, region) %>% 
  summarize(patient_avg_end_us_p1 = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_end_eu_p1 = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_end_others_p1 = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(
    patient_avg_end_us_p1 = ifelse(any(!is.na(patient_avg_end_us_p1)),
                                                first(na.omit(patient_avg_end_us_p1)), NaN),
    patient_avg_end_eu_p1 = ifelse(any(!is.na(patient_avg_end_eu_p1)),
                                                first(na.omit(patient_avg_end_eu_p1)), NaN),
    patient_avg_end_others_p1 = ifelse(any(!is.na(patient_avg_end_others_p1)),
                                                    first(na.omit(patient_avg_end_others_p1)), NaN)
    )


# Obtain the mean of (starting/ending)*(us/eu/others)*(phase2)
patient_mean_starting_us.eu.others_phase2 = trial_firm_detail_valid_patient %>%
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year, region) %>% 
  summarize(patient_avg_start_us_p2 = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_start_eu_p2 = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_start_others_p2 = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(
    patient_avg_start_us_p2 = ifelse(any(!is.na(patient_avg_start_us_p2)),
                                                first(na.omit(patient_avg_start_us_p2)), NaN),
    patient_avg_start_eu_p2 = ifelse(any(!is.na(patient_avg_start_eu_p2)),
                                                first(na.omit(patient_avg_start_eu_p2)), NaN),
    patient_avg_start_others_p2 = ifelse(any(!is.na(patient_avg_start_others_p2)),
                                                    first(na.omit(patient_avg_start_others_p2)), NaN)
    )
patient_mean_ending_us.eu.others_phase2 = trial_firm_detail_valid_patient %>%
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, end_year, region) %>% 
  summarize(patient_avg_end_us_p2 = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_end_eu_p2 = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_end_others_p2 = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(
    patient_avg_end_us_p2 = ifelse(any(!is.na(patient_avg_end_us_p2)),
                                                first(na.omit(patient_avg_end_us_p2)), NaN),
    patient_avg_end_eu_p2 = ifelse(any(!is.na(patient_avg_end_eu_p2)),
                                                first(na.omit(patient_avg_end_eu_p2)), NaN),
    patient_avg_end_others_p2 = ifelse(any(!is.na(patient_avg_end_others_p2)),
                                                    first(na.omit(patient_avg_end_others_p2)), NaN)
    )


# Obtain the mean of (starting/ending)*(us/eu/others)*(phase3)
patient_mean_starting_us.eu.others_phase3 = trial_firm_detail_valid_patient %>%
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, start_year, region) %>% 
  summarize(patient_avg_start_us_p3 = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_start_eu_p3 = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_start_others_p3 = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(
    patient_avg_start_us_p3 = ifelse(any(!is.na(patient_avg_start_us_p3)),
                                                first(na.omit(patient_avg_start_us_p3)), NaN),
    patient_avg_start_eu_p3 = ifelse(any(!is.na(patient_avg_start_eu_p3)),
                                                first(na.omit(patient_avg_start_eu_p3)), NaN),
    patient_avg_start_others_p3 = ifelse(any(!is.na(patient_avg_start_others_p3)),
                                                    first(na.omit(patient_avg_start_others_p3)), NaN)
    )
patient_mean_ending_us.eu.others_phase3 = trial_firm_detail_valid_patient %>%
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, end_year, region) %>% 
  summarize(patient_avg_end_us_p3 = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_end_eu_p3 = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_end_others_p3 = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(
    patient_avg_end_us_p3 = ifelse(any(!is.na(patient_avg_end_us_p3)),
                                                first(na.omit(patient_avg_end_us_p3)), NaN),
    patient_avg_end_eu_p3 = ifelse(any(!is.na(patient_avg_end_eu_p3)),
                                                first(na.omit(patient_avg_end_eu_p3)), NaN),
    patient_avg_end_others_p3 = ifelse(any(!is.na(patient_avg_end_others_p3)),
                                                    first(na.omit(patient_avg_end_others_p3)), NaN)
    )


# Obtain the mean of (starting/ending)*(us/eu/others)*(phase4)
patient_mean_starting_us.eu.others_phase4 = trial_firm_detail_valid_patient %>%
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, start_year, region) %>% 
  summarize(patient_avg_start_us_p4 = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_start_eu_p4 = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_start_others_p4 = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(
    patient_avg_start_us_p4 = ifelse(any(!is.na(patient_avg_start_us_p4)),
                                                first(na.omit(patient_avg_start_us_p4)), NaN),
    patient_avg_start_eu_p4 = ifelse(any(!is.na(patient_avg_start_eu_p4)),
                                                first(na.omit(patient_avg_start_eu_p4)), NaN),
    patient_avg_start_others_p4 = ifelse(any(!is.na(patient_avg_start_others_p4)),
                                                    first(na.omit(patient_avg_start_others_p4)), NaN)
    )
patient_mean_ending_us.eu.others_phase4 = trial_firm_detail_valid_patient %>%
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, end_year, region) %>% 
  summarize(patient_avg_end_us_p4 = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_end_eu_p4 = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_end_others_p4 = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(
    patient_avg_end_us_p4 = ifelse(any(!is.na(patient_avg_end_us_p4)),
                                                first(na.omit(patient_avg_end_us_p4)), NaN),
    patient_avg_end_eu_p4 = ifelse(any(!is.na(patient_avg_end_eu_p4)),
                                                first(na.omit(patient_avg_end_eu_p4)), NaN),
    patient_avg_end_others_p4 = ifelse(any(!is.na(patient_avg_end_others_p4)),
                                                    first(na.omit(patient_avg_end_others_p4)), NaN)
    )


# Add all 46 columns
firm_year_dataset_4 = firm_year_dataset_3 %>% 
  left_join(patient_stat_starting_allregion_allphases, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_stat_ending_allregion_allphases, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_starting_allregion_phase1, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_starting_allregion_phase2, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_starting_allregion_phase3, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_starting_allregion_phase4, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_ending_allregion_phase1, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_ending_allregion_phase2, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_ending_allregion_phase3, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_ending_allregion_phase4, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_starting_us.eu.others_allphases, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_ending_us.eu.others_allphases, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_starting_us.eu.others_phase1, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_ending_us.eu.others_phase1, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_starting_us.eu.others_phase2, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_ending_us.eu.others_phase2, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_starting_us.eu.others_phase3, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_ending_us.eu.others_phase3, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_starting_us.eu.others_phase4, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_ending_us.eu.others_phase4, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

# 319741
firm_year_dataset_4 %>% select(sponsor_name, sponsor_id, year, phase_2_start) %>% arrange(desc(phase_2_start))
```

##### Add detailed variables for phase_2_start_eu, phase_2_start_eu_abs, phase2_start_aact, phase_2_start_zombie_75percent, phase_2_start_zombie_outliar

```{r}
# Create phase_2_start_everyEUcountries
phase_2_start_everyEUcountries = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(region == "EU") %>% 
  group_by(sponsor_id, start_year, country) %>% 
  count() %>% 
  mutate(variable_name = paste("phase_2_start", country, sep = "_")) %>%
  select(start_year, variable_name, n) %>%
  pivot_wider(names_from = variable_name, values_from = n, values_fill = 0) %>% 
  ungroup() %>% 
  select(-country) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(across(starts_with("phase_2_start"), sum)) %>% 
  ungroup()

# Create phase_2_start_eu_abs, which counts the unique nct_id for every trial in eu
phase_2_start_eu_abs = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(region == "EU") %>% 
  distinct(across(-c(country, trial_id))) %>% 
  group_by(sponsor_id, start_year) %>% 
  count() %>% 
  rename(phase_2_start_eu_abs = n) %>% 
  ungroup()

# Create phase2_start_aact, which counts the trials from the aact dataset
phase2_start_aact = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(source == "AACT") %>% 
  group_by(sponsor_id, start_year) %>% 
  count() %>% 
  rename(phase2_start_aact = n) %>% 
  ungroup()

# Create phase_2_start_zombie_75percent and phase_2_start_zombie_outliar
phase_2_start_zombie_75percent = trial_firm_detail_3 %>% 
  filter(phase_2_zombie_75percent == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  count() %>% 
  rename(phase_2_start_zombie_75percent = n) %>% 
  ungroup()
# Create phase_2_start_zombie_outliar and phase_2_start_zombie_outliar
phase_2_start_zombie_outliar = trial_firm_detail_3 %>% 
  filter(phase_2_zombie_outliar == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  count() %>% 
  rename(phase_2_start_zombie_outliar = n) %>% 
  ungroup()



firm_year_dataset_5 = firm_year_dataset_4 %>% 
  left_join(phase_2_start_everyEUcountries, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_eu_abs, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase2_start_aact, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_zombie_75percent, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_zombie_outliar, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

# 319741
```

##### Add type 2 for phase_2_startdate_comp, phase_2_enddate_comp, phase_2_startdate_term, phase_2_enddate_term

Note that we're investigating the effect of implementation of GDPR, which took place in 2018. We define three types of trials:

  type 1. start before GDPR, end before GDPR
  type 2. start before GDPR, end after GDPR
  type 3. start after GDPR, end after GDPR
  
We want to single out the type 2 trials, so we want to create phase_2_startdate_comp_type2, phase_2_enddate_comp_type2, phase_2_startdate_term_type2, phase_2_enddate_term_type2

###### Note: no exact date for trials, only years, and GDPR was implemented in May 2018

```{r}
# Create phase_2_startdate_comp_type2, phase_2_enddate_comp_type2, phase_2_startdate_term_type2, phase_2_enddate_term_type2
phase_2_term_comp_type2 = trial_firm_detail_3 %>% 
  mutate(end_year = ifelse(end_year == "", "2024", end_year)) %>% 
  mutate(type = case_when(
    start_year < 2018 & end_year <= 2018 ~ "1",
    start_year <= 2018 & end_year >= 2018 ~ "2",
    start_year >= 2018 & end_year > 2018 ~ "3",
  )) %>% 
  filter(phase_2 == 1) %>% 
  filter(type == 2) %>% 
  filter(status %in% c("terminated", "completed")) %>% 
  select(sponsor_id, start_year, end_year, status, type)


phase_2_startdate_comp_type2 = phase_2_term_comp_type2 %>% 
  filter(status == "completed") %>% 
  group_by(sponsor_id, start_year) %>% 
  count() %>% 
  rename(phase_2_startdate_comp_type2 = n)

phase_2_enddate_comp_type2 = phase_2_term_comp_type2 %>% 
  filter(status == "completed") %>% 
  group_by(sponsor_id, end_year) %>% 
  count() %>% 
  rename(phase_2_enddate_comp_type2 = n)

phase_2_startdate_term_type2 = phase_2_term_comp_type2 %>% 
  filter(status == "terminated") %>% 
  group_by(sponsor_id, start_year) %>% 
  count() %>% 
  rename(phase_2_startdate_term_type2 = n)

phase_2_enddate_term_type2 = phase_2_term_comp_type2 %>% 
  filter(status == "terminated") %>% 
  group_by(sponsor_id, end_year) %>% 
  count() %>% 
  rename(phase_2_enddate_term_type2 = n)

# Left join these four columns and created the excluded type 2 column, total of 8 new columns
firm_year_dataset_6 = firm_year_dataset_5 %>% 
  left_join(phase_2_startdate_comp_type2, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  mutate(phase_2_startdate_comp_type2ex = phase_2_startdate_comp - phase_2_startdate_comp_type2) %>% 
  left_join(phase_2_enddate_comp_type2, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  mutate(phase_2_enddate_comp_type2ex = phase_2_enddate_comp - phase_2_enddate_comp_type2) %>% 
  left_join(phase_2_startdate_term_type2, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  mutate(phase_2_startdate_term_type2ex = phase_2_startdate_term - phase_2_startdate_term_type2) %>% 
  left_join(phase_2_enddate_term_type2, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  mutate(phase_2_enddate_term_type2ex = phase_2_enddate_term - phase_2_enddate_term_type2)

# 319741
```

##### Add variable phase_2_active, phase_2_active_zombie_75percent, phase_2_active_zombie_outliar, phase_2_comp_rate and phase_2_term_rate 

  This variable is at the sponsor year level, with a percentage value denoting the percentage of completed/terminated trials of all phase 2 trials per sponsor per year. Note that we will add a phase_2_active to keep track of the active phase 2 trials per year.
  

```{r}
# Create phase_2_active, phase_2_comp_rate, and phase_2_term_rate
phase_2_active_zombie_comp_term_rate = firm_year_dataset_6 %>%
  select(sponsor_id, year, phase_2_start, phase_2_start_zombie_75percent, phase_2_start_zombie_outliar, phase_2_enddate_comp, phase_2_enddate_term) %>% 
  arrange(sponsor_id, year) %>% 
  group_by(sponsor_id) %>% 
  mutate(
    # Calculate cumulative starts up to the current year
    cum_phase_2_start = cumsum(phase_2_start), 
    # Calculate cumulative ends up to the previous year
    cum_phase_2_end_prev = lag(cumsum(phase_2_enddate_comp + phase_2_enddate_term), default = 0), 
    # Calculate phase_2_active as the difference
    phase_2_active = cum_phase_2_start - cum_phase_2_end_prev,
    # Calculate avtive zombies up to the current year
    phase_2_active_zombie_75percent = cumsum(phase_2_start_zombie_75percent),
    phase_2_active_zombie_outliar = cumsum(phase_2_start_zombie_outliar),
    # Create phase_2_comp_rate and phase_2_term_rate
    #phase_2_comp_rate = phase_2_enddate_comp/phase_2_active,
    #phase_2_term_rate = phase_2_enddate_term/phase_2_active
  ) %>% 
  select(sponsor_id, year, phase_2_active, phase_2_active_zombie_75percent, phase_2_active_zombie_outliar) 

firm_year_dataset_7 = firm_year_dataset_6 %>% 
  left_join(phase_2_active_zombie_comp_term_rate, by = c("sponsor_id", "year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

# 319741
```

##### Add phase_2_startdate_trans_rate and phase_2_enddate_trans_rate
###### Note: Use drug name to improve this, go back to raw dataset and add drug name and parrell experiment (for next task)

 Few condition to match the transition of phase 2 to phase 3:
 
  - The phase 2 trial and phase 3 trial has to share the same sponsor_id, country, disease_id, source. (omit rows missing disease_id, 11.3%, keep rows with missing values for country)
  - The phase 2 trial must be ended (completed or terminated).
  - The end_year of the phase 2 trial must be earlier or equal to the start_year of the phase 3 trial.
  
 Note: For trials labels as phase2/3, we classify them as phase 3 earlier.

```{r}
# Create phase_2_transitioned, denoting a list of phase 2 trials that successfully transitioned into phase 3
phase_2_transitioned = trial_firm_detail_3 %>%
  filter(disease_id != "") %>% # Use only trials with valid disease_id to increase matching accuracy
  filter(phase_2 == 1 & status != "ongoing") %>%
  select(sponsor_id, country, disease_id, source, phase_2, trial_id, start_year, end_year) %>% 
  left_join(trial_firm_detail_3 %>%
              filter(phase_3 == 1) %>%
              select(sponsor_id, country, disease_id, source, phase_3, trial_id, start_year, end_year), 
            by = c("sponsor_id", "country", "disease_id", "source")) %>% # Join with phase 3 trials on the same identifiers
  na.omit() %>% # Only look at those units having both trial 
  filter(end_year.x <= start_year.y) %>% # Filter where the end_year of Phase 2 is <= start_year of Phase 3
  arrange(trial_id.y, start_year.y) %>% # Arrange start_year.y in increasing order so the first of the many phase 3 trials mapped to the same phase 2 has the earliest start date, which is closest to the end_date of such phase 2 trial
  distinct(trial_id.x, .keep_all = TRUE) %>% # Select unique trial_id.x to get rid of one-to-many relationship
  arrange(trial_id.y, desc(end_year.x)) %>% # Arrange end_year.x in descending order so the first of the many phase 2 trials mapped to the same phase 3 has the latest end date, which is closest to the start_date of such phase 3 trial
  distinct(trial_id.y, .keep_all = TRUE) %>%   # Select unique trial_id.y to get rid of many-to-one relationship
  select(sponsor_id, start_year = start_year.x, end_year = end_year.x)

phase_2_startdate_trans = phase_2_transitioned %>% 
  group_by(sponsor_id, start_year) %>% 
  count() %>% 
  rename(phase_2_startdate_trans = n)
  
phase_2_enddate_trans = phase_2_transitioned %>% 
  group_by(sponsor_id, end_year) %>% 
  count() %>% 
  rename(phase_2_enddate_trans = n)


# Create phase_2_startdate_trans_rate and phase_2_enddate_trans_rate
firm_year_dataset_8 = firm_year_dataset_7 %>% 
  left_join(phase_2_startdate_trans, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(phase_2_startdate_trans_rate = phase_2_startdate_trans/phase_2_start) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  left_join(phase_2_enddate_trans, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  mutate(phase_2_enddate_trans_rate = phase_2_enddate_trans/(phase_2_enddate_comp + phase_2_enddate_term)) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

# 319741
```

##### Add random/single_group/parallel_group summaries

  We now want to discover other attributes of clinical trials, particularly in if a trial is randomized or not, and if a trial's intervention type is single-group, parallel group, or others.

(startdate/enddate) * (random/single_group/parallel_group) * (count/proportion) 
(startdate/enddate) * phase_2 * (random/non_random/single_group/parallel_group) * count

Total of 20 new columns
  
```{r}
# Create randomize_single_parallel_group containing information of randomized, single_group, parallel_group
randomize_single_parallel_group = trial_firm_detail_3 %>% 
  mutate(randomized = as.numeric(ifelse(randomized == "", 0, randomized))) %>% 
  mutate(single_group = as.numeric(ifelse(single_group == "", 0, single_group))) %>% 
  mutate(parallel_group = as.numeric(ifelse(parallel_group == "", 0, parallel_group))) %>% 
  select(sponsor_id, start_year, end_year, randomized, single_group, parallel_group)

# Create variables startdate * (random/single_group/parallel_group) * (count/proportion) 
startdate_random_single_parallel_group = randomize_single_parallel_group %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(startdate_random_count = sum(randomized),
            startdate_random_prop = mean(randomized),
            startdate_single_count = sum(single_group),
            startdate_single_prop = mean(single_group),
            startdate_parallel_count = sum(parallel_group),
            startdate_parallel_prop = mean(parallel_group))
# Create variables enddate * (random/single_group/parallel_group) * (count/proportion) 
enddate_random_single_parallel_group = randomize_single_parallel_group %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(enddate_random_count = sum(randomized),
            enddate_random_prop = mean(randomized),
            enddate_single_count = sum(single_group),
            enddate_single_prop = mean(single_group),
            enddate_parallel_count = sum(parallel_group),
            enddate_parallel_prop = mean(parallel_group))



# Create randomize_single_parallel_group_p2 containing information of randomized, non_randomized, single_group, parallel_group for p2
randomize_single_parallel_group_p2 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  mutate(randomized = as.numeric(ifelse(randomized == "", 0, randomized))) %>% 
  mutate(non_randomized = ifelse(randomized == 1, 0, 1)) %>% 
  mutate(single_group = as.numeric(ifelse(single_group == "", 0, single_group))) %>% 
  mutate(parallel_group = as.numeric(ifelse(parallel_group == "", 0, parallel_group))) %>% 
  select(sponsor_id, start_year, end_year, randomized, non_randomized, single_group, parallel_group)

# Create variables startdate * phase_2 * (random/non_random/single_group/parallel_group) * count
startdate_p2_random_nonrandom_single_parallel_group = randomize_single_parallel_group_p2 %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(startdate_p2_random_count = sum(randomized),
            startdate_p2_non_random_count = sum(non_randomized),
            startdate_p2_single_count = sum(single_group),
            startdate_p2_parallel_count = sum(parallel_group))
# Create variables enddate * phase_2 * (random/non_random/single_group/parallel_group) * count
enddate_p2_random_nonrandom_single_parallel_group = randomize_single_parallel_group_p2 %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(enddate_p2_random_count = sum(randomized),
            enddate_p2_non_random_count = sum(non_randomized),
            enddate_p2_single_count = sum(single_group),
            enddate_p2_parallel_count = sum(parallel_group))



# Add these 20 columns to the firm_year_dataset
firm_year_dataset_9 = firm_year_dataset_8 %>% 
  left_join(startdate_random_single_parallel_group, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(enddate_random_single_parallel_group, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(startdate_p2_random_nonrandom_single_parallel_group, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(enddate_p2_random_nonrandom_single_parallel_group, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) 

# 319741
```
  
  
##### Add collaborator summaries

  Here we want to keep track of the numbers of collaborators in many ways:

  (all phase/p2) * (total/unique) * (active/new/old) * collaborator 
  p2_trial_with_collab
  
  With total of 13 new columns

```{r}
# Define the preserve_setdiff function to use later on
preserve_setdiff <- function(a, b) {
  for (item in b) {
    match_index <- match(item, a)  # Find the first occurrence of the item in `a`
    if (!is.na(match_index)) {
      a <- a[-match_index]        # Remove that occurrence from `a`
    }
  }
  return(a)
}


# Create variables all_phase*total/unique*ongoing/new/old
allphase_total_start_collab = trial_firm_detail_3 %>% 
  select(sponsor_id, start_year, collab_num, collaborator) %>% 
  filter(collab_num > 0) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(allphase_total_new_collab = sum(collab_num), allphase_total_new_collab_name = str_c(collaborator, collapse = ", "))

allphase_total_end_collab = trial_firm_detail_3 %>% 
  select(sponsor_id, end_year, collab_num, collaborator) %>% 
  filter(collab_num > 0) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(allphase_total_end_collab = sum(collab_num), allphase_total_end_collab_name = str_c(collaborator, collapse = ", "))

allphase_collab = firm_year_dataset_9 %>% 
  left_join(allphase_total_end_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(allphase_total_start_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  select(sponsor_id, year, allphase_total_new_collab, allphase_total_new_collab_name, allphase_total_end_collab, allphase_total_end_collab_name) %>% 
  group_by(sponsor_id) %>% 
  mutate(allphase_total_new_collab = ifelse(is.na(allphase_total_new_collab), 0, allphase_total_new_collab)) %>% 
  mutate(allphase_total_end_collab = ifelse(is.na(allphase_total_end_collab), 0, allphase_total_end_collab)) %>% 
  mutate(allphase_total_new_collab_name = ifelse(is.na(allphase_total_new_collab_name), "", allphase_total_new_collab_name)) %>%
  mutate(allphase_total_end_collab_name = ifelse(is.na(allphase_total_end_collab_name), "", allphase_total_end_collab_name)) %>%
  mutate(
    cum_allphase_total_new_collab = cumsum(allphase_total_new_collab),
    cum_allphase_total_new_collab_name = accumulate(
      allphase_total_new_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_allphase_total_end_collab = lag(cumsum(allphase_total_end_collab), default = 0),
    cum_allphase_total_end_collab_name = lag(accumulate(
      allphase_total_end_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    allphase_total_active_collab = cum_allphase_total_new_collab - cum_allphase_total_end_collab,
    allphase_active_collab_name = preserve_setdiff(str_split(cum_allphase_total_new_collab_name, ", ")[[1]], 
                                                    str_split(cum_allphase_total_end_collab_name, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    allphase_unique_active_collab_name = allphase_active_collab_name %>% 
      str_split(",\\s*") %>% unlist() %>% unique() %>% paste(collapse = ", ") ,
    allphase_unique_active_collab = allphase_unique_active_collab_name %>% str_split(",\\s*") %>% map_int(~ length(unique(.x))),
    allphase_unique_active_collab = ifelse(allphase_unique_active_collab_name == "", 0, allphase_unique_active_collab)
    ) %>% 
  ungroup() %>% 
  mutate(
    # Convert active and new collaborators into lists (ignoring empty strings)
    active_unique_collab_list = str_split(allphase_unique_active_collab_name, ",\\s*"),
    new_collab_list = str_split(allphase_total_new_collab_name, ",\\s*"),
    # Compare current new collaborators with previous year's active collaborators
    allphase_unique_new_collab = map2_dbl(
      new_collab_list, 
      lag(active_unique_collab_list, default = list(character(0))), 
      ~ length(setdiff(.x[.x != ""], .y[.y != ""])) # Remove empty strings and calculate unique collaborators
    ),
    allphase_total_old_collab = allphase_total_active_collab - allphase_total_new_collab,
    allphase_unique_old_collab = allphase_unique_active_collab - allphase_unique_new_collab,
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, allphase_total_active_collab, allphase_total_new_collab, allphase_total_old_collab, allphase_unique_active_collab, allphase_unique_new_collab, allphase_unique_old_collab)

  

# Create variables p2*total/unique*ongoing/new/old*collab
p2_total_start_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, start_year, collab_num, collaborator) %>% 
  filter(collab_num > 0) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_total_new_collab = sum(collab_num), p2_total_new_collab_name = str_c(collaborator, collapse = ", "))

p2_total_end_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, end_year, collab_num, collaborator) %>% 
  filter(collab_num > 0) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_total_end_collab = sum(collab_num), p2_total_end_collab_name = str_c(collaborator, collapse = ", "))

p2_collab = firm_year_dataset_9 %>% 
  left_join(p2_total_start_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_total_end_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_total_new_collab, p2_total_new_collab_name, p2_total_end_collab, p2_total_end_collab_name) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_total_new_collab = ifelse(is.na(p2_total_new_collab), 0, p2_total_new_collab)) %>% 
  mutate(p2_total_end_collab = ifelse(is.na(p2_total_end_collab), 0, p2_total_end_collab)) %>% 
  mutate(p2_total_new_collab_name = ifelse(is.na(p2_total_new_collab_name), "", p2_total_new_collab_name)) %>%
  mutate(p2_total_end_collab_name = ifelse(is.na(p2_total_end_collab_name), "", p2_total_end_collab_name)) %>%
  mutate(
    cum_p2_total_new_collab = cumsum(p2_total_new_collab),
    cum_p2_total_new_collab_name = accumulate(
      p2_total_new_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_total_end_collab = lag(cumsum(p2_total_end_collab), default = 0),
    cum_p2_total_end_collab_name = lag(accumulate(
      p2_total_end_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_total_active_collab = cum_p2_total_new_collab - cum_p2_total_end_collab,
    p2_unique_active_collab_name = preserve_setdiff(str_split(cum_p2_total_new_collab_name, ", ")[[1]], 
                                                    str_split(cum_p2_total_end_collab_name, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_collab = p2_unique_active_collab_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_collab = ifelse(p2_unique_active_collab_name == "", 0, p2_unique_active_collab)
    ) %>% 
  ungroup() %>% 
  mutate(
    # Convert active and new collaborators into lists (ignoring empty strings)
    active_unique_collab_list = str_split(p2_unique_active_collab_name, ",\\s*"),
    new_unique_collab_list = str_split(p2_total_new_collab_name, ",\\s*"),
    # Compare current new collaborators with previous year's active collaborators
    p2_unique_new_collab = map2_dbl(
      new_unique_collab_list, 
      lag(active_unique_collab_list, default = list(character(0))), 
      ~ length(setdiff(.x[.x != ""], .y[.y != ""])) # Remove empty strings and calculate unique collaborators
    ),
    p2_total_old_collab = p2_total_active_collab - p2_total_new_collab,
    p2_unique_old_collab = p2_unique_active_collab - p2_unique_new_collab,
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_total_active_collab, p2_total_new_collab, p2_total_old_collab, p2_unique_active_collab, p2_unique_new_collab, p2_unique_old_collab)



# Create variables p2*total/unique*ongoing/new/old*industry_collab
p2_total_start_industry_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(industry_collab != "") %>% 
  select(sponsor_id, start_year, industry_collab) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_total_new_industry_collab_name = str_c(industry_collab, collapse = ", "))

p2_total_end_industry_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(industry_collab != "") %>% 
  select(sponsor_id, end_year, industry_collab) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_total_end_industry_collab_name = str_c(industry_collab, collapse = ", "))

p2_industry_collab = firm_year_dataset_9 %>% 
  left_join(p2_total_start_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_total_end_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_total_new_industry_collab_name, p2_total_end_industry_collab_name) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_total_new_industry_collab_name = ifelse(is.na(p2_total_new_industry_collab_name), "", p2_total_new_industry_collab_name)) %>%
  mutate(p2_total_end_industry_collab_name = ifelse(is.na(p2_total_end_industry_collab_name), "", p2_total_end_industry_collab_name)) %>%
  mutate(p2_total_new_industry_collab = p2_total_new_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
         p2_total_new_industry_collab = ifelse(p2_total_new_industry_collab_name == "", 0, p2_total_new_industry_collab)) %>% 
  mutate(
    cum_p2_total_new_industry_collab_name = accumulate(
      p2_total_new_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_total_end_industry_collab_name = lag(accumulate(
      p2_total_end_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_active_industry_collab_name = preserve_setdiff(str_split(cum_p2_total_new_industry_collab_name, ", ")[[1]], 
                                                    str_split(cum_p2_total_end_industry_collab_name, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_active_industry_collab = p2_active_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
    p2_active_industry_collab = ifelse(p2_active_industry_collab_name == "", 0, p2_active_industry_collab),
    p2_unique_active_industry_collab = p2_active_industry_collab_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_industry_collab = ifelse(p2_active_industry_collab_name == "", 0, p2_unique_active_industry_collab)
    ) %>% 
  ungroup() %>% 
  mutate(
    # Convert active and new collaborators into lists (ignoring empty strings)
    active_industry_collab_list = str_split(p2_active_industry_collab_name, ",\\s*"),
    new_unique_industry_collab_list = str_split(p2_total_new_industry_collab_name, ",\\s*"),
    # Compare current new collaborators with previous year's active collaborators
    p2_unique_new_industry_collab = map2_dbl(
      new_unique_industry_collab_list, 
      lag(active_industry_collab_list, default = list(character(0))), 
      ~ length(unique(setdiff(.x[.x != ""], .y[.y != ""]))) # Remove empty strings and calculate unique collaborators
    ),
    p2_total_old_industry_collab = p2_active_industry_collab - p2_total_new_industry_collab,
    p2_unique_old_industry_collab = p2_unique_active_industry_collab - p2_unique_new_industry_collab,
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_total_active_industry_collab = p2_active_industry_collab, p2_total_new_industry_collab, p2_total_old_industry_collab, p2_unique_active_industry_collab, p2_unique_new_industry_collab, p2_unique_old_industry_collab)
  
  
  
# Create variables p2*total/unique*ongoing/new/old*non_industry_collab
p2_total_start_non_industry_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(non_industry_collab != "") %>% 
  select(sponsor_id, start_year, non_industry_collab) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_total_new_non_industry_collab_name = str_c(non_industry_collab, collapse = ", "))

p2_total_end_non_industry_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(non_industry_collab != "") %>% 
  select(sponsor_id, end_year, non_industry_collab) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_total_end_non_industry_collab_name = str_c(non_industry_collab, collapse = ", "))

p2_non_industry_collab = firm_year_dataset_9 %>% 
  left_join(p2_total_start_non_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_total_end_non_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_total_new_non_industry_collab_name, p2_total_end_non_industry_collab_name) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_total_new_non_industry_collab_name = ifelse(is.na(p2_total_new_non_industry_collab_name), "", p2_total_new_non_industry_collab_name)) %>%
  mutate(p2_total_end_non_industry_collab_name = ifelse(is.na(p2_total_end_non_industry_collab_name), "", p2_total_end_non_industry_collab_name)) %>%
  mutate(p2_total_new_non_industry_collab = p2_total_new_non_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
         p2_total_new_non_industry_collab = ifelse(p2_total_new_non_industry_collab_name == "", 0, p2_total_new_non_industry_collab)) %>% 
  mutate(
    cum_p2_total_new_non_industry_collab_name = accumulate(
      p2_total_new_non_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_total_end_non_industry_collab_name = lag(accumulate(
      p2_total_end_non_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_active_non_industry_collab_name = preserve_setdiff(str_split(cum_p2_total_new_non_industry_collab_name, ", ")[[1]], 
                                                    str_split(cum_p2_total_end_non_industry_collab_name, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_active_non_industry_collab = p2_active_non_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
    p2_active_non_industry_collab = ifelse(p2_active_non_industry_collab_name == "", 0, p2_active_non_industry_collab),
    p2_unique_active_non_industry_collab = p2_active_non_industry_collab_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_non_industry_collab = ifelse(p2_active_non_industry_collab_name == "", 0, p2_unique_active_non_industry_collab)
    ) %>% 
  ungroup() %>% 
  mutate(
    # Convert active and new collaborators into lists (ignoring empty strings)
    active_non_industry_collab_list = str_split(p2_active_non_industry_collab_name, ",\\s*"),
    new_unique_non_industry_collab_list = str_split(p2_total_new_non_industry_collab_name, ",\\s*"),
    # Compare current new collaborators with previous year's active collaborators
    p2_unique_new_non_industry_collab = map2_dbl(
      new_unique_non_industry_collab_list, 
      lag(active_non_industry_collab_list, default = list(character(0))), 
      ~ length(setdiff(.x[.x != ""], .y[.y != ""])) # Remove empty strings and calculate unique collaborators
    ),
    p2_total_old_non_industry_collab = p2_active_non_industry_collab - p2_total_new_non_industry_collab,
    p2_unique_old_non_industry_collab = p2_unique_active_non_industry_collab - p2_unique_new_non_industry_collab,
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_total_active_non_industry_collab = p2_active_non_industry_collab, p2_total_new_non_industry_collab, p2_total_old_non_industry_collab, p2_unique_active_non_industry_collab, p2_unique_new_non_industry_collab, p2_unique_old_non_industry_collab)



# Create variable p2_trial_with_collab
p2_with_collab_start = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  mutate(collab_dummy = ifelse(collab_num == 0, 0, 1)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_with_collab_start = sum(collab_dummy))

p2_with_collab_end = trial_firm_detail_3 %>%  
  filter(phase_2 == 1) %>% 
  mutate(collab_dummy = ifelse(collab_num == 0, 0, 1)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_with_collab_end = sum(collab_dummy))

p2_trial_with_collab_avtive = firm_year_dataset_9 %>% 
  left_join(p2_with_collab_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_with_collab_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  group_by(sponsor_id) %>% 
  mutate(across(everything(), ~ replace_na(., 0)),
         cum_p2_with_collab_start = cumsum(p2_with_collab_start),
         cum_p2_with_collab_end = lag(cumsum(p2_with_collab_end), default = 0),
         p2_trial_with_collab_avtive = cum_p2_with_collab_start - cum_p2_with_collab_end) %>% 
  select(sponsor_id, year, p2_trial_with_collab_avtive)




  
# Add these 13 columns to the firm_year_dataset
firm_year_dataset_10 = firm_year_dataset_9 %>% 
  left_join(allphase_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_non_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_trial_with_collab_avtive, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>%
  mutate(across(everything(), ~ replace_na(., 0))) 

```

##### Add covid

  Here we want to keep track of the numbers of phase 2 trials that are covid related:
  
  p2_covid_start and p2_covid_active for each firm_year

```{r}
# Create variable p2_trial_with_collab
p2_covid_start = trial_firm_detail_3 %>%  
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_covid_start = sum(covid))

p2_covid_end = trial_firm_detail_3 %>%  
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_covid_end = sum(covid))

p2_covid = firm_year_dataset_10 %>% 
  left_join(p2_covid_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_covid_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  group_by(sponsor_id) %>% 
  mutate(across(everything(), ~ replace_na(., 0)),
         cum_p2_covid_start = cumsum(p2_covid_start),
         cum_p2_covid_end = lag(cumsum(p2_covid_end), default = 0),
         p2_covid_avtive = cum_p2_covid_start - cum_p2_covid_end) %>% 
  select(sponsor_id, year, p2_covid_start, p2_covid_avtive)



firm_year_dataset_11 = firm_year_dataset_10 %>% 
  left_join(p2_covid, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>%
  mutate(across(everything(), ~ replace_na(., 0))) 
```

##### Add disease 

  Here we want to investigate the measure of different types of diseases, we will first classify diseases in the trial_firm_detail dataset in numerous ways and then count them in the firm_year_dataset.
  
  Utilize the disease_id_code_name table built from section /Clean Variables/disease
  
  We are interested in:
   - p2_unique_disease_ongoing
   
   - p2_cancer_ongoing
   
   - # of phase 2 trials in Diseases with low vs. high number patients
    - pre_2010, and pre_2018
    
   - # of phase 2 trials in Diseases with short vs. long lengths (from trial start to trial completion date)
    - pre_2010, and pre_2018
    
   - average/median/max/min p2 length of the trial for each company/year
   
   - # of phase 2 trials in Diseases with low costs and high costs in phase 2 costs
   
   - Average cost of phase 2 trials


```{r}
# p2_unique_disease_ongoing
p2_disease_start = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(disease_id != "") %>% 
  select(sponsor_id, start_year, disease_id) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_all_disease_start_list = str_c(disease_id, collapse = ", "))
p2_disease_end = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(disease_id != "") %>% 
  select(sponsor_id, end_year, disease_id) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_all_disease_end_list = str_c(disease_id, collapse = ", "))

p2_unique_disease_ongoing = firm_year_dataset_11 %>% 
  left_join(p2_disease_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_disease_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_all_disease_start_list, p2_all_disease_end_list) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_all_disease_start_list = ifelse(is.na(p2_all_disease_start_list), "", p2_all_disease_start_list)) %>%
  mutate(p2_all_disease_end_list = ifelse(is.na(p2_all_disease_end_list), "", p2_all_disease_end_list)) %>% 
  mutate(cum_p2_all_disease_start_list = accumulate(
      p2_all_disease_start_list, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", "))) %>% 
  mutate(cum_p2_all_disease_end_list = lag(accumulate(
      p2_all_disease_end_list, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_disease_ongoing_list = preserve_setdiff(str_split(cum_p2_all_disease_start_list, ", ")[[1]], 
                                                    str_split(cum_p2_all_disease_end_list, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_disease_ongoing = p2_unique_disease_ongoing_list %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_disease_ongoing = ifelse(p2_unique_disease_ongoing_list == "", 0, p2_unique_disease_ongoing)
    ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_unique_disease_ongoing)
  



# p2_cancer_ongoing
# Note that Cancer(C04) has disease_id = 4
p2_cancer_start = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(disease_id == 4) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_cancer_start = n())
p2_cancer_end = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(disease_id == 4) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_cancer_end = n())

p2_cancer_ongoing = firm_year_dataset_11 %>% 
  left_join(p2_cancer_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_cancer_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_cancer_start, p2_cancer_end) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  group_by(sponsor_id) %>% 
  mutate(cum_p2_cancer_start = cumsum(p2_cancer_start),
         cum_p2_cancer_end = lag(cumsum(p2_cancer_end), default = 0),
         p2_cancer_ongoing = cum_p2_cancer_start - cum_p2_cancer_end) %>% 
  select(sponsor_id, year, p2_cancer_ongoing)




# p2_high_patnum_pre2010_ongoing, p2_low_patnum_pre2010_ongoing, p2_long_length_pre2010_ongoing, p2_short_length_pre2010_ongoing 
p2_trial_pre2010 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(disease_id != "") %>% 
  filter(end_year != "") %>% 
  filter(end_year <= 2010) %>% 
  filter(patient_num != "") %>% 
  mutate(patient_num = as.numeric(patient_num),
         start_year = as.numeric(start_year),
         end_year = as.numeric(end_year),
         trial_length = end_year - start_year) %>% 
  select(trial_id, sponsor_id, disease_id, start_year, end_year, patient_num, trial_length)

p2_patnum_length_pre2010 = p2_trial_pre2010 %>% 
  group_by(disease_id) %>% 
  summarize(disease_mean_patnum = mean(patient_num),
            disease_mean_length = mean(trial_length)) %>% 
  ungroup() %>% 
  mutate(p2_high_patnum_pre2010 = ifelse(disease_mean_patnum > median(disease_mean_patnum), 1, 0),
         p2_low_patnum_pre2010 = ifelse(p2_high_patnum_pre2010 == 1, 0, 1),
         p2_long_length_pre2010 = ifelse(disease_mean_length > median(disease_mean_length), 1, 0),
         p2_short_length_pre2010 = ifelse(p2_long_length_pre2010 == 1, 0, 1)) %>% 
  select(disease_id, p2_high_patnum_pre2010, p2_low_patnum_pre2010, p2_long_length_pre2010, p2_short_length_pre2010)

p2_trial_patnum_length_pre2010 = p2_trial_pre2010 %>% 
  left_join(p2_patnum_length_pre2010, by = "disease_id") %>% 
  select(sponsor_id, start_year, end_year, p2_high_patnum_pre2010, p2_low_patnum_pre2010, p2_long_length_pre2010, p2_short_length_pre2010)

p2_trial_patnum_length_pre2010_start = p2_trial_patnum_length_pre2010 %>% 
  mutate(start_year = as.character(start_year)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_high_patnum_pre2010_start = sum(p2_high_patnum_pre2010),
            p2_low_patnum_pre2010_start = sum(p2_low_patnum_pre2010),
            p2_long_length_pre2010_start = sum(p2_long_length_pre2010),
            p2_short_length_pre2010_start = sum(p2_short_length_pre2010))
  
p2_trial_patnum_length_pre2010_end = p2_trial_patnum_length_pre2010 %>% 
  mutate(end_year = as.character(end_year)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_high_patnum_pre2010_end = sum(p2_high_patnum_pre2010),
            p2_low_patnum_pre2010_end = sum(p2_low_patnum_pre2010),
            p2_long_length_pre2010_end = sum(p2_long_length_pre2010),
            p2_short_length_pre2010_end = sum(p2_short_length_pre2010))

p2_trial_patnum_length_pre2010_ongoing = firm_year_dataset_11 %>% 
  left_join(p2_trial_patnum_length_pre2010_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_trial_patnum_length_pre2010_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_high_patnum_pre2010_start, p2_high_patnum_pre2010_end, p2_low_patnum_pre2010_start, p2_low_patnum_pre2010_end, p2_long_length_pre2010_start, p2_long_length_pre2010_end, p2_short_length_pre2010_start, p2_short_length_pre2010_end) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  group_by(sponsor_id) %>% 
  mutate(cum_p2_high_patnum_pre2010_start = cumsum(p2_high_patnum_pre2010_start),
         cum_p2_high_patnum_pre2010_end = lag(cumsum(p2_high_patnum_pre2010_end), default = 0),
         cum_p2_low_patnum_pre2010_start = cumsum(p2_low_patnum_pre2010_start),
         cum_p2_low_patnum_pre2010_end = lag(cumsum(p2_low_patnum_pre2010_end), default = 0),
         cum_p2_long_length_pre2010_start = cumsum(p2_long_length_pre2010_start),
         cum_p2_long_length_pre2010_end = lag(cumsum(p2_long_length_pre2010_end), default = 0),
         cum_p2_short_length_pre2010_start = cumsum(p2_short_length_pre2010_start),
         cum_p2_short_length_pre2010_end = lag(cumsum(p2_short_length_pre2010_end), default = 0),
         p2_high_patnum_pre2010_ongoing = cum_p2_high_patnum_pre2010_start - cum_p2_high_patnum_pre2010_end,
         p2_low_patnum_pre2010_ongoing = cum_p2_low_patnum_pre2010_start - cum_p2_low_patnum_pre2010_end,
         p2_long_length_pre2010_ongoing = cum_p2_long_length_pre2010_start - cum_p2_long_length_pre2010_end,
         p2_short_length_pre2010_ongoing = cum_p2_short_length_pre2010_start - cum_p2_short_length_pre2010_end,) %>% 
  select(sponsor_id, year, p2_high_patnum_pre2010_ongoing, p2_low_patnum_pre2010_ongoing, p2_long_length_pre2010_ongoing, p2_short_length_pre2010_ongoing)




# Do again for 2018 cutoff
# p2_high_patnum_pre2018_ongoing, p2_low_patnum_pre2018_ongoing, p2_long_length_pre2018_ongoing, p2_short_length_pre2018_ongoing 
p2_trial_pre2018 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(disease_id != "") %>% 
  filter(end_year != "") %>% 
  filter(end_year <= 2018) %>% 
  filter(patient_num != "") %>% 
  mutate(patient_num = as.numeric(patient_num),
         start_year = as.numeric(start_year),
         end_year = as.numeric(end_year),
         trial_length = end_year - start_year) %>% 
  select(trial_id, sponsor_id, disease_id, start_year, end_year, patient_num, trial_length)

p2_patnum_length_pre2018 = p2_trial_pre2018 %>% 
  group_by(disease_id) %>% 
  summarize(disease_mean_patnum = mean(patient_num),
            disease_mean_length = mean(trial_length)) %>% 
  ungroup() %>% 
  mutate(p2_high_patnum_pre2018 = ifelse(disease_mean_patnum > median(disease_mean_patnum), 1, 0),
         p2_low_patnum_pre2018 = ifelse(p2_high_patnum_pre2018 == 1, 0, 1),
         p2_long_length_pre2018 = ifelse(disease_mean_length > median(disease_mean_length), 1, 0),
         p2_short_length_pre2018 = ifelse(p2_long_length_pre2018 == 1, 0, 1)) %>% 
  select(disease_id, p2_high_patnum_pre2018, p2_low_patnum_pre2018, p2_long_length_pre2018, p2_short_length_pre2018)

p2_trial_patnum_length_pre2018 = p2_trial_pre2018 %>% 
  left_join(p2_patnum_length_pre2018, by = "disease_id") %>% 
  select(sponsor_id, start_year, end_year, p2_high_patnum_pre2018, p2_low_patnum_pre2018, p2_long_length_pre2018, p2_short_length_pre2018)

p2_trial_patnum_length_pre2018_start = p2_trial_patnum_length_pre2018 %>% 
  mutate(start_year = as.character(start_year)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_high_patnum_pre2018_start = sum(p2_high_patnum_pre2018),
            p2_low_patnum_pre2018_start = sum(p2_low_patnum_pre2018),
            p2_long_length_pre2018_start = sum(p2_long_length_pre2018),
            p2_short_length_pre2018_start = sum(p2_short_length_pre2018))
  
p2_trial_patnum_length_pre2018_end = p2_trial_patnum_length_pre2018 %>% 
  mutate(end_year = as.character(end_year)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_high_patnum_pre2018_end = sum(p2_high_patnum_pre2018),
            p2_low_patnum_pre2018_end = sum(p2_low_patnum_pre2018),
            p2_long_length_pre2018_end = sum(p2_long_length_pre2018),
            p2_short_length_pre2018_end = sum(p2_short_length_pre2018))

p2_trial_patnum_length_pre2018_ongoing = firm_year_dataset_11 %>% 
  left_join(p2_trial_patnum_length_pre2018_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_trial_patnum_length_pre2018_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_high_patnum_pre2018_start, p2_high_patnum_pre2018_end, p2_low_patnum_pre2018_start, p2_low_patnum_pre2018_end, p2_long_length_pre2018_start, p2_long_length_pre2018_end, p2_short_length_pre2018_start, p2_short_length_pre2018_end) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  group_by(sponsor_id) %>% 
  mutate(cum_p2_high_patnum_pre2018_start = cumsum(p2_high_patnum_pre2018_start),
         cum_p2_high_patnum_pre2018_end = lag(cumsum(p2_high_patnum_pre2018_end), default = 0),
         cum_p2_low_patnum_pre2018_start = cumsum(p2_low_patnum_pre2018_start),
         cum_p2_low_patnum_pre2018_end = lag(cumsum(p2_low_patnum_pre2018_end), default = 0),
         cum_p2_long_length_pre2018_start = cumsum(p2_long_length_pre2018_start),
         cum_p2_long_length_pre2018_end = lag(cumsum(p2_long_length_pre2018_end), default = 0),
         cum_p2_short_length_pre2018_start = cumsum(p2_short_length_pre2018_start),
         cum_p2_short_length_pre2018_end = lag(cumsum(p2_short_length_pre2018_end), default = 0),
         p2_high_patnum_pre2018_ongoing = cum_p2_high_patnum_pre2018_start - cum_p2_high_patnum_pre2018_end,
         p2_low_patnum_pre2018_ongoing = cum_p2_low_patnum_pre2018_start - cum_p2_low_patnum_pre2018_end,
         p2_long_length_pre2018_ongoing = cum_p2_long_length_pre2018_start - cum_p2_long_length_pre2018_end,
         p2_short_length_pre2018_ongoing = cum_p2_short_length_pre2018_start - cum_p2_short_length_pre2018_end,) %>% 
  select(sponsor_id, year, p2_high_patnum_pre2018_ongoing, p2_low_patnum_pre2018_ongoing, p2_long_length_pre2018_ongoing, p2_short_length_pre2018_ongoing)




# p2_average/median/max/min_length 
p2_trial_length = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>%
  filter(end_year != "") %>% 
  mutate(start_year = as.numeric(start_year),
         end_year = as.numeric(end_year),
         trial_length = end_year - start_year) %>% 
  select(trial_id, sponsor_id, start_year, end_year, trial_length)

p2_trial_length_start = p2_trial_length %>% 
  mutate(start_year = as.character(start_year)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_trial_length_start = str_c(trial_length, collapse = ", "))

p2_trial_length_end = p2_trial_length %>% 
  mutate(end_year = as.character(end_year)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_trial_length_end = str_c(trial_length, collapse = ", "))

p2_average_median_max_min_length = firm_year_dataset_11 %>% 
  left_join(p2_trial_length_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_trial_length_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_trial_length_start, p2_trial_length_end) %>% 
  mutate(across(everything(), ~ replace_na(., ""))) %>% 
  group_by(sponsor_id) %>% 
  mutate(cum_p2_trial_length_start = accumulate(
      p2_trial_length_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
         cum_p2_trial_length_end = lag(accumulate(
      p2_trial_length_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_trial_length_active = ifelse(length(preserve_setdiff(str_split(cum_p2_trial_length_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_end, ", ")[[1]])) == 0, NA,
                                    preserve_setdiff(str_split(cum_p2_trial_length_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_end, ", ")[[1]]) %>% paste(collapse = ", ")),
    p2_mean_length = mean(as.numeric(str_split(p2_trial_length_active, ", ")[[1]])),
    p2_median_length = median(as.numeric(str_split(p2_trial_length_active, ", ")[[1]])),
    p2_max_length = max(as.numeric(str_split(p2_trial_length_active, ", ")[[1]])),
    p2_min_length = min(as.numeric(str_split(p2_trial_length_active, ", ")[[1]]))
  ) %>% 
  select(sponsor_id, year, p2_mean_length, p2_median_length, p2_max_length, p2_min_length)

p2_average_median_max_min_length = p2_average_median_max_min_length %>% 
  mutate(p2_mean_length = ifelse(is.na(p2_mean_length), "", as.character(p2_mean_length)),
         p2_median_length = ifelse(is.na(p2_median_length), "", as.character(p2_median_length)),
         p2_max_length = ifelse(is.na(p2_max_length), "", as.character(p2_max_length)),
         p2_min_length = ifelse(is.na(p2_min_length), "", as.character(p2_min_length))
         )






# Create a mapping list from disease code to class and cost first
disease_code_cat = read_csv("disease/Disease_Categorization_by_R_D_Cost.csv")
disease_cat_cost = data_frame(
  category = c("Anti-Infective", "Oncology", "Other", "Gastrointestinal", "Respiratory System", "Central Nervous System", "Ophthalmology", "Cardiovascular", "Dermatology", "Endocrine", "Immunomodulation", "Pain and Anesthesia", "Genitourinary System"),
  class = c("mid", "mid", "", "high", "mid", "mid", "mid", "low", "low", "mid", "high", "high", "mid"),
  cost = c(14.2, 11.2, 0, 15.8, 12.2, 13.9, 13.8, 7, 8.9, 12.1, 16, 17,14.6)
)
disease_code_class_cost= disease_code_cat %>% 
  left_join(disease_cat_cost) %>% 
  mutate(disease_id = as.character(disease_id)) %>% 
  select(disease_id, class, cost)




# p2_highcost_ongoing, p2_midcost_ongoing, p2_lowcost_ongoing
p2_cost_class = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  left_join(disease_code_class_cost, by = "disease_id") %>% 
  mutate(highcost = ifelse(class == "high", 1, 0),
         midcost = ifelse(class == "mid", 1, 0),
         lowcost = ifelse(class == "low", 1, 0)) %>% 
  select(trial_id, sponsor_id, start_year, end_year, disease_id, highcost, midcost, lowcost) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) 

p2_cost_class_start = p2_cost_class %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(highcost_start = sum(highcost),
            midcost_start = sum(midcost),
            lowcost_start = sum(lowcost))

p2_cost_class_end = p2_cost_class %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(highcost_end= sum(highcost),
            midcost_end = sum(midcost),
            lowcost_end = sum(lowcost))

p2_cost_class_ongoing = firm_year_dataset_11 %>% 
  left_join(p2_cost_class_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_cost_class_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, highcost_start, highcost_end, midcost_start, midcost_end, lowcost_start, lowcost_end) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  group_by(sponsor_id) %>% 
  mutate(
    cum_highcost_start = cumsum(highcost_start),
    cum_highcost_end = lag(cumsum(highcost_end), default = 0),
    cum_midcost_start = cumsum(midcost_start),
    cum_midcost_end = lag(cumsum(midcost_end), default = 0),
    cum_lowcost_start = cumsum(lowcost_start),
    cum_lowcost_end = lag(cumsum(lowcost_end), default = 0),
    p2_highcost_ongoing = cum_highcost_start - cum_highcost_end,
    p2_midcost_ongoing = cum_midcost_start - cum_midcost_end,
    p2_lowcost_ongoing = cum_lowcost_start - cum_lowcost_end
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_highcost_ongoing, p2_midcost_ongoing, p2_lowcost_ongoing)




# p2_mean_cost
p2_cost = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  left_join(disease_code_class_cost, by = "disease_id") %>% 
  select(trial_id, sponsor_id, start_year, end_year, disease_id, cost) %>% 
  mutate(cost = ifelse(is.na(cost), 0, cost))

p2_cost_start = p2_cost %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_cost_start = str_c(cost, collapse = ", "))

p2_cost_end = p2_cost %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_cost_end = str_c(cost, collapse = ", "))

p2_mean_cost = firm_year_dataset_11 %>% 
  left_join(p2_cost_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_cost_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_cost_start, p2_cost_end) %>% 
  mutate(across(everything(), ~ replace_na(., ""))) %>% 
  group_by(sponsor_id) %>% 
  mutate(cum_p2_cost_start = accumulate(
      p2_cost_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
         cum_p2_cost_end = lag(accumulate(
      p2_cost_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_cost_active = ifelse(length(preserve_setdiff(str_split(cum_p2_cost_start, ", ")[[1]],
                                              str_split(cum_p2_cost_end, ", ")[[1]])) == 0, NA,
                                    preserve_setdiff(str_split(cum_p2_cost_start, ", ")[[1]],
                                              str_split(cum_p2_cost_end, ", ")[[1]]) %>% paste(collapse = ", ")),
    p2_mean_cost = mean(as.numeric(str_split(p2_cost_active, ", ")[[1]])),
    p2_mean_cost_without_other = mean(as.numeric(str_split(p2_cost_active, ", ")[[1]])[as.numeric(str_split(p2_cost_active, ", ")[[1]]) != 0])
  ) %>% 
  select(sponsor_id, year, p2_mean_cost, p2_mean_cost_without_other) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) 



# Add these 13 columns to the dataset
firm_year_dataset_12 = firm_year_dataset_11 %>% 
  left_join(p2_unique_disease_ongoing, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_cancer_ongoing, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_trial_patnum_length_pre2010_ongoing, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_trial_patnum_length_pre2018_ongoing, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_average_median_max_min_length, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_cost_class_ongoing, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_mean_cost, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) 

```


  Comments & Observations: 
   - For variables related to diseases, trials missing disease_id were not counted.
   - For variables related to patient_num, trials missing patient_num were not counted.
   - After filtering (phase_2 == 1, end_year<2010, patient_num != ""), we have 18729 trials left, with 29 diseases.
   - For p2_average/median/max/min_length, I only counted for the completed (or terminated) ones. 
   - For p2_mean_cost, since excess amount of "Other" class of disease (which have cost 0) will drag down the average cost of trials, I created a p2_mean_cost, and p2_mean_cost_without_other, which calculate average cost excluding the "Other" type of diseases.




  
  
  
```{r}
# Exploratory code



```


```{r}
# Sanity Check
# Unique sposnor_ids 23557
# N for firm_year 319741

```




### Exploratory datasets

#### sponsor_id_foundedyear_firsttrialyear

```{r}
# Contain information on the sponsor level, use for assess quality of sponsor_id matching
# Only contain sponsors with valid trials, which means trials that are present in trial_firm_detail_3
additional_firm_info = trial_firm_detail_3 %>% 
  group_by(sponsor_id) %>% 
  summarize(first_trial_year = min(start_year), industry_dummy = max(industry_dummy)) %>% 
  mutate(no_trial_before_2010 = ifelse(first_trial_year >= 2010, "1", "0"))

no_p2trial_before_2010 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id) %>% 
  summarize(first_p2trial_year = min(start_year)) %>% 
  mutate(no_p2trial_before_2010 = ifelse(first_p2trial_year >= 2010, "1", "0")) 

sponsor_name_source = main_raw_dataset %>% 
  select(sponsor_name, source) %>% 
  distinct(sponsor_name, .keep_all = TRUE)

sponsor_id_foundedyear_firsttrialyear = firm_name_founding_year_id_new %>%
  mutate(foundedyear_capitalq = year_founded) %>% 
  select(sponsor_name, sponsor_id, foundedyear_capitalq) %>% 
  left_join(additional_firm_info, by = "sponsor_id") %>% 
  left_join(no_p2trial_before_2010, by = "sponsor_id") %>% 
  left_join(sponsor_name_source, by = "sponsor_name") %>% 
  filter(sponsor_name %in% trial_firm_detail_3$sponsor_name) %>% # filter out companies not having trial record in our dataset
  mutate(sponsor_name_eu = ifelse(source == "EU", sponsor_name, "")) %>% 
  mutate(sponsor_name_aact = ifelse(source == "AACT", sponsor_name, "")) %>% 
  select(-source) %>% 
  mutate(across(everything(), ~ replace_na(., "")))


# Above is the new sponsor list with false negative removed, for the following we use the old version to identify false positive
potential_false_positive = sponsor_id_foundedyear_firsttrialyear %>% 
  group_by(sponsor_id) %>% 
  mutate(name_num = str_replace_all(paste("name_", row_number()), " ", "")) %>% 
  pivot_wider(id_cols = sponsor_id,
              names_from = name_num,
              values_from = sponsor_name) %>% 
  filter(!is.na(name_2))

sponsor_id_foundedyear_firsttrialyear = sponsor_id_foundedyear_firsttrialyear %>% 
  select(-sponsor_name, -sponsor_name_eu, -sponsor_name_aact) %>% 
  distinct(sponsor_id, .keep_all = TRUE) %>% 
  left_join(potential_false_positive) %>% 
  filter(!is.na(name_1)) %>% 
  mutate(across(everything(), ~ replace_na(., "")))


sponsor_id_foundedyear_firsttrialyear %>% filter(name_20 != "")

write.csv(sponsor_id_foundedyear_firsttrialyear, file = "sponsor_id_foundedyear_firsttrialyear_1121.csv")

```

Note: The additional information are based on sponsor_id and not sponsor_name


#### p2trial_length

```{r}
# Contain trial length for all phase 2 trials, flag them as ongoing or finished
p2trial_length = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% # 146718
  mutate(end_year = ifelse(end_year == "", "2024", end_year)) %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  mutate(trial_length = end_year - start_year) %>% 
  mutate(aact_dummy = ifelse(source == "AACT", "1", "0")) %>% 
  select(trial_id, status, start_year, end_year, trial_length, industry_dummy, aact_dummy)


p2trial_length %>% ggplot(aes(x = trial_length, fill = status)) + geom_bar() + xlim(-3, 30)
p2trial_length %>% filter(status == "ongoing") %>% ggplot(aes(x = trial_length, fill = status)) + geom_bar() + xlim(-3, 30) + scale_fill_manual(values = "#00BA38")
p2trial_length %>% filter(status != "ongoing") %>% ggplot(aes(x = trial_length, fill = status)) + geom_bar() + xlim(-3, 30) + scale_fill_manual(values = c("#F8766D", "#619CFF"))
p2trial_length %>% ggplot(aes(x = trial_length)) + geom_boxplot()

write.csv(p2trial_length, file = "p2trial_length.csv")

```

#### p2trial_length (unique trial_id)

Recall at the construciton of the dataset, we see trials taken place in different countries as different trials, and this might result in counting these trials multiple times in the previous dataset. Therefore, here we're trying to look at the distribution of phase 2 trial length with distinct nct_id/eudract_id.

```{r}
# Contain trial length for all phase 2 trials, flag them as ongoing or finished
p2trial_length_unique_trial_id = trial_firm_detail_3 %>% 
  distinct(nct_id, eudract_id, .keep_all = TRUE) %>% 
  filter(phase_2 == 1) %>% # 89829
  mutate(end_year = ifelse(end_year == "", "2024", end_year)) %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  mutate(trial_length = end_year - start_year) %>% 
  mutate(aact_dummy = ifelse(source == "AACT", "1", "0")) %>% 
  select(trial_id, status, start_year, end_year, trial_length, industry_dummy, aact_dummy)

p2trial_length_unique_trial_id %>% ggplot(aes(x = trial_length, fill = status)) + geom_bar() + xlim(-3, 30)
p2trial_length_unique_trial_id %>% filter(status == "ongoing") %>% ggplot(aes(x = trial_length, fill = status)) + geom_bar() + xlim(-3, 30) + scale_fill_manual(values = "#00BA38")
p2trial_length_unique_trial_id %>% filter(status != "ongoing") %>% ggplot(aes(x = trial_length, fill = status)) + geom_bar() + xlim(-3, 30) + scale_fill_manual(values = c("#F8766D", "#619CFF"))
p2trial_length_unique_trial_id %>% ggplot(aes(x = trial_length)) + geom_boxplot()

write.csv(p2trial_length_unique_trial_id, file = "p2trial_length_unique_trial_id.csv")
```

#### p2trial_length (unique trial_id) by days

```{r}
# Create combined dataset with days
# Refer to zombie_trials section
    
p2trial_length_unique_trial_id_days %>% ggplot(aes(x = trial_length_days, fill = status)) + geom_histogram(bins = 100) + xlim(-850, 10000)
p2trial_length_unique_trial_id_days %>% filter(status == "ongoing") %>% ggplot(aes(x = trial_length_days, fill = status)) + geom_histogram(bins = 100) + xlim(-850, 10000) + scale_fill_manual(values = "#00BA38")
p2trial_length_unique_trial_id_days %>% filter(status != "ongoing") %>% ggplot(aes(x = trial_length_days, fill = status)) + geom_histogram(bins = 100) + xlim(-850, 10000) + scale_fill_manual(values = c("#F8766D", "#619CFF"))
p2trial_length_unique_trial_id_days %>% filter(status == "ongoing") %>% ggplot(aes(x = trial_length_days)) + geom_boxplot()

write.csv(p2trial_length_unique_trial_id_days, file = "p2trial_length_unique_trial_id_days.csv")

p2trial_length_unique_trial_id_days %>% filter(status == "completed") %>% filter(industry_dummy == "1") %>% ggplot(aes(x = trial_length_days, fill = status)) + geom_histogram(bins = 100) + xlim(-850, 10000)

p2trial_length_unique_trial_id_days %>% filter(status == "completed") %>% filter(industry_dummy == "0") %>% ggplot(aes(x = trial_length_days, fill = status)) + geom_histogram(bins = 100) + xlim(-850, 10000)


p2trial_length_unique_trial_id_days %>% filter(status == "completed") %>% filter(industry_dummy == "1") %>% summary()
p2trial_length_unique_trial_id_days %>% filter(status == "completed") %>% filter(industry_dummy == "1") %>% summarize(sd = sd(trial_length_days))

p2trial_length_unique_trial_id_days %>% filter(status == "completed") %>% filter(industry_dummy == "0") %>% summarize(sd = sd(trial_length_days))



```


Note: 
  (for p2trial_length)
  1. 178 trials start after 2024, assuming it's projected start year?
  2. 0.00013 p2trials are over 30 years (19 trials)
     0.0025 p2trials are over 20 years (362 trials)
     0.013 p2trials are over 15 years (1891 trials)
     0.038 p2trials are over 10 years (5598 trials)
     
  (for p2trial_length_unique_trial_id)
  3. 147 trials start after 2024, assuming it's projected start year?
  4. 0.0002 p2trials are over 30 years (18 trials)
     0.0033 p2trials are over 20 years (300 trials)
     0.019 p2trials are over 15 years (1683 trials)
     0.049 p2trials are over 10 years (4362 trials)
     
  5. The p2trial_length_unique_trial_id_days calculates trial length in days as of today
     
     
## Export Datasets (Checkpoint)

```{r}
# Create csv files storing main_raw_dataset, trial_country_dataset, and trial_disease_firm_dataset
write.csv(main_raw_dataset, file = "main_raw_dataset.csv")
write.csv(trial_country_dataset, file = "trial_country_dataset.csv")
write.csv(trial_disease_firm_dataset, file = "trial_disease_firm_dataset.csv")

# Create csv files with unique company_id and unique country names and id
write.csv(trial_firm_detail_3, file = "trial_firm_detail_3.csv")
write.csv(firm_name_founding_year_id, file = "firm_name_founding_year_id.csv")
write.csv(firm_year_dataset_12, file = "firm_year_dataset_12112024.csv")

write.csv(disease_id_code_name, file = "disease_id_code_name.csv")
```

**Report to Sukhun:  sponsor_id_foundedyear_firsttrialyear and firm_year_dataset_11182024**

 1. Fixed, this is actually a bigger issue than I imagined, it stems from the way I constructed the p2trial_length_unique_trial_id_days dataset. It should be fine now, please double check.
 2. Done. Please double check to see if the new columns are what you expected
 3. Understood, thank you so much
 5. There's a small confusion here. There's startdate_random_count and there's startdate_p2_random_count, the first one counts for all phases while the second one counts only phase 2. For each sponsor-year, the startdate_p2_random_count doesn't exceed phase_2_start
  - For the discrepancy of the sponsors (including total sponsor numbers and number of distinct sponsors): When I was trying to label the source of the company names, I found some company are from the Capitalq dataset, so I removed these companies. Sorry for not disclosing this when I updated the dataset

*Using new sponsor matching, stuck at construct form_year_dataset*

An issue for the new firm_year_trial: After using firm_year went from 360274 to 125389, this is a rather huge cut and the main reason is: Many sponsor_names didn't match with the sponsor_names in the new sponsor_founding_matching_1112. Most of them are non-industry, which I guess is fine since that's not the focus of our project, but there are *54* unique industry sponsor_names not getting a match. I'm sending a list of these unmatched sponsor_names for your inspection in unmatched_sponsor_names. For the other (non-industry) sponsor not having a sponsor_id, how would you like me to handle them, should I filter them out or give them new sponsor_id?

Note that these unmatched sponsors all have found_year as 1965 because they're missing sponsor_id so they were grouped together when imputing also missing sponsor_found_year. For reference I provided their matched founded_year in capitals dataset.

# Questions and Notes

  
  
# Priority Tasks

Recruitment length of average trial (all, p1, p2, p3)
  
  
# Task

 1. maybe discard companies with only one trial
 2. maybe discard academic sponsor in the future
 3. Should we include UK in any_eu_pre_2016 since UK was still in EU then?









