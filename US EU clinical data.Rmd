---
title: "US EU clinical data"
output: html_document
date: "2024-09-24"
---

```{r}
#install and load necessary packages
#install.packages("stringdist")
library(readr)
library(tidyverse)
library(jsonlite)
library(stringr)
library(stringdist)
library(readxl)
library(janitor)
library(data.table)
library(ggplot2)
library(naniar)
library(purrr)
library(tm)
library(topicmodels)
library(tidytext)

```

# Loading and Clean the Datasets

First, we load the dataset from both sources of EU and US database.  From both database, we want to extract the key variables, which are: 

  Phase, # of patients, Start and end dates, disease, country, sponsor (firm), collaborators (firms/orgs), status (completion, termination)

Finally we want to construct a  firm-disease-start_year-country panel

## EU data

### Import the Data

```{r eval=FALSE}
#Load the EU data
# Initial dump
# temp = read_csv("EU data/euctr_euctr_dump-2024-09-07-092059.csv")

# Full EU dump
#eu1 = lapply(list.files(path = "EU data/all_euctr", pattern = "*.csv", full.names = TRUE), read_csv)
#eu1 = lapply(eu1, function(df) {
#  df = df[ , !(names(df) %in% "trial_version")]  # Remove the "trial_version" column due to type discrepancy
#  return(df)
#})
#eu1 = bind_rows(eu1) %>% 
#  distinct(eudract_number_with_country, .keep_all = TRUE)
#nrow(eu1)

# Notice that the newest csv file(2024-10-05) in the whole folder contains all unique EU trials, I'm guessing this is because each dataset renewal is an update of all trials, with some addition of new trials.

eu1 = read_csv("EU data/all_euctr/euctr_euctr_dump-2024-10-05-060856.csv")
nrow(eu1)
eu1

# List of potential variables for assessing subject number
eu1 %>% select(eudract_number_with_country, subject_in_the_member_state, subject_in_the_eea, subject_subjects_incapable_of_giving_consent_personally, subject_in_the_whole_clinical_trial, subject_childs, subject_elderly, subject_adults)


```

```{r}
# Create column covid, taking value 1 when the trial is COVID-19 related
eu1_covid = eu1 %>% 
  select(eudract_number_with_country, trial_secondary_objectives_of_the_trial, trial_medical_condition_s_being_investigated, full_title_of_the_trial, trial_main_objective_of_the_trial, name_or_abbreviated_title_of_the_trial_where_available, trial_medical_condition_in_easily_understood_language, title_of_the_trial_for_lay_people_in_easily_understood_i_e_non_) %>%
  filter(if_any(everything(), ~ str_detect(., str_c(c("COVID", "Covid", "covid", "SARS-CoV-2"), collapse = "|")))) %>% 
  mutate(covid = 1) %>% 
  select(eudract_number_with_country, covid)

eu1 = eu1 %>% left_join(eu1_covid, by = "eudract_number_with_country")
```

```{r}
# Create datasets for later use
eu_incapable_consent = eu1 %>% select(eudract_number_with_country, subject_subjects_incapable_of_giving_consent_personally) %>% 
  rename(eudract_id = eudract_number_with_country) %>% 
  mutate(subject_incapable_consent = ifelse(subject_subjects_incapable_of_giving_consent_personally == TRUE, 1, 0)) %>% 
  select(eudract_id, subject_incapable_consent)

eu_elderly = eu1 %>% select(eudract_number_with_country, subject_elderly) %>% 
  mutate(num_elderly_patient = ifelse(is.na(subject_elderly), 0, subject_elderly)) %>% 
  select(eudract_number_with_country, num_elderly_patient) %>% 
  mutate(elderly_eligible = 1) %>% 
  rename(eudract_id = eudract_number_with_country)

eu_healthy_volunteers = eu1 %>% select(eudract_number_with_country, subject_healthy_volunteers) %>% 
  mutate(subject_healthy_volunteers = ifelse(subject_healthy_volunteers == TRUE, 1, 0)) %>% 
  rename(eudract_id = eudract_number_with_country,
         healthy_volunteers = subject_healthy_volunteers)

```


Since the datasets consists more than 100 columns, we extract only the column with relevant informations, the mapping to the column name and the information is as follows: 

  eudract_number_with_country - id
  us_nct_clinicaltrials_gov_registry_number - nct_id
  
  sponsors - sponsors, collaborators
  trial_term - disease
  trial_therapeutic_area - disease
  date_on_which_this_record_was_first_entered_in_the_eudract_data - start date
  member_state_concerned - country
  
  trial_human_pharmacology_phase_i - phase 1
  trial_therapeutic_exploratory_phase_ii - phase 2
  trial_therapeutic_confirmatory_phase_iii - phase 3
  trial_therapeutic_use_phase_iv - phase 4
  subject_in_the_whole_clinical_trial - # of patients
  trial_status - status
  date_of_the_global_end_of_the_trial -  end date

Notes: 
  1. cannot find exact start date, use first record date instead
  2. trial_therapeutic_area has 30% missing values, and trial_term has 20% missing values, together they have 12% missing values
  
### Clean the Data

Now, we want to construct a dataset with only the mentioned columns

```{r}
#Select only the useful columns from the eu1 dataset
eu2 = eu1 %>% select("eudract_number_with_country", "us_nct_clinicaltrials_gov_registry_number", "sponsors", "trial_term", "trial_therapeutic_area", "date_on_which_this_record_was_first_entered_in_the_eudract_data", "member_state_concerned", "trial_human_pharmacology_phase_i", "trial_therapeutic_exploratory_phase_ii", "trial_therapeutic_confirmatory_phase_iii", "trial_therapeutic_use_phase_iv", "subject_in_the_whole_clinical_trial", "trial_status", "date_of_the_global_end_of_the_trial", "trial_randomised", "trial_parallel_group", "trial_cross_over", "trial_controlled", "covid")
```


#### sponsors, collaborators - sponsors

```{r eval=FALSE}
# Create columns name_of_sponsor, country, and name_of_organisation_providing_support from the sponsors column
# Transfer the column sponsor to a data frame sponsors_df
sponsors_df = data.frame()

for (i in seq_along(eu2$sponsors)){
  id = eu2$eudract_number_with_country[i]
  observation = eu2$sponsors[i]
  
  if(observation == "[]"){     #observations with value "[]" (missing values) returns an empty list instead of a data frame with fromJSON()
    sponsors_df = bind_rows(sponsors_df, fromJSON("[{}]") %>% mutate(id = id)) 
  }else{
    sponsors_df = bind_rows(sponsors_df, fromJSON(observation) %>% mutate(id = id))
  }
}

# Select the columns needed from sponsors_df, including id, name_of_sponsor, and status_of_the_sponsor(which will later be used to determine if the sponsor is in industry or not)
# Ignore organization providing support for now
selected_sponsors_df = sponsors_df[, c("id", "name_of_sponsor", "status_of_the_sponsor")]

# Combine selected_sponsors_df to eu2 and discard the column sponsor
eu3 = left_join(selected_sponsors_df, eu2, by = c("id" = "eudract_number_with_country"))

eu3 = eu3 %>% select(-"sponsors")

# Change the column status_of_the_sponsor into another dummy variable column industry_dummy
eu3 = eu3 %>% mutate(industry_dummy = case_when(
  status_of_the_sponsor == "Commercial" ~ 1,
  status_of_the_sponsor == "Non-Commercial" ~ 0,
  )) %>% 
  select(-"status_of_the_sponsor")

# Add column collab_num counting the number of collaborators for each trial
eu_collab_num_name = eu3 %>% 
  mutate(industry_collab = ifelse(industry_dummy == 1, name_of_sponsor, NA),
         non_industry_collab = ifelse(industry_dummy == 0, name_of_sponsor, NA)) %>% 
  group_by(id) %>% 
  reframe(collab_num = n()-1, 
          collaborator = list(unique(name_of_sponsor)),
          industry_collab = list(unique(industry_collab[!is.na(industry_collab)])),
          non_industry_collab = list(unique(non_industry_collab[!is.na(non_industry_collab)]))) 

eu3 = eu3 %>% 
  left_join(eu_collab_num_name, by = "id") %>% 
  mutate(collaborator = map2(collaborator, name_of_sponsor, ~ .x[.x != .y]),
         industry_collab = map2(industry_collab, name_of_sponsor, ~ .x[.x != .y]),
         non_industry_collab = map2(non_industry_collab, name_of_sponsor, ~ .x[.x != .y]))


# additional dataset to analyze collaborator
eu_trial_with_collab = selected_sponsors_df %>% 
  group_by(id) %>% 
  summarize(count = n()) %>% 
  filter(count > 1) %>% 
  distinct(id) %>% 
  pull(id)

eu_cosponsor = selected_sponsors_df %>% 
  filter(id %in% eu_trial_with_collab) %>% 
  select(cosponsor_name = name_of_sponsor, eudract_id = id, sponsor_type = status_of_the_sponsor)
```

Note: 
  1. Some observations have multiple sponsor information, some are duplicates and some are different sponsor information. What is the best solution? For now I use only the first one 
  2. Whats the difference between sponsor and organization providing support?

```{r}
# Note: some observations have multiple sponsors, for now the values are stored in multiple_sponsors_per_obsv
# Exploratory code
multiple_sponsors_per_obsv = data.frame()

for (observation in eu2$sponsors){
  if (!is.null(nrow(fromJSON(observation))) && nrow(fromJSON(observation)) > 1){
    multiple_sponsors_per_obsv = bind_rows(sponsors_df, fromJSON(observation))
  }
}

head(multiple_sponsors_per_obsv, 100)

# show the distribution of number of rows each JSON text converts to 
temp = c()
for (observation in eu2$sponsors){
  temp = c(temp, nrow(fromJSON(observation)))
}
table(temp)
```

#### start_year, start_date, end_date

Create `start_year`, `start_date` from `date_on_which_this_record_was_first_entered_in_the_eudract_data`,
and `end_date` form `date_of_the_global_end_of_the_trial`

```{r eval=FALSE}
#Create variable start_year, start_date, end_date
eu3 = eu3 %>% 
  rename(start_date = date_on_which_this_record_was_first_entered_in_the_eudract_data) %>% 
  mutate(start_year = year(start_date)) %>% 
  rename(end_date = date_of_the_global_end_of_the_trial)
```

#### country

Create the variable `country` base on `member_state_concerned`

```{r}
#Exam the values of member_state_concerned
#table(eu3$member_state_concerned)

#Notice every observation follows the form "country - agency" except Bulgaria
#Change the observations with value "Bulgarian Drug Agency" into "Bulgaria - temp"
eu4 = eu3 %>%
  mutate(member_state_concerned = ifelse(member_state_concerned == "Bulgarian Drug Agency", "Bulgaria - temp", member_state_concerned))

#Create variable country
eu4 = eu4 %>% separate(member_state_concerned, into = c("country", "agency"), sep = " - ") %>% 
  select(-"agency")
```

#### disease

We want to create a column disease indicating the research area the clinical trial targets. The closest standardized variable is "trial_therapeutic_area", which we will be using the level 1 area code (CXX) to represent the disease.

Note: These are the potential columns from eu1 that we can use, but none of these use mesh terms:
"trial_medical_condition_s_being_investigated", "trial_term", "trial_medical_condition_in_easily_understood_language"

```{r}
#Create disease from trial_therapeutic_area
eu5 = eu4 %>% 
  mutate(disease_code = substr(trial_therapeutic_area, nchar(eu4$trial_therapeutic_area)-3,nchar(eu4$trial_therapeutic_area)-1)) %>% 
  select(-trial_term, -trial_therapeutic_area) #remove trial_term and trial_therapeutic_area


eu4 %>% select(id, trial_therapeutic_area)
```

#### randomized,  single_group, parallel, and covid

  This is related to the design of the trial, randomized takes values of 1 and 0 denoting TRUE and FALSE, single_group takes value of 1 if trial_parallel_group, trial_cross_over, trial_controlled are all FALSE.
  
##### Note: since the raw dataset is missing a single_group column, we define a trial as single group if trial_parallel_group, trial_cross_over, trial_controlled are all FALSE.

```{r}
eu5 = eu5 %>% 
  mutate(randomized = ifelse(trial_randomised == TRUE, 1, 0)) %>% 
  mutate(single_group = ifelse(trial_parallel_group == FALSE & trial_cross_over == FALSE & trial_controlled == FALSE, 1, 0)) %>% 
  mutate(parallel_group = ifelse(trial_parallel_group == TRUE, 1, 0)) %>% 
  mutate(covid = ifelse(is.na(covid), 0, covid)) %>% 
  select(-c(trial_randomised, trial_parallel_group, trial_cross_over, trial_controlled))

```

#### (other variables)

#### change variable names

Change `id` to `eudract_id`,
`subject_in_the_whole_clinical_trial` to `patient_num`,
`us_nct_clinicaltrials_gov_registry_number` to `nct_id`,
`trial_human_pharmacology_phase_i` to `phase_1`,
`trial_therapeutic_exploratory_phase_ii` to `phase_2`,
`trial_therapeutic_confirmatory_phase_iii` to `phase_3`,
`trial_therapeutic_use_phase_iv` to `phase_4`,
`subject_in_the_whole_clinical_trial` to `patient_num`,
`trial_status` to `status`,
`name_of_sponsor` to `sponsor`

```{r}
#Code here 
eu6 = eu5 %>% 
  rename(
    eudract_id = id,
    patient_num = subject_in_the_whole_clinical_trial,
    nct_id = us_nct_clinicaltrials_gov_registry_number,
    phase_1 = trial_human_pharmacology_phase_i,
    phase_2 = trial_therapeutic_exploratory_phase_ii,
    phase_3 = trial_therapeutic_confirmatory_phase_iii,
    phase_4 = trial_therapeutic_use_phase_iv,
    status = trial_status,
    sponsor = name_of_sponsor
  )

```


Note: the classification of the area of study follows the MeSH tree classification, so for standardization we should use the browse_conditions table from AACT database, which also name their conditions based on MeSH tree classification.

## US data

### Import the Data

```{r}
#Load the US data sets, from the "Pipe-Delimited Files" from the AACT website with the most up-to-date version

us_browse_conditions = read_csv("US data/delimited data/browse_conditions.txt")
us_conditions = read_csv("US data/delimited data/conditions.txt")
us_countries = read_csv("US data/delimited data/countries.txt")
us_sponsors = read_csv("US data/delimited data/sponsors.txt")
us_studies = read_csv("US data/delimited data/studies.txt")
us_designs = read_csv("US data/delimited data/designs.txt")

#Notice that the data set is only with one column with "|" separating the different variables
#Separate the data into different variables in different columns

us_browse_conditions = separate(us_browse_conditions, col = "id|nct_id|mesh_term|downcase_mesh_term|mesh_type", into = c("id", "nct_id", "mesh_term", "downcase_mesh_term", "mesh_type"), sep = "\\|")
us_conditions = separate(us_conditions, col = "id|nct_id|name|downcase_name", into = c("id", "nct_id", "name", "downcase_name"), sep = "\\|")
us_countries = separate(us_countries, col = "id|nct_id|name|removed", into = c("id", "nct_id", "name", "removed"), sep = "\\|")
us_sponsors = separate(us_sponsors, col = "id|nct_id|agency_class|lead_or_collaborator|name", into = c("id", "nct_id", "agency_class", "lead_or_collaborator", "name"), sep = "\\|")
us_studies = separate(us_studies, col = colnames(us_studies)[1], into = unlist(strsplit(colnames(us_studies)[1], "\\|")), sep = "\\|")
us_designs = separate(us_designs, col = colnames(us_designs)[1], into = unlist(strsplit(colnames(us_designs)[1], "\\|")), sep = "\\|")


# Create datasets for later use
# us_elderly
us_baseline_counts = read_csv("US data/delimited data/baseline_measurements.txt")
us_baseline_counts = separate(us_baseline_counts, col = colnames(us_baseline_counts)[1], 
                              into = unlist(strsplit(colnames(us_baseline_counts)[1], "\\|")), sep = "\\|")
us_eligibilities = read_csv("US data/delimited data/eligibilities.txt")
us_eligibilities = separate(us_eligibilities, col = colnames(us_eligibilities)[1], 
                            into = unlist(strsplit(colnames(us_eligibilities)[1], "\\|")), sep = "\\|")

us_elderly_count = us_baseline_counts %>% 
  filter(title == "Age, Categorical") %>% 
  filter(category == ">=65 years") %>% 
  mutate(param_value_num = ifelse(param_value_num %in% c("", "NA"), "0", param_value_num)) %>% 
  group_by(nct_id) %>% 
  summarize(num_elderly_patient = sum(as.numeric(param_value_num))) %>% 
  filter(num_elderly_patient != 0)

us_elderly_eligible = us_eligibilities %>% 
  filter(older_adult == "t") %>% 
  select(nct_id) %>% 
  mutate(elderly_eligible = 1) 

us_elderly = us_elderly_count %>% full_join(us_elderly_eligible, by = "nct_id") %>% 
  mutate(elderly_eligible = 1,
         num_elderly_patient = ifelse(is.na(num_elderly_patient), 0, num_elderly_patient)) 


# us_accept_healthy_volunteers
us_healthy_volunteers = us_eligibilities %>% 
  select(nct_id, healthy_volunteers) %>% 
  mutate(healthy_volunteers = ifelse(healthy_volunteers == "t", 1, 0))


# us_plan_to_share_ipd
us_plan_to_share_ipd = us_studies %>% 
  select(nct_id, plan_to_share_ipd) %>% 
  filter(plan_to_share_ipd %in% c("YES", "NO")) %>% 
  mutate(plan_to_share_ipd_yes = ifelse(plan_to_share_ipd == "YES", 1, 0),
         plan_to_share_ipd_no = ifelse(plan_to_share_ipd == "NO", 1, 0)) %>% 
  select(-plan_to_share_ipd)

show(us_sponsors)
```



```{r}
# exploratory code
participant_flows = read_csv("US data/delimited data/participant_flows.txt")
participant_flows = separate(participant_flows, col = colnames(participant_flows)[1], into = unlist(strsplit(colnames(participant_flows)[1], "\\|")), sep = "\\|")

participant_flows = participant_flows %>% filter(units == "Participants") %>% filter(param_type == "NUMBER") %>% 
  mutate(outcome_patient_count = as.numeric(param_value)) %>% 
  group_by(nct_id) %>% 
  summarize(outcome_patient_count = sum(outcome_patient_count))


baseline_counts = read_csv("US data/delimited data/baseline_counts.txt")
baseline_counts = separate(baseline_counts, col = colnames(baseline_counts)[1], into = unlist(strsplit(colnames(baseline_counts)[1], "\\|")), sep = "\\|")

outcome_counts = read_csv("US data/delimited data/outcome_counts.txt")
outcome_counts = separate(outcome_counts, col = colnames(outcome_counts)[1], into = unlist(strsplit(colnames(outcome_counts)[1], "\\|")), sep = "\\|")

baseline_counts %>% filter(units == "Participants") %>% 
  mutate(patient_count = as.numeric(param_value)) %>% select(nct_id, result_group_id, ctgov_group_code, patient_count)
  select(nct_id, patient_count) %>% 
  group_by(nct_id) %>% 
  summarize(patient_count = sum(patient_count)) %>% 
  left_join(temp2 %>% filter(units == "Participants") %>% 
    mutate(outcome_patient_count = as.numeric(count)) %>% 
    select(nct_id, result_group_id, ctgov_group_code, outcome_patient_count) %>% 
    group_by(nct_id) %>% 
    summarize(outcome_patient_count = sum(outcome_patient_count)), by = c("nct_id"="nct_id")) %>% 
  filter(!is.na(patient_count) & !is.na(outcome_patient_count)) %>% 
  filter(patient_count >= outcome_patient_count)
  
baseline_counts %>% filter(scope != "overall")
```


*Note:* we want to investigate the participants number and recruitment rate:
  baseline_counts has the overall participants count for each clinical trials, but I'm not sure if this is before or after recruiting. Note that column ctgov_group_code split some trials into different arms with different count of each arm.
  outcome_counts counting the number of patients when observing outcome of the trial, which means the number of patients finishing the trials. But its tricky here because one nct_id has various different ways of partitioning their participants, and simply adding the number of aprticipants of one nct_id is counting the same participants multiple times, which is hard to capture the dropotu rate.
  participant_flows has recruitment detail for some of the trails in text format, which a small portion of it mentioned the number of patients recruited compared to number of patients planend to recruit. This is useful but very minimal information.



Since the US data scatters in multiple datasets, here's the mapping from each datasets to the key variables they provide:

  studies - start and end date, Phase, status, # of patients
  browse_conditions - disease (MeSH)
  conditions - disease
  countries - country
  sponsors - lead: sponsors, collaborators: collaborators
  designs - allocation, intervention_model
  
### Combine Datasets

Here, we want to select only the useful variables from each dataset and combine them

```{r}
#Extract only the necessary column from each dataset

#Select start_date, end_date, phase, status from us_studies, also select enrollment to compare to patient_num acquired from us_baseline_counts
us_studies_reduced = us_studies %>% 
  rename(end_date = completion_date, status = overall_status, patient_num = enrollment) %>% 
  select(nct_id, start_date, end_date, phase, status, patient_num)

# Mark the trials that are COVID-19 related
us_covid = us_studies %>% 
  filter(str_detect(official_title, str_c(c("COVID", "Covid", "covid", "SARS-CoV-2"), collapse = "|"))) %>% 
  mutate(covid = 1) %>% 
  select(nct_id, covid)

#Collapse the different diseases for the same trial into one observation and select disease from us_conditions

#use us_browse_conditions instead

#us_conditions_reduced = us_conditions %>%
#  rename(disease = downcase_name) %>% 
#  group_by(nct_id) %>%
#  summarize(disease = paste(unique(disease), collapse = ", ")) %>%
#  ungroup() %>% 
#  select(nct_id, disease)

#Select country from us_countries
#Note: what do we do if a trial has multiple country value
us_countries_reduced = us_countries %>% 
  rename(country = name) %>% 
  distinct(nct_id, country)

#Separate us_sponsors in to us_collaborator(collaborator) and us_sponsor(lead), and then select and count collaborator from us_collaborator and sponsors from us_sponsors
us_collaborator = us_sponsors %>% filter(lead_or_collaborator == "collaborator")
us_sponsor = us_sponsors %>% filter(lead_or_collaborator == "lead")

us_collaborator_reduced = us_collaborator %>% 
  rename(collaborator = name) %>%
  mutate(industry_collab = ifelse(agency_class == "INDUSTRY", collaborator, NA),
         non_industry_collab = ifelse(agency_class != "INDUSTRY", collaborator, NA)) %>% 
  group_by(nct_id) %>%
  summarize(collab_num = n(), 
            collaborator = list(unique(collaborator)),
            industry_collab = list(unique(industry_collab[!is.na(industry_collab)])),
            non_industry_collab = list(unique(non_industry_collab[!is.na(non_industry_collab)]))) %>%
  ungroup() %>% 
  select(nct_id, collab_num, collaborator, industry_collab, non_industry_collab)

us_sponsor_reduced = us_sponsor %>% 
  rename(sponsor = name) %>% 
  mutate(industry_dummy = ifelse(agency_class == "INDUSTRY", 1, 0)) %>% 
  select(nct_id, sponsor, industry_dummy)

us_designs_reduced = us_designs %>% 
  mutate(randomized = ifelse(allocation == "RANDOMIZED", 1, 0)) %>% 
  mutate(single_group = ifelse(intervention_model == "SINGLE_GROUP", 1, 0)) %>% 
  mutate(parallel_group = ifelse(intervention_model == "PARALLEL", 1, 0)) %>% 
  select(nct_id, randomized, single_group, parallel_group)

# Create extra list of collaborator for further analysis
us_collaborator_list = us_collaborator %>% 
  select(collaborator_name = name, nct_id = nct_id, collaborator_type = agency_class)

# Create a dataset of industry collaborators to further match to the concatenated company list
us_industry_collaborator = us_collaborator %>% 
  filter(agency_class == "INDUSTRY") %>% 
  select(nct_id, collab_name = name)

us_non_industry_collaborator = us_collaborator %>% 
  filter(agency_class != "INDUSTRY") %>% 
  select(nct_id, collab_name = name)


# exploratory data
us_sponsors %>% arrange(nct_id, desc(lead_or_collaborator))

```


```{r}
#Combine the datasets into us1

#Create a list consisting all datasets
us_datasets = list(us_studies_reduced, us_conditions_reduced, us_countries_reduced, us_sponsor_reduced, us_collaborator_reduced, us_designs_reduced, us_covid)

#Combine US datasets
us1 = reduce(us_datasets, full_join, by = "nct_id")

#Check the unique nct_id
length(unique(us1$nct_id))
```

### Clean the Data

#### phase_0, phase_1, phase_2, phase_3, phase_4

Create phase_0, phase_1, phase_2, phase_3, phase_4 from phase

```{r}
#Create five one-hot coded variable for phase 0 through 4
us1 = us1 %>% 
  mutate(phase_0 = phase %in% c("EARLY_PHASE1")) %>% 
  mutate(phase_1 = phase %in% c("PHASE1", "PHASE1/PHASE2")) %>%
  mutate(phase_2 = phase %in% c("PHASE1/PHASE2", "PHASE2", "PHASE2/PHASE3")) %>%
  mutate(phase_3 = phase %in% c("PHASE2/PHASE3", "PHASE3")) %>%
  mutate(phase_4 = phase %in% c("PHASE4")) %>% 
  select(-"phase")
```

#### start_year

Create start_year from start_date

```{r}
#Convert start_date and end_date into type date
us1 = us1 %>% 
  mutate(start_date = as_date(start_date),
         end_date = as_date(end_date)) %>% 
  mutate(start_year = year(start_date))

```

#### disease

To standardize disease, we will be using separate dataset us_browse_conditions which maps each unique US trials to multiple disease mesh terms. In order to map from the mesh terms to the mesh_code, we will be using the mesh_trees dataset. 

Then, we create a dataset mapping each unique trial to one mesh_code by selecting the level 1 code with the most occurrences for each unique trials.


```{r}
#View us_browse_conditions to see the related area per nct_id
us_browse_conditions = read_csv("US data/delimited data/browse_conditions.txt")

us_browse_conditions = separate(us_browse_conditions, col = "id|nct_id|mesh_term|downcase_mesh_term|mesh_type", into = c("id", "nct_id", "mesh_term", "downcase_mesh_term", "mesh_type"), sep = "\\|")

#There's multiple diseases per trial
#Use the mesh_trees dataset to create mapping from nct_id to mesh_term to mesh_code which is a one-to-many relation
mesh_trees = read_csv("US data/mesh_trees_2017.csv")
```

```{r}
nct_id_mesh_term_disease_code = left_join(us_browse_conditions, mesh_trees, by = c("mesh_term" = "dscrptr")) %>% select(nct_id, mesh_term, tree2level)

nct_id_mesh_term_disease_code %>% 
  

```

```{r}
# Exploratory code
# Count amount of one-to-many relationship
many_to_many_us_disease = nct_id_mesh_term_disease_code %>% 
  group_by(nct_id, mesh_term) %>%
  summarize(count = n()) %>% 
  filter(count > 1)

nrow(many_to_many_us_disease)
```

```{r}

#Create a dataset nct_id_mesh_code mapping each unique nct_id to the level 1 mesh_code with the most occurrences 
#### Major change: only retain the disease code that starts with C
nct_id_mesh_term_disease_code = nct_id_mesh_term_disease_code %>% 
  mutate(disease_code = substr(tree2level, 1, 3)) %>%
  filter(str_starts(disease_code, "C"))

nct_id_disease_code = data.frame()

nct_id_disease_code = nct_id_mesh_term_disease_code %>% 
  group_by(nct_id, disease_code) %>%  # Group by both nct_id and mesh_code
  summarize(count = n()) %>%       # Count occurrences of each mesh_code per nct_id
  ungroup() %>%                    # Ungroup to work with the data freely
  group_by(nct_id) %>%             # Group by nct_id to find the most frequent mesh_code
  filter(count == max(count)) %>%  # Filter the rows with the most frequent mesh_code
  slice(1) %>%                     # In case of ties, take the first occurrence
  select(nct_id, disease_code) 


# This second level mesh term matching will be used in later section
nct_id_disease_code_tree2 = nct_id_mesh_term_disease_code %>% 
  rename(disease_code_tree2 = tree2level) %>% 
  filter(nchar(disease_code_tree2) > 3) %>% 
  group_by(nct_id, disease_code_tree2) %>%  # Group by both nct_id and mesh_code
  summarize(count = n()) %>%       # Count occurrences of each mesh_code per nct_id
  ungroup() %>%                    # Ungroup to work with the data freely
  group_by(nct_id) %>%             # Group by nct_id to find the most frequent mesh_code
  filter(count == max(count)) %>%  # Filter the rows with the most frequent mesh_code
  slice(1) %>%                     # In case of ties, take the first occurrence
  select(nct_id, disease_code_tree2) %>% 
  ungroup()


```

Now, with the mapping dataset nct_id_mesh_code, we can create the column disease_code in the US dataset

```{r}
#Left join nct_id_disease_code to us1 so that each unique trial has a disease_code
us2 = left_join(us1, nct_id_disease_code, by = "nct_id")

#Note that 13.6% of US trials have missing value for disease_code
sum(is.na(us2$disease_code)) / nrow(us2)
```


## Combine US&EU Data

Note that the latest version of EU dataset is eu5, and the latest version of the US dataset is us1.
Now, we want to select the columns needed for both datasets and combine them

```{r}
#Select the columns needed for both datasets 
eu7 = eu6 %>% 
  rename(disease_code_eu = disease_code) %>% 
  select("nct_id", "eudract_id", "sponsor", "industry_dummy", "country", "disease_code_eu", "start_year", "phase_1", "phase_2", "phase_3", "phase_4", "patient_num", "end_date", "status", "randomized", "single_group", "parallel_group", "start_date", "end_date", "collab_num", "collaborator", "industry_collab", "non_industry_collab", "covid")
  
us3 = us2 %>% 
  rename(disease_code_us = disease_code) %>% 
  mutate(patient_num = as.numeric(patient_num)) %>% 
  select("nct_id", "sponsor", "industry_dummy", "country", "disease_code_us", "start_year", "phase_1", "phase_2", "phase_3", "phase_4", "patient_num", "end_date", "status", "randomized", "single_group", "parallel_group", "start_date", "end_date", "collab_num", "collaborator", "industry_collab", "non_industry_collab", "covid")

#For trial in eu6 having nct_id, us the corresponding start_year from us2
eu7 = eu7 %>%
  left_join(us2 %>% distinct(nct_id, start_year), by = "nct_id", suffix = c("_eu", "_us")) %>%
  mutate(start_year = coalesce(start_year_us, start_year_eu)) %>%
  select(-start_year_us, -start_year_eu)

eu6 %>% distinct(disease_code)
```


```{r}
#Combine two datasets
clinical_trials_1 = bind_rows(us3, eu7)

```

### Clean Variables

#### disease

What we have now is only disease_code, we also want to create disease_term based on the mesh_tree dataset, as well as creating an index for each disease_code.

```{r}
# Create column disease_code based on disease_code_eu and disease_code_us
clinical_trials_1 = clinical_trials_1 %>% 
  mutate(disease_code = coalesce(disease_code_eu, disease_code_us))

#Create mapping from each disease_code to level 1 disease_term
disease_code_to_term =  mesh_trees %>% 
  filter(level == 1) %>% 
  select(mesh_tree, dscrptr)

#Map each disease_term to each disease_code in clinical_trials_2
clinical_trials_2 = clinical_trials_1 %>% 
  left_join(disease_code_to_term, by = c("disease_code" = "mesh_tree")) %>% 
  rename(disease_term = dscrptr)
```

```{r}
#Create a mapping from each disease_code to disease_id
disease_code_to_id = clinical_trials_2 %>% 
  distinct(disease_code) %>% 
  arrange(disease_code) %>% 
  mutate(disease_id = ifelse(is.na(disease_code), NA, row_number()))

# Create mapping table disease_id_code_term for future use
disease_id_code_name = disease_code_to_id %>% 
  left_join(disease_code_to_term, by = c("disease_code" = "mesh_tree")) %>% 
  select(disease_id, mesh_code = disease_code, disease_name = dscrptr)

#Map each disease_index to each disease_code in clinical_trials_2
clinical_trials_2 = clinical_trials_2 %>% 
  left_join(disease_code_to_id, by = c("disease_code" = "disease_code"))



```



#### sponsor

We wish to standardize the companies by changing them all into lowercase and only keep the alphanumeric characters. In addition, we want to create an unique index for each companies, for companies names that belong to the same company but have slightly different names, we want them to share the same index. 

We will be performing fuzzy match using the stringdist package.

```{r}
#Standardize sponsor, and then group and arrange the combined dataset, also unlist and clean the collaborator columns
clinical_trials_3 = clinical_trials_2 %>%
  mutate(sponsor = str_to_lower(sponsor)) %>%  # Convert to lowercase
  mutate(sponsor = str_replace_all(sponsor, "[^a-z0-9\\s]", "")) %>%  # Remove non-alphanumeric characters
  mutate(sponsor = str_trim(sponsor)) %>%   
  mutate(collaborator = as.character(map(collaborator, ~ .x %>%                  # Clean collaborator names
                         str_to_lower() %>%                         # Convert to lowercase
                         str_replace_all("[^a-z0-9\\s]", "") %>%    # Remove non-alphanumeric characters
                         str_trim() %>%                             # Trim whitespace
                         str_c(collapse = ", ")))) %>%                # collapse the list of collaborator names
  mutate(industry_collab = as.character(map(industry_collab, ~ .x %>%                  # Clean collaborator names
                         str_to_lower() %>%                         # Convert to lowercase
                         str_replace_all("[^a-z0-9\\s]", "") %>%    # Remove non-alphanumeric characters
                         str_trim() %>%                             # Trim whitespace
                         str_c(collapse = ", ")))) %>% 
  mutate(non_industry_collab = as.character(map(non_industry_collab, ~ .x %>%                  # Clean collaborator names
                         str_to_lower() %>%                         # Convert to lowercase
                         str_replace_all("[^a-z0-9\\s]", "") %>%    # Remove non-alphanumeric characters
                         str_trim() %>%                             # Trim whitespace
                         str_c(collapse = ", ")))) %>% 
  group_by(sponsor, disease_code, start_year, country) %>%
  arrange(sponsor, disease_code, start_year) %>% 
  ungroup() %>% 
  rename(sponsor_name = sponsor)


# Also clean the collaborator name in us_industry_collaborator
us_industry_collaborator_clean = us_industry_collaborator %>% 
  mutate(collab_name = as.character(map(collab_name, ~ .x %>%                  # Clean collaborator names
                         str_to_lower() %>%                         # Convert to lowercase
                         str_replace_all("[^a-z0-9\\s]", "") %>%    # Remove non-alphanumeric characters
                         str_trim())))

us_non_industry_collaborator_clean = us_non_industry_collaborator %>% 
  mutate(collab_name = as.character(map(collab_name, ~ .x %>%                  # Clean collaborator names
                         str_to_lower() %>%                         # Convert to lowercase
                         str_replace_all("[^a-z0-9\\s]", "") %>%    # Remove non-alphanumeric characters
                         str_trim())))

eu_industry_collaborator_clean = eu6 %>% 
  filter(collab_num > 0,
         industry_dummy == 1) %>% 
  mutate(collab_name = as.character(map(sponsor, ~ .x %>%                  # Clean collaborator names
                         str_to_lower() %>%                         # Convert to lowercase
                         str_replace_all("[^a-z0-9\\s]", "") %>%    # Remove non-alphanumeric characters
                         str_trim()))) %>% 
  select(eudract_id, collab_name) %>% 
  filter(!is.na(collab_name))

eu_non_industry_collaborator_clean = eu6 %>% 
  filter(collab_num > 0,
         industry_dummy == 0) %>% 
  mutate(collab_name = as.character(map(sponsor, ~ .x %>%                  # Clean collaborator names
                         str_to_lower() %>%                         # Convert to lowercase
                         str_replace_all("[^a-z0-9\\s]", "") %>%    # Remove non-alphanumeric characters
                         str_trim()))) %>% 
  select(eudract_id, collab_name) %>% 
  filter(!is.na(collab_name))
  

```

```{r}
# Clean company and sponsor suffixes
suffixes = c("llc", "inc", "corp", "corporation", "limited", "co", "company", "ltd", "nasdaq\\w*")

clinical_trials_4 = clinical_trials_3 %>%
  mutate(sponsor_name = str_remove_all(sponsor_name, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>%
  mutate(sponsor_name = str_trim(sponsor_name)) %>% 
  mutate(collaborator = str_remove_all(collaborator, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>%
  mutate(collaborator = str_trim(collaborator)) %>% 
  mutate(industry_collab = str_remove_all(industry_collab, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>%
  mutate(industry_collab = str_trim(industry_collab)) %>% 
  mutate(non_industry_collab = str_remove_all(non_industry_collab, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>%
  mutate(non_industry_collab = str_trim(non_industry_collab))

# also clean suffixes for us_industry_collaborator
us_industry_collaborator_clean = us_industry_collaborator_clean %>% 
  mutate(collab_name = str_remove_all(collab_name, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>% 
  mutate(collab_name = str_trim(collab_name))

us_non_industry_collaborator_clean = us_non_industry_collaborator_clean %>% 
  mutate(collab_name = str_remove_all(collab_name, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>% 
  mutate(collab_name = str_trim(collab_name))

eu_industry_collaborator_clean = eu_industry_collaborator_clean %>% 
  mutate(collab_name = str_remove_all(collab_name, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>% 
  mutate(collab_name = str_trim(collab_name))

eu_non_industry_collaborator_clean = eu_non_industry_collaborator_clean %>% 
  mutate(collab_name = str_remove_all(collab_name, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>% 
  mutate(collab_name = str_trim(collab_name))

```


**This following section is the original method to create sponsor name matching. The matching dataset is then being refined and we will updated the false negatives from the matched dataset**

```{r, eval=FALSE}
# Assign index to each unique sponsors, use Jaro-Winkler distance to determine if different sponsor names are the same organization

# Following code from ChatGPT
# Function to calculate Jaro-Winkler distance in batches
distance_matrix = function(company_names, batch_size = 1000, method = "jw") {
  n = length(company_names)  # Get the total number of company names
  dist_list = list()         # Create an empty list to store distance matrix chunks
  
  # Loop through the data in batches
  for (i in seq(1, n, by = batch_size)) {
    end = min(i + batch_size - 1, n)  # Define the end of the current batch
    dist_chunk = stringdistmatrix(company_names[i:end], company_names, method = method)  # Calculate the distance
    dist_list[[length(dist_list) + 1]] <- dist_chunk  # Store the chunk in the list
  }
  
  # Combine the distance matrix chunks back together
  dist_matrix = do.call(rbind, dist_list)
  return(dist_matrix)
}

# Apply hierarchical clustering and assign indices based on the distance matrix
assign_fuzzy_index = function(company_names, batch_size = 1000, method = "jw", cut_height = 0.1) {
  # Get the distance matrix in batches
  dist_matrix = distance_matrix(company_names, batch_size, method)
  
  # Perform hierarchical clustering
  clusters = hclust(as.dist(dist_matrix))
  
  # Cut the dendrogram to define clusters
  cluster_groups = cutree(clusters, h = cut_height)
  
  return(cluster_groups)  # Return the cluster group indices
}

# 865051 observations in clinical_trials_4
```

  Before we fuzzy match, we want to also match with the names in the firm_founding_year2 dataset, which is a list of companies with their year founded information. 
  
  We want to create a mapping list, firm_name_founding_year_id, which include all company names from clinical_trials_4 and firm_founding_year2, along with their unique matched id and the year_founded information from firm_founding_year2.
  
  Note that the hyperparamter cut_height has value 0.09 as a result of tuning in order to reach 90% distinctness for company names in firm_founding_year2 which is already unique.
  
```{r, eval=FALSE}
# Load and Create firm_founding_year2
# Load the company_found_year datasets and fix the formatting 
biotech1 = row_to_names(read_excel("FoundingYear/biotech1.xls"), row_number = 2)
biotech2 = row_to_names(read_excel("FoundingYear/biotech2.xls"), row_number = 2)
biotech3 = row_to_names(read_excel("FoundingYear/biotech3.xls"), row_number = 2)
pharma1 = row_to_names(read_excel("FoundingYear/pharma1.xls"), row_number = 2)
pharma2 = row_to_names(read_excel("FoundingYear/pharma2.xls"), row_number = 2)
pharma3 = row_to_names(read_excel("FoundingYear/pharma3.xls"), row_number = 2)
pharma4 = row_to_names(read_excel("FoundingYear/pharma4.xls"), row_number = 2)

#Combine all of the datasets into firm_founding_year
datasets = list(biotech1, biotech2, biotech3, pharma1, pharma2, pharma3, pharma4)
firm_founding_year1 = do.call(rbind, datasets) %>% distinct(`Excel Company ID`, .keep_all = TRUE)

# Clean the company names and only select the useful columns
firm_founding_year2 = firm_founding_year1 %>%
  rename(company_name = `Company Name`) %>% 
  rename(year_founded = `Year Founded`) %>% 
  mutate(company_name = str_to_lower(company_name)) %>%  # Convert to lowercase
  mutate(company_name = str_replace_all(company_name, "[^a-z0-9\\s]", "")) %>%  # Remove non-alphanumeric characters
  mutate(company_name = str_remove_all(company_name, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>%
  mutate(company_name = str_trim(company_name))  %>% 
  rename(sponsor_name = company_name) %>% 
  mutate(year_founded = ifelse(year_founded == "-", NA, year_founded)) %>%
  select(sponsor_name, year_founded) %>% 
  filter(!is.na(year_founded)) # The purpose of this dataset is to map year_founded, so there's no need using observations without year_founded

# 45437 companies in firm_founding_year2
clinical_trials_4
```

 Now we want to apply fuzzy match on the combined list of company names from clinical_trials_4 and firm_founding_year2, in order to maximize the results, we want to separate the company names in the following groups:
 
  - Companies with names starting with numbers
  - Companies with name shorter than 10 characters
  - Companies with long names starting with a-g
  - Companies with long names starting with h-q
  - Companies with long names starting with r-z


```{r, eval=FALSE, fuzzy mapping}
# Create the mapping dataset firm_name_founding_year_id and perform fuzzy match to assign unique sponsor_id
firm_name_founding_year_id = bind_rows(firm_founding_year2 %>% select(sponsor_name), clinical_trials_4 %>% select(sponsor_name)) %>%
  distinct(sponsor_name) %>% 
  left_join(firm_founding_year2, by = join_by(sponsor_name)) %>% 
  arrange(sponsor_name) # 96224 unique company names

# Check the distribution of company name lengths and starting letters
firm_name_founding_year_id %>% ggplot(aes(x = nchar(sponsor_name))) + geom_histogram(bins = 50) + xlim(0, 50)
firm_name_founding_year_id %>% filter(!str_detect(sponsor_name, "^\\d")) %>% ggplot(aes(x = substr(sponsor_name, 1, 1))) + geom_bar()

# filter out and fuzzy match company names starting with (numbers, a-g, h-q, r-z)
firm_name_founding_year_id_numeric_start = firm_name_founding_year_id %>%
  filter(str_detect(sponsor_name, "^\\d")) %>% 
  mutate(sponsor_id = assign_fuzzy_index(sponsor_name, batch_size = 1000, cut_height = 0.01))
firm_name_founding_year_id_numeric_start$sponsor_id %>% max() # max sponsor_id 276

firm_name_founding_year_id_short = firm_name_founding_year_id %>%
  distinct(sponsor_name, .keep_all = TRUE) %>% 
  filter(!str_detect(sponsor_name, "^\\d")) %>% 
  filter(nchar(sponsor_name) <= 10) %>% 
  mutate(sponsor_id = assign_fuzzy_index(sponsor_name, batch_size = 1000, cut_height = 0.03))
firm_name_founding_year_id_short$sponsor_id %>% max() # max sponsor_id 13345

firm_name_founding_year_id_long_a_to_g = firm_name_founding_year_id %>% 
  distinct(sponsor_name, .keep_all = TRUE) %>% 
  filter(nchar(sponsor_name) > 10) %>% 
  filter(str_detect(sponsor_name, "^[A-Ga-g]")) %>% 
  mutate(sponsor_id = assign_fuzzy_index(sponsor_name, batch_size = 1000, cut_height = 0.1)) %>% 
  distinct(sponsor_name, .keep_all = TRUE)
firm_name_founding_year_id_long_a_to_g$sponsor_id %>% max() # max sponsor_id 27185

firm_name_founding_year_id_long_h_to_q = firm_name_founding_year_id %>% 
  distinct(sponsor_name, .keep_all = TRUE) %>% 
  filter(str_detect(sponsor_name, "^[H-Qh-q]")) %>% 
  filter(nchar(sponsor_name) > 10) %>%
  mutate(sponsor_id = assign_fuzzy_index(sponsor_name, batch_size = 1000, cut_height = 0.1)) %>% 
  distinct(sponsor_name, .keep_all = TRUE)
firm_name_founding_year_id_long_h_to_q$sponsor_id %>% max() # max sponsor_id 27151

firm_name_founding_year_id_long_r_to_z = firm_name_founding_year_id %>%
  distinct(sponsor_name, .keep_all = TRUE) %>% 
  filter(str_detect(sponsor_name, "^[R-Zr-z]")) %>% 
  filter(nchar(sponsor_name) > 10) %>%
  mutate(sponsor_id = assign_fuzzy_index(sponsor_name, batch_size = 1000, cut_height = 0.1)) %>% 
  distinct(sponsor_name, .keep_all = TRUE)
firm_name_founding_year_id_long_r_to_z$sponsor_id %>% max() # max sponsor_id 19205

# Combine the four indexed dataset to the complete firm_name_founding_year_id, by shifting indexes
firm_name_founding_year_id = firm_name_founding_year_id_numeric_start %>% 
  rbind(firm_name_founding_year_id_short %>% mutate(sponsor_id = 276 + sponsor_id)) %>% 
  rbind(firm_name_founding_year_id_long_a_to_g %>% mutate(sponsor_id = 276 + 13345 + sponsor_id)) %>% 
  rbind(firm_name_founding_year_id_long_h_to_q %>% mutate(sponsor_id = 276 + 13345 + 27185 + sponsor_id)) %>% 
  rbind(firm_name_founding_year_id_long_r_to_z %>% mutate(sponsor_id = 276 + 13345 + 27185 + 27151 + sponsor_id)) # 95853 observations

# Exploratory code
firm_name_founding_year_id %>% filter(str_detect(sponsor_name, "bayer"))
firm_name_founding_year_id %>% filter(str_detect(sponsor_name, "novartis"))
```

**End of sponsor name matching section**

```{r}
# False negatives
# Import the refined sponsor_name_found_year_id dataset
library(readxl)
company_matching_false_negative = read_excel("Sponsors/sponsor_founding_matching_1112.xlsx")
company_matching_false_negative = company_matching_false_negative %>% select(sponsor_name, sponsor_id, false_negative)

# Update firm_name_founding_year_id with identified false negatives
firm_name_founding_year_id_new = firm_name_founding_year_id %>% 
  left_join(company_matching_false_negative, by = c("sponsor_name" = "sponsor_name", "sponsor_id" = "sponsor_id")) %>% 
  mutate(sponsor_id = ifelse(is.na(false_negative), sponsor_id, false_negative))



# False positives
# Import the sponsor list identifying false positives
company_matching_false_positive = read_csv("Sponsors/sponsor_id_foundedyear_firsttrialyear_1121 (1).csv")
company_matching_false_positive = company_matching_false_positive %>% select(sponsor_id, `False Positive`, name_1, name_2, name_3, name_4, name_5, name_6, name_7, name_8) %>% filter(!is.na(`False Positive`))
company_matching_false_positive = company_matching_false_positive %>%
  pivot_longer(
    cols = starts_with("name_"),        # Specify columns to pivot (e.g., name_1, name_2, etc.)
    names_to = "name_type",             # Create a column to hold the original column names
    values_to = "name"                  # Create a column to hold the values (names)
  ) %>%
  filter(!is.na(name)) %>%              # Remove rows where the `name` column is NA
  select(-name_type) 

# Notice there will still be some false negatives if we treat all false positives as different companies, to fix this, let's export them as a xlsx file and manually fix them and make sure they're well behaved
#write_xlsx(company_matching_false_positive, "company_matching_false_positive.xlsx")

# After manually going over and correcting the false positives, we load back in the false positive datasaet
false_positive_corrected = read_excel("Sponsors/company_matching_false_positive.xlsx")
false_positive_corrected = false_positive_corrected %>% 
  select(sponsor_id, false_positive, sponsor_name)

# Obtain the maximum sponsor_id in order to assign new sponsor_ids for false positives
max_sponsor_id = firm_name_founding_year_id_new %>% pull(sponsor_id) %>% max()

# Update the false positives index with the new indeces
false_positive_corrected = false_positive_corrected %>% 
  mutate(false_positive = false_positive + max_sponsor_id)

# Update firm_name_founding_year_id_new with identified false positives
firm_name_founding_year_id_new = firm_name_founding_year_id_new %>% 
  left_join(false_positive_corrected, by = c("sponsor_name" = "sponsor_name", "sponsor_id" = "sponsor_id")) %>% 
  mutate(sponsor_id = ifelse(is.na(false_positive), sponsor_id, false_positive)) %>% 
  mutate(sponsor_id = ifelse(is.na(false_negative), sponsor_id, false_negative))

# Add the sources to the firm name dataset
firm_name_founding_year_id_source = firm_name_founding_year_id_new %>% 
  left_join(clinical_trials_4 %>% 
  select(sponsor_name, nct_id, eudract_id) %>% 
  distinct(sponsor_name, .keep_all = TRUE) %>% 
  mutate(source = ifelse(!is.na(eudract_id), "EU", "AACT")) %>% 
  select(sponsor_name, source), by = "sponsor_name") %>% 
  mutate(source = ifelse(is.na(source), "FoundingYearData", source))




# Add the sponsor name and the mapped id to the dataset
sponsor_name_id = firm_name_founding_year_id_new %>% select(sponsor_name, sponsor_id) # only sponsor name and id

clinical_trials_5 = clinical_trials_4 %>% 
  left_join(sponsor_name_id, by = c("sponsor_name" = "sponsor_name")) %>% 
  select("nct_id", "eudract_id", "sponsor_name", "industry_dummy", "sponsor_id", "disease_code", "disease_code_eu", "disease_code_us", "disease_term", "disease_id", "start_year",  "country", "phase_1", "phase_2", "phase_3", "phase_4", "patient_num", "end_date", "status", "randomized", "single_group", "parallel_group", "start_date", "end_date", "collab_num", "collaborator", "industry_collab", "non_industry_collab", "covid")

# 865051 observations

```


#### collaborator

The goal of this section is to create a list of collaborators, both from the EU dataset and the US dataset (AACT).

First, we map the US collaborators to the previously curated firm_name_founding_year_id_source. Creating a list of valid collaborators
Then, we use the same logic to get EU collaborators and add the two collab lists together.

```{r}
# Match US collaborator names to the sponsor firm name list 
# Note: Code generated by Claude

# Define the mapping function for collaborators
match_collaborators_to_sponsors <- function(collaborators_df, sponsors_df, 
                                           threshold = 0.1, batch_size = 1000, source = "AACT collab") {
  # Extract sponsor names and create ID mapping
  sponsor_names <- sponsors_df$sponsor_name
  sponsor_id_map <- deframe(sponsors_df %>% select(sponsor_name, sponsor_id))
  
  # Get unique collaborator names
  unique_collab_names <- collaborators_df %>% distinct(collab_name) %>% pull()
  
  # Initialize results dataframe
  match_results <- tibble(
    collab_name = unique_collab_names,
    sponsor_id = NA_integer_,
    best_sponsor_name = NA_character_  # Added this column
  )
  
  # Process collaborator names in batches
  n_collabs <- length(unique_collab_names)
  
  for (i in seq(1, n_collabs, by = batch_size)) {
    # Define the batch range
    end_idx <- min(i + batch_size - 1, n_collabs)
    current_batch <- unique_collab_names[i:end_idx]
    
    # Calculate distance matrix for this batch against all sponsors
    dist_batch <- stringdistmatrix(current_batch, sponsor_names, method = "jw")
    
    # For each name in the batch, find the best match
    for (j in 1:length(current_batch)) {
      # Get the absolute index in the original vector
      abs_idx <- i + j - 1
      
      # Find the index of the best match (minimum distance)
      best_idx <- which.min(dist_batch[j, ])
      best_distance <- dist_batch[j, best_idx]
      
      # Special case: check for exact name matches first
      exact_match_idx <- which(sponsor_names == current_batch[j])
      if (length(exact_match_idx) > 0) {
        # Prioritize exact matches
        best_idx <- exact_match_idx[1]
        best_distance <- 0
      }
      
      # Only assign if match is good enough
      if (best_distance <= threshold) {
        best_sponsor_name <- sponsor_names[best_idx]
        best_sponsor_id <- sponsor_id_map[[best_sponsor_name]]
        
        # Store in results
        match_results$sponsor_id[abs_idx] <- best_sponsor_id
        match_results$best_sponsor_name[abs_idx] <- best_sponsor_name  # Store the sponsor name
      }
    }
  }
  
  # Join the match results back with the full collaborators dataframe
  result <- collaborators_df %>%
    left_join(match_results, by = "collab_name") %>%
    mutate(source = source)
  
  return(result)
}



# Use the function to map the industry collaborator names to the indexed firm name list
matched_collaborators_us <- match_collaborators_to_sponsors(
  collaborators_df = us_industry_collaborator_clean,
  sponsors_df = firm_name_founding_year_id_source,
  threshold = 0.06,
  batch_size = 1000  # Adjust based on your system's memory capacity
)

matched_collaborators_eu <- match_collaborators_to_sponsors(
  collaborators_df = eu_industry_collaborator_clean,
  sponsors_df = firm_name_founding_year_id_source,
  threshold = 0.06,
  batch_size = 1000,  # Adjust based on your system's memory capacity
  source = "EU collab"
)


# Clean the matched collaborators by dropping unmatched ones and get unique collab_names
matched_collaborators_us = matched_collaborators_us %>% 
  distinct(collab_name, .keep_all = TRUE) %>% 
  select(-nct_id) %>% 
  select(sponsor_id, best_sponsor_name, collab_name, source) %>% 
  filter(!is.na(sponsor_id)) %>% 
  arrange(sponsor_id)

matched_collaborators_eu = matched_collaborators_eu %>% 
  distinct(collab_name, .keep_all = TRUE) %>% 
  select(-eudract_id) %>% 
  select(sponsor_id, best_sponsor_name, collab_name, source) %>% 
  filter(!is.na(sponsor_id)) %>% 
  arrange(sponsor_id)

matched_collaborators = bind_rows(matched_collaborators_us, matched_collaborators_eu) %>% 
  arrange(sponsor_id)

# matched_collaborators will be used in the future sections



# Now do the same for non industry collaborators
matched_non_ind_collaborators_us <- match_collaborators_to_sponsors(
  collaborators_df = us_non_industry_collaborator_clean,
  sponsors_df = firm_name_founding_year_id_source,
  threshold = 0.06,
  batch_size = 1000  # Adjust based on your system's memory capacity
)

matched_non_ind_collaborators_eu <- match_collaborators_to_sponsors(
  collaborators_df = eu_non_industry_collaborator_clean,
  sponsors_df = firm_name_founding_year_id_source,
  threshold = 0.06,
  batch_size = 1000,  # Adjust based on your system's memory capacity
  source = "EU collab"
)

matched_non_ind_collaborators_us = matched_non_ind_collaborators_us %>% 
  distinct(collab_name, .keep_all = TRUE) %>% 
  select(-nct_id) %>% 
  select(sponsor_id, best_sponsor_name, collab_name, source) %>% 
  filter(!is.na(sponsor_id)) %>% 
  arrange(sponsor_id)

matched_non_ind_collaborators_eu = matched_non_ind_collaborators_eu %>% 
  distinct(collab_name, .keep_all = TRUE) %>% 
  select(-eudract_id) %>% 
  select(sponsor_id, best_sponsor_name, collab_name, source) %>% 
  filter(!is.na(sponsor_id)) %>% 
  arrange(sponsor_id)

matched_non_ind_collaborators = bind_rows(matched_non_ind_collaborators_us, matched_non_ind_collaborators_eu) %>% 
  arrange(sponsor_id)



firm_name_founding_year_id_source

```




#### country

Standardize country names

```{r}
# Create a mapping list from names of countries used in our dataset to distinct and non-repeating country names in the world
# Load a list of all countries in the world, with another row distinct country
countries = read_csv("Countries/countries.csv") %>% 
  mutate(distinct_name = Country) %>% 
  select(Country, distinct_name)

# Extract the distinct list of names of countries in our dataset, then left join the list of countries from the previous step. Create a dataset distinct_country
standardized_country = clinical_trials_5 %>% 
  distinct(country) %>% 
  arrange(country) %>% 
  left_join(countries, by = c("country" = "Country")) 

# Check the number of names of countries not in the distinct list
standardized_country %>% filter(is.na(distinct_name)) # There are 46 names not in the distinct list

# For each name of countries not having a distinct name, map them to an existing name or create a distinct name
# Mapping based on research of region/country names 
standardized_country = standardized_country %>% mutate(distinct_name = case_when(
  !is.na(distinct_name) ~ distinct_name,
  country == "Aland Islands" ~ "Finland",
  country == "Antarctica" ~ "Antarctica",
  country == "Antigua and Barbuda" ~ "Antigua and Barbuda",
  country == "Bahamas" ~ "Bahamas",
  country == "Bonaire, Sint Eustatius and Saba" ~ "Netherlands",
  country == "Bosnia and Herzegovina" ~ "Bosnia and Herzegovina",
  country == "Brunei Darussalam" ~ "Brunei Darussalam",
  country == "CZECHIA" ~ "Czech Republic",
  country == "Central African Republic" ~ "Central African Republic",
  country == "Congo" ~ "Congo",
  country == "Congo, The Democratic Republic of the" ~ "Congo",
  country == "Czechia" ~ "Czech Republic",
  country == "Cte D'Ivoire" ~ "Ivory Coast",
  country == "Federated States of Micronesia" ~ "Federated States of Micronesia",
  country == "Former Serbia and Montenegro" ~ "Former Serbia and Montenegro",
  country == "Former Yugoslavia" ~ "Former Yugoslavia",
  country == "Gambia" ~ "Gambia",
  country == "Holy See (Vatican City State)" ~ "Vatican City State",
  country == "Iran, Islamic Republic of" ~ "Iran",
  country == "Korea, Republic of" ~ "South Korea",
  country == "Kosovo" ~ "Kosovo",
  country == "Lao People's Democratic Republic" ~ "Laos",
  country == "Libyan Arab Jamahiriya" ~ "Libya",
  country == "Macedonia, The Former Yugoslav Republic of" ~ "Macedonia",
  country == "Moldova, Republic of" ~ "Moldova",
  country == "Montenegro" ~ "Montenegro",
  country == "Myanmar" ~ "Myanmar",
  country == "North Macedonia" ~ "North Macedonia",
  country == "Northern Mariana Islands" ~ "United States",
  country == "Palestinian Territories, Occupied" ~ "Palestine",
  country == "Palestinian Territory, occupied" ~ "Palestine",
  country == "Russian Federation" ~ "Russia",
  country == "Runion" ~ "France",
  country == "Saint Kitts and Nevis" ~ "Saint Kitts and Nevis",
  country == "Saint Martin" ~ "Saint Martin",
  country == "South Georgia and the South Sandwich Islands" ~ "United Kingdom",
  country == "South Sudan" ~ "South Sudan",
  country == "Syrian Arab Republic" ~ "Syria",
  country == "The Democratic Republic of the Congo" ~ "Congo",
  country == "Timor-Leste" ~ "Timor-Leste",
  country == "Trinidad and Tobago" ~ "Trinidad and Tobago",
  country == "UK" ~ "United Kingdom",
  country == "United States Minor Outlying Islands" ~ "United States",
  country == "Virgin Islands (U.S.)" ~ "United States"
))

```


```{r}
# Map the country values to the standardized names 
clinical_trials_5 = clinical_trials_5 %>% 
  left_join(standardized_country, by = "country") %>% 
  mutate(country = distinct_name) %>% 
  select(-distinct_name)

# 865051
```


We want to also add an index for countries

```{r}
# Create column country_id 
# Create a mapping from each country to country_id
country_name_to_id = clinical_trials_5 %>% 
  distinct(country) %>% 
  arrange(country) %>% 
  mutate(country_id = ifelse(is.na(country), NA, row_number()))

#Map each disease_index to each disease_code in clinical_trials_2
clinical_trials_6 = clinical_trials_5 %>% 
  left_join(country_name_to_id, by = "country") %>% 
  select("nct_id", "eudract_id", "sponsor_name", "industry_dummy", "sponsor_id", "disease_code", "disease_code_eu", "disease_code_us", "disease_term", "disease_id", "start_year",  "country", "country_id", "phase_1", "phase_2", "phase_3", "phase_4", "patient_num", "status", "randomized", "single_group", "parallel_group", "start_date", "end_date", "collab_num", "collaborator", "industry_collab", "non_industry_collab", "covid")

# 865051
```

#### status

```{r}
# Look at the distinct values of status
#clinical_trials_6 %>% distinct(status)

# reclassify the statuses into "ongoing", "completed", "terminated", and "" for invalid input
# Classification might be subject to change 
clinical_trials_6 = clinical_trials_6 %>% mutate(status = case_when(
  status %in% c("Ongoing", "NOT_YET_RECRUITING", "ACTIVE_NOT_RECRUITING", "RECRUITING", "ENROLLING_BY_INVITATION") ~ "ongoing",
  status %in% c("Completed", "COMPLETED", "APPROVED_FOR_MARKETING") ~ "completed",
  status %in% c("TERMINATED", "WITHDRAWN", "Prematurely Ended", "Trial now transitioned", "Restarted", "Temporarily Halted", "SUSPENDED", "Prohibited by CA", "Suspended by CA", "WITHHELD") ~ "terminated",
  TRUE ~ ""
)) 

# 81702/865051 trials have invalid status value
```
#### Note: Classification might be subject to change 


### Change NA values to blank, TRUE/FALSE to 1/0

```{r}
# Change NA values to blank, TRUE/FALSE to 1/0, also change end_data to end_year

clinical_trials_7 = clinical_trials_6 %>% 
  mutate(nct_id = ifelse(is.na(nct_id), "", nct_id)) %>% 
  mutate(eudract_id = ifelse(is.na(eudract_id), "", eudract_id)) %>% 
  mutate(sponsor_name = ifelse(is.na(sponsor_name), "", sponsor_name)) %>% 
  mutate(industry_dummy = ifelse(is.na(industry_dummy), "", industry_dummy)) %>% 
  mutate(sponsor_id = ifelse(is.na(sponsor_id), "", sponsor_id)) %>% 
  mutate(disease_code = ifelse(is.na(disease_code), "", disease_code)) %>% 
  mutate(disease_code_eu = ifelse(is.na(disease_code_eu), "", disease_code_eu)) %>% 
  mutate(disease_code_us = ifelse(is.na(disease_code_us), "", disease_code_us)) %>% 
  mutate(disease_term = ifelse(is.na(disease_term), "", disease_term)) %>% 
  mutate(disease_id = ifelse(is.na(disease_id), "", disease_id)) %>% 
  mutate(start_year = ifelse(is.na(start_year), "", start_year)) %>% 
  mutate(country = ifelse(is.na(country), "", country)) %>% 
  mutate(country_id = ifelse(is.na(country_id), "", country_id)) %>% 
  mutate(patient_num = ifelse(is.na(patient_num), "", patient_num)) %>%
  mutate(randomized = ifelse(is.na(randomized), "", randomized)) %>%
  mutate(single_group = ifelse(is.na(single_group), "", single_group)) %>%
  mutate(parallel_group = ifelse(is.na(parallel_group), "", parallel_group)) %>%
  mutate(end_year = ifelse(is.na(end_date), "", year(end_date))) %>% 
  mutate(collab_num = ifelse(is.na(collab_num), 0, collab_num)) %>% 
  mutate(collaborator = ifelse(is.na(collaborator), "", collaborator)) %>% 
  mutate(industry_collab = ifelse(is.na(industry_collab), "", industry_collab)) %>% 
  mutate(non_industry_collab = ifelse(is.na(non_industry_collab), "", non_industry_collab)) %>% 
  mutate(covid = ifelse(is.na(covid), 0, covid)) %>% 
  mutate(phase_1 = ifelse(phase_1 == TRUE, 1, 0)) %>% 
  mutate(phase_2 = ifelse(phase_2 == TRUE, 1, 0)) %>% 
  mutate(phase_3 = ifelse(phase_3 == TRUE, 1, 0)) %>% 
  mutate(phase_4 = ifelse(phase_4 == TRUE, 1, 0)) 

# 865051
```

### Remove Duplicates

We want to remove the duplicates observations. First, we check them on the sponsor, country, nct_id, eudract_id level, then we look for EU trials also recorded in US dataset

```{r}
# Frist, check at the sponsor, country, nct_id, eudract_id level, since we have different trials with the same nct_id due to country, and different trials with the same eudract_id due to sponsor
clinical_trials_7 %>% 
  group_by(sponsor_id, country_id, nct_id, eudract_id) %>% 
  count() %>% 
  nrow()
```

```{r}
# Notice that there are 862993 unique trials where there are 865051 rows, we remove these obvious duplicates first
clinical_trials_8 = clinical_trials_7 %>% 
  distinct(sponsor_id, country_id, nct_id, eudract_id, .keep_all=TRUE)

# From 865051 to 862993 observations
```

Moving on, we want to make sure there's no overlap in EU data and the US data, on the sponsor-disease-start_year-country level.
First, we single out a subset, eu_with_nct_id, with trials in EU data that has an nct_id (potentially in US data).
Then, we remove the eudract_id in eu_with_nct_id, and also remove this subset from clinical_trials_7.
Lastly, we select the unique trials on the nct_id-sponsor-disease-start_year-country level.

```{r}
# Create subset, eu_with_nct_id
eu_with_nct_id = clinical_trials_8 %>% 
  filter(nct_id != "") %>% 
  filter(eudract_id != "")

# Remove eu_with_nct_id from clinical_trials_8
clinical_trials_9 = clinical_trials_8 %>% 
  anti_join(eu_with_nct_id, by = names(eu_with_nct_id))

# Erase the eudract_id in eu_with_nct_id to "impersonate" a US trial
eu_with_nct_id = eu_with_nct_id %>% mutate(eudract_id = "")

# Add the modified eu_with_nct_id back to clinical_trials_8 and select unique trials on the nct_id-eudract_id-sponsor-disease-start_year-country level
# Note we also want to include eudract_id because we might mistake distinct trials with missing values in other variables as the same trial
clinical_trials_9 = clinical_trials_9 %>% 
  bind_rows(eu_with_nct_id) %>% 
  distinct(nct_id, eudract_id, sponsor_id, disease_id, start_year, country_id, .keep_all=TRUE)

# From 862993 to 855992
```

## Construct datasets for easier use

### main_raw_dataset, trial_country_dataset, trial_disease_firm_dataset

```{r}
# rearrange the trials and assign a unique id to them, call the dataset main_raw_dataset
main_raw_dataset = clinical_trials_9 %>% 
  group_by(sponsor_name, disease_id, start_year) %>% 
  arrange(sponsor_name, disease_id, start_year, country_id) %>% 
  ungroup() %>% 
  mutate(trial_id = row_number()) %>% 
  mutate(source = ifelse(eudract_id == "", "AACT", "EU"))

main_raw_dataset = main_raw_dataset %>% 
  select(trial_id, names(main_raw_dataset)) # 858602

# fix one minor sponsor name error for one observation
main_raw_dataset = main_raw_dataset %>% mutate(sponsor_name = ifelse(sponsor_name == "department of \ngynaecology helse finnmark klinikk \nhammerfest", "department of gynaecology helse finnmark klinikk hammerfest", sponsor_name)) 


# Create trial_country_dataset and trial_disease_firm_dataset from main_raw_dataset
trial_country_dataset = main_raw_dataset %>% 
  select(trial_id, nct_id, eudract_id, country, country_id) # 858602

trial_disease_firm_dataset = main_raw_dataset %>% 
  select(trial_id, nct_id, eudract_id, sponsor_name, industry_dummy, sponsor_id, disease_code, disease_code_eu, disease_code_us, disease_term, disease_id, start_year, phase_1, phase_2, phase_3, phase_4, patient_num, end_year, status) # 858602


```


### firm_year_dataset

#### Create trial_firm_detail 

Use main_raw_dataset as a starting point, create a dataset firm_year_dataset with unit of analysis being firm(sponsor) and year.
Recall in the "sponsor" section in "Combine US&EU Data", we have a dataset, firm_name_founding_year_id, with all company names, company ids, and year founded for some of the companies.

```{r}
# Create dataset trial_firm_detail
# map year_founded to each company id in main_raw_dataset (with selected rows)
trial_firm_detail_1 = main_raw_dataset %>% 
  left_join(firm_name_founding_year_id %>% 
              mutate(sponsor_found_year = ifelse(is.na(year_founded), "", year_founded)) %>% 
              mutate(sponsor_id = as.character(sponsor_id)) %>% 
              select(sponsor_name, sponsor_id, sponsor_found_year), by = c("sponsor_name" = "sponsor_name", "sponsor_id" = "sponsor_id")) %>% 
  select(trial_id, sponsor_name, sponsor_id, sponsor_found_year, start_year, country, phase_1, phase_2, phase_3, phase_4, patient_num, status, end_year, industry_dummy, source, disease_id, nct_id, eudract_id, randomized, single_group, parallel_group, start_date, end_date, collab_num, collaborator, industry_collab, non_industry_collab, covid) %>% 
  mutate(sponsor_found_year = ifelse(is.na(sponsor_found_year), "", sponsor_found_year))


# create variable matched_capiq indicating the company matched their founded year from firm_name_founding_year_id
trial_firm_detail_1 = trial_firm_detail_1 %>% 
  mutate(matched_capiq = ifelse(sponsor_found_year == "", 0, 1))


# 855991
```

##### Define valid trials

Before we complete the construction of the datsset, which includes a lot of interation between variables, we want to set definitions of what defines a "valid" observation, here;s how I can think of to define a "valid" trial:

 - A trial needs to have a valid sponsor name
 - A trial needs to have at least one phase
 - A trial needs to have a start year
 - A trial's start year cannot be earlier than its sponsor's founded year
 - Since the scope of this project is up to 2024, any end_year after 2024 will be dropped
 - A trial not having an end_year:
   - if the status is "completed" or "terminated", then the trial should be discarded
   - if the status is missing, we assume the trial is still ongoing
 - A trial having an end year but not a status will be excluded
 - A trial having start_year larger than end_year will be excluded
 - An ongoing trial does not need end_year 
 
For companies missing sponsor_found_year, we will use their earliest trial start year as their founded year.
Also, we want to add a region classifier, taking values from "EU", "US", or "Others".
Additionally, for trials classifies as multiple phases, we define it as the latter phase.


```{r}
# Trim the dataset based on the aforementioned rules
trial_firm_detail_2 = trial_firm_detail_1 %>% # 855992, 48765, 14388
  filter(sponsor_name != "") %>% # 855758, 48763, 14387
  filter(!(phase_1 == 0 & phase_2 == 0 & phase_3 == 0 & phase_4 == 0)) %>% # 504137, 27505, 8892
  filter(start_year != "") %>% # 501591, 27418, 8835
  filter(start_year > sponsor_found_year) %>% # 499732, 27371, 8790
  mutate(end_year = ifelse(end_year > "2024", "", end_year)) %>% 
  mutate(end_date = as.Date(ifelse(end_date > as.Date("2024-12-31"), NA, end_date))) %>% 
  filter(!(end_year == "" & (status == "completed" | status == "terminated"))) %>% # 464764, 26243, 8412
  mutate(status = ifelse(status == "" & end_year == "", "ongoing", status)) %>% 
  filter(!(status == "" & !(end_year == ""))) %>% # 444336, 24108, 7836
  mutate(end_year = ifelse(end_year == "", "3000", end_year)) %>% 
  filter(start_year <= end_year) %>% # 443737, 23980, 7813 
  mutate(end_year = ifelse(end_year == "3000", "", end_year)) %>% 
  mutate(end_year = ifelse(status == "ongoing", "", end_year)) 

# fill in sponsor_found_year with minimum start_year
trial_firm_detail_2 = trial_firm_detail_2 %>%
  group_by(sponsor_id) %>%
  mutate(sponsor_found_year = ifelse(sponsor_found_year == "", min(start_year), sponsor_found_year)) %>% 
  ungroup() %>% 
  mutate(sponsor_id = as.numeric(sponsor_id))

# Classify each trial's phase as the latest one
trial_firm_detail_2 = trial_firm_detail_2 %>% 
  mutate(phase_1 = ifelse(phase_2 == 1|phase_3 == 1|phase_4 == 1, 0, phase_1)) %>% 
  mutate(phase_2 = ifelse(phase_3 == 1|phase_4 == 1, 0, phase_2)) %>% 
  mutate(phase_3 = ifelse(phase_4 == 1, 0, phase_3))


# 443737
```

```{r}
# Create the region variable
eu_countries = c("Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", "Czech Republic", "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", "Ireland", "Italy", "Latvia", "Lithuania", "Luxembourg", "Malta", "Netherlands", "Poland", "Portugal", "Romania", "Slovakia", "Slovenia", "Spain", "Sweden", "United Kingdom") 

trial_firm_detail_3 = trial_firm_detail_2 %>% mutate(region = case_when(
  country == "United States" ~ "US",
  country %in% eu_countries ~ "EU",
  TRUE ~ "Others"
))

# 443737
```

##### Update disease_id_code_name and clean mesh codes

  Update disease_id_code_name with number of trials per disease_id 
  
```{r}
# calculate number of p2 trials for each disease_id
disease_id_code_name = disease_id_code_name %>% left_join(
  trial_firm_detail_3 %>% 
    filter(phase_2 == 1) %>% 
    mutate(disease_id = as.numeric(disease_id)) %>% 
    group_by(disease_id) %>% 
    summarize(p2_trial_count = n()), by = "disease_id"
)


# Sine non C level mesh codes are invalid, we here change them into NAs to simplify future engineering
trial_firm_detail_3 = trial_firm_detail_3 %>% 
  mutate(disease_id = as.character(ifelse(as.numeric(disease_id) >= 26, NA, disease_id))) %>% 
  mutate(disease_id = ifelse(is.na(disease_id), "", disease_id)) 

# create a sample of 10 phase 2 trials with no disease_ids
no_disease_id_sample = trial_firm_detail_3 %>% filter(disease_id == "", phase_2 == 1) %>% sample_n(10)

```


#### Zombie trials and collaborator classification

  Through future steps investigating phase 2 trials, we found out that some trials has weirdly long trial length, inflatind the counts on ongoing trials oer year. Therefore we investigated the distribution of trial length and define the ongoing trials with unusual length as "zombie_trials". 
  
  We use two methods to classify zombie trials:
   - trial length longer than 75 percentile of industry finished (competed/terminated) trials
   - trial length as outliar of ongoing trials (beyond 1.5 times the interquartile range (IQR) over 3rd quartile)
   
```{r}
# calculate phase 2 trial length in days
p2trial_length_unique_trial_id_days = trial_firm_detail_3 %>% 
  filter(phase_2 == TRUE) %>% # 146130
  mutate(end_date = as.Date(ifelse(is.na(end_date), "3000-12-31", as.character(end_date)))) %>% 
  filter(start_date <= end_date) %>% # 145997
  mutate(end_date = as.Date(ifelse(end_date == as.Date("3000-12-31"), NA, end_date))) %>% 
  mutate(end_date = as.Date(ifelse(status == "ongoing", NA, end_date))) %>% # 145997
  mutate(status = ifelse(is.na(status), "ongoing", status)) %>% 
  mutate(end_date = as.Date(ifelse(is.na(end_date), "2024-11-13", as.character(end_date)))) %>% 
  mutate(trial_length_days = as.numeric(end_date - start_date)) %>% 
  select(trial_id, status, start_date, end_date, country, trial_length_days, industry_dummy, nct_id, eudract_id) %>% 
  mutate(across(everything(), ~ replace_na(., "")))



# Define zombie trials with first method
p2trial_length_unique_trial_id_days %>% 
  filter(industry_dummy == 1) %>% 
  filter(status != "ongoing") %>% summary() # Find that 75% percentile is 1277 for finished trials
phase_2_zombie_75percent = p2trial_length_unique_trial_id_days %>% 
  filter(status == "ongoing") %>% 
  mutate(phase_2_zombie_75percent = ifelse(trial_length_days > 1277, 1, 0)) %>% 
  select(trial_id, phase_2_zombie_75percent)

# Define zombie trials with second method
p2trial_length_unique_trial_id_days %>% 
  filter(status == "ongoing") %>% summary() # find outliar cutoff = 2177 + 1.5*(2177-603) = 4538
phase_2_zombie_outliar = p2trial_length_unique_trial_id_days %>% 
  filter(status == "ongoing") %>% 
  mutate(phase_2_zombie_outliar = ifelse(trial_length_days > 4538, 1, 0)) %>% 
  select(trial_id, phase_2_zombie_outliar)


# Merge the zombie trials obtained with both methods into trial_firm_detail_3
trial_firm_detail_3 = trial_firm_detail_3 %>% 
  left_join(phase_2_zombie_75percent) %>% 
  left_join(phase_2_zombie_outliar) %>% 
  select(-start_date, -end_date) %>% 
  mutate(sponsor_id = ifelse(is.na(sponsor_id), "", sponsor_id)) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))





# Additionally, add different classifications of collaborators
# including new, existing, recent, and established collaborators to the trials
trial_new_existing_recent_established = trial_firm_detail_3 %>%
  select(trial_id, sponsor_id, start_year, collab_num, collaborator) %>%
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(collab_num > 0) %>%
  mutate(collaborator_list = str_split(collaborator, ",\\s*")) %>%
  unnest(collaborator_list) %>%  # One row per collaborator
  group_by(sponsor_id, collaborator_list) %>%
  mutate(first_year = min(start_year)) %>% 
  ungroup() %>%
  group_by(trial_id) %>%
  summarise(
    collab_new = any(start_year == first_year),
    collab_existing = any(start_year - first_year >= 1),
    collab_recent = any(start_year - first_year >= 1 & start_year - first_year <= 2),
    collab_established = any(start_year - first_year >= 3),
    .groups = "drop",
    collab_new = ifelse(collab_new == TRUE, 1, 0),
    collab_existing = ifelse(collab_existing == TRUE, 1, 0),
    collab_recent = ifelse(collab_recent == TRUE, 1, 0),
    collab_established = ifelse(collab_established == TRUE, 1, 0)
  ) %>% 
  ungroup()

trial_firm_detail_3 = trial_firm_detail_3 %>% 
  mutate(collab = ifelse(collab_num > 0, 1, 0)) %>% 
  left_join(trial_new_existing_recent_established, by = "trial_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0)))
  

# 443742
```

   
#### Consturct firm_year_dataset

  Construct the firm_year_dataset from trial_firm_detail sponsor-year panel

```{r}
# Create variable year, which spans from founded year to 2024 for each company
firm_year_dataset_1 = trial_firm_detail_3 %>% 
  distinct(sponsor_id, sponsor_found_year, .keep_all = TRUE) %>% 
  select(sponsor_id, sponsor_name, sponsor_found_year, industry_dummy) %>% 
  rowwise() %>%
  mutate(year = list(seq(sponsor_found_year, 2024))) %>%
  unnest(year) %>% 
  select(-sponsor_found_year) %>% 
  mutate(year = as.character(year))

# Note that some companies share different names but have the same sponsor_id, we want to make sure all sponsor_id year combination is unique
firm_year_dataset_1 = firm_year_dataset_1 %>% distinct(sponsor_id, year, .keep_all = TRUE) %>% arrange(sponsor_id, year)

# 320776
```

##### Add trial counts for each start/end year and phase

  For each phase, create phase_x_start, phase_x_start_eu, phase_x_start_us, phase_x_start_others, which covers overall and regional start information. As for end date, create phase_x_enddate_comp, phase_x_enddate_term, phase_x_startdate_comp, phase_x_startdate_term, pointing out the end date and the start date of complete/terminated trials.
  
  This would create 8 column per trials, total 32 columnd.

```{r}
# phase 1 start, start_eu, start_us, start_others, complete, terminate
phase_1_start = trial_firm_detail_3 %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_1_start = n(), .groups = 'drop') 
phase_1_start_eu = trial_firm_detail_3 %>% 
  filter(region == "EU") %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_1_start_eu = n(), .groups = 'drop')
phase_1_start_us = trial_firm_detail_3 %>% 
  filter(region == "US") %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_1_start_us = n(), .groups = 'drop')
phase_1_start_others = trial_firm_detail_3 %>% 
  filter(region == "Others") %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_1_start_others = n(), .groups = 'drop')
phase_1_enddate_comp = trial_firm_detail_3 %>% 
  filter(status == "completed") %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_1_enddate_comp = n(), .groups = 'drop') 
phase_1_enddate_term = trial_firm_detail_3 %>% 
  filter(status == "terminated") %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_1_enddate_term = n(), .groups = 'drop') 
phase_1_startdate_comp = trial_firm_detail_3 %>% 
  filter(status == "completed") %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_1_startdate_comp = n(), .groups = 'drop') 
phase_1_startdate_term = trial_firm_detail_3 %>% 
  filter(status == "terminated") %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_1_startdate_term = n(), .groups = 'drop') 


# phase 2 start, start_eu, start_us, start_others, complete, terminate
phase_2_start = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_start = n(), .groups = 'drop') 
phase_2_start_eu = trial_firm_detail_3 %>% 
  filter(region == "EU") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_start_eu = n(), .groups = 'drop')
phase_2_start_us = trial_firm_detail_3 %>% 
  filter(region == "US") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_start_us = n(), .groups = 'drop')
phase_2_start_others = trial_firm_detail_3 %>% 
  filter(region == "Others") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_start_others = n(), .groups = 'drop')
phase_2_enddate_comp = trial_firm_detail_3 %>% 
  filter(status == "completed") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_2_enddate_comp = n(), .groups = 'drop') 
phase_2_enddate_term = trial_firm_detail_3 %>% 
  filter(status == "terminated") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_2_enddate_term = n(), .groups = 'drop') 
phase_2_startdate_comp = trial_firm_detail_3 %>% 
  filter(status == "completed") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_startdate_comp = n(), .groups = 'drop') 
phase_2_startdate_term = trial_firm_detail_3 %>% 
  filter(status == "terminated") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_startdate_term = n(), .groups = 'drop') 

# Create the different collab class for phase_2_startdate_comp and phase_2_startdate_term
phase_2_startdate_comp_w_collab = trial_firm_detail_3 %>% 
  filter(collab == 1,
         status == "completed",
         phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_startdate_comp_w_collab = n(), .groups = 'drop') 
phase_2_startdate_comp_w_exist_collab = trial_firm_detail_3 %>% 
  filter(collab_existing == 1,
         status == "completed",
         phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_startdate_comp_w_exist_collab = n(), .groups = 'drop') 
phase_2_startdate_comp_w_estab_collab = trial_firm_detail_3 %>% 
  filter(collab_established == 1,
         status == "completed",
         phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_startdate_comp_w_estab_collab = n(), .groups = 'drop') 

phase_2_startdate_term_w_collab = trial_firm_detail_3 %>% 
  filter(collab == 1,
         status == "terminated",
         phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_startdate_term_w_collab = n(), .groups = 'drop') 
phase_2_startdate_term_w_exist_collab = trial_firm_detail_3 %>% 
  filter(collab_existing == 1,
         status == "terminated",
         phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_startdate_term_w_exist_collab = n(), .groups = 'drop') 
phase_2_startdate_term_w_estab_collab = trial_firm_detail_3 %>% 
  filter(collab_established == 1,
         status == "terminated",
         phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_2_startdate_term_w_estab_collab = n(), .groups = 'drop') 


# phase 3 start, start_eu, start_us, start_others, complete, terminate
phase_3_start = trial_firm_detail_3 %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_3_start = n(), .groups = 'drop') 
phase_3_start_eu = trial_firm_detail_3 %>% 
  filter(region == "EU") %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_3_start_eu = n(), .groups = 'drop')
phase_3_start_us = trial_firm_detail_3 %>% 
  filter(region == "US") %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_3_start_us = n(), .groups = 'drop')
phase_3_start_others = trial_firm_detail_3 %>% 
  filter(region == "Others") %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_3_start_others = n(), .groups = 'drop')
phase_3_enddate_comp = trial_firm_detail_3 %>% 
  filter(status == "completed") %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_3_enddate_comp = n(), .groups = 'drop') 
phase_3_enddate_term = trial_firm_detail_3 %>% 
  filter(status == "terminated") %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_3_enddate_term = n(), .groups = 'drop') 
phase_3_startdate_comp = trial_firm_detail_3 %>% 
  filter(status == "completed") %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_3_startdate_comp = n(), .groups = 'drop') 
phase_3_startdate_term = trial_firm_detail_3 %>% 
  filter(status == "terminated") %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_3_startdate_term = n(), .groups = 'drop') 


# phase 4 start, start_eu, start_us, start_others, complete, terminate
phase_4_start = trial_firm_detail_3 %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_4_start = n(), .groups = 'drop') 
phase_4_start_eu = trial_firm_detail_3 %>% 
  filter(region == "EU") %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_4_start_eu = n(), .groups = 'drop')
phase_4_start_us = trial_firm_detail_3 %>% 
  filter(region == "US") %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_4_start_us = n(), .groups = 'drop')
phase_4_start_others = trial_firm_detail_3 %>% 
  filter(region == "Others") %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_4_start_others = n(), .groups = 'drop')
phase_4_enddate_comp = trial_firm_detail_3 %>% 
  filter(status == "completed") %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_4_enddate_comp = n(), .groups = 'drop') 
phase_4_enddate_term = trial_firm_detail_3 %>% 
  filter(status == "terminated") %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_4_enddate_term = n(), .groups = 'drop') 
phase_4_startdate_comp = trial_firm_detail_3 %>% 
  filter(status == "completed") %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_4_startdate_comp = n(), .groups = 'drop') 
phase_4_startdate_term = trial_firm_detail_3 %>% 
  filter(status == "terminated") %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(phase_4_startdate_term = n(), .groups = 'drop') 

# p2_count_pre_2018
p2_count_pre_2018 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1,
         start_year < "2018") %>% 
  group_by(sponsor_id) %>% 
  summarize(p2_count_pre_2018 = n())

# p2_eu_count_pre_2018
p2_eu_count_pre_2018 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1,
         start_year < "2018",
         region == "EU") %>% 
  group_by(sponsor_id) %>% 
  summarize(p2_eu_count_pre_2018 = n())

firm_year_dataset_2 = firm_year_dataset_1 %>% 
  left_join(phase_1_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_1_start_eu, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_1_start_us, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_1_start_others, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_1_enddate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_1_enddate_term, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_1_startdate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_1_startdate_term, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_eu, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_us, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_others, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_enddate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_2_enddate_term, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_2_startdate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_startdate_comp_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_startdate_comp_w_exist_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_startdate_comp_w_estab_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_startdate_term, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_startdate_term_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_startdate_term_w_exist_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_startdate_term_w_estab_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_3_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_3_start_eu, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_3_start_us, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_3_start_others, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_3_enddate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_3_enddate_term, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_3_startdate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_3_startdate_term, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_4_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>%
  left_join(phase_4_start_eu, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_4_start_us, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_4_start_others, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_4_enddate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_4_enddate_term, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_4_startdate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_4_startdate_term, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_count_pre_2018, by = c("sponsor_id" = "sponsor_id")) %>% 
  left_join(p2_eu_count_pre_2018, by = c("sponsor_id" = "sponsor_id")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

# 320776
```


##### Add EU exposure variables

any_eu_pre_2016: coded as 1 if a company has at least 1 trial in GDPR affected countries (EU countries) before 2016
eu_porp_pre_2016: the proportion of a company's trial that took place in EU before 2018
above_median_eu_pre_2016: coded as 1 if eu_porp_pre_2016 is above median

any_eu_pre_2018: Same as any_eu_pre_2016 but 2018 instead
eu_porp_pre_2018: Same as eu_porp_pre_2016 but 2018 instead
above_median_eu_pre_2018: Same as above_median_eu_pre_2016 but 2018 instead

Also, We want to create the separated counts of all 6 categories for each phases as well, total 6*5=30 new variables

Note: We have missing values for country

```{r}
# Add the column any_eu_pre_2016 and above_median_eu_pre_2016 to firm_year_dataset_2
eu_countries = c("Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", "Czech Republic", "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", "Ireland", "Italy", "Latvia", "Lithuania", "Luxembourg", "Malta", "Netherlands", "Poland", "Portugal", "Romania", "Slovakia", "Slovenia", "Spain", "Sweden", "United Kingdom")   # Should we include UK since UK is in EU before 2016

# 2016 cutoff
# All phases
eu_expose_pre_2016 = trial_firm_detail_3 %>% 
  filter(start_year < "2016") %>% 
  mutate(any_eu_pre_2016 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2016 = round(mean(any_eu_pre_2016), 3), # calculate proportion of eu trials
            any_eu_pre_2016 = max(any_eu_pre_2016)) # 1 if any trial is in EU
eu_prop_median_pre_2016 = median(eu_expose_pre_2016$eu_porp_pre_2016) # Calculate the median of EU proportion, 0.864
eu_expose_pre_2016 = eu_expose_pre_2016 %>% 
  mutate(above_median_eu_pre_2016 = ifelse(eu_porp_pre_2016>eu_prop_median_pre_2016, 1, 0)) # 1 if EU proportion > median

# Phase 1
eu_expose_pre_2016_p1 = trial_firm_detail_3 %>% 
  filter(phase_1 == 1) %>% 
  filter(start_year < "2016") %>% 
  mutate(any_eu_pre_2016_p1 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2016_p1 = round(mean(any_eu_pre_2016_p1), 3), 
            any_eu_pre_2016_p1 = max(any_eu_pre_2016_p1)) 
eu_prop_median_pre_2016_p1 = median(eu_expose_pre_2016_p1$eu_porp_pre_2016_p1) # eu_prop_median_pre_2016_p1 = 0
eu_expose_pre_2016_p1 = eu_expose_pre_2016_p1 %>% 
  mutate(above_median_eu_pre_2016_p1 = ifelse(eu_porp_pre_2016_p1>eu_prop_median_pre_2016_p1, 1, 0)) 

# Phase 2
eu_expose_pre_2016_p2 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(start_year < "2016") %>% 
  mutate(any_eu_pre_2016_p2 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2016_p2 = round(mean(any_eu_pre_2016_p2), 3), 
            any_eu_pre_2016_p2 = max(any_eu_pre_2016_p2)) 
eu_prop_median_pre_2016_p2 = median(eu_expose_pre_2016_p2$eu_porp_pre_2016_p2) # eu_prop_median_pre_2016_p2 = 0.6
eu_expose_pre_2016_p2 = eu_expose_pre_2016_p2 %>% 
  mutate(above_median_eu_pre_2016_p2 = ifelse(eu_porp_pre_2016_p2>eu_prop_median_pre_2016_p2, 1, 0)) 

# Phase 3
eu_expose_pre_2016_p3 = trial_firm_detail_3 %>% 
  filter(phase_3 == 1) %>% 
  filter(start_year < "2016") %>% 
  mutate(any_eu_pre_2016_p3 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2016_p3 = round(mean(any_eu_pre_2016_p3), 3), 
            any_eu_pre_2016_p3 = max(any_eu_pre_2016_p3)) 
eu_prop_median_pre_2016_p3 = median(eu_expose_pre_2016_p3$eu_porp_pre_2016_p3) # eu_prop_median_pre_2016_p3 = 0.936
eu_expose_pre_2016_p3 = eu_expose_pre_2016_p3 %>% 
  mutate(above_median_eu_pre_2016_p3 = ifelse(eu_porp_pre_2016_p3>eu_prop_median_pre_2016_p3, 1, 0)) 

# Phase 4
eu_expose_pre_2016_p4 = trial_firm_detail_3 %>% 
  filter(phase_4 == 1) %>% 
  filter(start_year < "2016") %>% 
  mutate(any_eu_pre_2016_p4 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2016_p4 = round(mean(any_eu_pre_2016_p4), 3), 
            any_eu_pre_2016_p4 = max(any_eu_pre_2016_p4)) 
eu_prop_median_pre_2016_p4 = median(eu_expose_pre_2016_p4$eu_porp_pre_2016_p4) # eu_prop_median_pre_2016_p2 = 1
eu_expose_pre_2016_p4 = eu_expose_pre_2016_p4 %>% 
  mutate(above_median_eu_pre_2016_p4 = ifelse(eu_porp_pre_2016_p4>eu_prop_median_pre_2016_p4, 1, 0)) 




# 2018 cutoff
# All phases
eu_expose_pre_2018 = trial_firm_detail_3 %>% 
  filter(start_year < "2018") %>% 
  mutate(any_eu_pre_2018 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2018 = round(mean(any_eu_pre_2018), 3), # calculate proportion of eu trials
            any_eu_pre_2018 = max(any_eu_pre_2018)) # 1 if any trial is in EU
eu_prop_median_pre_2018 = median(eu_expose_pre_2018$eu_porp_pre_2018) # Calculate the median of EU proportion, 0.778
eu_expose_pre_2018 = eu_expose_pre_2018 %>% 
  mutate(above_median_eu_pre_2018 = ifelse(eu_porp_pre_2018>eu_prop_median_pre_2018, 1, 0)) # 1 if EU proportion > median

# Phase 1
eu_expose_pre_2018_p1 = trial_firm_detail_3 %>% 
  filter(phase_1 == 1) %>% 
  filter(start_year < "2018") %>% 
  mutate(any_eu_pre_2018_p1 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2018_p1 = round(mean(any_eu_pre_2018_p1), 3), 
            any_eu_pre_2018_p1 = max(any_eu_pre_2018_p1)) 
eu_prop_median_pre_2018_p1 = median(eu_expose_pre_2018_p1$eu_porp_pre_2018_p1) # eu_prop_median_pre_2018_p1 = 0
eu_expose_pre_2018_p1 = eu_expose_pre_2018_p1 %>% 
  mutate(above_median_eu_pre_2018_p1 = ifelse(eu_porp_pre_2018_p1>eu_prop_median_pre_2018_p1, 1, 0)) 

# Phase 2
eu_expose_pre_2018_p2 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1,
         start_year < "2018") %>% 
  mutate(any_eu_pre_2018_p2 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2018_p2 = round(mean(any_eu_pre_2018_p2), 3), 
            any_eu_pre_2018_p2 = max(any_eu_pre_2018_p2)) 
eu_prop_median_pre_2018_p2 = median(eu_expose_pre_2018_p2$eu_porp_pre_2018_p2) # eu_prop_median_pre_2018_p2 = 0.4
eu_expose_pre_2018_p2 = eu_expose_pre_2018_p2 %>% 
  mutate(above_median_eu_pre_2018_p2 = ifelse(eu_porp_pre_2018_p2>eu_prop_median_pre_2018_p2, 1, 0)) 

# Phase 2 (industry)
eu_expose_pre_2018_p2_industry = trial_firm_detail_3 %>% 
  filter(phase_2 == 1,
         industry_dummy == 1) %>% 
  filter(start_year < "2018") %>% 
  mutate(any_eu_pre_2018_p2_industry = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2018_p2_industry = round(mean(any_eu_pre_2018_p2_industry), 3), 
            any_eu_pre_2018_p2_industry = max(any_eu_pre_2018_p2_industry)) 
eu_prop_median_pre_2018_p2_industry = median(eu_expose_pre_2018_p2_industry$eu_porp_pre_2018_p2_industry) # eu_prop_median_pre_2018_p2 = 0.333
eu_expose_pre_2018_p2_industry = eu_expose_pre_2018_p2_industry %>% 
  mutate(above_median_eu_pre_2018_p2_industry = ifelse(eu_porp_pre_2018_p2_industry>eu_prop_median_pre_2018_p2_industry, 1, 0)) 

# Phase 3
eu_expose_pre_2018_p3 = trial_firm_detail_3 %>% 
  filter(phase_3 == 1) %>% 
  filter(start_year < "2018") %>% 
  mutate(any_eu_pre_2018_p3 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2018_p3 = round(mean(any_eu_pre_2018_p3), 3), 
            any_eu_pre_2018_p3 = max(any_eu_pre_2018_p3)) 
eu_prop_median_pre_2018_p3 = median(eu_expose_pre_2018_p3$eu_porp_pre_2018_p3) # eu_prop_median_pre_2018_p3 = 0.875
eu_expose_pre_2018_p3 = eu_expose_pre_2018_p3 %>% 
  mutate(above_median_eu_pre_2018_p3 = ifelse(eu_porp_pre_2018_p3>eu_prop_median_pre_2018_p3, 1, 0)) 

# Phase 4
eu_expose_pre_2018_p4 = trial_firm_detail_3 %>% 
  filter(phase_4 == 1) %>% 
  filter(start_year < "2018") %>% 
  mutate(any_eu_pre_2018_p4 = ifelse(country %in% eu_countries, 1, 0)) %>% 
  group_by(sponsor_id) %>% 
  summarise(eu_porp_pre_2018_p4 = round(mean(any_eu_pre_2018_p4), 3), 
            any_eu_pre_2018_p4 = max(any_eu_pre_2018_p4)) 
eu_prop_median_pre_2018_p4 = median(eu_expose_pre_2018_p4$eu_porp_pre_2018_p4) # eu_prop_median_pre_2018_p2 = 1
eu_expose_pre_2018_p4 = eu_expose_pre_2018_p4 %>% 
  mutate(above_median_eu_pre_2018_p4 = ifelse(eu_porp_pre_2018_p4>eu_prop_median_pre_2018_p4, 1, 0)) 



# Combine all 30 columns
firm_year_dataset_3 = firm_year_dataset_2 %>% 
  left_join(eu_expose_pre_2016, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2016_p1, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2016_p2, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2016_p3, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2016_p4, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2018, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2018_p1, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2018_p2, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2018_p2_industry, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2018_p3, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2018_p4, by = "sponsor_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0))) # Notice companies founded after 2016 will have NA values

# 320776

# Use this code to obtain exposure on company level, independent of time
firm_year_dataset_3 %>% distinct(sponsor_id, .keep_all = TRUE) %>% 
  select(sponsor_id, sponsor_name, any_eu_pre_2016, above_median_eu_pre_2016)

# Exploratory statistics
quantile(eu_expose_pre_2018_p2$eu_porp_pre_2018_p2, probs = c(0, 0.25, 0.5, 0.75, 1))
quantile(eu_expose_pre_2018_p2_industry$eu_porp_pre_2018_p2_industry, probs = c(0, 0.25, 0.5, 0.75, 1))

firm_year_dataset_23 %>% select(eu_porp_pre_2018_p2_industry)
```

##### Add patient counts

  We also want to assess the patient numbers in each sector of measures. We want to include the following combination: (starting/ending)x(mean)x(all_regions/us/eu/others)x(all_phases/phase1/phase2/phase3/phase4) + (starting/ending)x(min/max/median)x(all_regions)x(all_phases)
  Totaling with 46 new columns

```{r}
# Only consider trials with a valid patient count number
trial_firm_detail_valid_patient = trial_firm_detail_3 %>% 
  filter(patient_num != "") %>% 
  mutate(patient_num = as.numeric(patient_num))

# Obtain the (mean/min/max/median) of (starting/ending)*(all_regions)*(all_phases)
patient_stat_starting_allregion_allphases = trial_firm_detail_valid_patient %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(patient_avg_start_all = mean(patient_num),
            patient_min_start_all = min(patient_num),
            patient_max_start_all = max(patient_num),
            patient_med_start_all = median(patient_num))
patient_stat_ending_allregion_allphases = trial_firm_detail_valid_patient %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(patient_avg_end_all = mean(patient_num),
            patient_min_end_all = min(patient_num),
            patient_max_end_all = max(patient_num),
            patient_med_end_all = median(patient_num))


# Obtain the mean of (starting/ending)*(all_regions)*(phase1/phase2/phase3/phase4)
patient_mean_starting_allregion_phase1 = trial_firm_detail_valid_patient %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(patient_avg_start_allregion_p1 = mean(patient_num))
patient_mean_starting_allregion_phase2 = trial_firm_detail_valid_patient %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(patient_avg_start_allregion_p2 = mean(patient_num))
### three bonus collab partition of patient_mean_starting_allregion_phase2
patient_mean_starting_allregion_phase2_w_collab = trial_firm_detail_valid_patient %>% 
  filter(collab == 1,
         phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(patient_avg_start_allregion_p2_w_collab = mean(patient_num))
patient_mean_starting_allregion_phase2_w_exist_collab = trial_firm_detail_valid_patient %>% 
  filter(collab_existing == 1,
         phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(patient_avg_start_allregion_p2_w_exist_collab = mean(patient_num))
patient_mean_starting_allregion_phase2_w_estab_collab = trial_firm_detail_valid_patient %>% 
  filter(collab_established == 1,
         phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(patient_avg_start_allregion_p2_w_estab_collab = mean(patient_num))


patient_mean_starting_allregion_phase3 = trial_firm_detail_valid_patient %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(patient_avg_start_allregion_p3 = mean(patient_num))
patient_mean_starting_allregion_phase4 = trial_firm_detail_valid_patient %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(patient_avg_start_allregion_p4 = mean(patient_num))

patient_mean_ending_allregion_phase1 = trial_firm_detail_valid_patient %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(patient_avg_end_allregion_p1 = mean(patient_num))
patient_mean_ending_allregion_phase2 = trial_firm_detail_valid_patient %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(patient_avg_end_allregion_p2 = mean(patient_num))
patient_mean_ending_allregion_phase3 = trial_firm_detail_valid_patient %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(patient_avg_end_allregion_p3 = mean(patient_num))
patient_mean_ending_allregion_phase4 = trial_firm_detail_valid_patient %>% 
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(patient_avg_end_allregion_p4 = mean(patient_num))


# Obtain the mean of (starting/ending)*(us/eu/others)*(all_phases)
patient_mean_starting_us.eu.others_allphases = trial_firm_detail_valid_patient %>% 
  group_by(sponsor_id, start_year, region) %>% 
  summarize(patient_avg_start_us_allphases = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_start_eu_allphases = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_start_others_allphases = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(
    patient_avg_start_us_allphases = ifelse(any(!is.na(patient_avg_start_us_allphases)),
                                                first(na.omit(patient_avg_start_us_allphases)), NaN),
    patient_avg_start_eu_allphases = ifelse(any(!is.na(patient_avg_start_eu_allphases)),
                                                first(na.omit(patient_avg_start_eu_allphases)), NaN),
    patient_avg_start_others_allphases = ifelse(any(!is.na(patient_avg_start_others_allphases)),
                                                    first(na.omit(patient_avg_start_others_allphases)), NaN)
    )
patient_mean_ending_us.eu.others_allphases = trial_firm_detail_valid_patient %>% 
  group_by(sponsor_id, end_year, region) %>% 
  summarize(patient_avg_end_us_allphases = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_end_eu_allphases = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_end_others_allphases = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(
    patient_avg_end_us_allphases = ifelse(any(!is.na(patient_avg_end_us_allphases)),
                                                first(na.omit(patient_avg_end_us_allphases)), NaN),
    patient_avg_end_eu_allphases = ifelse(any(!is.na(patient_avg_end_eu_allphases)),
                                                first(na.omit(patient_avg_end_eu_allphases)), NaN),
    patient_avg_end_others_allphases = ifelse(any(!is.na(patient_avg_end_others_allphases)),
                                                    first(na.omit(patient_avg_end_others_allphases)), NaN)
    )


# Obtain the mean of (starting/ending)*(us/eu/others)*(phase1)
patient_mean_starting_us.eu.others_phase1 = trial_firm_detail_valid_patient %>%
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, start_year, region) %>% 
  summarize(patient_avg_start_us_p1 = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_start_eu_p1 = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_start_others_p1 = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(
    patient_avg_start_us_p1 = ifelse(any(!is.na(patient_avg_start_us_p1)),
                                                first(na.omit(patient_avg_start_us_p1)), NaN),
    patient_avg_start_eu_p1 = ifelse(any(!is.na(patient_avg_start_eu_p1)),
                                                first(na.omit(patient_avg_start_eu_p1)), NaN),
    patient_avg_start_others_p1 = ifelse(any(!is.na(patient_avg_start_others_p1)),
                                                    first(na.omit(patient_avg_start_others_p1)), NaN)
    )
patient_mean_ending_us.eu.others_phase1 = trial_firm_detail_valid_patient %>%
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, end_year, region) %>% 
  summarize(patient_avg_end_us_p1 = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_end_eu_p1 = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_end_others_p1 = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(
    patient_avg_end_us_p1 = ifelse(any(!is.na(patient_avg_end_us_p1)),
                                                first(na.omit(patient_avg_end_us_p1)), NaN),
    patient_avg_end_eu_p1 = ifelse(any(!is.na(patient_avg_end_eu_p1)),
                                                first(na.omit(patient_avg_end_eu_p1)), NaN),
    patient_avg_end_others_p1 = ifelse(any(!is.na(patient_avg_end_others_p1)),
                                                    first(na.omit(patient_avg_end_others_p1)), NaN)
    )


# Obtain the mean of (starting/ending)*(us/eu/others)*(phase2)
patient_mean_starting_us.eu.others_phase2 = trial_firm_detail_valid_patient %>%
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year, region) %>% 
  summarize(patient_avg_start_us_p2 = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_start_eu_p2 = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_start_others_p2 = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(
    patient_avg_start_us_p2 = ifelse(any(!is.na(patient_avg_start_us_p2)),
                                                first(na.omit(patient_avg_start_us_p2)), NaN),
    patient_avg_start_eu_p2 = ifelse(any(!is.na(patient_avg_start_eu_p2)),
                                                first(na.omit(patient_avg_start_eu_p2)), NaN),
    patient_avg_start_others_p2 = ifelse(any(!is.na(patient_avg_start_others_p2)),
                                                    first(na.omit(patient_avg_start_others_p2)), NaN)
    )
patient_mean_ending_us.eu.others_phase2 = trial_firm_detail_valid_patient %>%
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, end_year, region) %>% 
  summarize(patient_avg_end_us_p2 = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_end_eu_p2 = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_end_others_p2 = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(
    patient_avg_end_us_p2 = ifelse(any(!is.na(patient_avg_end_us_p2)),
                                                first(na.omit(patient_avg_end_us_p2)), NaN),
    patient_avg_end_eu_p2 = ifelse(any(!is.na(patient_avg_end_eu_p2)),
                                                first(na.omit(patient_avg_end_eu_p2)), NaN),
    patient_avg_end_others_p2 = ifelse(any(!is.na(patient_avg_end_others_p2)),
                                                    first(na.omit(patient_avg_end_others_p2)), NaN)
    )


# Obtain the mean of (starting/ending)*(us/eu/others)*(phase3)
patient_mean_starting_us.eu.others_phase3 = trial_firm_detail_valid_patient %>%
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, start_year, region) %>% 
  summarize(patient_avg_start_us_p3 = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_start_eu_p3 = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_start_others_p3 = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(
    patient_avg_start_us_p3 = ifelse(any(!is.na(patient_avg_start_us_p3)),
                                                first(na.omit(patient_avg_start_us_p3)), NaN),
    patient_avg_start_eu_p3 = ifelse(any(!is.na(patient_avg_start_eu_p3)),
                                                first(na.omit(patient_avg_start_eu_p3)), NaN),
    patient_avg_start_others_p3 = ifelse(any(!is.na(patient_avg_start_others_p3)),
                                                    first(na.omit(patient_avg_start_others_p3)), NaN)
    )
patient_mean_ending_us.eu.others_phase3 = trial_firm_detail_valid_patient %>%
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, end_year, region) %>% 
  summarize(patient_avg_end_us_p3 = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_end_eu_p3 = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_end_others_p3 = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(
    patient_avg_end_us_p3 = ifelse(any(!is.na(patient_avg_end_us_p3)),
                                                first(na.omit(patient_avg_end_us_p3)), NaN),
    patient_avg_end_eu_p3 = ifelse(any(!is.na(patient_avg_end_eu_p3)),
                                                first(na.omit(patient_avg_end_eu_p3)), NaN),
    patient_avg_end_others_p3 = ifelse(any(!is.na(patient_avg_end_others_p3)),
                                                    first(na.omit(patient_avg_end_others_p3)), NaN)
    )


# Obtain the mean of (starting/ending)*(us/eu/others)*(phase4)
patient_mean_starting_us.eu.others_phase4 = trial_firm_detail_valid_patient %>%
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, start_year, region) %>% 
  summarize(patient_avg_start_us_p4 = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_start_eu_p4 = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_start_others_p4 = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(
    patient_avg_start_us_p4 = ifelse(any(!is.na(patient_avg_start_us_p4)),
                                                first(na.omit(patient_avg_start_us_p4)), NaN),
    patient_avg_start_eu_p4 = ifelse(any(!is.na(patient_avg_start_eu_p4)),
                                                first(na.omit(patient_avg_start_eu_p4)), NaN),
    patient_avg_start_others_p4 = ifelse(any(!is.na(patient_avg_start_others_p4)),
                                                    first(na.omit(patient_avg_start_others_p4)), NaN)
    )
patient_mean_ending_us.eu.others_phase4 = trial_firm_detail_valid_patient %>%
  filter(phase_4 == 1) %>% 
  group_by(sponsor_id, end_year, region) %>% 
  summarize(patient_avg_end_us_p4 = mean(patient_num[region == "US"], na.rm = TRUE),
            patient_avg_end_eu_p4 = mean(patient_num[region == "EU"], na.rm = TRUE),
            patient_avg_end_others_p4 = mean(patient_num[region == "Others"], na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(
    patient_avg_end_us_p4 = ifelse(any(!is.na(patient_avg_end_us_p4)),
                                                first(na.omit(patient_avg_end_us_p4)), NaN),
    patient_avg_end_eu_p4 = ifelse(any(!is.na(patient_avg_end_eu_p4)),
                                                first(na.omit(patient_avg_end_eu_p4)), NaN),
    patient_avg_end_others_p4 = ifelse(any(!is.na(patient_avg_end_others_p4)),
                                                    first(na.omit(patient_avg_end_others_p4)), NaN)
    )


# Add all 46 columns
firm_year_dataset_4 = firm_year_dataset_3 %>% 
  left_join(patient_stat_starting_allregion_allphases, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_stat_ending_allregion_allphases, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_starting_allregion_phase1, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_starting_allregion_phase2, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_starting_allregion_phase2_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_starting_allregion_phase2_w_exist_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>%
  left_join(patient_mean_starting_allregion_phase2_w_estab_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>%
  left_join(patient_mean_starting_allregion_phase3, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_starting_allregion_phase4, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_ending_allregion_phase1, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_ending_allregion_phase2, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_ending_allregion_phase3, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_ending_allregion_phase4, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_starting_us.eu.others_allphases, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_ending_us.eu.others_allphases, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_starting_us.eu.others_phase1, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_ending_us.eu.others_phase1, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_starting_us.eu.others_phase2, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_ending_us.eu.others_phase2, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_starting_us.eu.others_phase3, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_ending_us.eu.others_phase3, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(patient_mean_starting_us.eu.others_phase4, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(patient_mean_ending_us.eu.others_phase4, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

# 320776
firm_year_dataset_4 %>% select(sponsor_name, sponsor_id, year, phase_2_start) %>% arrange(desc(phase_2_start))
```

##### Add detailed variables for phase_2_start_eu, phase_2_start_eu_abs, phase_2_start_aact, phase_2_start_zombie_75percent, phase_2_start_zombie_outliar

```{r}
# Create phase_2_start_everyEUcountries
phase_2_start_everyEUcountries = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(region == "EU") %>% 
  group_by(sponsor_id, start_year, country) %>% 
  count() %>% 
  mutate(variable_name = paste("phase_2_start", country, sep = "_")) %>%
  select(start_year, variable_name, n) %>%
  pivot_wider(names_from = variable_name, values_from = n, values_fill = 0) %>% 
  ungroup() %>% 
  select(-country) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(across(starts_with("phase_2_start"), sum)) %>% 
  ungroup()

# Create phase_2_start_eu_abs, which counts the unique nct_id for every trial in eu
phase_2_start_eu_abs = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(region == "EU") %>% 
  distinct(across(-c(country, trial_id))) %>% 
  group_by(sponsor_id, start_year) %>% 
  count() %>% 
  rename(phase_2_start_eu_abs = n) %>% 
  ungroup()

# Create phase_2_start_aact, which counts the trials from the aact dataset
phase_2_start_aact = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(source == "AACT") %>% 
  group_by(sponsor_id, start_year) %>% 
  count() %>% 
  rename(phase_2_start_aact = n) %>% 
  ungroup()

# Create phase_2_start_zombie_75percent and phase_2_start_zombie_outliar
phase_2_start_zombie_75percent = trial_firm_detail_3 %>% 
  filter(phase_2_zombie_75percent == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  count() %>% 
  rename(phase_2_start_zombie_75percent = n) %>% 
  ungroup()
# Create phase_2_start_zombie_outliar and phase_2_start_zombie_outliar
phase_2_start_zombie_outliar = trial_firm_detail_3 %>% 
  filter(phase_2_zombie_outliar == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  count() %>% 
  rename(phase_2_start_zombie_outliar = n) %>% 
  ungroup()



firm_year_dataset_5 = firm_year_dataset_4 %>% 
  left_join(phase_2_start_everyEUcountries, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_eu_abs, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_aact, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_zombie_75percent, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_zombie_outliar, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

# 320776
```

##### Add type 2 for phase_2_startdate_comp, phase_2_enddate_comp, phase_2_startdate_term, phase_2_enddate_term

Note that we're investigating the effect of implementation of GDPR, which took place in 2018. We define three types of trials:

  type 1. start before GDPR, end before GDPR
  type 2. start before GDPR, end after GDPR
  type 3. start after GDPR, end after GDPR
  
We want to single out the type 2 trials, so we want to create phase_2_startdate_comp_type2, phase_2_enddate_comp_type2, phase_2_startdate_term_type2, phase_2_enddate_term_type2

###### Note: no exact date for trials, only years, and GDPR was implemented in May 2018

```{r}
# Create phase_2_startdate_comp_type2, phase_2_enddate_comp_type2, phase_2_startdate_term_type2, phase_2_enddate_term_type2
phase_2_term_comp_type2 = trial_firm_detail_3 %>% 
  mutate(end_year = ifelse(end_year == "", "2024", end_year)) %>% 
  mutate(type = case_when(
    start_year < 2018 & end_year <= 2018 ~ "1",
    start_year <= 2018 & end_year >= 2018 ~ "2",
    start_year >= 2018 & end_year > 2018 ~ "3",
  )) %>% 
  filter(phase_2 == 1) %>% 
  filter(type == 2) %>% 
  filter(status %in% c("terminated", "completed")) %>% 
  select(sponsor_id, start_year, end_year, status, type)


phase_2_startdate_comp_type2 = phase_2_term_comp_type2 %>% 
  filter(status == "completed") %>% 
  group_by(sponsor_id, start_year) %>% 
  count() %>% 
  rename(phase_2_startdate_comp_type2 = n)

phase_2_enddate_comp_type2 = phase_2_term_comp_type2 %>% 
  filter(status == "completed") %>% 
  group_by(sponsor_id, end_year) %>% 
  count() %>% 
  rename(phase_2_enddate_comp_type2 = n)

phase_2_startdate_term_type2 = phase_2_term_comp_type2 %>% 
  filter(status == "terminated") %>% 
  group_by(sponsor_id, start_year) %>% 
  count() %>% 
  rename(phase_2_startdate_term_type2 = n)

phase_2_enddate_term_type2 = phase_2_term_comp_type2 %>% 
  filter(status == "terminated") %>% 
  group_by(sponsor_id, end_year) %>% 
  count() %>% 
  rename(phase_2_enddate_term_type2 = n)

# Left join these four columns and created the excluded type 2 column, total of 8 new columns
firm_year_dataset_6 = firm_year_dataset_5 %>% 
  left_join(phase_2_startdate_comp_type2, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  mutate(phase_2_startdate_comp_type2ex = phase_2_startdate_comp - phase_2_startdate_comp_type2) %>% 
  left_join(phase_2_enddate_comp_type2, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  mutate(phase_2_enddate_comp_type2ex = phase_2_enddate_comp - phase_2_enddate_comp_type2) %>% 
  left_join(phase_2_startdate_term_type2, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  mutate(phase_2_startdate_term_type2ex = phase_2_startdate_term - phase_2_startdate_term_type2) %>% 
  left_join(phase_2_enddate_term_type2, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  mutate(phase_2_enddate_term_type2ex = phase_2_enddate_term - phase_2_enddate_term_type2)

# 320776
```

##### Add phase_2_active, phase_2_active_zombie_75percent, phase_2_active_zombie_outliar, phase_2_comp_rate and phase_2_term_rate 

  This variable is at the sponsor year level, with a percentage value denoting the percentage of completed/terminated trials of all phase 2 trials per sponsor per year. Note that we will add a phase_2_active to keep track of the active phase 2 trials per year.
  

```{r}
# Create phase_2_active, phase_2_comp_rate, and phase_2_term_rate
phase_2_active_zombie_comp_term_rate = firm_year_dataset_6 %>%
  select(sponsor_id, year, phase_2_start, phase_2_start_zombie_75percent, phase_2_start_zombie_outliar, phase_2_enddate_comp, phase_2_enddate_term) %>% 
  arrange(sponsor_id, year) %>% 
  group_by(sponsor_id) %>% 
  mutate(
    # Calculate cumulative starts up to the current year
    cum_phase_2_start = cumsum(phase_2_start), 
    # Calculate cumulative ends up to the previous year
    cum_phase_2_end_prev = lag(cumsum(phase_2_enddate_comp + phase_2_enddate_term), default = 0), 
    # Calculate phase_2_active as the difference
    phase_2_active = cum_phase_2_start - cum_phase_2_end_prev,
    # Calculate avtive zombies up to the current year
    phase_2_active_zombie_75percent = cumsum(phase_2_start_zombie_75percent),
    phase_2_active_zombie_outliar = cumsum(phase_2_start_zombie_outliar),
    # Create phase_2_comp_rate and phase_2_term_rate
    #phase_2_comp_rate = phase_2_enddate_comp/phase_2_active,
    #phase_2_term_rate = phase_2_enddate_term/phase_2_active
  ) %>% 
  select(sponsor_id, year, phase_2_active, phase_2_active_zombie_75percent, phase_2_active_zombie_outliar) 

firm_year_dataset_7 = firm_year_dataset_6 %>% 
  left_join(phase_2_active_zombie_comp_term_rate, by = c("sponsor_id", "year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

# 320776
```

##### Add phase_2_startdate_trans_rate and phase_2_enddate_trans_rate
###### Note: Use drug name to improve this, go back to raw dataset and add drug name and parrell experiment (for next task)

 Few condition to match the transition of phase 2 to phase 3:
 
  - The phase 2 trial and phase 3 trial has to share the same sponsor_id, country, disease_id, source. (omit rows missing disease_id, 11.3%, keep rows with missing values for country)
  - The phase 2 trial must be ended (completed or terminated).
  - The end_year of the phase 2 trial must be earlier or equal to the start_year of the phase 3 trial.
  
 Note: For trials labels as phase2/3, we classify them as phase 3 earlier.

```{r}
# Create phase_2_transitioned, denoting a list of phase 2 trials that successfully transitioned into phase 3
phase_2_transitioned = trial_firm_detail_3 %>%
  filter(disease_id != "") %>% # Use only trials with valid disease_id to increase matching accuracy
  filter(phase_2 == 1 & status != "ongoing") %>%
  select(sponsor_id, country, disease_id, source, phase_2, trial_id, start_year, end_year) %>% 
  left_join(trial_firm_detail_3 %>%
              filter(phase_3 == 1) %>%
              select(sponsor_id, country, disease_id, source, phase_3, trial_id, start_year, end_year), 
            by = c("sponsor_id", "country", "disease_id", "source")) %>% # Join with phase 3 trials on the same identifiers
  na.omit() %>% # Only look at those units having both trial 
  filter(end_year.x <= start_year.y) %>% # Filter where the end_year of Phase 2 is <= start_year of Phase 3
  arrange(trial_id.y, start_year.y) %>% # Arrange start_year.y in increasing order so the first of the many phase 3 trials mapped to the same phase 2 has the earliest start date, which is closest to the end_date of such phase 2 trial
  distinct(trial_id.x, .keep_all = TRUE) %>% # Select unique trial_id.x to get rid of one-to-many relationship
  arrange(trial_id.y, desc(end_year.x)) %>% # Arrange end_year.x in descending order so the first of the many phase 2 trials mapped to the same phase 3 has the latest end date, which is closest to the start_date of such phase 3 trial
  distinct(trial_id.y, .keep_all = TRUE) %>%   # Select unique trial_id.y to get rid of many-to-one relationship
  select(sponsor_id, start_year = start_year.x, end_year = end_year.x)

phase_2_startdate_trans = phase_2_transitioned %>% 
  group_by(sponsor_id, start_year) %>% 
  count() %>% 
  rename(phase_2_startdate_trans = n)
  
phase_2_enddate_trans = phase_2_transitioned %>% 
  group_by(sponsor_id, end_year) %>% 
  count() %>% 
  rename(phase_2_enddate_trans = n)


# Create phase_2_startdate_trans_rate and phase_2_enddate_trans_rate
firm_year_dataset_8 = firm_year_dataset_7 %>% 
  left_join(phase_2_startdate_trans, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(phase_2_startdate_trans_rate = phase_2_startdate_trans/phase_2_start) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  left_join(phase_2_enddate_trans, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  mutate(phase_2_enddate_trans_rate = phase_2_enddate_trans/(phase_2_enddate_comp + phase_2_enddate_term)) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

# 320776
```

##### Add random/single_group/parallel_group summaries

  We now want to discover other attributes of clinical trials, particularly in if a trial is randomized or not, and if a trial's intervention type is single-group, parallel group, or others.

(startdate/enddate) * (random/single_group/parallel_group) * (count/proportion) 
(startdate/enddate) * phase_2 * (random/non_random/single_group/parallel_group) * count

Total of 20 new columns
  
```{r}
# Create randomize_single_parallel_group containing information of randomized, single_group, parallel_group
randomize_single_parallel_group = trial_firm_detail_3 %>% 
  mutate(randomized = as.numeric(ifelse(randomized == "", 0, randomized))) %>% 
  mutate(single_group = as.numeric(ifelse(single_group == "", 0, single_group))) %>% 
  mutate(parallel_group = as.numeric(ifelse(parallel_group == "", 0, parallel_group))) %>% 
  select(sponsor_id, start_year, end_year, randomized, single_group, parallel_group)

# Create variables startdate * (random/single_group/parallel_group) * (count/proportion) 
startdate_random_single_parallel_group = randomize_single_parallel_group %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(startdate_random_count = sum(randomized),
            startdate_random_prop = mean(randomized),
            startdate_single_count = sum(single_group),
            startdate_single_prop = mean(single_group),
            startdate_parallel_count = sum(parallel_group),
            startdate_parallel_prop = mean(parallel_group))
# Create variables enddate * (random/single_group/parallel_group) * (count/proportion) 
enddate_random_single_parallel_group = randomize_single_parallel_group %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(enddate_random_count = sum(randomized),
            enddate_random_prop = mean(randomized),
            enddate_single_count = sum(single_group),
            enddate_single_prop = mean(single_group),
            enddate_parallel_count = sum(parallel_group),
            enddate_parallel_prop = mean(parallel_group))



# Create randomize_single_parallel_group_p2 containing information of randomized, non_randomized, single_group, parallel_group for p2
randomize_single_parallel_group_p2 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  mutate(randomized = as.numeric(ifelse(randomized == "", 0, randomized))) %>% 
  mutate(non_randomized = ifelse(randomized == 1, 0, 1)) %>% 
  mutate(single_group = as.numeric(ifelse(single_group == "", 0, single_group))) %>% 
  mutate(parallel_group = as.numeric(ifelse(parallel_group == "", 0, parallel_group))) %>% 
  select(sponsor_id, start_year, end_year, randomized, non_randomized, single_group, parallel_group)

# Create variables startdate * phase_2 * (random/non_random/single_group/parallel_group) * count
startdate_p2_random_nonrandom_single_parallel_group = randomize_single_parallel_group_p2 %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(startdate_p2_random_count = sum(randomized),
            startdate_p2_non_random_count = sum(non_randomized),
            startdate_p2_single_count = sum(single_group),
            startdate_p2_parallel_count = sum(parallel_group))
# Create variables enddate * phase_2 * (random/non_random/single_group/parallel_group) * count
enddate_p2_random_nonrandom_single_parallel_group = randomize_single_parallel_group_p2 %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(enddate_p2_random_count = sum(randomized),
            enddate_p2_non_random_count = sum(non_randomized),
            enddate_p2_single_count = sum(single_group),
            enddate_p2_parallel_count = sum(parallel_group))



# Add these 20 columns to the firm_year_dataset
firm_year_dataset_9 = firm_year_dataset_8 %>% 
  left_join(startdate_random_single_parallel_group, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(enddate_random_single_parallel_group, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(startdate_p2_random_nonrandom_single_parallel_group, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(enddate_p2_random_nonrandom_single_parallel_group, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) 

# 320776
```
  
  
##### Add collaborator summaries

  Here we want to keep track of the numbers of collaborators in many ways:

  (all phase/p2) * (total/unique) * (active/new/old) * collaborator 
  p2_trial_with_collab
  
  With total of 13 new columns
  
  Additionally, we also want to idnetify the size of industry collaborators with large_industry_collab and small_industry_collab
  
```{r}
# Create a list of CRO collaborators, and cro_collab indicating if a trial has any collaborators in the firm_cro dataset
firm_cro = read_csv("Sponsors/firm_cro.csv")

firm_cro_list = firm_cro %>% rename(firm_cro = CompanyName) %>% 
  mutate(firm_cro = str_to_lower(firm_cro)) %>%  # Convert to lowercase
  mutate(firm_cro = str_replace_all(firm_cro, "[^a-z0-9\\s]", "")) %>%  # Remove non-alphanumeric characters
  mutate(firm_cro = str_trim(firm_cro)) %>% 
  mutate(firm_cro = str_remove_all(firm_cro, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>% 
  pull(firm_cro)

cro_collab_p2 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  mutate(
    cro_collab_p2_dummy = sapply(
      str_split(collaborator, ",\\s*"), 
      function(collab_list) any(collab_list %in% firm_cro_list) 
    )
  ) %>% 
  mutate(cro_collab_p2_dummy = ifelse(cro_collab_p2_dummy == TRUE, 1, 0)) %>% 
  select(trial_id, sponsor_id, start_year, end_year, status, cro_collab_p2_dummy)

cro_collab_p3 = trial_firm_detail_3 %>% 
  filter(phase_3 == 1) %>% 
  mutate(
    cro_collab_p3_dummy = sapply(
      str_split(collaborator, ",\\s*"), 
      function(collab_list) any(collab_list %in% firm_cro_list) 
    )
  ) %>% 
  mutate(cro_collab_p3_dummy = ifelse(cro_collab_p3_dummy == TRUE, 1, 0)) %>% 
  select(trial_id, sponsor_id, start_year, end_year, status, cro_collab_p3_dummy)
```

```{r}
# Create a list of all industry collaborators and assign them with existing sponsor_ids
# If collaborator name not found in sponsor list, assign the id of the most similar sponsor name
industry_collab_no_id = eu_cosponsor %>% 
  filter(sponsor_type == "Commercial") %>% 
  rename(collaborator_type = sponsor_type, collaborator_name = cosponsor_name) %>% 
  bind_rows(us_collaborator_list %>% filter(collaborator_type == "INDUSTRY")) %>% 
  mutate(collaborator_name = str_to_lower(collaborator_name)) %>%  # Convert to lowercase
  mutate(collaborator_name = str_replace_all(collaborator_name, "[^a-z0-9\\s]", "")) %>%  # Remove non-alphanumeric characters
  mutate(collaborator_name = str_remove_all(collaborator_name, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>%
  mutate(collaborator_name = str_trim(collaborator_name)) %>% 
  left_join(sponsor_name_id, by = c('collaborator_name' = 'sponsor_name')) %>% 
  filter(is.na(sponsor_id)) %>% 
  select(collaborator_name)

industry_collab_no_id_matched = industry_collab_no_id %>%
  mutate(matched_sponsor_id = map_chr(collaborator_name, ~ {
          sponsor_name_id %>%
            mutate(dist = stringdist(.x, sponsor_name, method = "lv")) %>%
            arrange(dist) %>%
            slice(1) %>%
            pull(sponsor_id)}))
industry_collab_no_id_matched = industry_collab_no_id_matched %>% 
  mutate(matched_sponsor_id = as.numeric(matched_sponsor_id)) %>% 
  filter(!is.na(collaborator_name)) %>% 
  distinct(collaborator_name, .keep_all = TRUE)

collaborator_industry_2018 = eu_cosponsor %>% 
  filter(sponsor_type == "Commercial") %>% 
  rename(collaborator_type = sponsor_type, collaborator_name = cosponsor_name) %>% 
  bind_rows(us_collaborator_list %>% filter(collaborator_type == "INDUSTRY")) %>% 
  mutate(collaborator_name = str_to_lower(collaborator_name)) %>%  # Convert to lowercase
  mutate(collaborator_name = str_replace_all(collaborator_name, "[^a-z0-9\\s]", "")) %>%  # Remove non-alphanumeric characters
  mutate(collaborator_name = str_remove_all(collaborator_name, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>%
  mutate(collaborator_name = str_trim(collaborator_name)) %>% 
  left_join(sponsor_name_id, by = c('collaborator_name' = 'sponsor_name')) %>% 
  left_join(industry_collab_no_id_matched, by = 'collaborator_name') %>% 
  mutate(sponsor_id = ifelse(!is.na(sponsor_id), sponsor_id, matched_sponsor_id)) %>% 
  filter(!is.na(sponsor_id)) %>% 
  select(-matched_sponsor_id) %>% 
  filter(sponsor_id %in% trial_firm_detail_3$sponsor_id) %>% 
  mutate(collaborator_id = sponsor_id,
         eudract_id = ifelse(is.na(eudract_id), "", eudract_id),
         nct_id = ifelse(is.na(nct_id), "", nct_id)) %>% 
  select(-collaborator_type, -sponsor_id) %>% 
  left_join(trial_firm_detail_3 %>% select(sponsor_name, sponsor_id, phase_2, start_year, end_year, nct_id, eudract_id), 
            by = c("nct_id" = "nct_id", "eudract_id" = "eudract_id")) %>% 
  filter(collaborator_id != sponsor_id) %>% 
  filter(start_year <= 2018)

# Count the size (number of trails of each collaborator)
collaborator_industry_2018_size = trial_firm_detail_3 %>% filter(sponsor_id %in% collaborator_industry_2018$collaborator_id) %>% 
  group_by(sponsor_id) %>% 
  summarize(count = n()) %>% 
  ungroup() %>% 
  mutate(large_industry_collab = ifelse(count > median(count), 1, 0),
         small_industry_collab = ifelse(count <= median(count), 1, 0)) %>% # median is 6
  select(-count) %>% 
  rename(collaborator_id = sponsor_id)

# Create the dataset with trials with sized industry collaborators
collaborator_industry_2018 = collaborator_industry_2018 %>% 
  left_join(collaborator_industry_2018_size, by = "collaborator_id") %>% 
  select(sponsor_name, sponsor_id, collaborator_id, phase_2, start_year, end_year, large_industry_collab, small_industry_collab) %>% 
  arrange(sponsor_id) 

```

  

```{r}
# Define the preserve_setdiff function to use later on
preserve_setdiff <- function(a, b) {
  for (item in b) {
    match_index <- match(item, a)  # Find the first occurrence of the item in `a`
    if (!is.na(match_index)) {
      a <- a[-match_index]        # Remove that occurrence from `a`
    }
  }
  return(a)
}


# Create variables all_phase*total/unique*ongoing/new/old
allphase_total_start_collab = trial_firm_detail_3 %>% 
  select(sponsor_id, start_year, collab_num, collaborator) %>% 
  filter(collab_num > 0) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(allphase_total_new_collab = sum(collab_num), allphase_total_new_collab_name = str_c(collaborator, collapse = ", "))

allphase_total_end_collab = trial_firm_detail_3 %>% 
  select(sponsor_id, end_year, collab_num, collaborator) %>% 
  filter(collab_num > 0) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(allphase_total_end_collab = sum(collab_num), allphase_total_end_collab_name = str_c(collaborator, collapse = ", "))

allphase_collab = firm_year_dataset_9 %>% 
  left_join(allphase_total_end_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(allphase_total_start_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  select(sponsor_id, year, allphase_total_new_collab, allphase_total_new_collab_name, allphase_total_end_collab, allphase_total_end_collab_name) %>% 
  group_by(sponsor_id) %>% 
  mutate(allphase_total_new_collab = ifelse(is.na(allphase_total_new_collab), 0, allphase_total_new_collab)) %>% 
  mutate(allphase_total_end_collab = ifelse(is.na(allphase_total_end_collab), 0, allphase_total_end_collab)) %>% 
  mutate(allphase_total_new_collab_name = ifelse(is.na(allphase_total_new_collab_name), "", allphase_total_new_collab_name)) %>%
  mutate(allphase_total_end_collab_name = ifelse(is.na(allphase_total_end_collab_name), "", allphase_total_end_collab_name)) %>%
  mutate(
    cum_allphase_total_new_collab = cumsum(allphase_total_new_collab),
    cum_allphase_total_new_collab_name = accumulate(
      allphase_total_new_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_allphase_total_end_collab = lag(cumsum(allphase_total_end_collab), default = 0),
    cum_allphase_total_end_collab_name = lag(accumulate(
      allphase_total_end_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    allphase_total_active_collab = cum_allphase_total_new_collab - cum_allphase_total_end_collab,
    allphase_active_collab_name = preserve_setdiff(str_split(cum_allphase_total_new_collab_name, ", ")[[1]], 
                                                    str_split(cum_allphase_total_end_collab_name, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    allphase_unique_active_collab_name = allphase_active_collab_name %>% 
      str_split(",\\s*") %>% unlist() %>% unique() %>% paste(collapse = ", ") ,
    allphase_unique_active_collab = allphase_unique_active_collab_name %>% str_split(",\\s*") %>% map_int(~ length(unique(.x))),
    allphase_unique_active_collab = ifelse(allphase_unique_active_collab_name == "", 0, allphase_unique_active_collab)
    ) %>% 
  ungroup() %>% 
  mutate(
    # Convert active and new collaborators into lists (ignoring empty strings)
    active_unique_collab_list = str_split(allphase_unique_active_collab_name, ",\\s*"),
    new_collab_list = str_split(allphase_total_new_collab_name, ",\\s*"),
    # Compare current new collaborators with previous year's active collaborators
    allphase_unique_new_collab = map2_dbl(
      new_collab_list, 
      lag(active_unique_collab_list, default = list(character(0))), 
      ~ length(setdiff(.x[.x != ""], .y[.y != ""])) # Remove empty strings and calculate unique collaborators
    ),
    allphase_total_old_collab = allphase_total_active_collab - allphase_total_new_collab,
    allphase_unique_old_collab = allphase_unique_active_collab - allphase_unique_new_collab,
  ) %>% 
  ungroup() %>% 
  group_by(sponsor_id) %>% 
  mutate(
    active_unique_collab_list_lag2 = lag(active_unique_collab_list, n = 2, default = list(character(0))),
    allphase_unique_active_collab_established = map2_int(
      active_unique_collab_list,
      active_unique_collab_list_lag2,
      ~ length(intersect(.x[.x != ""], .y[.y != ""]))
    ),
    allphase_unique_active_collab_recent = allphase_unique_active_collab - allphase_unique_active_collab_established
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, allphase_total_active_collab, allphase_total_new_collab, allphase_total_old_collab, allphase_unique_active_collab, allphase_unique_new_collab, allphase_unique_old_collab, allphase_unique_active_collab_established, allphase_unique_active_collab_recent)

  

# Create variables p2*total/unique*ongoing/new/old*collab
p2_total_start_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, start_year, collab_num, collaborator) %>% 
  filter(collab_num > 0) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_total_new_collab = sum(collab_num), p2_total_new_collab_name = str_c(collaborator, collapse = ", "))

p2_total_end_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, end_year, collab_num, collaborator) %>% 
  filter(collab_num > 0) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_total_end_collab = sum(collab_num), p2_total_end_collab_name = str_c(collaborator, collapse = ", "))

p2_collab = firm_year_dataset_9 %>% 
  left_join(p2_total_start_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_total_end_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_total_new_collab, p2_total_new_collab_name, p2_total_end_collab, p2_total_end_collab_name) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_total_new_collab = ifelse(is.na(p2_total_new_collab), 0, p2_total_new_collab)) %>% 
  mutate(p2_total_end_collab = ifelse(is.na(p2_total_end_collab), 0, p2_total_end_collab)) %>% 
  mutate(p2_total_new_collab_name = ifelse(is.na(p2_total_new_collab_name), "", p2_total_new_collab_name)) %>%
  mutate(p2_total_end_collab_name = ifelse(is.na(p2_total_end_collab_name), "", p2_total_end_collab_name)) %>%
  mutate(
    cum_p2_total_new_collab = cumsum(p2_total_new_collab),
    cum_p2_total_new_collab_name = accumulate(
      p2_total_new_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_total_end_collab = lag(cumsum(p2_total_end_collab), default = 0),
    cum_p2_total_end_collab_name = lag(accumulate(
      p2_total_end_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_total_active_collab = cum_p2_total_new_collab - cum_p2_total_end_collab,
    p2_total_active_collab_name = preserve_setdiff(str_split(cum_p2_total_new_collab_name, ", ")[[1]], 
                                                    str_split(cum_p2_total_end_collab_name, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_collab = p2_total_active_collab_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_collab = ifelse(p2_total_active_collab_name == "", 0, p2_unique_active_collab)
    ) %>% 
  ungroup() %>% 
  mutate(
    # Convert active and new collaborators into lists (ignoring empty strings)
    active_total_collab_list = str_split(p2_total_active_collab_name, ",\\s*"),
    new_total_collab_list = str_split(p2_total_new_collab_name, ",\\s*"),
    
    # Fix: Apply unique per row instead of just for the first row
    active_unique_collab_list = map(active_total_collab_list, ~unique(.x[.x != ""])),
    new_unique_collab_list = map(new_total_collab_list, ~unique(.x[.x != ""])),
    
    # Fix: Apply preserve_setdiff per row
    old_total_collab_list = map2(
      active_total_collab_list, 
      new_total_collab_list, 
      ~preserve_setdiff(.x[.x != ""], .y[.y != ""])
    ),
    
    # Fix: Apply unique to each element in old_total_collab_list
    old_unique_collab_list = map(old_total_collab_list, ~unique(.x)),
    
    # Rest of your mutate code
    p2_unique_new_collab = map2_dbl(
      new_total_collab_list, 
      lag(active_total_collab_list, default = list(character(0))), 
      ~ length(unique(setdiff(.x[.x != ""], .y[.y != ""])))
    ),
    p2_total_old_collab = p2_total_active_collab - p2_total_new_collab,
    p2_unique_old_collab = p2_unique_active_collab - p2_unique_new_collab
  ) %>% 
  ungroup() %>% 
  group_by(sponsor_id) %>% 
  mutate(
    active_total_collab_list_lag2 = lag(active_total_collab_list, n = 2, default = list(character(0))),
    
    p2_unique_active_estab_collab = map2_int(
      active_total_collab_list,
      active_total_collab_list_lag2,
      ~ length(intersect(.x[.x != ""], .y[.y != ""]))
    ),
    p2_unique_active_recent_collab = p2_unique_active_collab - p2_unique_active_estab_collab,
    
    # Fix: Properly handle list operations for established and recent collaborators
    old_estab_collab_list = map2(
      old_unique_collab_list, 
      active_total_collab_list_lag2,
      ~ intersect(.x, unlist(.y)[unlist(.y) != ""])
    ),
    
    old_recent_collab_list = map2(
      old_unique_collab_list, 
      old_estab_collab_list,
      ~ setdiff(.x, .y)
    ),
    
    # Calculate unique counts
    p2_unique_old_estab_collab = map_int(old_estab_collab_list, length),
    p2_unique_old_recent_collab = map_int(old_recent_collab_list, length),
    
    # Calculate total counts (occurrences, not just unique)
    p2_total_old_estab_collab = pmap_int(
      list(old_total_collab_list, old_estab_collab_list),
      function(total, estab) {
        sum(total %in% estab)
      }
    ),
    
    p2_total_old_recent_collab = pmap_int(
      list(old_total_collab_list, old_recent_collab_list),
      function(total, recent) {
        sum(total %in% recent)
      }
    )
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_total_active_collab, p2_total_new_collab, p2_total_old_collab, 
         p2_unique_active_collab, p2_unique_new_collab, p2_unique_old_collab, 
         p2_unique_active_estab_collab, p2_unique_active_recent_collab, 
         p2_unique_old_estab_collab, p2_unique_old_recent_collab, 
         p2_total_old_estab_collab, p2_total_old_recent_collab)



```

  Counting number of p2 trials with all phases (and phase 2) new/exist/recent/estab collaborators


```{r}
# Add the variables new, existing, recent, and established collaborators to the trials, these are binary variables to each trials
trial_new_existing_recent_established = trial_firm_detail_3 %>%
  select(trial_id, sponsor_id, start_year, collab_num, collaborator) %>%
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(collab_num > 0) %>%
  mutate(collaborator_list = str_split(collaborator, ",\\s*")) %>%
  unnest(collaborator_list) %>%  # One row per collaborator
  group_by(sponsor_id, collaborator_list) %>%
  mutate(first_year = min(start_year)) %>% 
  ungroup() %>%
  group_by(trial_id) %>%
  summarise(
    collab_new = any(start_year == first_year),
    collab_existing = any(start_year - first_year >= 1),
    collab_recent = any(start_year - first_year >= 1 & start_year - first_year <= 2),
    collab_established = any(start_year - first_year >= 3),
    .groups = "drop",
    collab_new = ifelse(collab_new == TRUE, 1, 0),
    collab_existing = ifelse(collab_existing == TRUE, 1, 0),
    collab_recent = ifelse(collab_recent == TRUE, 1, 0),
    collab_established = ifelse(collab_established == TRUE, 1, 0)
  ) %>% 
  ungroup()


p2_collab_new_existing_recent_established = trial_firm_detail_3 %>% 
  select(trial_id, sponsor_id, start_year, end_year, collab_num, phase_2, status) %>% 
  filter(collab_num > 0) %>% 
  filter(phase_2 == 1) %>% 
  left_join(trial_new_existing_recent_established, by = "trial_id") %>% 
  select(trial_id, sponsor_id, start_year, end_year, collab_new, collab_existing, collab_recent, collab_established, status)
  
# Create the variables
p2_start_collab_new_existing_recent_established = p2_collab_new_existing_recent_established %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_collab_new = sum(collab_new),
            p2_start_collab_existing = sum(collab_existing),
            p2_start_collab_recent = sum(collab_recent),
            p2_start_collab_established = sum(collab_established)) 
p2_comp_collab_new_existing_recent_established = p2_collab_new_existing_recent_established %>% 
  filter(status == "completed",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_comp_collab_new = sum(collab_new),
            p2_comp_collab_existing = sum(collab_existing),
            p2_comp_collab_recent = sum(collab_recent),
            p2_comp_collab_established = sum(collab_established)) 
p2_term_collab_new_existing_recent_established = p2_collab_new_existing_recent_established %>% 
  filter(status == "terminated",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_term_collab_new = sum(collab_new),
            p2_term_collab_existing = sum(collab_existing),
            p2_term_collab_recent = sum(collab_recent),
            p2_term_collab_established = sum(collab_established))




# Also create ind, non_ind versions: new, existing, recent, and established collaborators to the trials, these are binary variables to each trials
# ind version
trial_new_existing_recent_established_ind = trial_firm_detail_3 %>%
  select(trial_id, sponsor_id, start_year, industry_collab) %>%
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(industry_collab != "") %>%
  mutate(collaborator_list = str_split(industry_collab, ",\\s*")) %>%
  unnest(collaborator_list) %>%  # One row per collaborator
  group_by(sponsor_id, collaborator_list) %>%
  mutate(first_year = min(start_year)) %>% 
  ungroup() %>%
  group_by(trial_id) %>%
  summarise(
    collab_new = any(start_year == first_year),
    collab_existing = any(start_year - first_year >= 1),
    collab_recent = any(start_year - first_year >= 1 & start_year - first_year <= 2),
    collab_established = any(start_year - first_year >= 3),
    .groups = "drop",
    collab_new = ifelse(collab_new == TRUE, 1, 0),
    collab_existing = ifelse(collab_existing == TRUE, 1, 0),
    collab_recent = ifelse(collab_recent == TRUE, 1, 0),
    collab_established = ifelse(collab_established == TRUE, 1, 0)
  ) %>% 
  ungroup()


p2_collab_new_existing_recent_established_ind = trial_firm_detail_3 %>% 
  select(trial_id, sponsor_id, start_year, end_year, industry_collab, phase_2, status) %>% 
  filter(industry_collab != "") %>% 
  filter(phase_2 == 1) %>% 
  left_join(trial_new_existing_recent_established_ind, by = "trial_id") %>% 
  select(trial_id, sponsor_id, start_year, end_year, collab_new, collab_existing, collab_recent, collab_established, status)
  
# Create the variables
p2_start_collab_new_existing_recent_established_ind = p2_collab_new_existing_recent_established_ind %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_collab_new_ind = sum(collab_new),
            p2_start_collab_existing_ind = sum(collab_existing),
            p2_start_collab_recent_ind = sum(collab_recent),
            p2_start_collab_established_ind = sum(collab_established)) 
p2_comp_collab_new_existing_recent_established_ind = p2_collab_new_existing_recent_established_ind %>% 
  filter(status == "completed",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_comp_collab_new_ind = sum(collab_new),
            p2_comp_collab_existing_ind = sum(collab_existing),
            p2_comp_collab_recent_ind = sum(collab_recent),
            p2_comp_collab_established_ind = sum(collab_established)) 
p2_term_collab_new_existing_recent_established_ind = p2_collab_new_existing_recent_established_ind %>% 
  filter(status == "terminated",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_term_collab_new_ind = sum(collab_new),
            p2_term_collab_existing_ind = sum(collab_existing),
            p2_term_collab_recent_ind = sum(collab_recent),
            p2_term_collab_established_ind = sum(collab_established))



# non_ind version
trial_new_existing_recent_established_non_ind = trial_firm_detail_3 %>%
  select(trial_id, sponsor_id, start_year, non_industry_collab) %>%
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(non_industry_collab != "") %>%
  mutate(collaborator_list = str_split(non_industry_collab, ",\\s*")) %>%
  unnest(collaborator_list) %>%  # One row per collaborator
  group_by(sponsor_id, collaborator_list) %>%
  mutate(first_year = min(start_year)) %>% 
  ungroup() %>%
  group_by(trial_id) %>%
  summarise(
    collab_new = any(start_year == first_year),
    collab_existing = any(start_year - first_year >= 1),
    collab_recent = any(start_year - first_year >= 1 & start_year - first_year <= 2),
    collab_established = any(start_year - first_year >= 3),
    .groups = "drop",
    collab_new = ifelse(collab_new == TRUE, 1, 0),
    collab_existing = ifelse(collab_existing == TRUE, 1, 0),
    collab_recent = ifelse(collab_recent == TRUE, 1, 0),
    collab_established = ifelse(collab_established == TRUE, 1, 0)
  ) %>% 
  ungroup()


p2_collab_new_existing_recent_established_non_ind = trial_firm_detail_3 %>% 
  select(trial_id, sponsor_id, start_year, end_year, non_industry_collab, phase_2, status) %>% 
  filter(non_industry_collab != "") %>% 
  filter(phase_2 == 1) %>% 
  left_join(trial_new_existing_recent_established_non_ind, by = "trial_id") %>% 
  select(trial_id, sponsor_id, start_year, end_year, collab_new, collab_existing, collab_recent, collab_established, status)
  
# Create the variables
p2_start_collab_new_existing_recent_established_non_ind = p2_collab_new_existing_recent_established_non_ind %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_collab_new_non_ind = sum(collab_new),
            p2_start_collab_existing_non_ind = sum(collab_existing),
            p2_start_collab_recent_non_ind = sum(collab_recent),
            p2_start_collab_established_non_ind = sum(collab_established)) 
p2_comp_collab_new_existing_recent_established_non_ind = p2_collab_new_existing_recent_established_non_ind %>% 
  filter(status == "completed",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_comp_collab_new_non_ind = sum(collab_new),
            p2_comp_collab_existing_non_ind = sum(collab_existing),
            p2_comp_collab_recent_non_ind = sum(collab_recent),
            p2_comp_collab_established_non_ind = sum(collab_established)) 
p2_term_collab_new_existing_recent_established_non_ind = p2_collab_new_existing_recent_established_non_ind %>% 
  filter(status == "terminated",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_term_collab_new_non_ind = sum(collab_new),
            p2_term_collab_existing_non_ind = sum(collab_existing),
            p2_term_collab_recent_non_ind = sum(collab_recent),
            p2_term_collab_established_non_ind = sum(collab_established))




```

Do the exact same thing for the above chunk, but use 5 year as recent/estab cutoff instead of 2

```{r}
# Do the exact same thing for the above chunk, but use 5 year as recent/estab cutoff instead of 2


# Add the variables new, existing, recent, and established collaborators to the trials, these are binary variables to each trials
trial_new_existing_recent_established_5y = trial_firm_detail_3 %>%
  select(trial_id, sponsor_id, start_year, collab_num, collaborator) %>%
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(collab_num > 0) %>%
  mutate(collaborator_list = str_split(collaborator, ",\\s*")) %>%
  unnest(collaborator_list) %>%  # One row per collaborator
  group_by(sponsor_id, collaborator_list) %>%
  mutate(first_year = min(start_year)) %>% 
  ungroup() %>%
  group_by(trial_id) %>%
  summarise(
    collab_new = any(start_year == first_year),
    collab_existing = any(start_year - first_year >= 1),
    collab_recent = any(start_year - first_year >= 1 & start_year - first_year <= 5),
    collab_established = any(start_year - first_year >= 6),
    .groups = "drop",
    collab_new = ifelse(collab_new == TRUE, 1, 0),
    collab_existing = ifelse(collab_existing == TRUE, 1, 0),
    collab_recent = ifelse(collab_recent == TRUE, 1, 0),
    collab_established = ifelse(collab_established == TRUE, 1, 0)
  ) %>% 
  ungroup()


p2_collab_new_existing_recent_established_5y = trial_firm_detail_3 %>% 
  select(trial_id, sponsor_id, start_year, end_year, collab_num, phase_2, status) %>% 
  filter(collab_num > 0) %>% 
  filter(phase_2 == 1) %>% 
  left_join(trial_new_existing_recent_established_5y, by = "trial_id") %>% 
  select(trial_id, sponsor_id, start_year, end_year, collab_new, collab_existing, collab_recent, collab_established, status)
  
# Create the variables
p2_start_collab_new_existing_recent_established_5y = p2_collab_new_existing_recent_established_5y %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_collab_recent_5y = sum(collab_recent),
            p2_start_collab_established_5y = sum(collab_established)) 
p2_comp_collab_new_existing_recent_established_5y = p2_collab_new_existing_recent_established_5y %>% 
  filter(status == "completed",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_comp_collab_recent_5y = sum(collab_recent),
            p2_comp_collab_established_5y = sum(collab_established)) 
p2_term_collab_new_existing_recent_established_5y = p2_collab_new_existing_recent_established_5y %>% 
  filter(status == "terminated",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize( p2_term_collab_recent_5y = sum(collab_recent),
            p2_term_collab_established_5y = sum(collab_established))





# Also create ind, non_ind versions: new, existing, recent, and established collaborators to the trials, these are binary variables to each trials
# ind version
trial_new_existing_recent_established_ind_5y = trial_firm_detail_3 %>%
  select(trial_id, sponsor_id, start_year, industry_collab) %>%
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(industry_collab != "") %>%
  mutate(collaborator_list = str_split(industry_collab, ",\\s*")) %>%
  unnest(collaborator_list) %>%  # One row per collaborator
  group_by(sponsor_id, collaborator_list) %>%
  mutate(first_year = min(start_year)) %>% 
  ungroup() %>%
  group_by(trial_id) %>%
  summarise(
    collab_new = any(start_year == first_year),
    collab_existing = any(start_year - first_year >= 1),
    collab_recent = any(start_year - first_year >= 1 & start_year - first_year <= 5),
    collab_established = any(start_year - first_year >= 6),
    .groups = "drop",
    collab_new = ifelse(collab_new == TRUE, 1, 0),
    collab_existing = ifelse(collab_existing == TRUE, 1, 0),
    collab_recent = ifelse(collab_recent == TRUE, 1, 0),
    collab_established = ifelse(collab_established == TRUE, 1, 0)
  ) %>% 
  ungroup()


p2_collab_new_existing_recent_established_ind_5y = trial_firm_detail_3 %>% 
  select(trial_id, sponsor_id, start_year, end_year, industry_collab, phase_2, status) %>% 
  filter(industry_collab != "") %>% 
  filter(phase_2 == 1) %>% 
  left_join(trial_new_existing_recent_established_ind_5y, by = "trial_id") %>% 
  select(trial_id, sponsor_id, start_year, end_year, collab_new, collab_existing, collab_recent, collab_established, status)
  
# Create the variables
p2_start_collab_new_existing_recent_established_ind_5y = p2_collab_new_existing_recent_established_ind_5y %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_collab_recent_ind_5y = sum(collab_recent),
            p2_start_collab_established_ind_5y = sum(collab_established)) 
p2_comp_collab_new_existing_recent_established_ind_5y = p2_collab_new_existing_recent_established_ind_5y %>% 
  filter(status == "completed",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_comp_collab_recent_ind_5y = sum(collab_recent),
            p2_comp_collab_established_ind_5y = sum(collab_established)) 
p2_term_collab_new_existing_recent_established_ind_5y = p2_collab_new_existing_recent_established_ind_5y %>% 
  filter(status == "terminated",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_term_collab_recent_ind_5y = sum(collab_recent),
            p2_term_collab_established_ind_5y = sum(collab_established))




# non_ind version
trial_new_existing_recent_established_non_ind_5y = trial_firm_detail_3 %>%
  select(trial_id, sponsor_id, start_year, non_industry_collab) %>%
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(non_industry_collab != "") %>%
  mutate(collaborator_list = str_split(non_industry_collab, ",\\s*")) %>%
  unnest(collaborator_list) %>%  # One row per collaborator
  group_by(sponsor_id, collaborator_list) %>%
  mutate(first_year = min(start_year)) %>% 
  ungroup() %>%
  group_by(trial_id) %>%
  summarise(
    collab_new = any(start_year == first_year),
    collab_existing = any(start_year - first_year >= 1),
    collab_recent = any(start_year - first_year >= 1 & start_year - first_year <= 5),
    collab_established = any(start_year - first_year >= 6),
    .groups = "drop",
    collab_new = ifelse(collab_new == TRUE, 1, 0),
    collab_existing = ifelse(collab_existing == TRUE, 1, 0),
    collab_recent = ifelse(collab_recent == TRUE, 1, 0),
    collab_established = ifelse(collab_established == TRUE, 1, 0)
  ) %>% 
  ungroup()


p2_collab_new_existing_recent_established_non_ind_5y = trial_firm_detail_3 %>% 
  select(trial_id, sponsor_id, start_year, end_year, non_industry_collab, phase_2, status) %>% 
  filter(non_industry_collab != "") %>% 
  filter(phase_2 == 1) %>% 
  left_join(trial_new_existing_recent_established_non_ind_5y, by = "trial_id") %>% 
  select(trial_id, sponsor_id, start_year, end_year, collab_new, collab_existing, collab_recent, collab_established, status)
  
# Create the variables
p2_start_collab_new_existing_recent_established_non_ind_5y = p2_collab_new_existing_recent_established_non_ind_5y %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_collab_recent_non_ind_5y = sum(collab_recent),
            p2_start_collab_established_non_ind_5y = sum(collab_established)) 
p2_comp_collab_new_existing_recent_established_non_ind_5y = p2_collab_new_existing_recent_established_non_ind_5y %>% 
  filter(status == "completed",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_comp_collab_recent_non_ind_5y = sum(collab_recent),
            p2_comp_collab_established_non_ind_5y = sum(collab_established)) 
p2_term_collab_new_existing_recent_established_non_ind_5y = p2_collab_new_existing_recent_established_non_ind_5y %>% 
  filter(status == "terminated",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_term_collab_recent_non_ind_5y = sum(collab_recent),
            p2_term_collab_established_non_ind_5y = sum(collab_established))



```

Do the exact same thing for the above chunk, but instead of p2 to all phase collab, do p2 to p2 collab

```{r}
# Do the exact same thing for the above chunk, but instead of p2 to all phase collab, do p2 to p2 collab

# Add the variables new, existing, recent, and established collaborators to the trials, these are binary variables to each trials
trial_new_existing_recent_established_to_p2 = trial_firm_detail_3 %>%
  filter(phase_2 == 1) %>% 
  select(trial_id, sponsor_id, start_year, collab_num, collaborator) %>%
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(collab_num > 0) %>%
  mutate(collaborator_list = str_split(collaborator, ",\\s*")) %>%
  unnest(collaborator_list) %>%  # One row per collaborator
  group_by(sponsor_id, collaborator_list) %>%
  mutate(first_year = min(start_year)) %>% 
  ungroup() %>%
  group_by(trial_id) %>%
  summarise(
    collab_new = any(start_year == first_year),
    collab_existing = any(start_year - first_year >= 1),
    collab_recent = any(start_year - first_year >= 1 & start_year - first_year <= 2),
    collab_established = any(start_year - first_year >= 3),
    .groups = "drop",
    collab_new = ifelse(collab_new == TRUE, 1, 0),
    collab_existing = ifelse(collab_existing == TRUE, 1, 0),
    collab_recent = ifelse(collab_recent == TRUE, 1, 0),
    collab_established = ifelse(collab_established == TRUE, 1, 0)
  ) %>% 
  ungroup()


p2_collab_new_existing_recent_established_to_p2 = trial_firm_detail_3 %>% 
  select(trial_id, sponsor_id, start_year, end_year, collab_num, phase_2, status) %>% 
  filter(collab_num > 0) %>% 
  filter(phase_2 == 1) %>% 
  left_join(trial_new_existing_recent_established_to_p2, by = "trial_id") %>% 
  select(trial_id, sponsor_id, start_year, end_year, collab_new, collab_existing, collab_recent, collab_established, status)
  
# Create the variables
p2_start_collab_new_existing_recent_established_to_p2 = p2_collab_new_existing_recent_established_to_p2 %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_collab_new_to_p2 = sum(collab_new),
            p2_start_collab_existing_to_p2 = sum(collab_existing),
            p2_start_collab_recent_to_p2 = sum(collab_recent),
            p2_start_collab_established_to_p2 = sum(collab_established)) 
p2_comp_collab_new_existing_recent_established_to_p2 = p2_collab_new_existing_recent_established_to_p2 %>% 
  filter(status == "completed",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_comp_collab_new_to_p2 = sum(collab_new),
            p2_comp_collab_existing_to_p2 = sum(collab_existing),
            p2_comp_collab_recent_to_p2 = sum(collab_recent),
            p2_comp_collab_established_to_p2 = sum(collab_established)) 
p2_term_collab_new_existing_recent_established_to_p2 = p2_collab_new_existing_recent_established_to_p2 %>% 
  filter(status == "terminated",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_term_collab_new_to_p2 = sum(collab_new),
            p2_term_collab_existing_to_p2 = sum(collab_existing),
            p2_term_collab_recent_to_p2 = sum(collab_recent),
            p2_term_collab_established_to_p2 = sum(collab_established))




# Also create ind, non_ind versions: new, existing, recent, and established collaborators to the trials, these are binary variables to each trials
# ind version
trial_new_existing_recent_established_ind_to_p2 = trial_firm_detail_3 %>%
  filter(phase_2 == 1) %>% 
  select(trial_id, sponsor_id, start_year, industry_collab) %>%
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(industry_collab != "") %>%
  mutate(collaborator_list = str_split(industry_collab, ",\\s*")) %>%
  unnest(collaborator_list) %>%  # One row per collaborator
  group_by(sponsor_id, collaborator_list) %>%
  mutate(first_year = min(start_year)) %>% 
  ungroup() %>%
  group_by(trial_id) %>%
  summarise(
    collab_new = any(start_year == first_year),
    collab_existing = any(start_year - first_year >= 1),
    collab_recent = any(start_year - first_year >= 1 & start_year - first_year <= 2),
    collab_established = any(start_year - first_year >= 3),
    .groups = "drop",
    collab_new = ifelse(collab_new == TRUE, 1, 0),
    collab_existing = ifelse(collab_existing == TRUE, 1, 0),
    collab_recent = ifelse(collab_recent == TRUE, 1, 0),
    collab_established = ifelse(collab_established == TRUE, 1, 0)
  ) %>% 
  ungroup()


p2_collab_new_existing_recent_established_ind_to_p2 = trial_firm_detail_3 %>% 
  select(trial_id, sponsor_id, start_year, end_year, industry_collab, phase_2, status) %>% 
  filter(industry_collab != "") %>% 
  filter(phase_2 == 1) %>% 
  left_join(trial_new_existing_recent_established_ind_to_p2, by = "trial_id") %>% 
  select(trial_id, sponsor_id, start_year, end_year, collab_new, collab_existing, collab_recent, collab_established, status)
  
# Create the variables
p2_start_collab_new_existing_recent_established_ind_to_p2 = p2_collab_new_existing_recent_established_ind_to_p2 %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_collab_new_ind_to_p2 = sum(collab_new),
            p2_start_collab_existing_ind_to_p2 = sum(collab_existing),
            p2_start_collab_recent_ind_to_p2 = sum(collab_recent),
            p2_start_collab_established_ind_to_p2 = sum(collab_established)) 
p2_comp_collab_new_existing_recent_established_ind_to_p2 = p2_collab_new_existing_recent_established_ind_to_p2 %>% 
  filter(status == "completed",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_comp_collab_new_ind_to_p2 = sum(collab_new),
            p2_comp_collab_existing_ind_to_p2 = sum(collab_existing),
            p2_comp_collab_recent_ind_to_p2 = sum(collab_recent),
            p2_comp_collab_established_ind_to_p2 = sum(collab_established)) 
p2_term_collab_new_existing_recent_established_ind_to_p2 = p2_collab_new_existing_recent_established_ind_to_p2 %>% 
  filter(status == "terminated",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_term_collab_new_ind_to_p2 = sum(collab_new),
            p2_term_collab_existing_ind_to_p2 = sum(collab_existing),
            p2_term_collab_recent_ind_to_p2 = sum(collab_recent),
            p2_term_collab_established_ind_to_p2 = sum(collab_established))



# non_ind version
trial_new_existing_recent_established_non_ind_to_p2 = trial_firm_detail_3 %>%
  filter(phase_2 == 1) %>% 
  select(trial_id, sponsor_id, start_year, non_industry_collab) %>%
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(non_industry_collab != "") %>%
  mutate(collaborator_list = str_split(non_industry_collab, ",\\s*")) %>%
  unnest(collaborator_list) %>%  # One row per collaborator
  group_by(sponsor_id, collaborator_list) %>%
  mutate(first_year = min(start_year)) %>% 
  ungroup() %>%
  group_by(trial_id) %>%
  summarise(
    collab_new = any(start_year == first_year),
    collab_existing = any(start_year - first_year >= 1),
    collab_recent = any(start_year - first_year >= 1 & start_year - first_year <= 2),
    collab_established = any(start_year - first_year >= 3),
    .groups = "drop",
    collab_new = ifelse(collab_new == TRUE, 1, 0),
    collab_existing = ifelse(collab_existing == TRUE, 1, 0),
    collab_recent = ifelse(collab_recent == TRUE, 1, 0),
    collab_established = ifelse(collab_established == TRUE, 1, 0)
  ) %>% 
  ungroup()


p2_collab_new_existing_recent_established_non_ind_to_p2 = trial_firm_detail_3 %>% 
  select(trial_id, sponsor_id, start_year, end_year, non_industry_collab, phase_2, status) %>% 
  filter(non_industry_collab != "") %>% 
  filter(phase_2 == 1) %>% 
  left_join(trial_new_existing_recent_established_non_ind_to_p2, by = "trial_id") %>% 
  select(trial_id, sponsor_id, start_year, end_year, collab_new, collab_existing, collab_recent, collab_established, status)
  
# Create the variables
p2_start_collab_new_existing_recent_established_non_ind_to_p2 = p2_collab_new_existing_recent_established_non_ind_to_p2 %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_collab_new_non_ind_to_p2 = sum(collab_new),
            p2_start_collab_existing_non_ind_to_p2 = sum(collab_existing),
            p2_start_collab_recent_non_ind_to_p2 = sum(collab_recent),
            p2_start_collab_established_non_ind_to_p2 = sum(collab_established)) 
p2_comp_collab_new_existing_recent_established_non_ind_to_p2 = p2_collab_new_existing_recent_established_non_ind_to_p2 %>% 
  filter(status == "completed",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_comp_collab_new_non_ind_to_p2 = sum(collab_new),
            p2_comp_collab_existing_non_ind_to_p2 = sum(collab_existing),
            p2_comp_collab_recent_non_ind_to_p2 = sum(collab_recent),
            p2_comp_collab_established_non_ind_to_p2 = sum(collab_established)) 
p2_term_collab_new_existing_recent_established_non_ind_to_p2 = p2_collab_new_existing_recent_established_non_ind_to_p2 %>% 
  filter(status == "terminated",
         end_year != "") %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_term_collab_new_non_ind_to_p2 = sum(collab_new),
            p2_term_collab_existing_non_ind_to_p2 = sum(collab_existing),
            p2_term_collab_recent_non_ind_to_p2 = sum(collab_recent),
            p2_term_collab_established_non_ind_to_p2 = sum(collab_established))


```


```{r}
# Add the variables with collab, industry collab, non industry collab
p2_start_with_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  mutate(collab_dummy = ifelse(collab_num == 0, 0, 1)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_with_collab = sum(collab_dummy))
p2_term_with_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(status == "terminated") %>% 
  mutate(collab_dummy = ifelse(collab_num == 0, 0, 1)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_term_with_collab = sum(collab_dummy))
p2_comp_with_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(status == "completed") %>% 
  mutate(collab_dummy = ifelse(collab_num == 0, 0, 1)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_comp_with_collab = sum(collab_dummy))

p2_start_with_collab_industry = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(industry_collab != "") %>% 
  mutate(collab_dummy = ifelse(collab_num == 0, 0, 1)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_with_collab_industry = sum(collab_dummy))
p2_term_with_collab_industry = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(industry_collab != "") %>% 
  filter(status == "terminated") %>% 
  mutate(collab_dummy = ifelse(collab_num == 0, 0, 1)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_term_with_collab_industry = sum(collab_dummy))
p2_comp_with_collab_industry = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(industry_collab != "") %>% 
  filter(status == "completed") %>% 
  mutate(collab_dummy = ifelse(collab_num == 0, 0, 1)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_comp_with_collab_industry = sum(collab_dummy))

p2_start_with_collab_non_industry = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(non_industry_collab != "") %>% 
  mutate(collab_dummy = ifelse(collab_num == 0, 0, 1)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_with_collab_non_industry = sum(collab_dummy))
p2_term_with_collab_non_industry = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(non_industry_collab != "") %>% 
  filter(status == "terminated") %>% 
  mutate(collab_dummy = ifelse(collab_num == 0, 0, 1)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_term_with_collab_non_industry = sum(collab_dummy))
p2_comp_with_collab_non_industry = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(non_industry_collab != "") %>% 
  filter(status == "completed") %>% 
  mutate(collab_dummy = ifelse(collab_num == 0, 0, 1)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_comp_with_collab_non_industry = sum(collab_dummy))

```


```{r}
# phase_2_start_with_collab(_in EU, in US, in other countries)
p2_start_with_collab_EU = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(region == "EU") %>% 
  mutate(collab_dummy = ifelse(collab_num == 0, 0, 1)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_with_collab_EU = sum(collab_dummy))
p2_start_with_collab_US = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(region == "US") %>% 
  mutate(collab_dummy = ifelse(collab_num == 0, 0, 1)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_with_collab_US = sum(collab_dummy))
p2_start_with_collab_other_countries = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(region == "Others") %>% 
  mutate(collab_dummy = ifelse(collab_num == 0, 0, 1)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_with_collab_other_countries = sum(collab_dummy))

```


```{r}
# Create variables p2*total/unique*ongoing/new/old*industry_collab
p2_total_start_industry_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(industry_collab != "") %>% 
  select(sponsor_id, start_year, industry_collab) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_total_new_industry_collab_name = str_c(industry_collab, collapse = ", "))

p2_total_end_industry_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(industry_collab != "") %>% 
  select(sponsor_id, end_year, industry_collab) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_total_end_industry_collab_name = str_c(industry_collab, collapse = ", "))

p2_industry_collab = firm_year_dataset_9 %>% 
  left_join(p2_total_start_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_total_end_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_total_new_industry_collab_name, p2_total_end_industry_collab_name) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_total_new_industry_collab_name = ifelse(is.na(p2_total_new_industry_collab_name), "", p2_total_new_industry_collab_name)) %>%
  mutate(p2_total_end_industry_collab_name = ifelse(is.na(p2_total_end_industry_collab_name), "", p2_total_end_industry_collab_name)) %>%
  mutate(p2_total_new_industry_collab = p2_total_new_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
         p2_total_new_industry_collab = ifelse(p2_total_new_industry_collab_name == "", 0, p2_total_new_industry_collab)) %>% 
  mutate(
    cum_p2_total_new_industry_collab_name = accumulate(
      p2_total_new_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_total_end_industry_collab_name = lag(accumulate(
      p2_total_end_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_active_industry_collab_name = preserve_setdiff(str_split(cum_p2_total_new_industry_collab_name, ", ")[[1]], 
                                                    str_split(cum_p2_total_end_industry_collab_name, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_active_industry_collab = p2_active_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
    p2_active_industry_collab = ifelse(p2_active_industry_collab_name == "", 0, p2_active_industry_collab),
    p2_unique_active_industry_collab = p2_active_industry_collab_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_industry_collab = ifelse(p2_active_industry_collab_name == "", 0, p2_unique_active_industry_collab)
    ) %>% 
  ungroup() %>% 
  mutate(
    # Convert active and new collaborators into lists (ignoring empty strings)
    active_industry_collab_list = str_split(p2_active_industry_collab_name, ",\\s*"),
    new_unique_industry_collab_list = str_split(p2_total_new_industry_collab_name, ",\\s*"),
    # Compare current new collaborators with previous year's active collaborators
    p2_unique_new_industry_collab = map2_dbl(
      new_unique_industry_collab_list, 
      lag(active_industry_collab_list, default = list(character(0))), 
      ~ length(unique(setdiff(.x[.x != ""], .y[.y != ""]))) # Remove empty strings and calculate unique collaborators
    ),
    p2_total_old_industry_collab = p2_active_industry_collab - p2_total_new_industry_collab,
    p2_unique_old_industry_collab = p2_unique_active_industry_collab - p2_unique_new_industry_collab,
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_total_active_industry_collab = p2_active_industry_collab, p2_total_new_industry_collab, p2_total_old_industry_collab, p2_unique_active_industry_collab, p2_unique_new_industry_collab, p2_unique_old_industry_collab)


# Create variables p2*total/unique*ongoing/new/old*large*industry_collab
p2_total_start_large_industry_collab = collaborator_industry_2018 %>% 
  filter(phase_2 == 1) %>% 
  filter(large_industry_collab == 1) %>% 
  select(sponsor_id, start_year, collaborator_id) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_total_new_large_industry_collab_name = str_c(collaborator_id, collapse = ", "))

p2_total_end_large_industry_collab = collaborator_industry_2018 %>% 
  filter(phase_2 == 1) %>% 
  filter(large_industry_collab == 1) %>% 
  select(sponsor_id, end_year, collaborator_id) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_total_end_large_industry_collab_name = str_c(collaborator_id, collapse = ", "))

p2_large_industry_collab = firm_year_dataset_9 %>% 
  left_join(p2_total_start_large_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_total_end_large_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_total_new_large_industry_collab_name, p2_total_end_large_industry_collab_name) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_total_new_large_industry_collab_name = ifelse(is.na(p2_total_new_large_industry_collab_name), "", p2_total_new_large_industry_collab_name)) %>%
  mutate(p2_total_end_large_industry_collab_name = ifelse(is.na(p2_total_end_large_industry_collab_name), "", p2_total_end_large_industry_collab_name)) %>%
  mutate(p2_total_new_large_industry_collab = p2_total_new_large_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
         p2_total_new_large_industry_collab = ifelse(p2_total_new_large_industry_collab_name == "", 0, p2_total_new_large_industry_collab)) %>% 
  mutate(
    cum_p2_total_new_large_industry_collab_name = accumulate(
      p2_total_new_large_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_total_end_large_industry_collab_name = lag(accumulate(
      p2_total_end_large_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_active_large_industry_collab_name = preserve_setdiff(str_split(cum_p2_total_new_large_industry_collab_name, ", ")[[1]], 
                                                    str_split(cum_p2_total_end_large_industry_collab_name, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_active_large_industry_collab = p2_active_large_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
    p2_active_large_industry_collab = ifelse(p2_active_large_industry_collab_name == "", 0, p2_active_large_industry_collab),
    p2_unique_active_large_industry_collab = p2_active_large_industry_collab_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_large_industry_collab = ifelse(p2_active_large_industry_collab_name == "", 0, p2_unique_active_large_industry_collab)
    ) %>% 
  ungroup() %>% 
  mutate(
    # Convert active and new collaborators into lists (ignoring empty strings)
    active_large_industry_collab_list = str_split(p2_active_large_industry_collab_name, ",\\s*"),
    new_unique_large_industry_collab_list = str_split(p2_total_new_large_industry_collab_name, ",\\s*"),
    # Compare current new collaborators with previous year's active collaborators
    p2_unique_new_large_industry_collab = map2_dbl(
      new_unique_large_industry_collab_list, 
      lag(active_large_industry_collab_list, default = list(character(0))), 
      ~ length(unique(setdiff(.x[.x != ""], .y[.y != ""]))) # Remove empty strings and calculate unique collaborators
    ),
    p2_total_old_large_industry_collab = p2_active_large_industry_collab - p2_total_new_large_industry_collab,
    p2_unique_old_large_industry_collab = p2_unique_active_large_industry_collab - p2_unique_new_large_industry_collab,
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_total_active_large_industry_collab = p2_active_large_industry_collab, p2_total_new_large_industry_collab, p2_total_old_large_industry_collab, p2_unique_active_large_industry_collab, p2_unique_new_large_industry_collab, p2_unique_old_large_industry_collab)


# Create variables p2*total/unique*ongoing/new/old*small*industry_collab
p2_total_start_small_industry_collab = collaborator_industry_2018 %>% 
  filter(phase_2 == 1) %>% 
  filter(small_industry_collab == 1) %>% 
  select(sponsor_id, start_year, collaborator_id) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_total_new_small_industry_collab_name = str_c(collaborator_id, collapse = ", "))

p2_total_end_small_industry_collab = collaborator_industry_2018 %>% 
  filter(phase_2 == 1) %>% 
  filter(small_industry_collab == 1) %>% 
  select(sponsor_id, end_year, collaborator_id) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_total_end_small_industry_collab_name = str_c(collaborator_id, collapse = ", "))

p2_small_industry_collab = firm_year_dataset_9 %>% 
  left_join(p2_total_start_small_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_total_end_small_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_total_new_small_industry_collab_name, p2_total_end_small_industry_collab_name) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_total_new_small_industry_collab_name = ifelse(is.na(p2_total_new_small_industry_collab_name), "", p2_total_new_small_industry_collab_name)) %>%
  mutate(p2_total_end_small_industry_collab_name = ifelse(is.na(p2_total_end_small_industry_collab_name), "", p2_total_end_small_industry_collab_name)) %>%
  mutate(p2_total_new_small_industry_collab = p2_total_new_small_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
         p2_total_new_small_industry_collab = ifelse(p2_total_new_small_industry_collab_name == "", 0, p2_total_new_small_industry_collab)) %>% 
  mutate(
    cum_p2_total_new_small_industry_collab_name = accumulate(
      p2_total_new_small_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_total_end_small_industry_collab_name = lag(accumulate(
      p2_total_end_small_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_active_small_industry_collab_name = preserve_setdiff(str_split(cum_p2_total_new_small_industry_collab_name, ", ")[[1]], 
                                                    str_split(cum_p2_total_end_small_industry_collab_name, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_active_small_industry_collab = p2_active_small_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
    p2_active_small_industry_collab = ifelse(p2_active_small_industry_collab_name == "", 0, p2_active_small_industry_collab),
    p2_unique_active_small_industry_collab = p2_active_small_industry_collab_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_small_industry_collab = ifelse(p2_active_small_industry_collab_name == "", 0, p2_unique_active_small_industry_collab)
    ) %>% 
  ungroup() %>% 
  mutate(
    # Convert active and new collaborators into lists (ignoring empty strings)
    active_small_industry_collab_list = str_split(p2_active_small_industry_collab_name, ",\\s*"),
    new_unique_small_industry_collab_list = str_split(p2_total_new_small_industry_collab_name, ",\\s*"),
    # Compare current new collaborators with previous year's active collaborators
    p2_unique_new_small_industry_collab = map2_dbl(
      new_unique_small_industry_collab_list, 
      lag(active_small_industry_collab_list, default = list(character(0))), 
      ~ length(unique(setdiff(.x[.x != ""], .y[.y != ""]))) # Remove empty strings and calculate unique collaborators
    ),
    p2_total_old_small_industry_collab = p2_active_small_industry_collab - p2_total_new_small_industry_collab,
    p2_unique_old_small_industry_collab = p2_unique_active_small_industry_collab - p2_unique_new_small_industry_collab,
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_total_active_small_industry_collab = p2_active_small_industry_collab, p2_total_new_small_industry_collab, p2_total_old_small_industry_collab, p2_unique_active_small_industry_collab, p2_unique_new_small_industry_collab, p2_unique_old_small_industry_collab)

  
# Create variables p2*total/unique*ongoing/new/old*non_industry_collab
p2_total_start_non_industry_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(non_industry_collab != "") %>% 
  select(sponsor_id, start_year, non_industry_collab) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_total_new_non_industry_collab_name = str_c(non_industry_collab, collapse = ", "))

p2_total_end_non_industry_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(non_industry_collab != "") %>% 
  select(sponsor_id, end_year, non_industry_collab) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_total_end_non_industry_collab_name = str_c(non_industry_collab, collapse = ", "))

p2_non_industry_collab = firm_year_dataset_9 %>% 
  left_join(p2_total_start_non_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_total_end_non_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_total_new_non_industry_collab_name, p2_total_end_non_industry_collab_name) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_total_new_non_industry_collab_name = ifelse(is.na(p2_total_new_non_industry_collab_name), "", p2_total_new_non_industry_collab_name)) %>%
  mutate(p2_total_end_non_industry_collab_name = ifelse(is.na(p2_total_end_non_industry_collab_name), "", p2_total_end_non_industry_collab_name)) %>%
  mutate(p2_total_new_non_industry_collab = p2_total_new_non_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
         p2_total_new_non_industry_collab = ifelse(p2_total_new_non_industry_collab_name == "", 0, p2_total_new_non_industry_collab)) %>% 
  mutate(
    cum_p2_total_new_non_industry_collab_name = accumulate(
      p2_total_new_non_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_total_end_non_industry_collab_name = lag(accumulate(
      p2_total_end_non_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_active_non_industry_collab_name = preserve_setdiff(str_split(cum_p2_total_new_non_industry_collab_name, ", ")[[1]], 
                                                    str_split(cum_p2_total_end_non_industry_collab_name, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_active_non_industry_collab = p2_active_non_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
    p2_active_non_industry_collab = ifelse(p2_active_non_industry_collab_name == "", 0, p2_active_non_industry_collab),
    p2_unique_active_non_industry_collab = p2_active_non_industry_collab_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_non_industry_collab = ifelse(p2_active_non_industry_collab_name == "", 0, p2_unique_active_non_industry_collab)
    ) %>% 
  ungroup() %>% 
  mutate(
    # Convert active and new collaborators into lists (ignoring empty strings)
    active_non_industry_collab_list = str_split(p2_active_non_industry_collab_name, ",\\s*"),
    new_unique_non_industry_collab_list = str_split(p2_total_new_non_industry_collab_name, ",\\s*"),
    # Compare current new collaborators with previous year's active collaborators
    p2_unique_new_non_industry_collab = map2_dbl(
      new_unique_non_industry_collab_list, 
      lag(active_non_industry_collab_list, default = list(character(0))), 
      ~ length(setdiff(.x[.x != ""], .y[.y != ""])) # Remove empty strings and calculate unique collaborators
    ),
    p2_total_old_non_industry_collab = p2_active_non_industry_collab - p2_total_new_non_industry_collab,
    p2_unique_old_non_industry_collab = p2_unique_active_non_industry_collab - p2_unique_new_non_industry_collab,
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_total_active_non_industry_collab = p2_active_non_industry_collab, p2_total_new_non_industry_collab, p2_total_old_non_industry_collab, p2_unique_active_non_industry_collab, p2_unique_new_non_industry_collab, p2_unique_old_non_industry_collab)



# Create variable p2_trial_with_collab
p2_with_collab_start = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  mutate(collab_dummy = ifelse(collab_num == 0, 0, 1)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_with_collab_start = sum(collab_dummy))

p2_with_collab_end = trial_firm_detail_3 %>%  
  filter(phase_2 == 1) %>% 
  mutate(collab_dummy = ifelse(collab_num == 0, 0, 1)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_with_collab_end = sum(collab_dummy))

p2_trial_with_collab_avtive = firm_year_dataset_9 %>% 
  left_join(p2_with_collab_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_with_collab_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  group_by(sponsor_id) %>% 
  mutate(across(everything(), ~ replace_na(., 0)),
         cum_p2_with_collab_start = cumsum(p2_with_collab_start),
         cum_p2_with_collab_end = lag(cumsum(p2_with_collab_end), default = 0),
         p2_trial_with_collab_avtive = cum_p2_with_collab_start - cum_p2_with_collab_end) %>% 
  select(sponsor_id, year, p2_trial_with_collab_avtive)



# Create variables p2_trial_cro_collab
p2_with_cro_collab_start = cro_collab_p2 %>% 
    filter(cro_collab_p2_dummy > 0) %>% 
    group_by(sponsor_id, start_year) %>% 
    summarize(p2_with_cro_collab_start = sum(cro_collab_p2_dummy))

p2_with_cro_collab_end = cro_collab_p2 %>% 
    filter(cro_collab_p2_dummy > 0) %>% 
    group_by(sponsor_id, end_year) %>% 
    summarize(p2_with_cro_collab_end = sum(cro_collab_p2_dummy))

p2_with_cro_collab_comp = cro_collab_p2 %>% 
    filter(cro_collab_p2_dummy > 0) %>% 
    filter(status == "completed") %>% 
    group_by(sponsor_id, end_year) %>% 
    summarize(p2_with_cro_collab_comp = sum(cro_collab_p2_dummy))
p2_with_cro_collab_term = cro_collab_p2 %>% 
    filter(cro_collab_p2_dummy > 0) %>% 
    filter(status == "terminated") %>% 
    group_by(sponsor_id, end_year) %>% 
    summarize(p2_with_cro_collab_term = sum(cro_collab_p2_dummy))


p2_trial_with_cro_collab = firm_year_dataset_9 %>% 
  left_join(p2_with_cro_collab_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_with_cro_collab_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_with_cro_collab_comp, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_with_cro_collab_term, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  group_by(sponsor_id) %>% 
  mutate(across(everything(), ~ replace_na(., 0)),
         cum_p2_with_cro_collab_start = cumsum(p2_with_cro_collab_start),
         cum_p2_with_cro_collab_end = lag(cumsum(p2_with_cro_collab_end), default = 0),
         p2_trial_with_cro_collab_active = cum_p2_with_cro_collab_start - cum_p2_with_cro_collab_end) %>% 
  select(sponsor_id, year, p2_trial_with_cro_collab_active, p2_with_cro_collab_comp, p2_with_cro_collab_term)



# Create variables p3_trial_cro_collab
p3_with_cro_collab_start = cro_collab_p3 %>% 
    filter(cro_collab_p3_dummy > 0) %>% 
    group_by(sponsor_id, start_year) %>% 
    summarize(p3_with_cro_collab_start = sum(cro_collab_p3_dummy))

p3_with_cro_collab_end = cro_collab_p3 %>% 
    filter(cro_collab_p3_dummy > 0) %>% 
    group_by(sponsor_id, end_year) %>% 
    summarize(p3_with_cro_collab_end = sum(cro_collab_p3_dummy))

p3_with_cro_collab_comp = cro_collab_p3 %>% 
    filter(cro_collab_p3_dummy > 0) %>% 
    filter(status == "completed") %>% 
    group_by(sponsor_id, end_year) %>% 
    summarize(p3_with_cro_collab_comp = sum(cro_collab_p3_dummy))
p3_with_cro_collab_term = cro_collab_p3 %>% 
    filter(cro_collab_p3_dummy > 0) %>% 
    filter(status == "terminated") %>% 
    group_by(sponsor_id, end_year) %>% 
    summarize(p3_with_cro_collab_term = sum(cro_collab_p3_dummy))


p3_trial_with_cro_collab = firm_year_dataset_9 %>% 
  left_join(p3_with_cro_collab_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p3_with_cro_collab_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p3_with_cro_collab_comp, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p3_with_cro_collab_term, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  group_by(sponsor_id) %>% 
  mutate(across(everything(), ~ replace_na(., 0)),
         cum_p3_with_cro_collab_start = cumsum(p3_with_cro_collab_start),
         cum_p3_with_cro_collab_end = lag(cumsum(p3_with_cro_collab_end), default = 0),
         p3_trial_with_cro_collab_active = cum_p3_with_cro_collab_start - cum_p3_with_cro_collab_end) %>% 
  select(sponsor_id, year, p3_trial_with_cro_collab_active, p3_with_cro_collab_comp, p3_with_cro_collab_term)


  
# Add these 13 columns to the firm_year_dataset
firm_year_dataset_10 = firm_year_dataset_9 %>% 
  left_join(allphase_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_start_collab_new_existing_recent_established, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_comp_collab_new_existing_recent_established, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_term_collab_new_existing_recent_established, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_start_collab_new_existing_recent_established_ind, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_comp_collab_new_existing_recent_established_ind, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_term_collab_new_existing_recent_established_ind, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_start_collab_new_existing_recent_established_non_ind, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_comp_collab_new_existing_recent_established_non_ind, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_term_collab_new_existing_recent_established_non_ind, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_start_collab_new_existing_recent_established_5y, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_comp_collab_new_existing_recent_established_5y, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_term_collab_new_existing_recent_established_5y, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_start_collab_new_existing_recent_established_ind_5y, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_comp_collab_new_existing_recent_established_ind_5y, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_term_collab_new_existing_recent_established_ind_5y, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_start_collab_new_existing_recent_established_non_ind_5y, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_comp_collab_new_existing_recent_established_non_ind_5y, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_term_collab_new_existing_recent_established_non_ind_5y, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_start_collab_new_existing_recent_established_to_p2, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_comp_collab_new_existing_recent_established_to_p2, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_term_collab_new_existing_recent_established_to_p2, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_start_collab_new_existing_recent_established_ind_to_p2, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_comp_collab_new_existing_recent_established_ind_to_p2, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_term_collab_new_existing_recent_established_ind_to_p2, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_start_collab_new_existing_recent_established_non_ind_to_p2, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_comp_collab_new_existing_recent_established_non_ind_to_p2, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_term_collab_new_existing_recent_established_non_ind_to_p2, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_start_with_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_term_with_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_comp_with_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_start_with_collab_industry, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_term_with_collab_industry, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_comp_with_collab_industry, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_start_with_collab_non_industry, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_term_with_collab_non_industry, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_comp_with_collab_non_industry, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_start_with_collab_EU, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_with_collab_US, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_with_collab_other_countries, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_large_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_small_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_non_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_trial_with_collab_avtive, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>%
  left_join(p2_trial_with_cro_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>%
  left_join(p3_trial_with_cro_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>%
  mutate(p2_start_without_collab = phase_2_start - p2_start_with_collab,
         p2_start_without_collab_industry = phase_2_start - p2_start_with_collab_industry) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) 

# 320776
```




##### Add covid

  Here we want to keep track of the numbers of phase 2 trials that are covid related:
  
  p2_covid_start and p2_covid_active for each firm_year

```{r}
# Create variable p2_trial_with_collab
p2_covid_start = trial_firm_detail_3 %>%  
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_covid_start = sum(covid))

p2_covid_end = trial_firm_detail_3 %>%  
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_covid_end = sum(covid))

p2_covid = firm_year_dataset_10 %>% 
  left_join(p2_covid_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_covid_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  group_by(sponsor_id) %>% 
  mutate(across(everything(), ~ replace_na(., 0)),
         cum_p2_covid_start = cumsum(p2_covid_start),
         cum_p2_covid_end = lag(cumsum(p2_covid_end), default = 0),
         p2_covid_avtive = cum_p2_covid_start - cum_p2_covid_end) %>% 
  select(sponsor_id, year, p2_covid_start, p2_covid_avtive)



firm_year_dataset_11 = firm_year_dataset_10 %>% 
  left_join(p2_covid, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>%
  mutate(across(everything(), ~ replace_na(., 0))) 

# 320776
```

##### Add disease 

  Here we want to investigate the measure of different types of diseases, we will first classify diseases in the trial_firm_detail dataset in numerous ways and then count them in the firm_year_dataset.
  
  Utilize the disease_id_code_name table built from section /Clean Variables/disease
  
  We are interested in:
   - p2_unique_disease_ongoing
   
   - p2_cancer_ongoing
   
   - p2_cxx_disease_start
   
   - # of phase 2 trials in Diseases with low vs. high number patients
    - pre_2010, and pre_2018
    
   - # of phase 2 trials in Diseases with short vs. long lengths (from trial start to trial completion date)
    - pre_2010, and pre_2018
    
   - average/median/max/min p2 length of the trial for each company/year
   
   - # of phase 2 trials in Diseases with low costs and high costs in phase 2 costs
   
   - Average cost of phase 2 trials


```{r}
# p2_unique_disease_ongoing
p2_disease_start = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(disease_id != "") %>% 
  select(sponsor_id, start_year, disease_id) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_all_disease_start_list = str_c(disease_id, collapse = ", "))
p2_disease_end = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(disease_id != "") %>% 
  select(sponsor_id, end_year, disease_id) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_all_disease_end_list = str_c(disease_id, collapse = ", "))

p2_unique_disease_ongoing = firm_year_dataset_11 %>% 
  left_join(p2_disease_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_disease_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_all_disease_start_list, p2_all_disease_end_list) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_all_disease_start_list = ifelse(is.na(p2_all_disease_start_list), "", p2_all_disease_start_list)) %>%
  mutate(p2_all_disease_end_list = ifelse(is.na(p2_all_disease_end_list), "", p2_all_disease_end_list)) %>% 
  mutate(cum_p2_all_disease_start_list = accumulate(
      p2_all_disease_start_list, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", "))) %>% 
  mutate(cum_p2_all_disease_end_list = lag(accumulate(
      p2_all_disease_end_list, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_disease_ongoing_list = preserve_setdiff(str_split(cum_p2_all_disease_start_list, ", ")[[1]], 
                                                    str_split(cum_p2_all_disease_end_list, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_disease_ongoing = p2_unique_disease_ongoing_list %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_disease_ongoing = ifelse(p2_unique_disease_ongoing_list == "", 0, p2_unique_disease_ongoing)
    ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_unique_disease_ongoing)

```

Create p2_unique_disease_ongoing_w_collab/exist_collab/estab_collab
```{r}
# Create p2_unique_disease_ongoing_w_collab/exist_collab/estab_collab

# p2_unique_disease_ongoing_w_collab
p2_disease_start_w_collab = trial_firm_detail_3 %>% 
  filter(collab == 1,
         phase_2 == 1,
         disease_id != "") %>% 
  select(sponsor_id, start_year, disease_id) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_all_disease_start_list = str_c(disease_id, collapse = ", "))
p2_disease_end_w_collab = trial_firm_detail_3 %>% 
  filter(collab == 1,
         phase_2 == 1,
         disease_id != "") %>% 
  select(sponsor_id, end_year, disease_id) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_all_disease_end_list = str_c(disease_id, collapse = ", "))

p2_unique_disease_ongoing_w_collab = firm_year_dataset_11 %>% 
  left_join(p2_disease_start_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_disease_end_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_all_disease_start_list, p2_all_disease_end_list) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_all_disease_start_list = ifelse(is.na(p2_all_disease_start_list), "", p2_all_disease_start_list)) %>%
  mutate(p2_all_disease_end_list = ifelse(is.na(p2_all_disease_end_list), "", p2_all_disease_end_list)) %>% 
  mutate(cum_p2_all_disease_start_list = accumulate(
      p2_all_disease_start_list, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", "))) %>% 
  mutate(cum_p2_all_disease_end_list = lag(accumulate(
      p2_all_disease_end_list, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_disease_ongoing_list = preserve_setdiff(str_split(cum_p2_all_disease_start_list, ", ")[[1]], 
                                                    str_split(cum_p2_all_disease_end_list, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_disease_ongoing_w_collab = p2_unique_disease_ongoing_list %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_disease_ongoing_w_collab = ifelse(p2_unique_disease_ongoing_list == "", 0, p2_unique_disease_ongoing_w_collab)
    ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_unique_disease_ongoing_w_collab)

# p2_unique_disease_ongoing_w_exist_collab
p2_disease_start_w_exist_collab = trial_firm_detail_3 %>% 
  filter(collab_existing == 1,
         phase_2 == 1,
         disease_id != "") %>% 
  select(sponsor_id, start_year, disease_id) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_all_disease_start_list = str_c(disease_id, collapse = ", "))
p2_disease_end_w_exist_collab = trial_firm_detail_3 %>% 
  filter(collab_existing == 1,
         phase_2 == 1,
         disease_id != "") %>% 
  select(sponsor_id, end_year, disease_id) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_all_disease_end_list = str_c(disease_id, collapse = ", "))

p2_unique_disease_ongoing_w_exist_collab = firm_year_dataset_11 %>% 
  left_join(p2_disease_start_w_exist_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_disease_end_w_exist_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_all_disease_start_list, p2_all_disease_end_list) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_all_disease_start_list = ifelse(is.na(p2_all_disease_start_list), "", p2_all_disease_start_list)) %>%
  mutate(p2_all_disease_end_list = ifelse(is.na(p2_all_disease_end_list), "", p2_all_disease_end_list)) %>% 
  mutate(cum_p2_all_disease_start_list = accumulate(
      p2_all_disease_start_list, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", "))) %>% 
  mutate(cum_p2_all_disease_end_list = lag(accumulate(
      p2_all_disease_end_list, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_disease_ongoing_list = preserve_setdiff(str_split(cum_p2_all_disease_start_list, ", ")[[1]], 
                                                    str_split(cum_p2_all_disease_end_list, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_disease_ongoing_w_exist_collab = p2_unique_disease_ongoing_list %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_disease_ongoing_w_exist_collab = ifelse(p2_unique_disease_ongoing_list == "", 0, p2_unique_disease_ongoing_w_exist_collab)
    ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_unique_disease_ongoing_w_exist_collab)

# p2_unique_disease_ongoing_w_estab_collab
p2_disease_start_w_estab_collab = trial_firm_detail_3 %>% 
  filter(collab_established == 1,
         phase_2 == 1,
         disease_id != "") %>% 
  select(sponsor_id, start_year, disease_id) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_all_disease_start_list = str_c(disease_id, collapse = ", "))
p2_disease_end_w_estab_collab = trial_firm_detail_3 %>% 
  filter(collab_established == 1,
         phase_2 == 1,
         disease_id != "") %>% 
  select(sponsor_id, end_year, disease_id) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_all_disease_end_list = str_c(disease_id, collapse = ", "))

p2_unique_disease_ongoing_w_estab_collab = firm_year_dataset_11 %>% 
  left_join(p2_disease_start_w_estab_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_disease_end_w_estab_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_all_disease_start_list, p2_all_disease_end_list) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_all_disease_start_list = ifelse(is.na(p2_all_disease_start_list), "", p2_all_disease_start_list)) %>%
  mutate(p2_all_disease_end_list = ifelse(is.na(p2_all_disease_end_list), "", p2_all_disease_end_list)) %>% 
  mutate(cum_p2_all_disease_start_list = accumulate(
      p2_all_disease_start_list, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", "))) %>% 
  mutate(cum_p2_all_disease_end_list = lag(accumulate(
      p2_all_disease_end_list, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_disease_ongoing_list = preserve_setdiff(str_split(cum_p2_all_disease_start_list, ", ")[[1]], 
                                                    str_split(cum_p2_all_disease_end_list, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_disease_ongoing_w_estab_collab = p2_unique_disease_ongoing_list %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_disease_ongoing_w_estab_collab = ifelse(p2_unique_disease_ongoing_list == "", 0, p2_unique_disease_ongoing_w_estab_collab)
    ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_unique_disease_ongoing_w_estab_collab)

```

```{r}
# p2_cancer_ongoing
# Note that Cancer(C04) has disease_id = 4
p2_cancer_start = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(disease_id == 4) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_cancer_start = n())
p2_cancer_end = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(disease_id == 4) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_cancer_end = n())

p2_cancer_ongoing = firm_year_dataset_11 %>% 
  left_join(p2_cancer_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_cancer_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_cancer_start, p2_cancer_end) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  group_by(sponsor_id) %>% 
  mutate(cum_p2_cancer_start = cumsum(p2_cancer_start),
         cum_p2_cancer_end = lag(cumsum(p2_cancer_end), default = 0),
         p2_cancer_ongoing = cum_p2_cancer_start - cum_p2_cancer_end) %>% 
  select(sponsor_id, year, p2_cancer_ongoing)



# p2_cxx_disease_start
cxx_list = c(1:25) # find the list of disease_ids corresponding to CXX diseases

p2_cxx_disease_start = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(disease_id %in% cxx_list) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_cxx_disease_start = n())




# p2_high_patnum_pre2010_ongoing, p2_low_patnum_pre2010_ongoing, p2_long_length_pre2010_ongoing, p2_short_length_pre2010_ongoing 
p2_trial_pre2010 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(disease_id != "") %>% 
  filter(end_year != "") %>% 
  filter(end_year <= 2010) %>% 
  filter(patient_num != "") %>% 
  mutate(patient_num = as.numeric(patient_num),
         start_year = as.numeric(start_year),
         end_year = as.numeric(end_year),
         trial_length = end_year - start_year) %>% 
  select(trial_id, sponsor_id, disease_id, start_year, end_year, patient_num, trial_length)

p2_patnum_length_pre2010 = p2_trial_pre2010 %>% 
  group_by(disease_id) %>% 
  summarize(disease_mean_patnum = mean(patient_num),
            disease_mean_length = mean(trial_length)) %>% 
  ungroup() %>% 
  mutate(p2_high_patnum_pre2010 = ifelse(disease_mean_patnum > median(disease_mean_patnum), 1, 0),
         p2_low_patnum_pre2010 = ifelse(p2_high_patnum_pre2010 == 1, 0, 1),
         p2_long_length_pre2010 = ifelse(disease_mean_length > median(disease_mean_length), 1, 0),
         p2_short_length_pre2010 = ifelse(p2_long_length_pre2010 == 1, 0, 1)) %>% 
  select(disease_id, p2_high_patnum_pre2010, p2_low_patnum_pre2010, p2_long_length_pre2010, p2_short_length_pre2010)

p2_trial_patnum_length_pre2010 = p2_trial_pre2010 %>% 
  left_join(p2_patnum_length_pre2010, by = "disease_id") %>% 
  select(sponsor_id, start_year, end_year, p2_high_patnum_pre2010, p2_low_patnum_pre2010, p2_long_length_pre2010, p2_short_length_pre2010)

p2_trial_patnum_length_pre2010_start = p2_trial_patnum_length_pre2010 %>% 
  mutate(start_year = as.character(start_year)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_high_patnum_pre2010_start = sum(p2_high_patnum_pre2010),
            p2_low_patnum_pre2010_start = sum(p2_low_patnum_pre2010),
            p2_long_length_pre2010_start = sum(p2_long_length_pre2010),
            p2_short_length_pre2010_start = sum(p2_short_length_pre2010))
  
p2_trial_patnum_length_pre2010_end = p2_trial_patnum_length_pre2010 %>% 
  mutate(end_year = as.character(end_year)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_high_patnum_pre2010_end = sum(p2_high_patnum_pre2010),
            p2_low_patnum_pre2010_end = sum(p2_low_patnum_pre2010),
            p2_long_length_pre2010_end = sum(p2_long_length_pre2010),
            p2_short_length_pre2010_end = sum(p2_short_length_pre2010))

p2_trial_patnum_length_pre2010_ongoing = firm_year_dataset_11 %>% 
  left_join(p2_trial_patnum_length_pre2010_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_trial_patnum_length_pre2010_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_high_patnum_pre2010_start, p2_high_patnum_pre2010_end, p2_low_patnum_pre2010_start, p2_low_patnum_pre2010_end, p2_long_length_pre2010_start, p2_long_length_pre2010_end, p2_short_length_pre2010_start, p2_short_length_pre2010_end) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  group_by(sponsor_id) %>% 
  mutate(cum_p2_high_patnum_pre2010_start = cumsum(p2_high_patnum_pre2010_start),
         cum_p2_high_patnum_pre2010_end = lag(cumsum(p2_high_patnum_pre2010_end), default = 0),
         cum_p2_low_patnum_pre2010_start = cumsum(p2_low_patnum_pre2010_start),
         cum_p2_low_patnum_pre2010_end = lag(cumsum(p2_low_patnum_pre2010_end), default = 0),
         cum_p2_long_length_pre2010_start = cumsum(p2_long_length_pre2010_start),
         cum_p2_long_length_pre2010_end = lag(cumsum(p2_long_length_pre2010_end), default = 0),
         cum_p2_short_length_pre2010_start = cumsum(p2_short_length_pre2010_start),
         cum_p2_short_length_pre2010_end = lag(cumsum(p2_short_length_pre2010_end), default = 0),
         p2_high_patnum_pre2010_ongoing = cum_p2_high_patnum_pre2010_start - cum_p2_high_patnum_pre2010_end,
         p2_low_patnum_pre2010_ongoing = cum_p2_low_patnum_pre2010_start - cum_p2_low_patnum_pre2010_end,
         p2_long_length_pre2010_ongoing = cum_p2_long_length_pre2010_start - cum_p2_long_length_pre2010_end,
         p2_short_length_pre2010_ongoing = cum_p2_short_length_pre2010_start - cum_p2_short_length_pre2010_end,) %>% 
  select(sponsor_id, year, p2_high_patnum_pre2010_ongoing, p2_low_patnum_pre2010_ongoing, p2_long_length_pre2010_ongoing, p2_short_length_pre2010_ongoing)




# Do again for 2018 cutoff
# p2_high_patnum_pre2018_ongoing, p2_low_patnum_pre2018_ongoing, p2_long_length_pre2018_ongoing, p2_short_length_pre2018_ongoing 
p2_trial_pre2018 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(disease_id != "") %>% 
  filter(end_year != "") %>% 
  filter(end_year <= 2018) %>% 
  filter(patient_num != "") %>% 
  mutate(patient_num = as.numeric(patient_num),
         start_year = as.numeric(start_year),
         end_year = as.numeric(end_year),
         trial_length = end_year - start_year) %>% 
  select(trial_id, sponsor_id, disease_id, start_year, end_year, patient_num, trial_length)

p2_patnum_length_pre2018 = p2_trial_pre2018 %>% 
  group_by(disease_id) %>% 
  summarize(disease_mean_patnum = mean(patient_num),
            disease_mean_length = mean(trial_length)) %>% 
  ungroup() %>% 
  mutate(p2_high_patnum_pre2018 = ifelse(disease_mean_patnum > median(disease_mean_patnum), 1, 0),
         p2_low_patnum_pre2018 = ifelse(p2_high_patnum_pre2018 == 1, 0, 1),
         p2_long_length_pre2018 = ifelse(disease_mean_length > median(disease_mean_length), 1, 0),
         p2_short_length_pre2018 = ifelse(p2_long_length_pre2018 == 1, 0, 1)) %>% 
  select(disease_id, p2_high_patnum_pre2018, p2_low_patnum_pre2018, p2_long_length_pre2018, p2_short_length_pre2018)

p2_trial_patnum_length_pre2018 = p2_trial_pre2018 %>% 
  left_join(p2_patnum_length_pre2018, by = "disease_id") %>% 
  select(sponsor_id, start_year, end_year, p2_high_patnum_pre2018, p2_low_patnum_pre2018, p2_long_length_pre2018, p2_short_length_pre2018)

p2_trial_patnum_length_pre2018_start = p2_trial_patnum_length_pre2018 %>% 
  mutate(start_year = as.character(start_year)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_high_patnum_pre2018_start = sum(p2_high_patnum_pre2018),
            p2_low_patnum_pre2018_start = sum(p2_low_patnum_pre2018),
            p2_long_length_pre2018_start = sum(p2_long_length_pre2018),
            p2_short_length_pre2018_start = sum(p2_short_length_pre2018))
  
p2_trial_patnum_length_pre2018_end = p2_trial_patnum_length_pre2018 %>% 
  mutate(end_year = as.character(end_year)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_high_patnum_pre2018_end = sum(p2_high_patnum_pre2018),
            p2_low_patnum_pre2018_end = sum(p2_low_patnum_pre2018),
            p2_long_length_pre2018_end = sum(p2_long_length_pre2018),
            p2_short_length_pre2018_end = sum(p2_short_length_pre2018))

p2_trial_patnum_length_pre2018_ongoing = firm_year_dataset_11 %>% 
  left_join(p2_trial_patnum_length_pre2018_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_trial_patnum_length_pre2018_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_high_patnum_pre2018_start, p2_high_patnum_pre2018_end, p2_low_patnum_pre2018_start, p2_low_patnum_pre2018_end, p2_long_length_pre2018_start, p2_long_length_pre2018_end, p2_short_length_pre2018_start, p2_short_length_pre2018_end) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  group_by(sponsor_id) %>% 
  mutate(cum_p2_high_patnum_pre2018_start = cumsum(p2_high_patnum_pre2018_start),
         cum_p2_high_patnum_pre2018_end = lag(cumsum(p2_high_patnum_pre2018_end), default = 0),
         cum_p2_low_patnum_pre2018_start = cumsum(p2_low_patnum_pre2018_start),
         cum_p2_low_patnum_pre2018_end = lag(cumsum(p2_low_patnum_pre2018_end), default = 0),
         cum_p2_long_length_pre2018_start = cumsum(p2_long_length_pre2018_start),
         cum_p2_long_length_pre2018_end = lag(cumsum(p2_long_length_pre2018_end), default = 0),
         cum_p2_short_length_pre2018_start = cumsum(p2_short_length_pre2018_start),
         cum_p2_short_length_pre2018_end = lag(cumsum(p2_short_length_pre2018_end), default = 0),
         p2_high_patnum_pre2018_ongoing = cum_p2_high_patnum_pre2018_start - cum_p2_high_patnum_pre2018_end,
         p2_low_patnum_pre2018_ongoing = cum_p2_low_patnum_pre2018_start - cum_p2_low_patnum_pre2018_end,
         p2_long_length_pre2018_ongoing = cum_p2_long_length_pre2018_start - cum_p2_long_length_pre2018_end,
         p2_short_length_pre2018_ongoing = cum_p2_short_length_pre2018_start - cum_p2_short_length_pre2018_end,) %>% 
  select(sponsor_id, year, p2_high_patnum_pre2018_ongoing, p2_low_patnum_pre2018_ongoing, p2_long_length_pre2018_ongoing, p2_short_length_pre2018_ongoing)




# p2_average/median/max/min_length 
p2_trial_length_mesh = trial_firm_detail_3 %>% # Calculate the average trial length for each disease_id for imputation later on
  filter(phase_2 == 1) %>%
  filter(end_year != "") %>% 
  mutate(start_year = as.numeric(start_year),
         end_year = as.numeric(end_year),
         trial_length = end_year - start_year) %>% 
  group_by(disease_id) %>% 
  summarize(mesh_trial_length = mean(trial_length)) 

p2_trial_length = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>%
  mutate(start_year = as.numeric(start_year),
         end_year = as.numeric(end_year),
         trial_length = end_year - start_year) %>% 
  select(trial_id, sponsor_id, disease_id, start_year, end_year, trial_length) %>% 
  mutate(end_year = ifelse(is.na(end_year), 2024, end_year)) %>% 
  left_join(p2_trial_length_mesh, by = "disease_id") %>% 
  mutate(trial_length_imputed = ifelse(is.na(trial_length), mesh_trial_length, trial_length)) %>% 
  select(-mesh_trial_length)

p2_trial_length_start = p2_trial_length %>% 
  mutate(start_year = as.character(start_year)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_trial_length_start = str_c(trial_length, collapse = ", "),
            p2_trial_length_imputed_start = str_c(trial_length_imputed, collapse = ", "))

p2_trial_length_end = p2_trial_length %>% 
  mutate(end_year = as.character(end_year)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_trial_length_end = str_c(trial_length, collapse = ", "),
            p2_trial_length_imputed_end = str_c(trial_length_imputed, collapse = ", "))

p2_average_median_max_min_length = firm_year_dataset_11 %>% 
  left_join(p2_trial_length_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_trial_length_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_trial_length_start, p2_trial_length_end, p2_trial_length_imputed_start, p2_trial_length_imputed_end) %>% 
  mutate(across(everything(), ~ replace_na(., ""))) %>% 
  group_by(sponsor_id) %>% 
  mutate(cum_p2_trial_length_start = accumulate(
      p2_trial_length_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
         cum_p2_trial_length_end = lag(accumulate(
      p2_trial_length_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = ""),
      cum_p2_trial_length_imputed_start = accumulate(
      p2_trial_length_imputed_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
         cum_p2_trial_length_imputed_end = lag(accumulate(
      p2_trial_length_imputed_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_trial_length_active = ifelse(length(preserve_setdiff(str_split(cum_p2_trial_length_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_end, ", ")[[1]])) == 0, NA,
                                    preserve_setdiff(str_split(cum_p2_trial_length_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_end, ", ")[[1]]) %>% paste(collapse = ", ")),
    p2_mean_length = mean(as.numeric(str_split(p2_trial_length_active, ", ")[[1]])),
    p2_median_length = median(as.numeric(str_split(p2_trial_length_active, ", ")[[1]])),
    p2_max_length = max(as.numeric(str_split(p2_trial_length_active, ", ")[[1]])),
    p2_min_length = min(as.numeric(str_split(p2_trial_length_active, ", ")[[1]])),
    p2_trial_length_imputed_active = ifelse(length(preserve_setdiff(str_split(cum_p2_trial_length_imputed_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_imputed_end, ", ")[[1]])) == 0, NA,
                                    preserve_setdiff(str_split(cum_p2_trial_length_imputed_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_imputed_end, ", ")[[1]]) %>% paste(collapse = ", ")),
    p2_mean_length_imputed = mean(as.numeric(str_split(p2_trial_length_imputed_active, ", ")[[1]]))
  ) %>% 
  select(sponsor_id, year, p2_mean_length, p2_mean_length_imputed, p2_median_length, p2_max_length, p2_min_length)

p2_average_median_max_min_length = p2_average_median_max_min_length %>% 
  mutate(p2_mean_length = ifelse(is.na(p2_mean_length), "", as.character(p2_mean_length)),
         p2_mean_length_imputed = ifelse(is.na(p2_mean_length_imputed), "", as.character(p2_mean_length_imputed)),
         p2_median_length = ifelse(is.na(p2_median_length), "", as.character(p2_median_length)),
         p2_max_length = ifelse(is.na(p2_max_length), "", as.character(p2_max_length)),
         p2_min_length = ifelse(is.na(p2_min_length), "", as.character(p2_min_length))
         )

```

Create p2_mean_length_w_collab/exist_collab/estab_collab
```{r}
# Create p2_mean_length_w_collab/exist_collab/estab_collab

# p2_average_length_w_collab
p2_trial_length_w_collab = trial_firm_detail_3 %>% 
  filter(collab == 1,
         phase_2 == 1) %>%
  mutate(start_year = as.numeric(start_year),
         end_year = as.numeric(end_year),
         trial_length = end_year - start_year) %>% 
  select(trial_id, sponsor_id, disease_id, start_year, end_year, trial_length) %>% 
  mutate(end_year = ifelse(is.na(end_year), 2024, end_year))

p2_trial_length_start_w_collab = p2_trial_length_w_collab %>% 
  mutate(start_year = as.character(start_year)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_trial_length_start = str_c(trial_length, collapse = ", "))

p2_trial_length_end_w_collab = p2_trial_length_w_collab %>% 
  mutate(end_year = as.character(end_year)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_trial_length_end = str_c(trial_length, collapse = ", "))

p2_average_length_w_collab = firm_year_dataset_11 %>% 
  left_join(p2_trial_length_start_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_trial_length_end_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_trial_length_start, p2_trial_length_end) %>% 
  mutate(across(everything(), ~ replace_na(., ""))) %>% 
  group_by(sponsor_id) %>% 
  mutate(cum_p2_trial_length_start = accumulate(
      p2_trial_length_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
         cum_p2_trial_length_end = lag(accumulate(
      p2_trial_length_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_trial_length_active = ifelse(length(preserve_setdiff(str_split(cum_p2_trial_length_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_end, ", ")[[1]])) == 0, NA,
                                    preserve_setdiff(str_split(cum_p2_trial_length_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_end, ", ")[[1]]) %>% paste(collapse = ", ")),
    p2_mean_length_w_collab = mean(as.numeric(str_split(p2_trial_length_active, ", ")[[1]]))) %>% 
  select(sponsor_id, year, p2_mean_length_w_collab) %>% 
  mutate(p2_mean_length_w_collab = ifelse(is.na(p2_mean_length_w_collab), "", as.character(p2_mean_length_w_collab)))

# p2_average_length_w_exist_collab
p2_trial_length_w_exist_collab = trial_firm_detail_3 %>% 
  filter(collab_existing == 1,
         phase_2 == 1) %>%
  mutate(start_year = as.numeric(start_year),
         end_year = as.numeric(end_year),
         trial_length = end_year - start_year) %>% 
  select(trial_id, sponsor_id, disease_id, start_year, end_year, trial_length) %>% 
  mutate(end_year = ifelse(is.na(end_year), 2024, end_year))

p2_trial_length_start_w_exist_collab = p2_trial_length_w_exist_collab %>% 
  mutate(start_year = as.character(start_year)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_trial_length_start = str_c(trial_length, collapse = ", "))

p2_trial_length_end_w_exist_collab = p2_trial_length_w_exist_collab %>% 
  mutate(end_year = as.character(end_year)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_trial_length_end = str_c(trial_length, collapse = ", "))

p2_average_length_w_exist_collab = firm_year_dataset_11 %>% 
  left_join(p2_trial_length_start_w_exist_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_trial_length_end_w_exist_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_trial_length_start, p2_trial_length_end) %>% 
  mutate(across(everything(), ~ replace_na(., ""))) %>% 
  group_by(sponsor_id) %>% 
  mutate(cum_p2_trial_length_start = accumulate(
      p2_trial_length_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
         cum_p2_trial_length_end = lag(accumulate(
      p2_trial_length_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_trial_length_active = ifelse(length(preserve_setdiff(str_split(cum_p2_trial_length_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_end, ", ")[[1]])) == 0, NA,
                                    preserve_setdiff(str_split(cum_p2_trial_length_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_end, ", ")[[1]]) %>% paste(collapse = ", ")),
    p2_mean_length_w_exist_collab = mean(as.numeric(str_split(p2_trial_length_active, ", ")[[1]]))) %>% 
  select(sponsor_id, year, p2_mean_length_w_exist_collab) %>% 
  mutate(p2_mean_length_w_exist_collab = ifelse(is.na(p2_mean_length_w_exist_collab), "", as.character(p2_mean_length_w_exist_collab)))

# p2_average_length_w_estab_collab
p2_trial_length_w_estab_collab = trial_firm_detail_3 %>% 
  filter(collab_established == 1,
         phase_2 == 1) %>%
  mutate(start_year = as.numeric(start_year),
         end_year = as.numeric(end_year),
         trial_length = end_year - start_year) %>% 
  select(trial_id, sponsor_id, disease_id, start_year, end_year, trial_length) %>% 
  mutate(end_year = ifelse(is.na(end_year), 2024, end_year))

p2_trial_length_start_w_estab_collab = p2_trial_length_w_estab_collab %>% 
  mutate(start_year = as.character(start_year)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_trial_length_start = str_c(trial_length, collapse = ", "))

p2_trial_length_end_w_estab_collab = p2_trial_length_w_estab_collab %>% 
  mutate(end_year = as.character(end_year)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_trial_length_end = str_c(trial_length, collapse = ", "))

p2_average_length_w_estab_collab = firm_year_dataset_11 %>% 
  left_join(p2_trial_length_start_w_estab_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_trial_length_end_w_estab_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_trial_length_start, p2_trial_length_end) %>% 
  mutate(across(everything(), ~ replace_na(., ""))) %>% 
  group_by(sponsor_id) %>% 
  mutate(cum_p2_trial_length_start = accumulate(
      p2_trial_length_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
         cum_p2_trial_length_end = lag(accumulate(
      p2_trial_length_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_trial_length_active = ifelse(length(preserve_setdiff(str_split(cum_p2_trial_length_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_end, ", ")[[1]])) == 0, NA,
                                    preserve_setdiff(str_split(cum_p2_trial_length_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_end, ", ")[[1]]) %>% paste(collapse = ", ")),
    p2_mean_length_w_estab_collab = mean(as.numeric(str_split(p2_trial_length_active, ", ")[[1]]))) %>% 
  select(sponsor_id, year, p2_mean_length_w_estab_collab) %>% 
  mutate(p2_mean_length_w_estab_collab = ifelse(is.na(p2_mean_length_w_estab_collab), "", as.character(p2_mean_length_w_estab_collab)))

```


```{r}
# Create a mapping list from disease code to class and cost first
disease_code_cat = read_csv("disease/Disease_Categorization_by_R_D_Cost.csv")
disease_cat_cost = data_frame(
  category = c("Anti-Infective", "Oncology", "Other", "Gastrointestinal", "Respiratory System", "Central Nervous System", "Ophthalmology", "Cardiovascular", "Dermatology", "Endocrine", "Immunomodulation", "Pain and Anesthesia", "Genitourinary System"),
  class = c("mid", "mid", "", "high", "mid", "mid", "mid", "low", "low", "mid", "high", "high", "mid"),
  cost = c(14.2, 11.2, 0, 15.8, 12.2, 13.9, 13.8, 7, 8.9, 12.1, 16, 17,14.6)
)
disease_code_class_cost= disease_code_cat %>% 
  left_join(disease_cat_cost) %>% 
  mutate(disease_id = as.character(disease_id)) %>% 
  select(disease_id, class, cost)




# p2_highcost_ongoing, p2_midcost_ongoing, p2_lowcost_ongoing
p2_cost_class = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  left_join(disease_code_class_cost, by = "disease_id") %>% 
  mutate(highcost = ifelse(class == "high", 1, 0),
         midcost = ifelse(class == "mid", 1, 0),
         lowcost = ifelse(class == "low", 1, 0)) %>% 
  select(trial_id, sponsor_id, start_year, end_year, disease_id, highcost, midcost, lowcost) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) 

p2_cost_class_start = p2_cost_class %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(highcost_start = sum(highcost),
            midcost_start = sum(midcost),
            lowcost_start = sum(lowcost))

p2_cost_class_end = p2_cost_class %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(highcost_end= sum(highcost),
            midcost_end = sum(midcost),
            lowcost_end = sum(lowcost))

p2_cost_class_ongoing = firm_year_dataset_11 %>% 
  left_join(p2_cost_class_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_cost_class_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, highcost_start, highcost_end, midcost_start, midcost_end, lowcost_start, lowcost_end) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  group_by(sponsor_id) %>% 
  mutate(
    cum_highcost_start = cumsum(highcost_start),
    cum_highcost_end = lag(cumsum(highcost_end), default = 0),
    cum_midcost_start = cumsum(midcost_start),
    cum_midcost_end = lag(cumsum(midcost_end), default = 0),
    cum_lowcost_start = cumsum(lowcost_start),
    cum_lowcost_end = lag(cumsum(lowcost_end), default = 0),
    p2_highcost_ongoing = cum_highcost_start - cum_highcost_end,
    p2_midcost_ongoing = cum_midcost_start - cum_midcost_end,
    p2_lowcost_ongoing = cum_lowcost_start - cum_lowcost_end
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_highcost_ongoing, p2_midcost_ongoing, p2_lowcost_ongoing)




# p2_mean_cost
p2_cost = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  left_join(disease_code_class_cost, by = "disease_id") %>% 
  select(trial_id, sponsor_id, start_year, end_year, disease_id, cost) %>% 
  mutate(cost = ifelse(is.na(cost), 0, cost))

p2_cost_start = p2_cost %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_cost_start = str_c(cost, collapse = ", "))

p2_cost_end = p2_cost %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_cost_end = str_c(cost, collapse = ", "))

p2_mean_cost = firm_year_dataset_11 %>% 
  left_join(p2_cost_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_cost_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_cost_start, p2_cost_end) %>% 
  mutate(across(everything(), ~ replace_na(., ""))) %>% 
  group_by(sponsor_id) %>% 
  mutate(cum_p2_cost_start = accumulate(
      p2_cost_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
         cum_p2_cost_end = lag(accumulate(
      p2_cost_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_cost_active = ifelse(length(preserve_setdiff(str_split(cum_p2_cost_start, ", ")[[1]],
                                              str_split(cum_p2_cost_end, ", ")[[1]])) == 0, NA,
                                    preserve_setdiff(str_split(cum_p2_cost_start, ", ")[[1]],
                                              str_split(cum_p2_cost_end, ", ")[[1]]) %>% paste(collapse = ", ")),
    p2_mean_cost = mean(as.numeric(str_split(p2_cost_active, ", ")[[1]])),
    p2_mean_cost_without_other = mean(as.numeric(str_split(p2_cost_active, ", ")[[1]])[as.numeric(str_split(p2_cost_active, ", ")[[1]]) != 0])
  ) %>% 
  select(sponsor_id, year, p2_mean_cost, p2_mean_cost_without_other) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) 



# Add these 13 columns to the dataset
firm_year_dataset_12 = firm_year_dataset_11 %>% 
  left_join(p2_unique_disease_ongoing, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_unique_disease_ongoing_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_unique_disease_ongoing_w_exist_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_unique_disease_ongoing_w_estab_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_cancer_ongoing, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_cxx_disease_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_trial_patnum_length_pre2010_ongoing, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_trial_patnum_length_pre2018_ongoing, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_average_median_max_min_length, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_average_length_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_average_length_w_exist_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_average_length_w_estab_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_cost_class_ongoing, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_mean_cost, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) 

# 320776
```



  Comments & Observations: 
   - For variables related to diseases, trials missing disease_id were not counted.
   - For variables related to patient_num, trials missing patient_num were not counted.
   - After filtering (phase_2 == 1, end_year<2010, patient_num != ""), we have 18729 trials left, with 29 diseases.
   - For p2_average/median/max/min_length, I only counted for the completed (or terminated) ones. 
   - For p2_mean_cost, since excess amount of "Other" class of disease (which have cost 0) will drag down the average cost of trials, I created a p2_mean_cost, and p2_mean_cost_without_other, which calculate average cost excluding the "Other" type of diseases.
   
   
##### Add size

We want to count the number of p2/all trials of companies starting before 2018 and use this to determine the companies size, whether they are above or below median of number of trials.

size_above_median_p2_2018, size_below_median_p2_2018, size_above_median_all_2018, size_below_median_all_2018

```{r}
# Count the number of (p2/all) trials started before 2018 for each company
sponsor_found_year = firm_name_founding_year_id_new %>% 
  group_by(sponsor_id) %>% summarize(year_founded = min(year_founded))


num_p2_trials_pre_2018 = trial_firm_detail_3 %>% 
  filter(phase_2 == "1") %>% 
  filter(as.numeric(start_year) < 2018) %>% 
  group_by(sponsor_id) %>% 
  summarize(num_p2_trials_pre_2018 = n()) %>% 
  ungroup()
num_p2_trials_pre_2018 = sponsor_found_year %>% 
  left_join(num_p2_trials_pre_2018, by = "sponsor_id") %>% 
  rowwise() %>% 
  mutate(temp = case_when(
    is.na(year_founded) ~ NA,
    !is.na(num_p2_trials_pre_2018) ~ num_p2_trials_pre_2018,
    year_founded <= "2018" & is.na(num_p2_trials_pre_2018) ~ 0),
         temp = ifelse(
    is.na(temp) & !is.na(num_p2_trials_pre_2018), num_p2_trials_pre_2018, temp)) %>% 
  select(sponsor_id, temp) %>% 
  filter(!is.na(temp)) %>% 
  rename(num_p2_trials_pre_2018 = temp) %>% 
  filter(sponsor_id %in% trial_firm_detail_3$sponsor_id)
quantile_p2_trials_pre_2018 = 
  num_p2_trials_pre_2018 %>% pull(num_p2_trials_pre_2018) %>% quantile(probs = c(0.5, 0.75, 0.9))


num_all_trials_pre_2018 = trial_firm_detail_3 %>% 
  filter(as.numeric(start_year) < 2018) %>% 
  group_by(sponsor_id) %>% 
  summarize(num_all_trials_pre_2018 = n()) %>% 
  ungroup() 
num_all_trials_pre_2018 = sponsor_found_year %>% 
  left_join(num_all_trials_pre_2018, by = "sponsor_id") %>% 
  rowwise() %>% 
  mutate(temp = case_when(
    is.na(year_founded) ~ NA,
    !is.na(num_all_trials_pre_2018) ~ num_all_trials_pre_2018,
    year_founded <= "2018" & is.na(num_all_trials_pre_2018) ~ 0),
         temp = ifelse(
    is.na(temp) & !is.na(num_all_trials_pre_2018), num_all_trials_pre_2018, temp)) %>% 
  select(sponsor_id, temp) %>% 
  filter(!is.na(temp)) %>% 
  rename(num_all_trials_pre_2018 = temp) %>% 
  filter(sponsor_id %in% trial_firm_detail_3$sponsor_id)
quantile_all_trials_pre_2018 = 
  num_all_trials_pre_2018 %>% pull(num_all_trials_pre_2018) %>% quantile(probs = c(0.50, 0.75, 0.9))



# Create a dataset determining if a sponsor is above or below average for num of (p2/all) trials started before 2018
sponsor_size = num_all_trials_pre_2018 %>% 
  left_join(num_p2_trials_pre_2018, by = "sponsor_id") %>% 
  mutate(size_below_50_p2_2018 = as.character(ifelse(num_p2_trials_pre_2018 <= quantile_p2_trials_pre_2018["50%"], 1, 0)), 
         size_50_to_75_p2_2018 = as.character(ifelse(quantile_p2_trials_pre_2018["50%"] < num_p2_trials_pre_2018 & num_p2_trials_pre_2018 <= quantile_p2_trials_pre_2018["75%"], 1, 0)),
         size_75_to_90_p2_2018 = as.character(ifelse(quantile_p2_trials_pre_2018["75%"] < num_p2_trials_pre_2018 & num_p2_trials_pre_2018 <= quantile_p2_trials_pre_2018["90%"], 1, 0)),
         size_90_above_p2_2018 = as.character(ifelse(num_p2_trials_pre_2018 > quantile_p2_trials_pre_2018["90%"], 1, 0)), 
         
         size_below_50_all_2018 = as.character(ifelse(num_all_trials_pre_2018 <= quantile_all_trials_pre_2018["50%"], 1, 0)), 
         size_50_to_75_all_2018 = as.character(ifelse(quantile_all_trials_pre_2018["50%"] < num_all_trials_pre_2018 & num_all_trials_pre_2018 <= quantile_all_trials_pre_2018["75%"], 1, 0)), 
         size_75_to_90_all_2018 = as.character(ifelse(quantile_all_trials_pre_2018["75%"] < num_all_trials_pre_2018 & num_all_trials_pre_2018 <= quantile_all_trials_pre_2018["90%"], 1, 0)),
         size_90_above_all_2018 = as.character(ifelse(num_all_trials_pre_2018 > quantile_all_trials_pre_2018["90%"], 1, 0))) %>% 
  select(-num_all_trials_pre_2018, -num_p2_trials_pre_2018)



# Add these 4 columns to the dataset
firm_year_dataset_13 = firm_year_dataset_12 %>% 
  left_join(sponsor_size, by = "sponsor_id") %>% 
  mutate(across(everything(), ~ replace_na(., "")))

# 320776
```



##### Add unique sites

We want to keep track of the unique sites (countries) each company conduct their trials in over their years.

Additionally, we also want to count the unique EU sites.

```{r}
# Create variables p2_unique_active_site
p2_unique_site_start = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_unique_site_start = str_c(country, collapse = ", "))

p2_unique_site_end = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_unique_site_end = str_c(country, collapse = ", "))

p2_unique_active_site = firm_year_dataset_13 %>% 
  left_join(p2_unique_site_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_unique_site_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_unique_site_start, p2_unique_site_end) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_unique_site_start = ifelse(is.na(p2_unique_site_start), "", p2_unique_site_start)) %>%
  mutate(p2_unique_site_end = ifelse(is.na(p2_unique_site_end), "", p2_unique_site_end)) %>%
  mutate(
    cum_p2_unique_site_start = accumulate(
      p2_unique_site_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_unique_site_end = lag(accumulate(
      p2_unique_site_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")
  ) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_active_site_name = preserve_setdiff(str_split(cum_p2_unique_site_start, ", ")[[1]], 
                                                    str_split(cum_p2_unique_site_end, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_site = p2_unique_active_site_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_site = ifelse(p2_unique_active_site_name == "", 0, p2_unique_active_site)
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_unique_active_site)


# Create variables p2_unique_active_site_eu
p2_unique_site_eu_start = trial_firm_detail_3 %>% 
  filter(phase_2 == 1,
         country %in% eu_countries) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_unique_site_start = str_c(country, collapse = ", "))

p2_unique_site_eu_end = trial_firm_detail_3 %>% 
  filter(phase_2 == 1,
         country %in% eu_countries) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_unique_site_end = str_c(country, collapse = ", "))

p2_unique_active_site_eu = firm_year_dataset_13 %>% 
  left_join(p2_unique_site_eu_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_unique_site_eu_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_unique_site_start, p2_unique_site_end) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_unique_site_start = ifelse(is.na(p2_unique_site_start), "", p2_unique_site_start)) %>%
  mutate(p2_unique_site_end = ifelse(is.na(p2_unique_site_end), "", p2_unique_site_end)) %>%
  mutate(
    cum_p2_unique_site_start = accumulate(
      p2_unique_site_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_unique_site_end = lag(accumulate(
      p2_unique_site_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")
  ) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_active_site_name = preserve_setdiff(str_split(cum_p2_unique_site_start, ", ")[[1]], 
                                                    str_split(cum_p2_unique_site_end, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_site_eu = p2_unique_active_site_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_site_eu = ifelse(p2_unique_active_site_name == "", 0, p2_unique_active_site_eu)
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_unique_active_site_eu)




# Create variables p2_unique_active_site_non_eu
p2_unique_site_non_eu_start = trial_firm_detail_3 %>% 
  filter(phase_2 == 1,
         !country %in% eu_countries) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_unique_site_start = str_c(country, collapse = ", "))

p2_unique_site_non_eu_end = trial_firm_detail_3 %>% 
  filter(phase_2 == 1,
         !country %in% eu_countries) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_unique_site_end = str_c(country, collapse = ", "))

p2_unique_active_site_non_eu = firm_year_dataset_13 %>% 
  left_join(p2_unique_site_non_eu_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_unique_site_non_eu_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_unique_site_start, p2_unique_site_end) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_unique_site_start = ifelse(is.na(p2_unique_site_start), "", p2_unique_site_start)) %>%
  mutate(p2_unique_site_end = ifelse(is.na(p2_unique_site_end), "", p2_unique_site_end)) %>%
  mutate(
    cum_p2_unique_site_start = accumulate(
      p2_unique_site_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_unique_site_end = lag(accumulate(
      p2_unique_site_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")
  ) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_active_site_name = preserve_setdiff(str_split(cum_p2_unique_site_start, ", ")[[1]], 
                                                    str_split(cum_p2_unique_site_end, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_site_non_eu = p2_unique_active_site_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_site_non_eu = ifelse(p2_unique_active_site_name == "", 0, p2_unique_active_site_non_eu)
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_unique_active_site_non_eu)



# Create variables p2_unique_active_site_eu_w_collab
p2_unique_site_eu_start_w_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1,
         country %in% eu_countries,
         collab_num > 0) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_unique_site_start = str_c(country, collapse = ", "))

p2_unique_site_eu_end_w_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1,
         country %in% eu_countries,
         collab_num > 0) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_unique_site_end = str_c(country, collapse = ", "))

p2_unique_active_site_eu_w_collab = firm_year_dataset_13 %>% 
  left_join(p2_unique_site_eu_start_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_unique_site_eu_end_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_unique_site_start, p2_unique_site_end) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_unique_site_start = ifelse(is.na(p2_unique_site_start), "", p2_unique_site_start)) %>%
  mutate(p2_unique_site_end = ifelse(is.na(p2_unique_site_end), "", p2_unique_site_end)) %>%
  mutate(
    cum_p2_unique_site_start = accumulate(
      p2_unique_site_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_unique_site_end = lag(accumulate(
      p2_unique_site_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")
  ) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_active_site_name = preserve_setdiff(str_split(cum_p2_unique_site_start, ", ")[[1]], 
                                                    str_split(cum_p2_unique_site_end, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_site_eu_w_collab = p2_unique_active_site_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_site_eu_w_collab = ifelse(p2_unique_active_site_name == "", 0, p2_unique_active_site_eu_w_collab)
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_unique_active_site_eu_w_collab)



# Create variables p2_unique_active_site_non_eu_w_collab
p2_unique_site_non_eu_start_w_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1,
         !country %in% eu_countries,
         collab_num > 0) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_unique_site_start = str_c(country, collapse = ", "))

p2_unique_site_non_eu_end_w_collab = trial_firm_detail_3 %>% 
  filter(phase_2 == 1,
         !country %in% eu_countries,
         collab_num > 0) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_unique_site_end = str_c(country, collapse = ", "))

p2_unique_active_site_non_eu_w_collab = firm_year_dataset_13 %>% 
  left_join(p2_unique_site_non_eu_start_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_unique_site_non_eu_end_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_unique_site_start, p2_unique_site_end) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_unique_site_start = ifelse(is.na(p2_unique_site_start), "", p2_unique_site_start)) %>%
  mutate(p2_unique_site_end = ifelse(is.na(p2_unique_site_end), "", p2_unique_site_end)) %>%
  mutate(
    cum_p2_unique_site_start = accumulate(
      p2_unique_site_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_unique_site_end = lag(accumulate(
      p2_unique_site_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")
  ) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_active_site_name = preserve_setdiff(str_split(cum_p2_unique_site_start, ", ")[[1]], 
                                                    str_split(cum_p2_unique_site_end, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_site_non_eu_w_collab = p2_unique_active_site_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_site_non_eu_w_collab = ifelse(p2_unique_active_site_name == "", 0, p2_unique_active_site_non_eu_w_collab)
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_unique_active_site_non_eu_w_collab)


```

Create variables p2_unique_active_site_w_collab/exist_collab/estab_collab
```{r}
# Create variables p2_unique_active_site_w_collab/exist_collab/estab_collab

# p2_unique_active_site_w_collab
p2_unique_site_start_w_collab = trial_firm_detail_3 %>% 
  filter(collab == 1,
         phase_2 == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_unique_site_start = str_c(country, collapse = ", "))

p2_unique_site_end_w_collab = trial_firm_detail_3 %>% 
  filter(collab == 1,
         phase_2 == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_unique_site_end = str_c(country, collapse = ", "))

p2_unique_active_site_w_collab = firm_year_dataset_13 %>% 
  left_join(p2_unique_site_start_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_unique_site_end_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_unique_site_start, p2_unique_site_end) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_unique_site_start = ifelse(is.na(p2_unique_site_start), "", p2_unique_site_start)) %>%
  mutate(p2_unique_site_end = ifelse(is.na(p2_unique_site_end), "", p2_unique_site_end)) %>%
  mutate(
    cum_p2_unique_site_start = accumulate(
      p2_unique_site_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_unique_site_end = lag(accumulate(
      p2_unique_site_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")
  ) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_active_site_name = preserve_setdiff(str_split(cum_p2_unique_site_start, ", ")[[1]], 
                                                    str_split(cum_p2_unique_site_end, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_site_w_collab = p2_unique_active_site_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_site_w_collab = ifelse(p2_unique_active_site_name == "", 0, p2_unique_active_site_w_collab)
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_unique_active_site_w_collab)

# p2_unique_active_site_w_exist_collab
p2_unique_site_start_w_exist_collab = trial_firm_detail_3 %>% 
  filter(collab_existing == 1,
         phase_2 == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_unique_site_start = str_c(country, collapse = ", "))

p2_unique_site_end_w_exist_collab = trial_firm_detail_3 %>% 
  filter(collab_existing == 1,
         phase_2 == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_unique_site_end = str_c(country, collapse = ", "))

p2_unique_active_site_w_exist_collab = firm_year_dataset_13 %>% 
  left_join(p2_unique_site_start_w_exist_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_unique_site_end_w_exist_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_unique_site_start, p2_unique_site_end) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_unique_site_start = ifelse(is.na(p2_unique_site_start), "", p2_unique_site_start)) %>%
  mutate(p2_unique_site_end = ifelse(is.na(p2_unique_site_end), "", p2_unique_site_end)) %>%
  mutate(
    cum_p2_unique_site_start = accumulate(
      p2_unique_site_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_unique_site_end = lag(accumulate(
      p2_unique_site_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")
  ) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_active_site_name = preserve_setdiff(str_split(cum_p2_unique_site_start, ", ")[[1]], 
                                                    str_split(cum_p2_unique_site_end, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_site_w_exist_collab = p2_unique_active_site_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_site_w_exist_collab = ifelse(p2_unique_active_site_name == "", 0, p2_unique_active_site_w_exist_collab)
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_unique_active_site_w_exist_collab)

# p2_unique_active_site_w_estab_collab
p2_unique_site_start_w_estab_collab = trial_firm_detail_3 %>% 
  filter(collab_established == 1,
         phase_2 == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_unique_site_start = str_c(country, collapse = ", "))

p2_unique_site_end_w_estab_collab = trial_firm_detail_3 %>% 
  filter(collab_established == 1,
         phase_2 == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_unique_site_end = str_c(country, collapse = ", "))

p2_unique_active_site_w_estab_collab = firm_year_dataset_13 %>% 
  left_join(p2_unique_site_start_w_estab_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_unique_site_end_w_estab_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_unique_site_start, p2_unique_site_end) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_unique_site_start = ifelse(is.na(p2_unique_site_start), "", p2_unique_site_start)) %>%
  mutate(p2_unique_site_end = ifelse(is.na(p2_unique_site_end), "", p2_unique_site_end)) %>%
  mutate(
    cum_p2_unique_site_start = accumulate(
      p2_unique_site_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_unique_site_end = lag(accumulate(
      p2_unique_site_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")
  ) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_active_site_name = preserve_setdiff(str_split(cum_p2_unique_site_start, ", ")[[1]], 
                                                    str_split(cum_p2_unique_site_end, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_site_w_estab_collab = p2_unique_active_site_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_site_w_estab_collab = ifelse(p2_unique_active_site_name == "", 0, p2_unique_active_site_w_estab_collab)
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p2_unique_active_site_w_estab_collab)

```

```{r}
# Add these 4 column to the dataset
firm_year_dataset_14 = firm_year_dataset_13 %>% 
  left_join(p2_unique_active_site, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_unique_active_site_eu, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_unique_active_site_non_eu, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_unique_active_site_eu_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_unique_active_site_non_eu_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_unique_active_site_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_unique_active_site_w_exist_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(p2_unique_active_site_w_estab_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  mutate(across(everything(), ~ replace_na(., "")))

```

  
##### Add age of sponsor

We are interested in the age of the companies when GDPR applied (2018), we are classifying them into at_least_3_years, at_least_5_years, at_least_10_years, in the form of dummy variables. If we're missing founded year information about a sponsor, use their earliest trial year as founded year.

  age_3y_up_2018, age_5y_up_2018, age_10y_up_2018


```{r}
# Create variables age_3y_up_2018, age_5y_up_2018, age_10y_up_2018
sponsor_age_2018 = trial_firm_detail_3 %>% 
  group_by(sponsor_id) %>% 
  summarize(sponsor_found_year = as.numeric(min(sponsor_found_year))) %>% 
  mutate(sponsor_age_2018 = 2018 - sponsor_found_year,
         age_3y_up_2018 = ifelse(sponsor_age_2018 >= 3, 1, 0),
         age_5y_up_2018 = ifelse(sponsor_age_2018 >= 5, 1, 0),
         age_10y_up_2018 = ifelse(sponsor_age_2018 >= 10, 1, 0)) %>% 
  select(sponsor_id, age_3y_up_2018, age_5y_up_2018, age_10y_up_2018)


# Combine these 3 variables
firm_year_dataset_15 = firm_year_dataset_14 %>% 
  left_join(sponsor_age_2018, by = c("sponsor_id" = "sponsor_id")) %>% 
  mutate(across(everything(), ~ replace_na(., "")))
```

  

##### Add incapable of giving consent

  Further we discovered a useful metric from the Eu dataset, subject_subjects_incapable_of_giving_consent_personally. we hereby adding p2_start_incapable_consent to the firm-year panel and see if this reveal useful insights.
  
  Note that this variable is only available in the EU dataset so the observation is only for within EU.
  
  
```{r}
# Create p2_start_incapable_consent
p2_start_incapable_consent = trial_firm_detail_3 %>% left_join(eu_incapable_consent, by = "eudract_id") %>% 
  filter(subject_incapable_consent == 1) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, start_year, subject_incapable_consent) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_incapable_consent = sum(subject_incapable_consent))

# Do the same for collab/exist_collab/estab_collab
# p2_start_incapable_consent_w_collab
p2_start_incapable_consent_w_collab = trial_firm_detail_3 %>% left_join(eu_incapable_consent, by = "eudract_id") %>% 
  filter(subject_incapable_consent == 1,
         phase_2 == 1,
         collab == 1) %>% 
  select(sponsor_id, start_year, subject_incapable_consent) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_incapable_consent_w_collab = sum(subject_incapable_consent))
# p2_start_incapable_consent_w_exist_collab
p2_start_incapable_consent_w_exist_collab = trial_firm_detail_3 %>% left_join(eu_incapable_consent, by = "eudract_id") %>% 
  filter(subject_incapable_consent == 1,
         phase_2 == 1,
         collab_existing == 1) %>% 
  select(sponsor_id, start_year, subject_incapable_consent) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_incapable_consent_w_exist_collab = sum(subject_incapable_consent))
# p2_start_incapable_consent_w_estab_collab
p2_start_incapable_consent_w_estab_collab= trial_firm_detail_3 %>% left_join(eu_incapable_consent, by = "eudract_id") %>% 
  filter(subject_incapable_consent == 1,
         phase_2 == 1,
         collab_established == 1) %>% 
  select(sponsor_id, start_year, subject_incapable_consent) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_incapable_consent_w_estab_collab = sum(subject_incapable_consent))



firm_year_dataset_16 = firm_year_dataset_15 %>% 
  left_join(p2_start_incapable_consent, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_incapable_consent_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_incapable_consent_w_exist_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_incapable_consent_w_estab_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))
```
  


##### Add elderly patient

  We're interested in both the number of elderly patient and the number of trials with elderly eligible
  
  p2_start_elderly_patient_num, p2_start_elderly_eligible

```{r}
# Create p2_start_elderly_patient_num, p2_start_elderly_eligible
# Note we created eu_elderly, us_elderly in previous sections
p2_start_elderly = trial_firm_detail_3 %>% filter(phase_2 == 1) %>% 
  left_join(eu_elderly, by = "eudract_id") %>% 
  left_join(us_elderly, by = "nct_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0)),
         num_elderly_patient = num_elderly_patient.x + num_elderly_patient.y,
         elderly_eligible = elderly_eligible.x + elderly_eligible.y) %>% 
  select(sponsor_id, start_year, num_elderly_patient, elderly_eligible) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_elderly_patient_num = sum(num_elderly_patient),
            p2_start_elderly_eligible = sum(elderly_eligible))

# Do the same for collab/exist_collab/estab_collab
# p2_start_elderly_w_collab
p2_start_elderly_w_collab = trial_firm_detail_3 %>% filter(phase_2 == 1, collab == 1) %>% 
  left_join(eu_elderly, by = "eudract_id") %>% 
  left_join(us_elderly, by = "nct_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0)),
         num_elderly_patient = num_elderly_patient.x + num_elderly_patient.y,
         elderly_eligible = elderly_eligible.x + elderly_eligible.y) %>% 
  select(sponsor_id, start_year, num_elderly_patient, elderly_eligible) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_elderly_patient_num_w_collab = sum(num_elderly_patient),
            p2_start_elderly_eligible_w_collab = sum(elderly_eligible))
# p2_start_elderly_w_exist_collab
p2_start_elderly_w_exist_collab = trial_firm_detail_3 %>% filter(phase_2 == 1, collab_existing == 1) %>% 
  left_join(eu_elderly, by = "eudract_id") %>% 
  left_join(us_elderly, by = "nct_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0)),
         num_elderly_patient = num_elderly_patient.x + num_elderly_patient.y,
         elderly_eligible = elderly_eligible.x + elderly_eligible.y) %>% 
  select(sponsor_id, start_year, num_elderly_patient, elderly_eligible) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_elderly_patient_num_w_exist_collab = sum(num_elderly_patient),
            p2_start_elderly_eligible_w_exist_collab = sum(elderly_eligible))
# p2_start_elderly_w_estab_collab
p2_start_elderly_w_estab_collab = trial_firm_detail_3 %>% filter(phase_2 == 1, collab_established == 1) %>% 
  left_join(eu_elderly, by = "eudract_id") %>% 
  left_join(us_elderly, by = "nct_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0)),
         num_elderly_patient = num_elderly_patient.x + num_elderly_patient.y,
         elderly_eligible = elderly_eligible.x + elderly_eligible.y) %>% 
  select(sponsor_id, start_year, num_elderly_patient, elderly_eligible) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_elderly_patient_num_w_estab_collab = sum(num_elderly_patient),
            p2_start_elderly_eligible_w_estab_collab = sum(elderly_eligible))



firm_year_dataset_17 = firm_year_dataset_16 %>% 
  left_join(p2_start_elderly, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_elderly_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_elderly_w_exist_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_elderly_w_estab_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))
```


##### Add accept healthy volunteers

  We want to look at if a trial accepts healthy volunteers
  
  p2_start_healthy_volunteers_yes, p2_start_healthy_volunteers_no
  
```{r}
# Create p2_start_healthy_volunteers
p2_start_healthy_volunteer = trial_firm_detail_3 %>% filter(phase_2 == 1) %>% 
  left_join(eu_healthy_volunteers, by = "eudract_id") %>% 
  left_join(us_healthy_volunteers, by = "nct_id") %>% 
  mutate(healthy_volunteers_yes = ifelse(healthy_volunteers.x == 1 | healthy_volunteers.y == 1, 1, 0),
         healthy_volunteers_no = ifelse(healthy_volunteers.x == 0 | healthy_volunteers.y == 0, 1, 0),
         across(everything(), ~ replace_na(., 0))) %>% 
  select(sponsor_id, start_year, healthy_volunteers_yes, healthy_volunteers_no) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_healthy_volunteers_yes = sum(healthy_volunteers_yes),
            p2_start_healthy_volunteers_no = sum(healthy_volunteers_no))
  
firm_year_dataset_18 = firm_year_dataset_17 %>% 
  left_join(p2_start_healthy_volunteer, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

```





##### Add plan to share ipd

  We want to look at if a trial plans to share Individual Participant Data (IPD)
  Note that this variable is only available for US trials

  p2_start_plan_to_share_ipd_yes, p2_start_plan_to_share_ipd_no
  
  
```{r}
# Create p2_start_plan_to_share_ipd_yes, p2_start_plan_to_share_ipd_no
p2_start_plan_to_share_ipd = trial_firm_detail_3 %>% filter(phase_2 == 1) %>% 
  left_join(us_plan_to_share_ipd, by = "nct_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  select(sponsor_id, start_year, plan_to_share_ipd_yes, plan_to_share_ipd_no) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_plan_to_share_ipd_yes = sum(plan_to_share_ipd_yes),
            p2_start_plan_to_share_ipd_no = sum(plan_to_share_ipd_no))

# Do the same for collab/exist_collab/estab_collab
# p2_start_plan_to_share_ipd_w_collab
p2_start_plan_to_share_ipd_w_collab = trial_firm_detail_3 %>% filter(phase_2 == 1, collab == 1) %>% 
  left_join(us_plan_to_share_ipd, by = "nct_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  select(sponsor_id, start_year, plan_to_share_ipd_yes) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_plan_to_share_ipd_yes_w_collab = sum(plan_to_share_ipd_yes))
# p2_start_plan_to_share_ipd_w_exist_collab
p2_start_plan_to_share_ipd_w_exist_collab = trial_firm_detail_3 %>% filter(phase_2 == 1, collab_existing == 1) %>% 
  left_join(us_plan_to_share_ipd, by = "nct_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  select(sponsor_id, start_year, plan_to_share_ipd_yes) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_plan_to_share_ipd_yes_w_exist_collab = sum(plan_to_share_ipd_yes))
# p2_start_plan_to_share_ipd_w_estab_collab
p2_start_plan_to_share_ipd_w_estab_collab = trial_firm_detail_3 %>% filter(phase_2 == 1, collab_established == 1) %>% 
  left_join(us_plan_to_share_ipd, by = "nct_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  select(sponsor_id, start_year, plan_to_share_ipd_yes) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_plan_to_share_ipd_yes_w_estab_collab = sum(plan_to_share_ipd_yes))



firm_year_dataset_19 = firm_year_dataset_18 %>% 
  left_join(p2_start_plan_to_share_ipd, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_plan_to_share_ipd_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_plan_to_share_ipd_w_exist_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_plan_to_share_ipd_w_estab_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

```
  



##### Add stop reason

  In the exploratory dataset section, we created the us_trial_stop_reason. 
  
  we now want to create columns p2_start_withdraw_recruitment, p2_start_withdraw_sponsor,  p2_start_withdraw_other_reasons
  p2_start_withdraw_recruitment_pre_gdpr, p2_start_withdraw_sponsor_pre_gdpr,  p2_start_withdraw_other_reasons_pre_gdpr
  p2_start_withdraw_recruitment_post_gdpr, p2_start_withdraw_sponsor_post_gdpr,  p2_start_withdraw_other_reasons_post_gdpr
  
  
```{r}
# Create columns p2_start_withdraw_recruitment, p2_start_withdraw_sponsor,  p2_start_withdraw_other_reasons
#  p2_start_withdraw_recruitment_pre_gdpr, p2_start_withdraw_sponsor_pre_gdpr,  p2_start_withdraw_other_reasons_pre_gdpr
#  p2_start_withdraw_recruitment_post_gdpr, p2_start_withdraw_sponsor_post_gdpr,  p2_start_withdraw_other_reasons_post_gdpr

p2_us_trial_stop_reason = us_trial_stop_reason %>% 
  left_join(trial_firm_detail_3 %>% select(nct_id, phase_2)) %>% 
  filter(phase_2 == 1)

p2_trial_stop_reason = p2_us_trial_stop_reason %>% 
  mutate(wd_recruitment = recruitment_issue,
         wd_sponsor = sponsor_issue,
         wd_other_reasons = other_reasons) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_wd_recruitment = sum(wd_recruitment),
            p2_start_wd_sponsor = sum(wd_sponsor),
            p2_start_wd_other_reasons = sum(wd_other_reasons))

# Do the same for collab/exist_collab/estab_collab
# p2_us_trial_stop_reason_w_collab
p2_us_trial_stop_reason_w_collab = us_trial_stop_reason %>% 
  left_join(trial_firm_detail_3 %>% select(nct_id, phase_2, collab)) %>% 
  filter(phase_2 == 1,
         collab == 1)

p2_trial_stop_reason_w_collab = p2_us_trial_stop_reason_w_collab %>% 
  mutate(wd_recruitment = recruitment_issue,
         wd_sponsor = sponsor_issue,
         wd_other_reasons = other_reasons) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_wd_recruitment_w_collab = sum(wd_recruitment),
            p2_start_wd_sponsor_w_collab = sum(wd_sponsor),
            p2_start_wd_other_reasons_w_collab = sum(wd_other_reasons))


# p2_us_trial_stop_reason_w_exist_collab
p2_us_trial_stop_reason_w_exist_collab = us_trial_stop_reason %>% 
  left_join(trial_firm_detail_3 %>% select(nct_id, phase_2, collab_existing)) %>% 
  filter(phase_2 == 1,
         collab_existing == 1)

p2_trial_stop_reason_w_exist_collab = p2_us_trial_stop_reason_w_exist_collab %>% 
  mutate(wd_recruitment = recruitment_issue,
         wd_sponsor = sponsor_issue,
         wd_other_reasons = other_reasons) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_wd_recruitment_w_exist_collab = sum(wd_recruitment),
            p2_start_wd_sponsor_w_exist_collab = sum(wd_sponsor),
            p2_start_wd_other_reasons_w_exist_collab = sum(wd_other_reasons))

# p2_us_trial_stop_reason_w_estab_collab
p2_us_trial_stop_reason_w_estab_collab = us_trial_stop_reason %>% 
  left_join(trial_firm_detail_3 %>% select(nct_id, phase_2, collab_established)) %>% 
  filter(phase_2 == 1,
         collab_established == 1)

p2_trial_stop_reason_w_estab_collab = p2_us_trial_stop_reason_w_estab_collab %>% 
  mutate(wd_recruitment = recruitment_issue,
         wd_sponsor = sponsor_issue,
         wd_other_reasons = other_reasons) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_wd_recruitment_w_estab_collab = sum(wd_recruitment),
            p2_start_wd_sponsor_w_estab_collab = sum(wd_sponsor),
            p2_start_wd_other_reasons_w_estab_collab = sum(wd_other_reasons))


firm_year_dataset_20 = firm_year_dataset_19 %>% 
  left_join(p2_trial_stop_reason, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_trial_stop_reason_w_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_trial_stop_reason_w_exist_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_trial_stop_reason_w_estab_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

```
  

##### Add China, Japan, Australia, Canada, Korea, India

  We also want to add number of phase 2 trials in China, Japan, Australia, Canada, Korea, India
  
  phase_2_start_china
  
```{r}
# phase_2_start_china
phase_2_start_china = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(country == "China") %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(phase_2_start_china = n())
phase_2_start_japan = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(country == "Japan") %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(phase_2_start_japan = n())
phase_2_start_australia = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(country == "Australia") %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(phase_2_start_australia = n())
phase_2_start_canada = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(country == "Canada") %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(phase_2_start_canada = n())
phase_2_start_korea = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(country == "South Korea") %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(phase_2_start_korea = n())
phase_2_start_india = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(country == "India") %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(phase_2_start_india = n())

firm_year_dataset_21 = firm_year_dataset_20 %>% 
  left_join(phase_2_start_china, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_japan, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_australia, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_canada, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_korea, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(phase_2_start_india, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

```


##### Add cancer special variables

  We want to add these variables for cancer trials:
    p2_start_cancer
    cancer_p2_startdate_comp
    cancer_p2_startdate_term
    cancer_patient_avg_start_allregion_p2
    cancer_p2_unique_active_site
    cancer_p2_mean_length
    cancer_p2_total_active_collab
    cancer_p2_total_new_collab
    cancer_p2_total_old_collab
    cancer_p2_total_old_industry_collab
    cancer_p2_total_new_non_industry_collab
    no_cancer_pre_2018_p2
    no_cancer_pre_2018_all

    
```{r}
# p2_start_cancer
p2_start_cancer = trial_firm_detail_3 %>% 
  filter(phase_2 == 1,
         disease_id == "4") %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_start_cancer = n(), .groups = 'drop')

# cancer_p2_startdate_comp
cancer_p2_startdate_comp = trial_firm_detail_3 %>% 
  filter(disease_id == 4) %>% 
  filter(status == "completed") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(cancer_p2_startdate_comp = n(), .groups = 'drop') 

# cancer_p2_startdate_term
cancer_p2_startdate_term = trial_firm_detail_3 %>% 
  filter(disease_id == 4) %>% 
  filter(status == "terminated") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(cancer_phase_2_startdate_term = n(), .groups = 'drop') 

# cancer_patient_avg_start_allregion_p2
cancer_patient_avg_start_allregion_p2 = trial_firm_detail_valid_patient %>% 
  filter(disease_id == 4) %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(cancer_patient_avg_start_allregion_p2 = mean(patient_num))

# p2_unique_active_site
cancer_p2_unique_site_start = trial_firm_detail_3 %>% 
  filter(disease_id == 4) %>% 
  filter(phase_2 == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_unique_site_start = str_c(country, collapse = ", "))
cancer_p2_unique_site_end = trial_firm_detail_3 %>% 
  filter(disease_id == 4) %>% 
  filter(phase_2 == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_unique_site_end = str_c(country, collapse = ", "))
cancer_p2_unique_active_site = firm_year_dataset_13 %>% 
  left_join(cancer_p2_unique_site_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(cancer_p2_unique_site_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_unique_site_start, p2_unique_site_end) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_unique_site_start = ifelse(is.na(p2_unique_site_start), "", p2_unique_site_start)) %>%
  mutate(p2_unique_site_end = ifelse(is.na(p2_unique_site_end), "", p2_unique_site_end)) %>%
  mutate(
    cum_p2_unique_site_start = accumulate(
      p2_unique_site_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_unique_site_end = lag(accumulate(
      p2_unique_site_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")
  ) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_active_site_name = preserve_setdiff(str_split(cum_p2_unique_site_start, ", ")[[1]], 
                                                    str_split(cum_p2_unique_site_end, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    cancer_p2_unique_active_site = p2_unique_active_site_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    cancer_p2_unique_active_site = ifelse(p2_unique_active_site_name == "", 0, cancer_p2_unique_active_site)
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, cancer_p2_unique_active_site)

# cancer_p2_mean_length
cancer_p2_trial_length = trial_firm_detail_3 %>% 
  filter(disease_id == 4) %>% 
  filter(phase_2 == 1) %>%
  mutate(start_year = as.numeric(start_year),
         end_year = as.numeric(end_year),
         trial_length = end_year - start_year) %>% 
  select(trial_id, sponsor_id, start_year, end_year, trial_length) %>% 
  mutate(end_year = ifelse(is.na(end_year), 2024, end_year)) 
cancer_p2_trial_length_start = cancer_p2_trial_length %>% 
  mutate(start_year = as.character(start_year)) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_trial_length_start = str_c(trial_length, collapse = ", "))
cancer_p2_trial_length_end = cancer_p2_trial_length %>% 
  mutate(end_year = as.character(end_year)) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(p2_trial_length_end = str_c(trial_length, collapse = ", "))
cancer_p2_average_median_max_min_length = firm_year_dataset_11 %>% 
  left_join(cancer_p2_trial_length_start, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(cancer_p2_trial_length_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_trial_length_start, p2_trial_length_end) %>% 
  mutate(across(everything(), ~ replace_na(., ""))) %>% 
  group_by(sponsor_id) %>% 
  mutate(cum_p2_trial_length_start = accumulate(
      p2_trial_length_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
         cum_p2_trial_length_end = lag(accumulate(
      p2_trial_length_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_trial_length_active = ifelse(length(preserve_setdiff(str_split(cum_p2_trial_length_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_end, ", ")[[1]])) == 0, NA,
                                    preserve_setdiff(str_split(cum_p2_trial_length_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_end, ", ")[[1]]) %>% paste(collapse = ", ")),
    p2_mean_length = mean(as.numeric(str_split(p2_trial_length_active, ", ")[[1]])),
    p2_median_length = median(as.numeric(str_split(p2_trial_length_active, ", ")[[1]])),
    p2_max_length = max(as.numeric(str_split(p2_trial_length_active, ", ")[[1]])),
    p2_min_length = min(as.numeric(str_split(p2_trial_length_active, ", ")[[1]])),
  ) %>% 
  select(sponsor_id, year, p2_mean_length, p2_median_length, p2_max_length, p2_min_length)
cancer_p2_average_median_max_min_length = cancer_p2_average_median_max_min_length %>% 
  mutate(cancer_p2_mean_length = ifelse(is.na(p2_mean_length), "", as.character(p2_mean_length)),
         cancer_p2_median_length = ifelse(is.na(p2_median_length), "", as.character(p2_median_length)),
         cancer_p2_max_length = ifelse(is.na(p2_max_length), "", as.character(p2_max_length)),
         cancer_p2_min_length = ifelse(is.na(p2_min_length), "", as.character(p2_min_length))
         ) %>% 
  select(sponsor_id, year, cancer_p2_mean_length)

# cancer_p2_total_active_collab, cancer_p2_total_new_collab, cancer_p2_total_old_collab
cancer_p2_total_start_collab = trial_firm_detail_3 %>% 
  filter(disease_id == 4) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, start_year, collab_num, collaborator) %>% 
  filter(collab_num > 0) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_total_new_collab = sum(collab_num), p2_total_new_collab_name = str_c(collaborator, collapse = ", "))
cancer_p2_total_end_collab = trial_firm_detail_3 %>% 
  filter(disease_id == 4) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, end_year, collab_num, collaborator) %>% 
  filter(collab_num > 0) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_total_end_collab = sum(collab_num), p2_total_end_collab_name = str_c(collaborator, collapse = ", "))
cancer_p2_collab = firm_year_dataset_9 %>% 
  left_join(cancer_p2_total_start_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(cancer_p2_total_end_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_total_new_collab, p2_total_new_collab_name, p2_total_end_collab, p2_total_end_collab_name) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_total_new_collab = ifelse(is.na(p2_total_new_collab), 0, p2_total_new_collab)) %>% 
  mutate(p2_total_end_collab = ifelse(is.na(p2_total_end_collab), 0, p2_total_end_collab)) %>% 
  mutate(p2_total_new_collab_name = ifelse(is.na(p2_total_new_collab_name), "", p2_total_new_collab_name)) %>%
  mutate(p2_total_end_collab_name = ifelse(is.na(p2_total_end_collab_name), "", p2_total_end_collab_name)) %>%
  mutate(
    cum_p2_total_new_collab = cumsum(p2_total_new_collab),
    cum_p2_total_new_collab_name = accumulate(
      p2_total_new_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_total_end_collab = lag(cumsum(p2_total_end_collab), default = 0),
    cum_p2_total_end_collab_name = lag(accumulate(
      p2_total_end_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_total_active_collab = cum_p2_total_new_collab - cum_p2_total_end_collab,
    p2_unique_active_collab_name = preserve_setdiff(str_split(cum_p2_total_new_collab_name, ", ")[[1]], 
                                                    str_split(cum_p2_total_end_collab_name, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_collab = p2_unique_active_collab_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_collab = ifelse(p2_unique_active_collab_name == "", 0, p2_unique_active_collab)
    ) %>% 
  ungroup() %>% 
  mutate(
    # Convert active and new collaborators into lists (ignoring empty strings)
    active_unique_collab_list = str_split(p2_unique_active_collab_name, ",\\s*"),
    new_unique_collab_list = str_split(p2_total_new_collab_name, ",\\s*"),
    # Compare current new collaborators with previous year's active collaborators
    p2_unique_new_collab = map2_dbl(
      new_unique_collab_list, 
      lag(active_unique_collab_list, default = list(character(0))), 
      ~ length(setdiff(.x[.x != ""], .y[.y != ""])) # Remove empty strings and calculate unique collaborators
    ),
    p2_total_old_collab = p2_total_active_collab - p2_total_new_collab,
    p2_unique_old_collab = p2_unique_active_collab - p2_unique_new_collab,
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, 
         cancer_p2_total_active_collab = p2_total_active_collab, 
         cancer_p2_total_new_collab = p2_total_new_collab, 
         cancer_p2_total_old_collab = p2_total_old_collab)

# cancer_p2_total_old_industry_collab
cancer_p2_total_start_industry_collab = trial_firm_detail_3 %>% 
  filter(disease_id == 4) %>% 
  filter(phase_2 == 1) %>% 
  filter(industry_collab != "") %>% 
  select(sponsor_id, start_year, industry_collab) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_total_new_industry_collab_name = str_c(industry_collab, collapse = ", "))
cancer_p2_total_end_industry_collab = trial_firm_detail_3 %>% 
  filter(disease_id == 4) %>% 
  filter(phase_2 == 1) %>% 
  filter(industry_collab != "") %>% 
  select(sponsor_id, end_year, industry_collab) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_total_end_industry_collab_name = str_c(industry_collab, collapse = ", "))
cancer_p2_industry_collab = firm_year_dataset_9 %>% 
  left_join(cancer_p2_total_start_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(cancer_p2_total_end_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_total_new_industry_collab_name, p2_total_end_industry_collab_name) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_total_new_industry_collab_name = ifelse(is.na(p2_total_new_industry_collab_name), "", p2_total_new_industry_collab_name)) %>%
  mutate(p2_total_end_industry_collab_name = ifelse(is.na(p2_total_end_industry_collab_name), "", p2_total_end_industry_collab_name)) %>%
  mutate(p2_total_new_industry_collab = p2_total_new_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
         p2_total_new_industry_collab = ifelse(p2_total_new_industry_collab_name == "", 0, p2_total_new_industry_collab)) %>% 
  mutate(
    cum_p2_total_new_industry_collab_name = accumulate(
      p2_total_new_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_total_end_industry_collab_name = lag(accumulate(
      p2_total_end_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_active_industry_collab_name = preserve_setdiff(str_split(cum_p2_total_new_industry_collab_name, ", ")[[1]], 
                                                    str_split(cum_p2_total_end_industry_collab_name, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_active_industry_collab = p2_active_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
    p2_active_industry_collab = ifelse(p2_active_industry_collab_name == "", 0, p2_active_industry_collab),
    p2_unique_active_industry_collab = p2_active_industry_collab_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_industry_collab = ifelse(p2_active_industry_collab_name == "", 0, p2_unique_active_industry_collab)
    ) %>% 
  ungroup() %>% 
  mutate(
    # Convert active and new collaborators into lists (ignoring empty strings)
    active_industry_collab_list = str_split(p2_active_industry_collab_name, ",\\s*"),
    new_unique_industry_collab_list = str_split(p2_total_new_industry_collab_name, ",\\s*"),
    # Compare current new collaborators with previous year's active collaborators
    p2_unique_new_industry_collab = map2_dbl(
      new_unique_industry_collab_list, 
      lag(active_industry_collab_list, default = list(character(0))), 
      ~ length(unique(setdiff(.x[.x != ""], .y[.y != ""]))) # Remove empty strings and calculate unique collaborators
    ),
    p2_total_old_industry_collab = p2_active_industry_collab - p2_total_new_industry_collab,
    p2_unique_old_industry_collab = p2_unique_active_industry_collab - p2_unique_new_industry_collab,
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, cancer_p2_total_old_industry_collab = p2_total_old_industry_collab)


# cancer_p2_total_new_non_industry_collab
cancer_p2_total_start_non_industry_collab = trial_firm_detail_3 %>% 
  filter(disease_id == 4) %>% 
  filter(phase_2 == 1) %>% 
  filter(non_industry_collab != "") %>% 
  select(sponsor_id, start_year, non_industry_collab) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_total_new_non_industry_collab_name = str_c(non_industry_collab, collapse = ", "))
cancer_p2_total_end_non_industry_collab = trial_firm_detail_3 %>% 
  filter(disease_id == 4) %>% 
  filter(phase_2 == 1) %>% 
  filter(non_industry_collab != "") %>% 
  select(sponsor_id, end_year, non_industry_collab) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_total_end_non_industry_collab_name = str_c(non_industry_collab, collapse = ", "))
cancer_p2_non_industry_collab = firm_year_dataset_9 %>% 
  left_join(cancer_p2_total_start_non_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(cancer_p2_total_end_non_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, p2_total_new_non_industry_collab_name, p2_total_end_non_industry_collab_name) %>% 
  group_by(sponsor_id) %>% 
  mutate(p2_total_new_non_industry_collab_name = ifelse(is.na(p2_total_new_non_industry_collab_name), "", p2_total_new_non_industry_collab_name)) %>%
  mutate(p2_total_end_non_industry_collab_name = ifelse(is.na(p2_total_end_non_industry_collab_name), "", p2_total_end_non_industry_collab_name)) %>%
  mutate(p2_total_new_non_industry_collab = p2_total_new_non_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
         p2_total_new_non_industry_collab = ifelse(p2_total_new_non_industry_collab_name == "", 0, p2_total_new_non_industry_collab)) %>% 
  mutate(
    cum_p2_total_new_non_industry_collab_name = accumulate(
      p2_total_new_non_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_total_end_non_industry_collab_name = lag(accumulate(
      p2_total_end_non_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_active_non_industry_collab_name = preserve_setdiff(str_split(cum_p2_total_new_non_industry_collab_name, ", ")[[1]], 
                                                    str_split(cum_p2_total_end_non_industry_collab_name, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_active_non_industry_collab = p2_active_non_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
    p2_active_non_industry_collab = ifelse(p2_active_non_industry_collab_name == "", 0, p2_active_non_industry_collab),
    p2_unique_active_non_industry_collab = p2_active_non_industry_collab_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_non_industry_collab = ifelse(p2_active_non_industry_collab_name == "", 0, p2_unique_active_non_industry_collab)
    ) %>% 
  ungroup() %>% 
  mutate(
    # Convert active and new collaborators into lists (ignoring empty strings)
    active_non_industry_collab_list = str_split(p2_active_non_industry_collab_name, ",\\s*"),
    new_unique_non_industry_collab_list = str_split(p2_total_new_non_industry_collab_name, ",\\s*"),
    # Compare current new collaborators with previous year's active collaborators
    p2_unique_new_non_industry_collab = map2_dbl(
      new_unique_non_industry_collab_list, 
      lag(active_non_industry_collab_list, default = list(character(0))), 
      ~ length(setdiff(.x[.x != ""], .y[.y != ""])) # Remove empty strings and calculate unique collaborators
    ),
    p2_total_old_non_industry_collab = p2_active_non_industry_collab - p2_total_new_non_industry_collab,
    p2_unique_old_non_industry_collab = p2_unique_active_non_industry_collab - p2_unique_new_non_industry_collab,
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, cancer_p2_total_new_non_industry_collab = p2_total_new_non_industry_collab)


# no_cancer_pre_2018_p2
no_cancer_pre_2018_p2 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  filter(disease_id == 4) %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(start_year <= 2018) %>% 
  distinct(sponsor_id) %>% 
  mutate(no_cancer_pre_2018_p2 = 0)


# no_cancer_pre_2018_all
no_cancer_pre_2018_all = trial_firm_detail_3 %>% 
  filter(disease_id == 4) %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(start_year <= 2018) %>% 
  distinct(sponsor_id) %>% 
  mutate(no_cancer_pre_2018_all = 0)



# merge these 10 variables to the firm-year panel
firm_year_dataset_22 = firm_year_dataset_21 %>% 
  left_join(p2_start_cancer, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(cancer_p2_startdate_comp, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(cancer_p2_startdate_term, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(cancer_patient_avg_start_allregion_p2, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(cancer_p2_unique_active_site, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(cancer_p2_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(cancer_p2_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  left_join(cancer_p2_non_industry_collab, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  left_join(cancer_p2_average_median_max_min_length, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  mutate(across(everything(), ~ replace_na(., ""))) %>% 
  left_join(no_cancer_pre_2018_p2, by = c("sponsor_id" = "sponsor_id")) %>% 
  left_join(no_cancer_pre_2018_all, by = c("sponsor_id" = "sponsor_id")) %>% 
  mutate(across(everything(), ~ replace_na(., 1)))

```


##### Add ongoing for p1, p2, p3

```{r}
# p1/p2/p3_ongoing
phase_1_end = trial_firm_detail_3 %>% 
  filter(phase_1 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_1_end = n(), .groups = 'drop') 
phase_2_end = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_2_end = n(), .groups = 'drop')
phase_3_end = trial_firm_detail_3 %>% 
  filter(phase_3 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarise(phase_3_end = n(), .groups = 'drop')

p1_p2_p3_ongoing = firm_year_dataset_22 %>% 
  left_join(phase_1_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_2_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  left_join(phase_3_end, by = c("sponsor_id" = "sponsor_id", "year" = "end_year")) %>% 
  select(sponsor_id, year, phase_1_start, phase_1_end, phase_2_start, phase_2_end, phase_3_start, phase_3_end) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  group_by(sponsor_id) %>% 
  mutate(
    cum_phase_1_start = cumsum(phase_1_start),
    cum_phase_1_end = lag(cumsum(phase_1_end), default = 0),
    cum_phase_2_start = cumsum(phase_2_start),
    cum_phase_2_end = lag(cumsum(phase_2_end), default = 0),
    cum_phase_3_start = cumsum(phase_3_start),
    cum_phase_3_end = lag(cumsum(phase_3_end), default = 0),
    p1_ongoing = cum_phase_1_start - cum_phase_1_end,
    p2_ongoing = cum_phase_2_start - cum_phase_2_end,
    p3_ongoing = cum_phase_3_start - cum_phase_3_end
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, year, p1_ongoing, p2_ongoing, p3_ongoing)


# Add these 3 variables to the firm-year panel
firm_year_dataset_23 = firm_year_dataset_22 %>% 
  left_join(p1_p2_p3_ongoing, by = c("sponsor_id" = "sponsor_id", "year" = "year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))


```

##### Add more collab information

Create p2_start_w_large_collab, p2_start_w_small_collab


We want to label the collaborators with size based on their num of p2 trials before 2018.

Note that most collaborators in our list does not have any p2 trials pre 2018, so the median cutoff we determined is based on the collaborators with valid number of p2 trials pre 2018.

And then we want to create collab_large and collab_small in the trial_firm_detail, called trial_firm_detail_w_collab_size


```{r}
# Use the previously created p2_count_pre_2018 to get the number of p2 trials by 2018 of all the collaborators
# and then calculate the median
median_p2_count_pre_2018 = matched_collaborators %>% 
  distinct(sponsor_id) %>% 
  left_join(p2_count_pre_2018, by = "sponsor_id") %>% # Notice there is a good chunk with NA values
  filter(!is.na(p2_count_pre_2018)) %>% # Only consider those with a valid count
  summarize(median_p2_count_pre_2018 = median(p2_count_pre_2018)) %>% 
  pull(median_p2_count_pre_2018)

# label the collaborators with "large" and "small" based on their p2_count_pre_2018
matched_collaborators_with_size = matched_collaborators %>% 
  left_join(p2_count_pre_2018, by = "sponsor_id") %>% 
  mutate(p2_count_pre_2018 = ifelse(is.na(p2_count_pre_2018), 0, p2_count_pre_2018),
         collab_size = ifelse(p2_count_pre_2018 > median_p2_count_pre_2018, "large", "small"))

# Create an alternative label with 0 as the cutoff instead of median (4)
matched_collaborators_with_size_2 = matched_collaborators %>% 
  left_join(p2_count_pre_2018, by = "sponsor_id") %>% 
  mutate(p2_count_pre_2018 = ifelse(is.na(p2_count_pre_2018), 0, p2_count_pre_2018),
         collab_size = ifelse(p2_count_pre_2018 > 0, "large", "small"))

```

```{r}
# Now, we want to update the trial_firm_detail_3 with the number of large/small trials based on the collab names recorded

# The following code generated by Claude
# Function to process collaborators and create the new columns
add_collab_count_by_size <- function(trial_df, collaborator_size_df) {
  
  # First, ensure the size column in matched_collaborators_with_size is clean
  collaborator_size_df <- collaborator_size_df %>%
    mutate(collab_size = tolower(collab_size)) %>%
    filter(collab_size %in% c("large", "small"))
  
  # Split the large/small collaborators
  large_collaborators <- collaborator_size_df %>% 
    filter(collab_size == "large") %>% 
    pull(collab_name)
  
  small_collaborators <- collaborator_size_df %>% 
    filter(collab_size == "small") %>% 
    pull(collab_name)
  
  # Process each row in the trial dataset
  result <- trial_df %>%
    rowwise() %>%
    mutate(
      # Handle empty collaborator field
      collaborator_list = if(is.na(collaborator) || collaborator == "") 
                           list(character(0)) 
                         else 
                           list(str_split(collaborator, ",\\s*")[[1]]),
      
      # Find large collaborators
      large_collab_list = list(intersect(collaborator_list, large_collaborators)),
      large_collab = if(length(large_collab_list) > 0) 
                     paste(large_collab_list, collapse = ", ")
                   else 
                     NA_character_,
      large_collab_count = length(large_collab_list),
      
      # Find small collaborators
      small_collab_list = list(intersect(collaborator_list, small_collaborators)),
      small_collab = if(length(small_collab_list) > 0) 
                     paste(small_collab_list, collapse = ", ")
                   else 
                     NA_character_,
      small_collab_count = length(small_collab_list)
    ) %>%
    # Remove temporary columns
    select(-collaborator_list, -large_collab_list, -small_collab_list)
  
  return(result)
}


trial_firm_detail_w_collab_size = add_collab_count_by_size(
   trial_df = trial_firm_detail_3,
   collaborator_size_df = matched_collaborators_with_size
 ) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, sponsor_name, start_year, end_year, large_collab, large_collab_count, small_collab, small_collab_count)

trial_firm_detail_w_collab_size_2 = add_collab_count_by_size(
   trial_df = trial_firm_detail_3,
   collaborator_size_df = matched_collaborators_with_size_2
 ) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, sponsor_name, start_year, end_year, large_collab, large_collab_count, small_collab, small_collab_count)

```

Finally, create all the sized collab variables with trial_firm_detail_w_collab_size

```{r}
# p2_start_w_large_collab, p2_start_w_small_collab
p2_start_w_large_collab = trial_firm_detail_w_collab_size %>% 
  filter(large_collab_count > 0) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_w_large_collab = n())
p2_start_w_small_collab = trial_firm_detail_w_collab_size %>% 
  filter(small_collab_count > 0)%>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_w_small_collab = n())

# p2_start_w_large_collab_2, p2_start_w_small_collab_2 (use cutoff 0 instead of median)
p2_start_w_large_collab_2 = trial_firm_detail_w_collab_size_2 %>% 
  filter(large_collab_count > 0) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_w_large_collab_2 = n())
p2_start_w_small_collab_2 = trial_firm_detail_w_collab_size_2 %>% 
  filter(small_collab_count > 0)%>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_w_small_collab_2 = n())

# Add these variables to the firm-year panel
firm_year_dataset_24 = firm_year_dataset_23 %>% 
  left_join(p2_start_w_large_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_small_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_large_collab_2, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_small_collab_2, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

```



##### Add Upwork data

We used Upwork freelancing to source extra information about our sponsors and collaborators. Including founding year, headquarter locations, and public/private (time of IPO)

We will join these information into out firm dataset and create the following new variables:

 - p2_start_with_young/old_collab
 - p2_start_with_US/EU/Others_collab
 - p2_start_with_public/private_collab_2010
 - p2_start_with_public/private_collab_2017
 
 
```{r}
firm_name_founding_year_id_new
# Load the Upwork data
upwork1 = read_excel("Upwork firm data/sponsor_founding_matching_1112_forupwork-PART1.xlsx")
upwork2 = read_excel("Upwork firm data/sponsor_founding_matching_1112_forupwork-PART2.xlsx")

us_states <- c(
  "Alabama", "AL", "Alaska", "AK", "Arizona", "AZ", "Arkansas", "AR",
  "California", "CA", "Colorado", "CO", "Connecticut", "CT", "Delaware", "DE",
  "Florida", "FL", "Georgia", "GA", "Hawaii", "HI", "Idaho", "ID",
  "Illinois", "IL", "Indiana", "IN", "Iowa", "IA", "Kansas", "KS",
  "Kentucky", "KY", "Louisiana", "LA", "Maine", "ME", "Maryland", "MD",
  "Massachusetts", "MA", "Michigan", "MI", "Minnesota", "MN", "Mississippi", "MS",
  "Missouri", "MO", "Montana", "MT", "Nebraska", "NE", "Nevada", "NV",
  "New Hampshire", "NH", "New Jersey", "NJ", "New Mexico", "NM", "New York", "NY",
  "North Carolina", "NC", "North Dakota", "ND", "Ohio", "OH", "Oklahoma", "OK",
  "Oregon", "OR", "Pennsylvania", "PA", "Rhode Island", "RI", "South Carolina", "SC",
  "South Dakota", "SD", "Tennessee", "TN", "Texas", "TX", "Utah", "UT",
  "Vermont", "VT", "Virginia", "VA", "Washington", "WA", "West Virginia", "WV",
  "Wisconsin", "WI", "Wyoming", "WY", "West Coast", "East Coast"
)
```

The first thing we want to do is to trim the firm-year dataset with the additional founding year information.
We want to make sure that the earliest year of the panel is not earlier than the sponsors' founding year.

```{r}
panel_firm_found_year = firm_year_dataset_24 %>% 
  distinct(sponsor_name) %>% 
  left_join(upwork1 %>% distinct(sponsor_name, .keep_all = TRUE) %>% select(sponsor_name, foundedyear), by = "sponsor_name") %>%
  left_join(upwork2 %>% distinct(sponsor_name, .keep_all = TRUE) %>% select(sponsor_name, foundedyear), by = "sponsor_name") %>% 
  mutate(found_year = coalesce(foundedyear.x, foundedyear.y)) %>% 
  select(sponsor_name, found_year)

firm_year_dataset_25 = firm_year_dataset_24 %>% 
  left_join(panel_firm_found_year, by = "sponsor_name") %>% 
  filter(is.na(found_year)|year >= found_year) %>% 
  select(-found_year)

```

Now let's get to cleaning the upwork data, combining them, and create the new collaborator variables, as well as the sponsonr level variable

```{r}
# our list of companies are partitioned into two parts and collected by two different freelancers
# clean upwork1
upwork1_1 = upwork1 %>% 
  distinct(sponsor_name, .keep_all = TRUE) %>% 
  mutate(hq_country = case_when(
    str_detect(regions, "US|United States") ~ "US",
    !is.na(if_outsideus) ~ if_outsideus,
    str_detect(regions, str_c(us_states, collapse = "|")) ~ "US",
    TRUE ~ word(regions, -1, sep = ",\\s*")
  )) %>% 
  left_join(standardized_country, by = c("hq_country" = "country")) %>% 
  mutate(hq_country = ifelse(!is.na(distinct_name), distinct_name, hq_country)) %>% 
  select(-distinct_name) %>% 
  mutate(hq_region = case_when(
    hq_country == "US" ~ "US",
    str_detect(hq_country, str_c(eu_countries, collapse = "|")) ~ "EU",
    TRUE ~ "Others"
  )) 

upwork1_2 = upwork1_1 %>% 
  mutate(age_2018 = ifelse(foundedyear > 2018, NA, 2018-foundedyear)) 

upwork1_3 = upwork1_2 %>% 
  mutate(IPO_year = as.numeric(word(IPO_date, -1, sep = ",\\s*")),
         public_private_2010 = case_when(
           foundedyear > 2010 ~ NA,
           IPO_year <= 2010 ~ "Public",
           IPO_year > 2010 ~ "Private",
           is.na(IPO_year) ~ "Private"
         ),
         public_private_2017 = case_when(
           foundedyear > 2017 ~ NA,
           IPO_year <= 2017 ~ "Public",
           IPO_year > 2017 ~ "Private",
           is.na(IPO_year) ~ "Private"
         )) %>% 
  mutate(source = "upwork1") %>% 
  select(sponsor_name, foundedyear, age_2018, hq_country, hq_region, IPO_year, public_private_2010, public_private_2017, source) 


# Clean upwork2
upwork2_1 = upwork2 %>% 
  distinct(sponsor_name, .keep_all = TRUE) %>% 
  mutate(hq_country = case_when(
    !is.na(regions) ~ "US",
    !is.na(if_outsideus) ~ word(if_outsideus, -1, sep = ",\\s*")
  )) %>% 
  left_join(standardized_country, by = c("hq_country" = "country")) %>% 
  mutate(hq_country = ifelse(!is.na(distinct_name), distinct_name, hq_country)) %>% 
  select(-distinct_name) %>% 
  mutate(hq_region = case_when(
    hq_country == "US" ~ "US",
    str_detect(hq_country, str_c(eu_countries, collapse = "|")) ~ "EU",
    TRUE ~ "Others"
  )) 

upwork2_2 = upwork2_1 %>% 
  mutate(age_2018 = ifelse(foundedyear > 2018, NA, 2018-foundedyear)) 

upwork2_3 = upwork2_2 %>% 
  mutate(IPO_year = year(as.Date(as.numeric(IPO_date), origin = "1899-12-30")),
         public_private_2010 = case_when(
           foundedyear > 2010 ~ NA,
           IPO_year <= 2010 ~ "Public",
           IPO_year > 2010 ~ "Private",
           is.na(IPO_year) ~ "Private"
         ),
         public_private_2017 = case_when(
           foundedyear > 2017 ~ NA,
           IPO_year <= 2017 ~ "Public",
           IPO_year > 2017 ~ "Private",
           is.na(IPO_year) ~ "Private"
         )) %>% 
  mutate(source = "upwork2") %>% 
  select(sponsor_name, foundedyear, age_2018, hq_country, hq_region, IPO_year, public_private_2010, public_private_2017, source)


# Now, we combine the partitioned upwork datasets
# One thing we noticed is that around 5000 names from both upwork datasets overlaps, and upwork2 has consistant better entry than upwork1 for theese duplicates. Therefore, we will use data from upwork2 do tackle the duplicate issue
upwork_total = bind_rows(upwork2_3, upwork1_3) %>% 
  arrange(sponsor_name, desc(source)) %>% 
  distinct(sponsor_name, .keep_all = TRUE) %>% 
  select(-source) %>% 
  mutate(sponsor_name = str_to_lower(sponsor_name)) %>%  # Convert to lowercase
  mutate(sponsor_name = str_replace_all(sponsor_name, "[^a-z0-9\\s]", "")) %>%  # Remove non-alphanumeric characters
  mutate(sponsor_name = str_remove_all(sponsor_name, paste0("\\b(", paste(suffixes, collapse = "|"), ")\\b"))) %>%
  mutate(sponsor_name = str_trim(sponsor_name))


```
 
```{r}
# First, we want to match these variables on the sponsor level, add to the panel later
matched_sponsor_upwork = firm_name_founding_year_id_new %>% 
  select(sponsor_name, sponsor_id, year_founded) %>% 
  left_join(upwork_total %>% select(sponsor_name, foundedyear, hq_region, public_private_2010, public_private_2017),
            by = "sponsor_name") %>% 
  mutate(year_founded = ifelse(!is.na(foundedyear), foundedyear, year_founded)) %>% 
  select(-foundedyear, -sponsor_name) %>% 
  arrange(sponsor_id, year_founded) %>% 
  distinct(sponsor_id, .keep_all = TRUE)




# We're also  interested in these variable of the collaborators, we will join these variables to our matched collaborator list
matched_collaborators_upwork = matched_collaborators %>% 
  left_join(upwork_total, by = c("best_sponsor_name" = "sponsor_name"))

# label the collaborators with old_young_2018, joining existing US/EU/Others, public_private_2010, and public_private_2017
age_2018_median = matched_collaborators_upwork %>% 
  filter(!is.na(age_2018)) %>% 
  pull(age_2018) %>% 
  median()

matched_collaborators_upwork = matched_collaborators_upwork %>% 
  mutate(old_young_2018 = ifelse(age_2018 > age_2018_median, "old", "young"))




# p2_start_with_young/old_collab
add_collab_count_by_age <- function(trial_df, collaborator_df) {
  
  # First, ensure the size column in matched_collaborators_with_size is clean
  collaborator_df <- collaborator_df %>%
    mutate(old_young_2018 = tolower(old_young_2018)) %>%
    filter(old_young_2018 %in% c("old", "young"))
  
  # Split the large/small collaborators
  old_collaborators <- collaborator_df %>% 
    filter(old_young_2018 == "old") %>% 
    pull(collab_name)
  
  young_collaborators <- collaborator_df %>% 
    filter(old_young_2018 == "young") %>% 
    pull(collab_name)
  
  # Process each row in the trial dataset
  result <- trial_df %>%
    rowwise() %>%
    mutate(
      # Handle empty collaborator field
      collaborator_list = if(is.na(collaborator) || collaborator == "") 
                           list(character(0)) 
                         else 
                           list(str_split(collaborator, ",\\s*")[[1]]),
      
      # Find large collaborators
      old_collab_list = list(intersect(collaborator_list, old_collaborators)),
      old_collab = if(length(old_collab_list) > 0) 
                     paste(old_collab_list, collapse = ", ")
                   else 
                     NA_character_,
      old_collab_count = length(old_collab_list),
      
      # Find small collaborators
      young_collab_list = list(intersect(collaborator_list, young_collaborators)),
      young_collab = if(length(young_collab_list) > 0) 
                     paste(young_collab_list, collapse = ", ")
                   else 
                     NA_character_,
      young_collab_count = length(young_collab_list)
    ) %>%
    # Remove temporary columns
    select(-collaborator_list, -old_collab_list, -young_collab_list)
  
  return(result)
}


trial_firm_detail_w_collab_age = add_collab_count_by_age(
   trial_df = trial_firm_detail_3,
   collaborator_df = matched_collaborators_upwork
 ) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, disease_id, sponsor_name, start_year, end_year, old_collab, old_collab_count, young_collab, young_collab_count)


# p2_start_w_old_collab, p2_start_w_young_collab
p2_start_w_old_collab = trial_firm_detail_w_collab_age %>% 
  filter(old_collab_count > 0) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_w_old_collab = n())
p2_start_w_young_collab = trial_firm_detail_w_collab_age %>% 
  filter(young_collab_count > 0)%>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_w_young_collab = n())





# p2_start_with_US/EU/Others_collab
add_collab_count_by_region <- function(trial_df, collaborator_df) {
  
  # First, ensure the size column in matched_collaborators_with_size is clean
  collaborator_df <- collaborator_df %>%
    filter(hq_region %in% c("US", "EU", "Others"))
  
  # Split the large/small collaborators
  us_collaborators <- collaborator_df %>% 
    filter(hq_region == "US") %>% 
    pull(collab_name)
  
  eu_collaborators <- collaborator_df %>% 
    filter(hq_region == "EU") %>% 
    pull(collab_name)
  
  other_region_collaborators <- collaborator_df %>% 
    filter(hq_region == "Others") %>% 
    pull(collab_name)
  
  # Process each row in the trial dataset
  result <- trial_df %>%
    rowwise() %>%
    mutate(
      # Handle empty collaborator field
      collaborator_list = if(is.na(collaborator) || collaborator == "") 
                           list(character(0)) 
                         else 
                           list(str_split(collaborator, ",\\s*")[[1]]),
      
      # Find US collaborators
      us_collab_list = list(intersect(collaborator_list, us_collaborators)),
      us_collab = if(length(us_collab_list) > 0) 
                     paste(us_collab_list, collapse = ", ")
                   else 
                     NA_character_,
      us_collab_count = length(us_collab_list),
      
      # Find EU collaborators
      eu_collab_list = list(intersect(collaborator_list, eu_collaborators)),
      eu_collab = if(length(eu_collab_list) > 0) 
                     paste(eu_collab_list, collapse = ", ")
                   else 
                     NA_character_,
      eu_collab_count = length(eu_collab_list),
      
      # Find Other collaborators
      other_region_collab_list = list(intersect(collaborator_list, other_region_collaborators)),
      other_region_collab = if(length(other_region_collab_list) > 0) 
                     paste(other_region_collab_list, collapse = ", ")
                   else 
                     NA_character_,
      other_region_collab_count = length(other_region_collab_list),
    ) %>%
    # Remove temporary columns
    select(-collaborator_list, -us_collab_list, -eu_collab_list, -other_region_collab_list)
  
  return(result)
}


trial_firm_detail_w_collab_region = add_collab_count_by_region(
   trial_df = trial_firm_detail_3,
   collaborator_df = matched_collaborators_upwork
 ) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, disease_id, sponsor_name, start_year, end_year, us_collab, us_collab_count, eu_collab, eu_collab_count, other_region_collab, other_region_collab_count)


# p2_start_w_us_collab, p2_start_w_eu_collab, p2_start_w_other_region_collab
p2_start_w_us_collab = trial_firm_detail_w_collab_region %>% 
  filter(us_collab_count > 0) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_w_us_collab = n())
p2_start_w_eu_collab = trial_firm_detail_w_collab_region %>% 
  filter(eu_collab_count > 0)%>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_w_eu_collab = n())
p2_start_w_other_region_collab = trial_firm_detail_w_collab_region %>% 
  filter(other_region_collab_count > 0)%>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_w_other_region_collab = n())





#p2_start_with_public/private_collab_2010
add_collab_count_by_status_2010 <- function(trial_df, collaborator_df) {
  
  # First, ensure the size column in matched_collaborators_with_size is clean
  collaborator_df <- collaborator_df %>%
    filter(public_private_2010 %in% c("Public", "Private"))
  
  # Split the public/private collaborators
  public_collaborators <- collaborator_df %>% 
    filter(public_private_2010 == "Public") %>% 
    pull(collab_name)
  
  private_collaborators <- collaborator_df %>% 
    filter(public_private_2010 == "Private") %>% 
    pull(collab_name)
  
  # Process each row in the trial dataset
  result <- trial_df %>%
    rowwise() %>%
    mutate(
      # Handle empty collaborator field
      collaborator_list = if(is.na(collaborator) || collaborator == "") 
                           list(character(0)) 
                         else 
                           list(str_split(collaborator, ",\\s*")[[1]]),
      
      # Find large collaborators
      public_collab_list_2010 = list(intersect(collaborator_list, public_collaborators)),
      public_collab_2010 = if(length(public_collab_list_2010) > 0) 
                     paste(public_collab_list_2010, collapse = ", ")
                   else 
                     NA_character_,
      public_collab_count_2010 = length(public_collab_list_2010),
      
      # Find small collaborators
      private_collab_list_2010 = list(intersect(collaborator_list, private_collaborators)),
      private_collab_2010 = if(length(private_collab_list_2010) > 0) 
                     paste(private_collab_list_2010, collapse = ", ")
                   else 
                     NA_character_,
      private_collab_count_2010 = length(private_collab_list_2010)
    ) %>%
    # Remove temporary columns
    select(-collaborator_list, -public_collab_list_2010, -private_collab_list_2010)
  
  return(result)
}


trial_firm_detail_w_collab_status_2010 = add_collab_count_by_status_2010(
   trial_df = trial_firm_detail_3,
   collaborator_df = matched_collaborators_upwork
 ) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, sponsor_name, start_year, end_year, public_collab_2010, public_collab_count_2010, private_collab_2010, private_collab_count_2010)


# p2_start_w_public_collab_2010, p2_start_w_private_collab_2010
p2_start_w_public_collab_2010 = trial_firm_detail_w_collab_status_2010 %>% 
  filter(public_collab_count_2010 > 0) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_w_public_collab_2010 = n())
p2_start_w_private_collab_2010 = trial_firm_detail_w_collab_status_2010 %>% 
  filter(private_collab_count_2010 > 0)%>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_w_private_collab_2010 = n())






#p2_start_with_public/private_collab_2017
add_collab_count_by_status_2017 <- function(trial_df, collaborator_df) {
  
  # First, ensure the size column in matched_collaborators_with_size is clean
  collaborator_df <- collaborator_df %>%
    filter(public_private_2017 %in% c("Public", "Private"))
  
  # Split the public/private collaborators
  public_collaborators <- collaborator_df %>% 
    filter(public_private_2017 == "Public") %>% 
    pull(collab_name)
  
  private_collaborators <- collaborator_df %>% 
    filter(public_private_2017 == "Private") %>% 
    pull(collab_name)
  
  # Process each row in the trial dataset
  result <- trial_df %>%
    rowwise() %>%
    mutate(
      # Handle empty collaborator field
      collaborator_list = if(is.na(collaborator) || collaborator == "") 
                           list(character(0)) 
                         else 
                           list(str_split(collaborator, ",\\s*")[[1]]),
      
      # Find large collaborators
      public_collab_list_2017 = list(intersect(collaborator_list, public_collaborators)),
      public_collab_2017 = if(length(public_collab_list_2017) > 0) 
                     paste(public_collab_list_2017, collapse = ", ")
                   else 
                     NA_character_,
      public_collab_count_2017 = length(public_collab_list_2017),
      
      # Find small collaborators
      private_collab_list_2017 = list(intersect(collaborator_list, private_collaborators)),
      private_collab_2017 = if(length(private_collab_list_2017) > 0) 
                     paste(private_collab_list_2017, collapse = ", ")
                   else 
                     NA_character_,
      private_collab_count_2017 = length(private_collab_list_2017)
    ) %>%
    # Remove temporary columns
    select(-collaborator_list, -public_collab_list_2017, -private_collab_list_2017)
  
  return(result)
}


trial_firm_detail_w_collab_status_2017 = add_collab_count_by_status_2017(
   trial_df = trial_firm_detail_3,
   collaborator_df = matched_collaborators_upwork
 ) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, sponsor_name, start_year, end_year, public_collab_2017, public_collab_count_2017, private_collab_2017, private_collab_count_2017)


# p2_start_w_public_collab_2017, p2_start_w_private_collab_2017
p2_start_w_public_collab_2017 = trial_firm_detail_w_collab_status_2017 %>% 
  filter(public_collab_count_2017 > 0) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_w_public_collab_2017 = n())
p2_start_w_private_collab_2017 = trial_firm_detail_w_collab_status_2017 %>% 
  filter(private_collab_count_2017 > 0)%>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_w_private_collab_2017 = n())






# Add these new collab variables to the firm year panel
firm_year_dataset_26 = firm_year_dataset_25 %>% 
  left_join(matched_sponsor_upwork, by = "sponsor_id") %>% 
  mutate(across(everything(), ~ replace_na(., ""))) %>% 
  left_join(p2_start_w_old_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_young_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_us_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_eu_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_other_region_collab, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_public_collab_2010, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_private_collab_2010, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_public_collab_2017, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_private_collab_2017, by = c("sponsor_id" = "sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

```

##### Add non_industry location data

We also want to explore the headquarter location for non-industry sponsors and collaborators, which we will create the following variables:

  Update the hq_region variable based on the database we received.
  
  Create p2_start_w_non_ind_us/eu/others_collab

```{r}
# Update hq_region in firm_year panel
updated_hq_region = read.csv("Sponsors/sponsor2hq_region_broad.csv")
updated_hq_region = updated_hq_region %>% select(sponsor_name, hq_region_broad = hq_region_broad1)

firm_year_dataset_27 = firm_year_dataset_26 %>% 
  left_join(updated_hq_region, by = "sponsor_name") %>% 
  mutate(hq_region = case_when(
    hq_region == "Others" & hq_region_broad != "" ~ hq_region_broad,
    hq_region == "" & hq_region_broad != "" & !is.na(hq_region_broad) ~ hq_region_broad,
    TRUE ~ hq_region
  )) %>% 
  select(-hq_region_broad)

```

```{r}
# p2_start_with_non_ind_US/EU/Others_collab
matched_non_ind_collaborators_region = matched_non_ind_collaborators %>% 
  left_join(updated_hq_region, by = c("best_sponsor_name" = "sponsor_name")) %>% 
  rename(hq_region = hq_region_broad) %>% 
  filter(hq_region %in% c("US", "EU", "Others"))


add_non_ind_collab_count_by_region <- function(trial_df, collaborator_df) {
  
  # First, ensure the size column in matched_collaborators_with_size is clean
  collaborator_df <- collaborator_df %>%
    filter(hq_region %in% c("US", "EU", "Others"))
  
  # Split the us/eu/others collaborators
  us_collaborators <- collaborator_df %>% 
    filter(hq_region == "US") %>% 
    pull(collab_name)
  
  eu_collaborators <- collaborator_df %>% 
    filter(hq_region == "EU") %>% 
    pull(collab_name)
  
  other_region_collaborators <- collaborator_df %>% 
    filter(hq_region == "Others") %>% 
    pull(collab_name)
  
  # Process each row in the trial dataset
  result <- trial_df %>%
    rowwise() %>%
    mutate(
      # Handle empty collaborator field
      collaborator_list = if(is.na(collaborator) || collaborator == "") 
                           list(character(0)) 
                         else 
                           list(str_split(collaborator, ",\\s*")[[1]]),
      
      # Find US collaborators
      us_collab_list = list(intersect(collaborator_list, us_collaborators)),
      us_collab = if(length(us_collab_list) > 0) 
                     paste(us_collab_list, collapse = ", ")
                   else 
                     NA_character_,
      us_collab_count = length(us_collab_list),
      
      # Find EU collaborators
      eu_collab_list = list(intersect(collaborator_list, eu_collaborators)),
      eu_collab = if(length(eu_collab_list) > 0) 
                     paste(eu_collab_list, collapse = ", ")
                   else 
                     NA_character_,
      eu_collab_count = length(eu_collab_list),
      
      # Find Other collaborators
      other_region_collab_list = list(intersect(collaborator_list, other_region_collaborators)),
      other_region_collab = if(length(other_region_collab_list) > 0) 
                     paste(other_region_collab_list, collapse = ", ")
                   else 
                     NA_character_,
      other_region_collab_count = length(other_region_collab_list),
    ) %>%
    # Remove temporary columns
    select(-collaborator_list, -us_collab_list, -eu_collab_list, -other_region_collab_list)
  
  return(result)
}


trial_firm_detail_w_non_ind_collab_region = add_non_ind_collab_count_by_region(
   trial_df = trial_firm_detail_3,
   collaborator_df = matched_non_ind_collaborators_region
 ) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, disease_id, sponsor_name, start_year, end_year, us_collab, us_collab_count, eu_collab, eu_collab_count, other_region_collab, other_region_collab_count)


# p2_start_w_us_collab, p2_start_w_eu_collab, p2_start_w_other_region_collab
p2_start_w_non_ind_us_collab = trial_firm_detail_w_non_ind_collab_region %>% 
  filter(us_collab_count > 0) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_w_non_ind_us_collab = n())
p2_start_w_non_ind_eu_collab = trial_firm_detail_w_non_ind_collab_region %>% 
  filter(eu_collab_count > 0)%>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_w_non_ind_eu_collab = n())
p2_start_w_non_ind_other_region_collab = trial_firm_detail_w_non_ind_collab_region %>% 
  filter(other_region_collab_count > 0)%>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_w_non_ind_other_region_collab = n())



firm_year_dataset_28 = firm_year_dataset_27 %>% 
  left_join(p2_start_w_non_ind_us_collab, by = c("sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_non_ind_eu_collab, by = c("sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_non_ind_other_region_collab, by = c("sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))


```



##### Add result reporting

add whether the trial report their result in 1 year or three years based on data provided by Sean

p2_start/end_result_1y/3y


```{r}
# Add result_1y, result_3y to trial_firm_detail
result_reporting = read_csv("result_reporting_data.csv")

trial_firm_detail_3 = trial_firm_detail_3 %>% 
  left_join(result_reporting %>% select(nct_id, result_1y = result1, result_3y = result3), by = "nct_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

```

```{r}
# Create p2_start/end_result_1y/3y
p2_start_result_1y = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_result_1y = sum(result_1y))

p2_end_result_1y = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_end_result_1y = sum(result_1y))

p2_start_result_3y = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarize(p2_start_result_3y = sum(result_3y))

p2_end_result_3y = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, end_year) %>% 
  summarize(p2_end_result_3y = sum(result_3y))


# Add these 4 variables to the firm year panel
firm_year_dataset_29 = firm_year_dataset_28 %>% 
  left_join(p2_start_result_1y, by = c("sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_end_result_1y, by = c("sponsor_id", "year" = "end_year")) %>% 
  left_join(p2_start_result_3y, by = c("sponsor_id", "year" = "start_year")) %>% 
  left_join(p2_end_result_3y, by = c("sponsor_id", "year" = "end_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))


```



##### Add collab with similar experience

We want to count the number fo p2 trials that has collaborators with similar experience (disease_id) in the field as the trial

Since we only have level 2 mesh code for AACT trials, and seeing the experience of level 1 is not good enough resolution. So we would only be focusing on the act id with level 2 mesh codes here.

 p2_similar_exp_all_phase_collab
 
```{r}
# Add the level 2 mesh code to the trials dataset
trial_firm_detail_tree2 = trial_firm_detail_3 %>% 
  left_join(nct_id_disease_code_tree2, by = "nct_id")

# The following code is from ChatGPT vibe coding
# STEP 1: expand the collaborator list so each collaborator has its own row
trial_long = trial_firm_detail_tree2 %>% 
  filter(!is.na(disease_code_tree2)) %>% 
  mutate(collaborator_list = str_split(collaborator, ",\\s*")) %>%
  unnest(collaborator_list)

# STEP 2: create a role-based mapping of all disease experiences for everyone
# the sponsor and each collaborator are all actors
trial_roles <- trial_long %>%
  select(trial_id, sponsor_id, sponsor_name, collaborator_list, start_year, disease_code_tree2) %>%
  # first get sponsors as actors
  mutate(actor = sponsor_name) %>%
  select(actor, start_year, disease_code_tree2) %>%
  distinct() %>%
  bind_rows(
    trial_long %>%
      filter(collaborator_list != "") %>% 
      mutate(actor = collaborator_list) %>%
      select(actor, start_year, disease_code_tree2) %>%
      distinct()
  ) %>% 
  distinct()

# STEP 3: get for each actor all their disease codes up to each year
actor_exp <- trial_roles %>%
  group_by(actor) %>%
  arrange(start_year) %>%
  summarise(
    disease_history = list(
      tibble(
        year = start_year,
        disease = disease_code_tree2
      )
    ),
    .groups = "drop"
  )

# STEP 4: join back to trial_long to assess whether any collaborator had experience
trial_long_with_exp <- trial_long %>%
  filter(phase_2 == 1) %>%  # only Phase 2 trials
  left_join(actor_exp, by = c("collaborator_list" = "actor")) %>%
  rowwise() %>%
  mutate(
    p2_similar_exp_all_phase_collab = {
      # get the list of disease codes for this collaborator
      hist <- disease_history
      if (is.null(hist) || length(hist) == 0 || is.na(collaborator_list)) {
        0
      } else {
        # filter collaborator history before the trial's year
        relevant <- hist %>% filter(year < start_year)
        # check if any disease matches current
        if (any(relevant$disease == disease_code_tree2)) 1 else 0
      }
    }
  ) %>%
  ungroup()

# STEP 5: aggregate to trial level
# if any collaborator had a match, set to 1, else 0
final_trial_level <- trial_long_with_exp %>%
  group_by(trial_id) %>%
  summarise(
    p2_similar_exp_all_phase_collab = max(p2_similar_exp_all_phase_collab, na.rm = TRUE)
  ) %>%
  ungroup()

# join back to trial_dirm_detail for final result
p2_similar_exp_all_phase_collab = trial_firm_detail_tree2 %>%
  left_join(final_trial_level, by = "trial_id") %>%
  mutate(
    p2_similar_exp_all_phase_collab = ifelse(is.na(p2_similar_exp_all_phase_collab), 0, p2_similar_exp_all_phase_collab)
  ) %>% 
  group_by(sponsor_id, start_year) %>% 
  summarise(p2_similar_exp_all_phase_collab = sum(p2_similar_exp_all_phase_collab))



# Add this variable to the firm year panel
firm_year_dataset_30 = firm_year_dataset_29 %>% 
  left_join(p2_similar_exp_all_phase_collab, by = c("sponsor_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

```

 
 
 
 
 



  
```{r}
# Exploratory code


```


```{r}
# Sanity Check
# Unique sposnor_ids 23557
# N for firm_year 319741


```




### Exploratory datasets

#### sponsor_id_foundedyear_firsttrialyear

```{r}
# Contain information on the sponsor level, use for assess quality of sponsor_id matching
# Only contain sponsors with valid trials, which means trials that are present in trial_firm_detail_3
additional_firm_info = trial_firm_detail_3 %>% 
  group_by(sponsor_id) %>% 
  summarize(first_trial_year = min(start_year), industry_dummy = max(industry_dummy)) %>% 
  mutate(no_trial_before_2010 = ifelse(first_trial_year >= 2010, "1", "0"))

no_p2trial_before_2010 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id) %>% 
  summarize(first_p2trial_year = min(start_year)) %>% 
  mutate(no_p2trial_before_2010 = ifelse(first_p2trial_year >= 2010, "1", "0")) 

sponsor_name_source = main_raw_dataset %>% 
  select(sponsor_name, source) %>% 
  distinct(sponsor_name, .keep_all = TRUE)

sponsor_id_foundedyear_firsttrialyear = firm_name_founding_year_id_new %>%
  mutate(sponsor_name = ifelse(sponsor_name == "department of \ngynaecology helse finnmark klinikk \nhammerfest", "department of gynaecology helse finnmark klinikk hammerfest", sponsor_name)) %>% 
  select(sponsor_name, sponsor_id, year_founded) %>% 
  left_join(additional_firm_info, by = "sponsor_id") %>% 
  left_join(no_p2trial_before_2010, by = "sponsor_id") %>% 
  left_join(sponsor_name_source, by = "sponsor_name") %>% 
  filter(sponsor_name %in% trial_firm_detail_3$sponsor_name) %>% # filter out companies not having trial record in our dataset
  mutate(sponsor_name_eu = ifelse(source == "EU", sponsor_name, "")) %>% 
  mutate(sponsor_name_aact = ifelse(source == "AACT", sponsor_name, "")) %>% 
  select(-source) %>% 
  mutate(across(everything(), ~ replace_na(., "")))


# Above is the new sponsor list with false negative removed, for the following we use the old version to identify false positive
potential_false_positive = sponsor_id_foundedyear_firsttrialyear %>% 
  group_by(sponsor_id) %>% 
  mutate(name_num = str_replace_all(paste("name_", row_number()), " ", "")) %>% 
  pivot_wider(id_cols = sponsor_id,
              names_from = name_num,
              values_from = sponsor_name) %>% 
  filter(!is.na(name_2))

sponsor_id_foundedyear_firsttrialyear = sponsor_id_foundedyear_firsttrialyear %>% 
  select(-sponsor_name, -sponsor_name_eu, -sponsor_name_aact) %>% 
  distinct(sponsor_id, .keep_all = TRUE) %>% 
  left_join(potential_false_positive) %>% 
  filter(!is.na(name_1)) %>% 
  mutate(across(everything(), ~ replace_na(., "")))


sponsor_id_foundedyear_firsttrialyear %>% filter(name_20 != "")

write.csv(sponsor_id_foundedyear_firsttrialyear, file = "sponsor_id_foundedyear_firsttrialyear_0122.csv")

sponsor_id_foundedyear_firsttrialyear %>% distinct(sponsor_id)
sponsor_id_foundedyear_firsttrialyear %>% filter(industry_dummy == 1) %>% distinct(sponsor_id)

```

Note: The additional information are based on sponsor_id and not sponsor_name

#### firm_name_founding_year_id_source

We have a previous version of this before, but wit hthe updated found year from upqwork data, we want to update the foundyear of this master list as well

```{r}
# Update foundedyear of the master company list
firm_master_list = firm_name_founding_year_id_source %>% 
  left_join(upwork_total %>% select(sponsor_name, foundedyear), by = "sponsor_name") %>% 
  mutate(year_founded = ifelse(!is.na(foundedyear), foundedyear, year_founded)) %>% 
  select(-foundedyear, -false_negative, -false_positive)




```


#### p2trial_length

```{r}
# Contain trial length for all phase 2 trials, flag them as ongoing or finished
p2trial_length = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% # 146718
  mutate(end_year = ifelse(end_year == "", "2024", end_year)) %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  mutate(trial_length = end_year - start_year) %>% 
  mutate(aact_dummy = ifelse(source == "AACT", "1", "0")) %>% 
  select(trial_id, status, start_year, end_year, trial_length, industry_dummy, aact_dummy)


p2trial_length %>% ggplot(aes(x = trial_length, fill = status)) + geom_bar() + xlim(-3, 30)
p2trial_length %>% filter(status == "ongoing") %>% ggplot(aes(x = trial_length, fill = status)) + geom_bar() + xlim(-3, 30) + scale_fill_manual(values = "#00BA38")
p2trial_length %>% filter(status != "ongoing") %>% ggplot(aes(x = trial_length, fill = status)) + geom_bar() + xlim(-3, 30) + scale_fill_manual(values = c("#F8766D", "#619CFF"))
p2trial_length %>% ggplot(aes(x = trial_length)) + geom_boxplot()

write.csv(p2trial_length, file = "p2trial_length.csv")

```

#### p2trial_length (unique trial_id)

Recall at the construciton of the dataset, we see trials taken place in different countries as different trials, and this might result in counting these trials multiple times in the previous dataset. Therefore, here we're trying to look at the distribution of phase 2 trial length with distinct nct_id/eudract_id.

```{r}
# Contain trial length for all phase 2 trials, flag them as ongoing or finished
p2trial_length_unique_trial_id = trial_firm_detail_3 %>% 
  distinct(nct_id, eudract_id, .keep_all = TRUE) %>% 
  filter(phase_2 == 1) %>% # 89829
  mutate(end_year = ifelse(end_year == "", "2024", end_year)) %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  mutate(trial_length = end_year - start_year) %>% 
  mutate(aact_dummy = ifelse(source == "AACT", "1", "0")) %>% 
  select(trial_id, status, start_year, end_year, trial_length, industry_dummy, aact_dummy)

p2trial_length_unique_trial_id %>% ggplot(aes(x = trial_length, fill = status)) + geom_bar() + xlim(-3, 30)
p2trial_length_unique_trial_id %>% filter(status == "ongoing") %>% ggplot(aes(x = trial_length, fill = status)) + geom_bar() + xlim(-3, 30) + scale_fill_manual(values = "#00BA38")
p2trial_length_unique_trial_id %>% filter(status != "ongoing") %>% ggplot(aes(x = trial_length, fill = status)) + geom_bar() + xlim(-3, 30) + scale_fill_manual(values = c("#F8766D", "#619CFF"))
p2trial_length_unique_trial_id %>% ggplot(aes(x = trial_length)) + geom_boxplot()

write.csv(p2trial_length_unique_trial_id, file = "p2trial_length_unique_trial_id.csv")
```

#### p2trial_length (unique trial_id) by days

```{r}
# Create combined dataset with days
# Refer to zombie_trials section
    
p2trial_length_unique_trial_id_days %>% ggplot(aes(x = trial_length_days, fill = status)) + geom_histogram(bins = 100) + xlim(-850, 10000)
p2trial_length_unique_trial_id_days %>% filter(status == "ongoing") %>% ggplot(aes(x = trial_length_days, fill = status)) + geom_histogram(bins = 100) + xlim(-850, 10000) + scale_fill_manual(values = "#00BA38")
p2trial_length_unique_trial_id_days %>% filter(status != "ongoing") %>% ggplot(aes(x = trial_length_days, fill = status)) + geom_histogram(bins = 100) + xlim(-850, 10000) + scale_fill_manual(values = c("#F8766D", "#619CFF"))
p2trial_length_unique_trial_id_days %>% filter(status == "ongoing") %>% ggplot(aes(x = trial_length_days)) + geom_boxplot()

write.csv(p2trial_length_unique_trial_id_days, file = "p2trial_length_unique_trial_id_days.csv")

p2trial_length_unique_trial_id_days %>% filter(status == "completed") %>% filter(industry_dummy == "1") %>% ggplot(aes(x = trial_length_days, fill = status)) + geom_histogram(bins = 100) + xlim(-850, 10000)

p2trial_length_unique_trial_id_days %>% filter(status == "completed") %>% filter(industry_dummy == "0") %>% ggplot(aes(x = trial_length_days, fill = status)) + geom_histogram(bins = 100) + xlim(-850, 10000)


p2trial_length_unique_trial_id_days %>% filter(status == "completed") %>% filter(industry_dummy == "1") %>% summary()
p2trial_length_unique_trial_id_days %>% filter(status == "completed") %>% filter(industry_dummy == "1") %>% summarize(sd = sd(trial_length_days))

p2trial_length_unique_trial_id_days %>% filter(status == "completed") %>% filter(industry_dummy == "0") %>% summarize(sd = sd(trial_length_days))



```







     
     
#### Reasons of drop and withdraw

  We found a interesting variable from the US dataset, why_stopped, indicating the reasons of trials stopping, we then run text analysis on these descriptions to see if theres any insights. 

```{r}
# Create a reason of ending dataset
us_why_stopped = us_studies %>% filter(why_stopped != "") %>% select(nct_id, why_stopped) # 39797

why_stopped = trial_firm_detail_3 %>% 
  left_join(us_why_stopped, by = "nct_id") %>% 
  filter(!is.na(why_stopped)) %>% 
  select(nct_id, sponsor_id, start_year, end_year, why_stopped) %>% 
  distinct(nct_id, .keep_all = TRUE) %>% 
  mutate(doc_id = row_number())

why_stopped %>% filter(str_detect(why_stopped, regex("data", ignore_case = TRUE)))

653/19743
```

  Here we try different algorithms to categorize reasons of stopping

```{r}
# Method: Use topic modeling (LDA) to categorize reasons of stopping, and use keyword matching to polish
# Curate a keyword list
stop_reason_keywords = list(
  recruitment_issue = "(enroll|enrolled|enrol|enrolling|recruited|recruit|recruiting|accrue)",
  sponsor_issue = "(sponsors|Sponsor's|sponsorship|sponsoring)"
)

# Load and process the texts
docs <- Corpus(VectorSource(why_stopped$why_stopped))
docs <- tm_map(docs, content_transformer(tolower))
docs <- tm_map(docs, removePunctuation)
docs <- tm_map(docs, removeNumbers)
docs <- tm_map(docs, removeWords, stopwords("english"))
docs <- tm_map(docs, removeWords, c("study", "due", "terminated"))
docs <- tm_map(docs, stripWhitespace)

# Create a DocumentTermMatrix and remove sparse terms
dtm <- DocumentTermMatrix(docs)
dtm <- removeSparseTerms(dtm, 0.95)
row_totals <- apply(dtm, 1, sum) 
dtm <- dtm[row_totals > 0, ] 

# Fit an LDA model with 2 topics (you might need to adjust 'k')
# k = number of classes (tune to see 2 has the best performance), alpha = distribution of topics per document
set.seed(0223)
lda_model <- LDA(dtm, k = 2, control = list(alpha = 0.15, seed = 0223)) 

# Extract the top terms for each topic
topics <- tidy(lda_model, matrix = "beta") %>%
  group_by(topic) %>%
  top_n(5, beta) %>%
  ungroup() %>%
  arrange(topic, -beta)

print(topics) # Analyse and conclude topic 1 is recruitment, topic 2 is sponsor related issue

# Assign topic probability to each documents
doc_topics = tidy(lda_model, matrix = "gamma") %>% mutate(doc_id = as.numeric(document))

# Merge with original dataset
us_trial_stop_reason = why_stopped %>%
  left_join(doc_topics %>% pivot_wider(names_from = topic, values_from = gamma, names_prefix = "topic_"), by = "doc_id") %>% 
  select(-doc_id, -document) %>% 
  mutate(recruitment_issue = ifelse(topic_1 >= .3, 1, 0),
         sponsor_issue = ifelse(topic_2 >= .5, 1, 0),) %>%  # Find the threshold for each topic 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  select(-topic_1, -topic_2) %>% 
  mutate(recruitment_issue =  ifelse(str_detect(why_stopped, regex(stop_reason_keywords$recruitment_issue, ignore_case = TRUE)),
                                     1, recruitment_issue),
         sponsor_issue = ifelse(str_detect(why_stopped, regex(stop_reason_keywords$sponsor_issue, ignore_case = TRUE)),
                                1, sponsor_issue),
         other_reasons = ifelse(recruitment_issue == 0 & sponsor_issue == 0, 1, 0)) %>% 
  arrange(sponsor_id)

```

```{r}
# Merge the variable to the firm-year panel
```


*Raw observations*

Sample recruitment issues:
 - Recruitment Issues
 - Low Enrollment
 - Insufficient recruitment rate
 - Enrollment has been halted
 - Unable to recruit participants due to restrictive inclusion/exclusion criteria. Will update protocol with IRB \\& begin anew after approval.
 
Sample sponsor issues:
 - Company's decision
 - Sponsor insolvency
 - Trial terminated by Sponsor
 - Business Decision
 - Management Decision
 
Sample other reasons:
 - Insufficient clinical activity
 - The control product was recalled.
 - This study is being closed because it is unworkable.
 - Strategic considerations
 - Data obtained from the M11-427 study is not critical to the continued evaluation of ABT-126.
 - Corporate finances
 - Methodology applied did not meet all criteria required per guidelines
 
Also, note that there might be overlap for recruitment issue and sponsor issue: (the following are both recruitment and sponsor issue):
 - Sponsor decision due to low recruitment
 - The Sponsor decided to prematurely terminate the study due to the lower-than-expected recruitment rate.
 - Business Considerations (difficulty with enrollment)



```{r}
# Exploring topic trends with 2017 cutoff
us_trial_stop_reason_pre_gdpr = us_trial_stop_reason %>% filter(as.numeric(start_year) < 2018)
us_trial_stop_reason_post_gdpr = us_trial_stop_reason %>% filter(as.numeric(start_year) >= 2018)

us_trial_stop_reason_pre_2017 %>% #12153
  filter(other_reasons == 1) #4427

us_trial_stop_reason_post_2017 %>% #7590
  filter(other_reasons == 1) #2643


4427/12153
2954/7590
```

Ending due to recruitment issue dropped from 41.8% pre 2017 (5081/12153) to 35.2% post 2017 (2674/7590)
Ending due to sponsor issue stays roughly the same, with 32.8% (3985/12153) pre 2017 to 34.8% (2643/7590) post 2017
Ending due to other reasons stays roughly the same, with 36.4% (4427/12153) pre 2017 to 38.9% (2954/7590) post 2017

     
     
     
     
     
#### Top countries other than US and EU
  
  Discover top 10 other countries in the Others class
  
```{r}
trial_firm_detail_3 %>% 
  filter(phase_2 == 1,
         region == "Others",
         country != "") %>% 
  group_by(country) %>% 
  summarize(country_count = n()) %>% 
  arrange(desc(country_count)) %>% 
  top_n(10)
  
```
#### Descriptive statistics

```{r}
# number of trial starts in each phase
trial_firm_detail_3 %>% 
  mutate(phase = case_when(
    phase_1 == 1 ~ "phase_1",
    phase_2 == 1 ~ "phase_2",
    phase_3 == 1 ~ "phase_3",
    phase_4 == 1 ~ "phase_4",
  )) %>% 
  group_by(phase) %>% 
  summarize(count = n())

# number of Trial Starts in each phase with collaborator
trial_firm_detail_3 %>% 
  mutate(phase = case_when(
    phase_1 == 1 ~ "phase_1",
    phase_2 == 1 ~ "phase_2",
    phase_3 == 1 ~ "phase_3",
    phase_4 == 1 ~ "phase_4",
  )) %>% 
  filter(collaborator != "") %>% 
  group_by(phase) %>% 
  summarize(count = n())

# number of Trial Starts in each phase with no collaborator
trial_firm_detail_3 %>% 
  mutate(phase = case_when(
    phase_1 == 1 ~ "phase_1",
    phase_2 == 1 ~ "phase_2",
    phase_3 == 1 ~ "phase_3",
    phase_4 == 1 ~ "phase_4",
  )) %>% 
  filter(collaborator == "") %>% 
  group_by(phase) %>% 
  summarize(count = n())

# number of Completed Trials in each phase
trial_firm_detail_3 %>% 
  mutate(phase = case_when(
    phase_1 == 1 ~ "phase_1",
    phase_2 == 1 ~ "phase_2",
    phase_3 == 1 ~ "phase_3",
    phase_4 == 1 ~ "phase_4",
  )) %>% 
  filter(status == "completed") %>% 
  group_by(phase) %>% 
  summarize(count = n())

# number of Completed Trials in each phase with collaborators
trial_firm_detail_3 %>% 
  mutate(phase = case_when(
    phase_1 == 1 ~ "phase_1",
    phase_2 == 1 ~ "phase_2",
    phase_3 == 1 ~ "phase_3",
    phase_4 == 1 ~ "phase_4",
  )) %>% 
  filter(status == "completed",
         collaborator != "") %>% 
  group_by(phase) %>% 
  summarize(count = n())

# number of Completed Trials in each phase with no collaborators
trial_firm_detail_3 %>% 
  mutate(phase = case_when(
    phase_1 == 1 ~ "phase_1",
    phase_2 == 1 ~ "phase_2",
    phase_3 == 1 ~ "phase_3",
    phase_4 == 1 ~ "phase_4",
  )) %>% 
  filter(status == "completed",
         collaborator == "") %>% 
  group_by(phase) %>% 
  summarize(count = n())

# number of Terminated Trials in each phase
trial_firm_detail_3 %>% 
  mutate(phase = case_when(
    phase_1 == 1 ~ "phase_1",
    phase_2 == 1 ~ "phase_2",
    phase_3 == 1 ~ "phase_3",
    phase_4 == 1 ~ "phase_4",
  )) %>% 
  filter(status == "terminated") %>% 
  group_by(phase) %>% 
  summarize(count = n())

# number of Terminated Trials in each phase with collaborators
trial_firm_detail_3 %>% 
  mutate(phase = case_when(
    phase_1 == 1 ~ "phase_1",
    phase_2 == 1 ~ "phase_2",
    phase_3 == 1 ~ "phase_3",
    phase_4 == 1 ~ "phase_4",
  )) %>% 
  filter(status == "terminated",
         collaborator != "") %>% 
  group_by(phase) %>% 
  summarize(count = n())

# number of Terminated Trials in each phase with no collaborators
trial_firm_detail_3 %>% 
  mutate(phase = case_when(
    phase_1 == 1 ~ "phase_1",
    phase_2 == 1 ~ "phase_2",
    phase_3 == 1 ~ "phase_3",
    phase_4 == 1 ~ "phase_4",
  )) %>% 
  filter(status == "terminated",
         collaborator == "") %>% 
  group_by(phase) %>% 
  summarize(count = n())


# Top 10 companies for above_median_eu_pre_2018_p2
above_median_eu_pre_2018_p2_industry = firm_year_dataset_23 %>% 
  filter(above_median_eu_pre_2018_p2_industry == 1) %>% 
  distinct(sponsor_id)
below_median_eu_pre_2018_p2_industry = firm_year_dataset_23 %>% 
  filter(above_median_eu_pre_2018_p2_industry == 0) %>% 
  distinct(sponsor_id)

#top_10_sponsors_above_median_eu_pre_2018_p2_industry
top_10_sponsors_above_median_eu_pre_2018_p2_industry = above_median_eu_pre_2018_p2_industry %>% 
  left_join(trial_firm_detail_3, by = "sponsor_id") %>% 
  filter(phase_2 == 1,
         start_year < "2018",
         industry_dummy == 1) %>% 
  group_by(sponsor_id) %>% 
  summarize(count = n()) %>% 
  arrange(desc(count)) %>% 
  top_n(10) %>% 
  left_join(firm_name_founding_year_id %>% select(sponsor_name, sponsor_id) %>% distinct(sponsor_id, .keep_all = T), by = "sponsor_id") %>% 
  select(sponsor_id, sponsor_name, count)

#top_10_sponsors_below_median_eu_pre_2018_p2_industry
top_10_sponsors_below_median_eu_pre_2018_p2_industry = below_median_eu_pre_2018_p2_industry %>% 
  left_join(trial_firm_detail_3, by = "sponsor_id") %>% 
  filter(phase_2 == 1,
         start_year < "2018",
         industry_dummy == 1) %>% 
  group_by(sponsor_id) %>% 
  summarize(count = n()) %>% 
  arrange(desc(count)) %>% 
  top_n(10) %>% 
  left_join(firm_name_founding_year_id %>% select(sponsor_name, sponsor_id) %>% distinct(sponsor_id, .keep_all = T), by = "sponsor_id") %>% 
  select(sponsor_id, sponsor_name, count)

# number of p2 trials in aact trials wiht collaborators
trial_firm_detail_3 %>% 
  filter(industry_dummy == 1,
         phase_2 == 1,
         source == "AACT",
         collab_num >= 0) 
trial_firm_detail_3 %>% 
  filter(industry_dummy == 1,
         phase_2 == 1,
         source == "AACT",
         collab_num >= 1) 
trial_firm_detail_3 %>% 
  filter(industry_dummy == 1,
         phase_2 == 1,
         source == "AACT",
         collab_num >= 2) 

trial_firm_detail_3 %>% 
  filter(industry_dummy == 1,
         phase_2 == 1,
         source == "EU",
         collab_num >= 0) 
trial_firm_detail_3 %>% 
  filter(industry_dummy == 1,
         phase_2 == 1,
         source == "EU",
         collab_num >= 1) 
trial_firm_detail_3 %>% 
  filter(industry_dummy == 1,
         phase_2 == 1,
         source == "EU",
         collab_num >= 2) 

```

#### Master sponsor list

We want to keep track of a master list of companies/sponsors so we can refer to this list whenver we have more matching to do in the future, called master_sponsor_list

```{r}
# Curate a master_sponsor_list that includes sponsor_name, sponsor_id, industry_dummy, founded_year, hq_location, matched_collaborator
master_sponsor_list = firm_name_founding_year_id_source %>% 
  select(-false_negative, -false_positive) %>% 
  left_join(updated_hq_region, by = "sponsor_name") %>% 
  mutate(hq_region_broad = ifelse(is.na(hq_region_broad), "", hq_region_broad)) %>% 
  left_join(bind_rows(matched_collaborators, matched_non_ind_collaborators) %>% 
    distinct(sponsor_id) %>% 
    mutate(matched_collaborator = 1), by = "sponsor_id") %>% 
  mutate(matched_collaborator = ifelse(is.na(matched_collaborator), 0, 1)) %>% 
  left_join(trial_firm_detail_3 %>% 
    select(sponsor_id, industry_dummy) %>% 
    distinct(sponsor_id, .keep_all = TRUE), by = "sponsor_id") %>% 
  mutate(industry_dummy = ifelse(is.na(industry_dummy), "", industry_dummy)) %>% 
  left_join(upwork_total %>% 
    select(sponsor_name, foundedyear, hq_country, hq_region, public_private_2010, public_private_2017), by = "sponsor_name") %>% 
  mutate(hq_region = ifelse(is.na(hq_country), NA, hq_region)) %>% 
  mutate(year_founded = ifelse(!is.na(foundedyear), foundedyear, year_founded),
         year_founded = as.character(year_founded)) %>% 
  select(sponsor_name, sponsor_id, source, industry_dummy, year_founded, hq_country, hq_region, hq_region_broad, matched_collaborator, public_private_2010, public_private_2017) %>% 
  mutate(across(everything(), ~ replace_na(., ""))) 


master_sponsor_list_w_industry = master_sponsor_list %>% filter(industry_dummy != "")


```


#### firm-disease-year panel

  Create a firm-disease-year panel to assess the change of disease focus over the years for each companies, there are two definitions that we want to work with:
  
  Def 1: per company, each company would only have such disease if it has trial focusing on such diseases pre 2018
  Def 2: overall disease, tracking all existing diseases pre 2018 for all companies



```{r}
# The panels should only keep track of sponsors active before 2018
active_company_pre_2018 = trial_firm_detail_3 %>% 
  filter(as.numeric(start_year) <= 2018) %>% 
  select(sponsor_id) %>% 
  as.vector()

# def 1
# Curate a dataset of each sponsor_id and their diseases before 2018
sponsor_disease_list = trial_firm_detail_3 %>% 
  filter(as.numeric(start_year) <= 2018) %>% 
  filter(disease_id != "") %>% 
  group_by(sponsor_id) %>% 
  distinct(disease_id) %>% 
  arrange(sponsor_id, as.numeric(disease_id)) %>% 
  summarize(disease_id = list(disease_id))

firm_disease_year_data_def1 = trial_firm_detail_3 %>% 
  group_by(sponsor_id) %>% 
  slice_min(sponsor_found_year, with_ties = F) %>% 
  ungroup() %>% 
  filter(sponsor_id %in% unlist(active_company_pre_2018)) %>% 
  filter(disease_id != "") %>% 
  select(sponsor_id, sponsor_name, sponsor_found_year) %>% 
  rowwise() %>%
  mutate(year = list(seq(sponsor_found_year, 2024))) %>%
  unnest(year) %>% 
  select(-sponsor_found_year) %>% 
  left_join(sponsor_disease_list, by = "sponsor_id") %>% 
  unnest(disease_id) %>% 
  arrange(sponsor_id, as.numeric(disease_id), as.numeric(year)) %>% 
  left_join(disease_id_code_name %>% 
              select(disease_id, mesh_code) %>% 
              mutate(disease_id = as.character(disease_id)), by = "disease_id") %>% 
  select(sponsor_id, sponsor_name, disease_id, mesh_code, year)


# def 2 
# First curate a list of all diseases before 2018
all_disease_list = trial_firm_detail_3 %>% 
  filter(as.numeric(start_year) <= 2018) %>% 
  distinct(disease_id) %>% 
  arrange(as.numeric(disease_id)) %>% 
  filter(disease_id != "") %>% 
  as.list()

firm_disease_year_data_def2 = trial_firm_detail_3 %>% 
  group_by(sponsor_id) %>% 
  slice_min(sponsor_found_year, with_ties = F) %>%
  ungroup() %>% 
  filter(disease_id != "") %>% 
  filter(sponsor_id %in% unlist(active_company_pre_2018)) %>% 
  select(sponsor_id, sponsor_name, sponsor_found_year) %>% 
  rowwise() %>%
  mutate(year = list(seq(sponsor_found_year, 2024))) %>%
  unnest(year) %>% 
  select(-sponsor_found_year) %>% 
  mutate(disease_id = all_disease_list) %>% 
  unnest(disease_id) %>% 
  arrange(sponsor_id, as.numeric(disease_id), as.numeric(year)) %>% 
  left_join(disease_id_code_name %>% 
              select(disease_id, mesh_code) %>% 
              mutate(disease_id = as.character(disease_id)), by = "disease_id") %>% 
  select(sponsor_id, sponsor_name, disease_id, mesh_code, year)

```

##### Definition 1

###### phase2 start/complete/treminate/ongoing

```{r}
# Create corresponding columns
p2_start_fdy = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarise(p2_start = n(), .groups = 'drop') 
p2_end_fdy = trial_firm_detail_3 %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarise(p2_end = n())
p2_startdate_comp_fdy = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(status == "completed") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarise(p2_startdate_comp = n(), .groups = 'drop') 
p2_startdate_term_fdy = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(status == "terminated") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarise(p2_startdate_term = n(), .groups = 'drop') 


p2_ongoing_fdy = firm_disease_year_data_def1 %>% 
  left_join(p2_start_fdy, by = c("sponsor_id" = "sponsor_id", "disease_id" = "disease_id", "year" = "start_year")) %>% 
  left_join(p2_end_fdy, by = c("sponsor_id" = "sponsor_id", "disease_id" = "disease_id", "year" = "end_year")) %>% 
  select(sponsor_id, disease_id, year, p2_start, p2_end) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  group_by(sponsor_id, disease_id) %>% 
  mutate(cum_p2_start = cumsum(p2_start),
         cum_p2_end = lag(cumsum(p2_end), default = 0),
         p2_ongoing = cum_p2_start - cum_p2_end) %>% 
  select(sponsor_id, disease_id, year, p2_ongoing)



# Merge these 4 variables to the panel
firm_disease_year_data_def1_1 = firm_disease_year_data_def1 %>% 
  left_join(p2_start_fdy, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_startdate_comp_fdy, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_startdate_term_fdy, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_ongoing_fdy, by = c("sponsor_id", "disease_id", "year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

```

     
###### above_median_eu_pre_2018_p2, industry_dummy

```{r}
# Create corresponding columns
eu_expose_pre_2018_p2_fdy = eu_expose_pre_2018_p2 %>% 
  select(sponsor_id, above_median_eu_pre_2018_p2)
industry_dummy_fdy = trial_firm_detail_3 %>% 
  select(sponsor_id, industry_dummy) %>% 
  distinct(sponsor_id, .keep_all = T)

# Merge these 2 variables to the panel
firm_disease_year_data_def1_2 = firm_disease_year_data_def1_1 %>% 
  left_join(eu_expose_pre_2018_p2_fdy, by = "sponsor_id") %>% 
  left_join(industry_dummy_fdy, by = "sponsor_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

```


###### patient_avg_start_allregion_p2

```{r}
# Create corresponding columns
patient_mean_starting_allregion_phase2_fdy = trial_firm_detail_valid_patient %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarise(patient_avg_start_allregion_p2 = mean(patient_num))

# Merge this variable to the panel
firm_disease_year_data_def1_3 = firm_disease_year_data_def1_2 %>% 
  left_join(patient_mean_starting_allregion_phase2_fdy, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

```



##### Definition 2

###### phase2 start/complete/treminate/ongoing

```{r}
# Create corresponding columns, fdy means firm_disease_year
p2_start_fdy2 = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarise(p2_start = n(), .groups = 'drop') 
p2_end_fdy2 = trial_firm_detail_3 %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarise(p2_end = n())
p2_startdate_comp_fdy2 = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(status == "completed") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarise(p2_startdate_comp = n(), .groups = 'drop') 
p2_startdate_term_fdy2 = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(status == "terminated") %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarise(p2_startdate_term = n(), .groups = 'drop') 


p2_ongoing_fdy2 = firm_disease_year_data_def2 %>% 
  left_join(p2_start_fdy2, by = c("sponsor_id" = "sponsor_id", "disease_id" = "disease_id", "year" = "start_year")) %>% 
  left_join(p2_end_fdy2, by = c("sponsor_id" = "sponsor_id", "disease_id" = "disease_id", "year" = "end_year")) %>% 
  select(sponsor_id, disease_id, year, p2_start, p2_end) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  group_by(sponsor_id, disease_id) %>% 
  mutate(cum_p2_start = cumsum(p2_start),
         cum_p2_end = lag(cumsum(p2_end), default = 0),
         p2_ongoing = cum_p2_start - cum_p2_end) %>% 
  select(sponsor_id, disease_id, year, p2_ongoing)



# Merge these 4 variables to the panel
firm_disease_year_data_def2_1 = firm_disease_year_data_def2 %>% 
  left_join(p2_start_fdy, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_startdate_comp_fdy, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_startdate_term_fdy, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_ongoing_fdy, by = c("sponsor_id", "disease_id", "year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

```

     
###### above_median_eu_pre_2018_p2, industry_dummy

```{r}
# Create corresponding columns
eu_expose_pre_2018_p2_fdy2 = eu_expose_pre_2018_p2 %>% 
  select(sponsor_id, above_median_eu_pre_2018_p2)
eu_expose_pre_2018_p2_industry_fdy2 = eu_expose_pre_2018_p2_industry %>% 
  select(sponsor_id, eu_porp_pre_2018_p2_industry, above_median_eu_pre_2018_p2_industry)
industry_dummy_fdy2 = trial_firm_detail_3 %>% 
  select(sponsor_id, industry_dummy) %>% 
  distinct(sponsor_id, .keep_all = T)


# Merge these 2 variables to the panel
firm_disease_year_data_def2_2 = firm_disease_year_data_def2_1 %>% 
  left_join(eu_expose_pre_2018_p2_fdy2, by = "sponsor_id") %>% 
  left_join(eu_expose_pre_2018_p2_industry_fdy2, by = "sponsor_id") %>% 
  left_join(industry_dummy_fdy2, by = "sponsor_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

```


###### patient_avg_start_allregion_p2

```{r}
# Create corresponding columns
patient_mean_starting_allregion_phase2_fdy2 = trial_firm_detail_valid_patient %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarise(patient_avg_start_allregion_p2 = mean(patient_num))

### three bonus collab partition of patient_mean_starting_allregion_phase2
patient_mean_starting_allregion_phase2_w_collab_fdy2 = trial_firm_detail_valid_patient %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(collab == 1,
         phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarise(patient_avg_start_allregion_p2_w_collab = mean(patient_num))
patient_mean_starting_allregion_phase2_w_exist_collab_fdy2 = trial_firm_detail_valid_patient %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(collab_existing == 1,
         phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarise(patient_avg_start_allregion_p2_w_exist_collab = mean(patient_num))
patient_mean_starting_allregion_phase2_w_estab_collab_fdy2 = trial_firm_detail_valid_patient %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(collab_established == 1,
         phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarise(patient_avg_start_allregion_p2_w_estab_collab = mean(patient_num))



# Merge this variable to the panel
firm_disease_year_data_def2_3 = firm_disease_year_data_def2_2 %>% 
  left_join(patient_mean_starting_allregion_phase2_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(patient_mean_starting_allregion_phase2_w_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(patient_mean_starting_allregion_phase2_w_exist_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(patient_mean_starting_allregion_phase2_w_estab_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

```

###### p2_mean_length

```{r}
# Create p2_mean_length
p2_trial_length_start_fdy2 = p2_trial_length %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarise(p2_trial_length_start = str_c(trial_length, collapse = ", "))

p2_trial_length_end_fdy2 = p2_trial_length %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarise(p2_trial_length_end = str_c(trial_length, collapse = ", "))

p2_average_median_max_min_length_fdy2 = firm_disease_year_data_def2_3 %>% 
  left_join(p2_trial_length_start_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_trial_length_end_fdy2, by = c("sponsor_id", "disease_id", "year" = "end_year")) %>% 
  select(sponsor_id, disease_id, year, p2_trial_length_start, p2_trial_length_end) %>% 
  mutate(across(everything(), ~ replace_na(., ""))) %>% 
  group_by(sponsor_id, disease_id) %>% 
  mutate(cum_p2_trial_length_start = accumulate(
      p2_trial_length_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
         cum_p2_trial_length_end = lag(accumulate(
      p2_trial_length_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_trial_length_active = ifelse(length(preserve_setdiff(str_split(cum_p2_trial_length_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_end, ", ")[[1]])) == 0, NA,
                                    preserve_setdiff(str_split(cum_p2_trial_length_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_end, ", ")[[1]]) %>% paste(collapse = ", ")),
    p2_mean_length = mean(as.numeric(str_split(p2_trial_length_active, ", ")[[1]])),
    p2_median_length = median(as.numeric(str_split(p2_trial_length_active, ", ")[[1]])),
    p2_max_length = max(as.numeric(str_split(p2_trial_length_active, ", ")[[1]])),
    p2_min_length = min(as.numeric(str_split(p2_trial_length_active, ", ")[[1]])),
  ) %>% 
  select(sponsor_id, disease_id, year, p2_mean_length)

p2_average_median_max_min_length_fdy2 = p2_average_median_max_min_length_fdy2 %>% 
  mutate(p2_mean_length = ifelse(is.na(p2_mean_length), "", as.character(p2_mean_length)))


firm_disease_year_data_def2_4 = firm_disease_year_data_def2_3 %>% 
  left_join(p2_average_median_max_min_length_fdy2, by = c("sponsor_id", "disease_id", "year")) %>% 
  mutate(across(everything(), ~ replace_na(., "")))


```

###### p2_start_ipd_share, p2_start_incapable_share, p2_start_incapable_share, p2_start_incapable_share_w_collab


```{r}
# IPD share
p2_start_ipd_share_fdy2 = trial_firm_detail_3 %>% filter(phase_2 == 1) %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  left_join(us_plan_to_share_ipd, by = "nct_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  select(sponsor_id, disease_id, start_year, plan_to_share_ipd_yes, plan_to_share_ipd_no) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_ipd_share_yes = sum(plan_to_share_ipd_yes),
            p2_start_ipd_share_no = sum(plan_to_share_ipd_no))

# Do the same for collab/exist_collab/estab_collab
# p2_start_ipd_share_w_collab
p2_start_ipd_share_w_collab_fdy2 = trial_firm_detail_3 %>% filter(phase_2 == 1, collab == 1) %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  left_join(us_plan_to_share_ipd, by = "nct_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  select(sponsor_id, disease_id, start_year, plan_to_share_ipd_yes) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_ipd_share_w_collab = sum(plan_to_share_ipd_yes))
# p2_start_ipd_share_w_exist_collab
p2_start_ipd_share_w_exist_collab_fdy2 = trial_firm_detail_3 %>% filter(phase_2 == 1, collab_existing == 1) %>% 
  mutate(start_year = as.numeric(start_year)) %>%
  left_join(us_plan_to_share_ipd, by = "nct_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  select(sponsor_id, disease_id, start_year, plan_to_share_ipd_yes) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_ipd_share_w_exist_collab = sum(plan_to_share_ipd_yes))
# p2_start_ipd_share_w_estab_collab
p2_start_ipd_share_w_estab_collab_fdy2 = trial_firm_detail_3 %>% filter(phase_2 == 1, collab_established == 1) %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  left_join(us_plan_to_share_ipd, by = "nct_id") %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  select(sponsor_id, disease_id, start_year, plan_to_share_ipd_yes) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_ipd_share_w_estab_collab = sum(plan_to_share_ipd_yes))




# Incapable Share
p2_start_incapable_share_fdy2 = trial_firm_detail_3 %>% left_join(eu_incapable_consent, by = "eudract_id") %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(subject_incapable_consent == 1) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, disease_id, start_year, subject_incapable_consent) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_incapable_share = sum(subject_incapable_consent))

# Do the same for collab/exist_collab/estab_collab
# p2_start_incapable_consent_w_collab
p2_start_incapable_share_w_collab_fdy2 = trial_firm_detail_3 %>% left_join(eu_incapable_consent, by = "eudract_id") %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(subject_incapable_consent == 1,
         phase_2 == 1,
         collab == 1) %>% 
  select(sponsor_id, disease_id, start_year, subject_incapable_consent) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_incapable_share_w_collab = sum(subject_incapable_consent))
# p2_start_incapable_consent_w_exist_collab
p2_start_incapable_share_w_exist_collab_fdy2 = trial_firm_detail_3 %>% left_join(eu_incapable_consent, by = "eudract_id") %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(subject_incapable_consent == 1,
         phase_2 == 1,
         collab_existing == 1) %>% 
  select(sponsor_id, disease_id, start_year, subject_incapable_consent) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_incapable_share_w_exist_collab = sum(subject_incapable_consent))
# p2_start_incapable_consent_w_estab_collab
p2_start_incapable_share_w_estab_collab_fdy2 = trial_firm_detail_3 %>% left_join(eu_incapable_consent, by = "eudract_id") %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(subject_incapable_consent == 1,
         phase_2 == 1,
         collab_established == 1) %>% 
  select(sponsor_id, disease_id, start_year, subject_incapable_consent) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_incapable_share_w_estab_collab = sum(subject_incapable_consent))



firm_disease_year_data_def2_5 = firm_disease_year_data_def2_4 %>% 
  left_join(p2_start_ipd_share_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_ipd_share_w_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_ipd_share_w_exist_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_ipd_share_w_estab_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_incapable_share_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_incapable_share_w_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_incapable_share_w_exist_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_incapable_share_w_estab_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))  

```


###### p2_unique_active_site
    
```{r}
# Create p2_unique_active_site
p2_unique_site_start_fdy2 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_unique_site_start = str_c(country, collapse = ", "))
p2_unique_site_end_fdy2 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarize(p2_unique_site_end = str_c(country, collapse = ", "))
p2_unique_active_site_fdy2 = firm_disease_year_data_def2_5 %>% 
  left_join(p2_unique_site_start_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_unique_site_end_fdy2, by = c("sponsor_id", "disease_id", "year" = "end_year")) %>% 
  select(sponsor_id, disease_id, year, p2_unique_site_start, p2_unique_site_end) %>% 
  group_by(sponsor_id, disease_id) %>% 
  mutate(p2_unique_site_start = ifelse(is.na(p2_unique_site_start), "", p2_unique_site_start)) %>%
  mutate(p2_unique_site_end = ifelse(is.na(p2_unique_site_end), "", p2_unique_site_end)) %>%
  mutate(
    cum_p2_unique_site_start = accumulate(
      p2_unique_site_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_unique_site_end = lag(accumulate(
      p2_unique_site_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")
  ) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_active_site_name = preserve_setdiff(str_split(cum_p2_unique_site_start, ", ")[[1]], 
                                                    str_split(cum_p2_unique_site_end, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_site = p2_unique_active_site_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_site = ifelse(p2_unique_active_site_name == "", 0, p2_unique_active_site)
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, disease_id, year, p2_unique_active_site)

# Create p2_unique_active_site_eu
p2_unique_site_start_eu_fdy2 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1,
         region == "EU") %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_unique_site_start = str_c(country, collapse = ", "))
p2_unique_site_end_eu_fdy2 = trial_firm_detail_3 %>% 
  filter(phase_2 == 1,
         region == "EU") %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarize(p2_unique_site_end = str_c(country, collapse = ", "))
p2_unique_active_site_eu_fdy2 = firm_disease_year_data_def2_5 %>% 
  left_join(p2_unique_site_start_eu_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_unique_site_end_eu_fdy2, by = c("sponsor_id", "disease_id", "year" = "end_year")) %>% 
  select(sponsor_id, disease_id, year, p2_unique_site_start, p2_unique_site_end) %>% 
  group_by(sponsor_id, disease_id) %>% 
  mutate(p2_unique_site_start = ifelse(is.na(p2_unique_site_start), "", p2_unique_site_start)) %>%
  mutate(p2_unique_site_end = ifelse(is.na(p2_unique_site_end), "", p2_unique_site_end)) %>%
  mutate(
    cum_p2_unique_site_start = accumulate(
      p2_unique_site_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_unique_site_end = lag(accumulate(
      p2_unique_site_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")
  ) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_active_site_name = preserve_setdiff(str_split(cum_p2_unique_site_start, ", ")[[1]], 
                                                    str_split(cum_p2_unique_site_end, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_site_eu = p2_unique_active_site_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_site_eu = ifelse(p2_unique_active_site_name == "", 0, p2_unique_active_site_eu)
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, disease_id, year, p2_unique_active_site_eu)


firm_disease_year_data_def2_6 = firm_disease_year_data_def2_5 %>% 
  left_join(p2_unique_active_site_fdy2, by = c("sponsor_id", "disease_id", "year")) %>% 
  left_join(p2_unique_active_site_eu_fdy2, by = c("sponsor_id", "disease_id", "year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))


```

     
     
###### p2_total_active/new/old_collab, p2_total_new/old_industry/non_industry_collab

```{r}
# p2_total_active/new/old_collab
p2_total_start_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, disease_id, start_year, collab_num, collaborator) %>% 
  filter(collab_num > 0) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_total_new_collab = sum(collab_num))
p2_total_end_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, disease_id, end_year, collab_num, collaborator) %>% 
  filter(collab_num > 0) %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarize(p2_total_end_collab = sum(collab_num))

p2_collab_fdy2 = firm_disease_year_data_def2_5 %>% 
  left_join(p2_total_start_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_total_end_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "end_year")) %>% 
  select(sponsor_id, disease_id, year, p2_total_new_collab, p2_total_end_collab) %>% 
  group_by(sponsor_id, disease_id) %>% 
  mutate(p2_total_new_collab = ifelse(is.na(p2_total_new_collab), 0, p2_total_new_collab)) %>% 
  mutate(p2_total_end_collab = ifelse(is.na(p2_total_end_collab), 0, p2_total_end_collab)) %>% 
  mutate(
    cum_p2_total_new_collab = cumsum(p2_total_new_collab),
    cum_p2_total_end_collab = lag(cumsum(p2_total_end_collab), default = 0)
    ) %>% 
  rowwise() %>% 
  mutate(
    p2_total_active_collab = cum_p2_total_new_collab - cum_p2_total_end_collab,
    p2_total_old_collab = p2_total_active_collab - p2_total_new_collab
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, disease_id, year, p2_total_active_collab, p2_total_new_collab, p2_total_old_collab)



# Create variables p2_total_new/old_industry_collab
p2_total_start_industry_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(phase_2 == 1) %>% 
  filter(industry_collab != "") %>% 
  select(sponsor_id, disease_id, start_year, industry_collab) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_total_new_industry_collab_name = str_c(industry_collab, collapse = ", "))
p2_total_end_industry_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  filter(phase_2 == 1) %>% 
  filter(industry_collab != "") %>% 
  select(sponsor_id, disease_id, end_year, industry_collab) %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarize(p2_total_end_industry_collab_name = str_c(industry_collab, collapse = ", "))

p2_industry_collab_fdy2 = firm_disease_year_data_def2_5 %>% 
  left_join(p2_total_start_industry_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_total_end_industry_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "end_year")) %>% 
  select(sponsor_id, disease_id, year, p2_total_new_industry_collab_name, p2_total_end_industry_collab_name) %>% 
  group_by(sponsor_id, disease_id) %>% 
  mutate(
    p2_total_new_industry_collab_name = ifelse(is.na(p2_total_new_industry_collab_name), "", p2_total_new_industry_collab_name),
    p2_total_end_industry_collab_name = ifelse(is.na(p2_total_end_industry_collab_name), "", p2_total_end_industry_collab_name)
    ) %>%
  mutate(
    p2_total_new_industry_collab = p2_total_new_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
    p2_total_new_industry_collab = ifelse(p2_total_new_industry_collab_name == "", 0, p2_total_new_industry_collab)
    ) %>% 
  mutate(
    cum_p2_total_new_industry_collab_name = accumulate(
      p2_total_new_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_total_end_industry_collab_name = lag(accumulate(
      p2_total_end_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_active_industry_collab_name = preserve_setdiff(str_split(cum_p2_total_new_industry_collab_name, ", ")[[1]], 
                                                    str_split(cum_p2_total_end_industry_collab_name, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_active_industry_collab = p2_active_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
    p2_active_industry_collab = ifelse(p2_active_industry_collab_name == "", 0, p2_active_industry_collab)
    ) %>% 
  ungroup() %>% 
  mutate(
    p2_total_old_industry_collab = p2_active_industry_collab - p2_total_new_industry_collab
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, disease_id, year, p2_total_new_industry_collab, p2_total_old_industry_collab)



# Create variables p2_total_new/old_non_industry_collab
p2_total_start_non_industry_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(phase_2 == 1) %>% 
  filter(non_industry_collab != "") %>% 
  select(sponsor_id, disease_id, start_year, non_industry_collab) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_total_new_non_industry_collab_name = str_c(non_industry_collab, collapse = ", "))
p2_total_end_non_industry_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  filter(phase_2 == 1) %>% 
  filter(non_industry_collab != "") %>% 
  select(sponsor_id, disease_id, end_year, non_industry_collab) %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarize(p2_total_end_non_industry_collab_name = str_c(non_industry_collab, collapse = ", "))

p2_non_industry_collab_fdy2 = firm_disease_year_data_def2_5 %>% 
  left_join(p2_total_start_non_industry_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_total_end_non_industry_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "end_year")) %>% 
  select(sponsor_id, disease_id, year, p2_total_new_non_industry_collab_name, p2_total_end_non_industry_collab_name) %>% 
  group_by(sponsor_id, disease_id) %>% 
  mutate(
    p2_total_new_non_industry_collab_name = ifelse(is.na(p2_total_new_non_industry_collab_name), "", p2_total_new_non_industry_collab_name),
    p2_total_end_non_industry_collab_name = ifelse(is.na(p2_total_end_non_industry_collab_name), "", p2_total_end_non_industry_collab_name)
    ) %>%
  mutate(
    p2_total_new_non_industry_collab = p2_total_new_non_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
    p2_total_new_non_industry_collab = ifelse(p2_total_new_non_industry_collab_name == "", 0, p2_total_new_non_industry_collab)
    ) %>% 
  mutate(
    cum_p2_total_new_non_industry_collab_name = accumulate(
      p2_total_new_non_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_total_end_non_industry_collab_name = lag(accumulate(
      p2_total_end_non_industry_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_active_non_industry_collab_name = preserve_setdiff(str_split(cum_p2_total_new_non_industry_collab_name, ", ")[[1]], 
                                                    str_split(cum_p2_total_end_non_industry_collab_name, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_active_non_industry_collab = p2_active_non_industry_collab_name %>% str_split(", ") %>% map_int(~ length(.x)),
    p2_active_non_industry_collab = ifelse(p2_active_non_industry_collab_name == "", 0, p2_active_non_industry_collab)
    ) %>% 
  ungroup() %>% 
  mutate(
    p2_total_old_non_industry_collab = p2_active_non_industry_collab - p2_total_new_non_industry_collab
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, disease_id, year, p2_total_new_non_industry_collab, p2_total_old_non_industry_collab)



firm_disease_year_data_def2_7 = firm_disease_year_data_def2_6 %>% 
  left_join(p2_collab_fdy2, by = c("sponsor_id", "disease_id", "year")) %>% 
  left_join(p2_industry_collab_fdy2, by = c("sponsor_id", "disease_id", "year")) %>% 
  left_join(p2_non_industry_collab_fdy2, by = c("sponsor_id", "disease_id", "year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))


```

###### Collab base variables

p2_start_w_collab, p2_start_collab_new, p2_start_collab_exist, p2_start_collab_recent, p2_start_collab_estab

p2_start_w_collab_ind, p2_start_w_collab_non_ind

p2_ongoing_w_collab

p2_comp_with_collab

```{r}
# Create these variables
p2_start_collab_new_existing_recent_established_fdy2 = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_w_collab = sum(collab), 
            p2_start_collab_new = sum(collab_new),
            p2_start_collab_existing = sum(collab_existing),
            p2_start_collab_recent = sum(collab_recent),
            p2_start_collab_established = sum(collab_established)) 
p2_start_w_collab_ind_fdy2 = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(industry_collab != "") %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_w_collab_ind = n())
p2_start_w_collab_non_ind_fdy2 = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(non_industry_collab != "") %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_w_collab_non_ind = n())


# Create corresponding columns, fdy means firm_disease_year
p2_start_w_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(collab == 1,
         phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarise(p2_start = n(), .groups = 'drop') 
p2_end_w_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  filter(collab == 1,
         phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarise(p2_end = n())
p2_end_w_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  filter(collab == 1,
         phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarise(p2_end = n())
p2_end_w_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  filter(collab == 1,
         phase_2 == 1) %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarise(p2_end = n())


# p2_ongoing_w_collab
p2_ongoing_w_collab_fdy2 = firm_disease_year_data_def2 %>% 
  left_join(p2_start_w_collab_fdy2, by = c("sponsor_id" = "sponsor_id", "disease_id" = "disease_id", "year" = "start_year")) %>% 
  left_join(p2_end_w_collab_fdy2, by = c("sponsor_id" = "sponsor_id", "disease_id" = "disease_id", "year" = "end_year")) %>% 
  select(sponsor_id, disease_id, year, p2_start, p2_end) %>% 
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  group_by(sponsor_id, disease_id) %>% 
  mutate(cum_p2_start = cumsum(p2_start),
         cum_p2_end = lag(cumsum(p2_end), default = 0),
         p2_ongoing_w_collab = cum_p2_start - cum_p2_end) %>% 
  select(sponsor_id, disease_id, year, p2_ongoing_w_collab)


#p2_comp_with_collab
p2_comp_with_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  filter(phase_2 == 1,
         collab == 1) %>% 
  filter(status == "completed") %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarize(p2_comp_with_collab = n())


firm_disease_year_data_def2_8 = firm_disease_year_data_def2_7 %>% 
  left_join(p2_start_collab_new_existing_recent_established_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_collab_ind_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_collab_non_ind_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_ongoing_w_collab_fdy2, by = c("sponsor_id", "disease_id", "year")) %>% 
  left_join(p2_comp_with_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "end_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))


```


###### p2_mean_length_w_collab


```{r}
# p2_mean_length_w_collab
p2_trial_length_start_w_collab_fdy2 = p2_trial_length_w_collab %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarise(p2_trial_length_start = str_c(trial_length, collapse = ", "))
p2_trial_length_end_w_collab_fdy2 = p2_trial_length_w_collab %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarise(p2_trial_length_end = str_c(trial_length, collapse = ", "))

p2_average_length_w_collab_fdy2 = firm_disease_year_data_def2_8 %>% 
  left_join(p2_trial_length_start_w_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_trial_length_end_w_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "end_year")) %>% 
  select(sponsor_id, disease_id, year, p2_trial_length_start, p2_trial_length_end) %>% 
  mutate(across(everything(), ~ replace_na(., ""))) %>% 
  group_by(sponsor_id, disease_id) %>% 
  mutate(cum_p2_trial_length_start = accumulate(
      p2_trial_length_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
         cum_p2_trial_length_end = lag(accumulate(
      p2_trial_length_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_trial_length_active = ifelse(length(preserve_setdiff(str_split(cum_p2_trial_length_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_end, ", ")[[1]])) == 0, NA,
                                    preserve_setdiff(str_split(cum_p2_trial_length_start, ", ")[[1]],
                                              str_split(cum_p2_trial_length_end, ", ")[[1]]) %>% paste(collapse = ", ")),
    p2_mean_length_w_collab = mean(as.numeric(str_split(p2_trial_length_active, ", ")[[1]]))) %>% 
  select(sponsor_id, disease_id, year, p2_mean_length_w_collab) %>% 
  mutate(p2_mean_length_w_collab = ifelse(is.na(p2_mean_length_w_collab), "", as.character(p2_mean_length_w_collab)))



firm_disease_year_data_def2_9 = firm_disease_year_data_def2_8 %>% 
  left_join(p2_average_length_w_collab_fdy2, by = c("sponsor_id", "disease_id", "year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))

```


###### p2_unique_active_site_w_collab, p2_unique_active_site_eu_w_collab, p2_unique_active_site_non_eu_w_collab


```{r}
# p2_unique_active_site_w_collab
p2_unique_site_start_w_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(collab == 1,
         phase_2 == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_unique_site_start = str_c(country, collapse = ", "))
p2_unique_site_end_w_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  filter(collab == 1,
         phase_2 == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarize(p2_unique_site_end = str_c(country, collapse = ", "))

p2_unique_active_site_w_collab_fdy2 = firm_disease_year_data_def2_9 %>% 
  left_join(p2_unique_site_start_w_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_unique_site_end_w_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "end_year")) %>% 
  select(sponsor_id, disease_id, year, p2_unique_site_start, p2_unique_site_end) %>% 
  group_by(sponsor_id, disease_id) %>% 
  mutate(p2_unique_site_start = ifelse(is.na(p2_unique_site_start), "", p2_unique_site_start)) %>%
  mutate(p2_unique_site_end = ifelse(is.na(p2_unique_site_end), "", p2_unique_site_end)) %>%
  mutate(
    cum_p2_unique_site_start = accumulate(
      p2_unique_site_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_unique_site_end = lag(accumulate(
      p2_unique_site_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")
  ) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_active_site_name = preserve_setdiff(str_split(cum_p2_unique_site_start, ", ")[[1]], 
                                                    str_split(cum_p2_unique_site_end, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_site_w_collab = p2_unique_active_site_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_site_w_collab = ifelse(p2_unique_active_site_name == "", 0, p2_unique_active_site_w_collab)
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, disease_id, year, p2_unique_active_site_w_collab)



# Create variables p2_unique_active_site_eu_w_collab
p2_unique_site_eu_start_w_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(phase_2 == 1,
         country %in% eu_countries,
         collab == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_unique_site_start = str_c(country, collapse = ", "))
p2_unique_site_eu_end_w_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  filter(phase_2 == 1,
         country %in% eu_countries,
         collab == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarize(p2_unique_site_end = str_c(country, collapse = ", "))

p2_unique_active_site_eu_w_collab_fdy2 = firm_disease_year_data_def2_9 %>% 
  left_join(p2_unique_site_eu_start_w_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_unique_site_eu_end_w_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "end_year")) %>% 
  select(sponsor_id, disease_id, year, p2_unique_site_start, p2_unique_site_end) %>% 
  group_by(sponsor_id, disease_id) %>% 
  mutate(p2_unique_site_start = ifelse(is.na(p2_unique_site_start), "", p2_unique_site_start)) %>%
  mutate(p2_unique_site_end = ifelse(is.na(p2_unique_site_end), "", p2_unique_site_end)) %>%
  mutate(
    cum_p2_unique_site_start = accumulate(
      p2_unique_site_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_unique_site_end = lag(accumulate(
      p2_unique_site_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")
  ) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_active_site_name = preserve_setdiff(str_split(cum_p2_unique_site_start, ", ")[[1]], 
                                                    str_split(cum_p2_unique_site_end, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_site_eu_w_collab = p2_unique_active_site_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_site_eu_w_collab = ifelse(p2_unique_active_site_name == "", 0, p2_unique_active_site_eu_w_collab)
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, disease_id, year, p2_unique_active_site_eu_w_collab)



# Create variables p2_unique_active_site_non_eu_w_collab
p2_unique_site_non_eu_start_w_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(phase_2 == 1,
         !country %in% eu_countries,
         collab == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_unique_site_start = str_c(country, collapse = ", "))
p2_unique_site_non_eu_end_w_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  filter(phase_2 == 1,
         !country %in% eu_countries,
         collab == 1) %>% 
  mutate(country = ifelse(country == "", NA, country)) %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarize(p2_unique_site_end = str_c(country, collapse = ", "))

p2_unique_active_site_non_eu_w_collab_fdy2 = firm_disease_year_data_def2_9 %>% 
  left_join(p2_unique_site_non_eu_start_w_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_unique_site_non_eu_end_w_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "end_year")) %>% 
  select(sponsor_id, disease_id, year, p2_unique_site_start, p2_unique_site_end) %>% 
  group_by(sponsor_id, disease_id) %>% 
  mutate(p2_unique_site_start = ifelse(is.na(p2_unique_site_start), "", p2_unique_site_start)) %>%
  mutate(p2_unique_site_end = ifelse(is.na(p2_unique_site_end), "", p2_unique_site_end)) %>%
  mutate(
    cum_p2_unique_site_start = accumulate(
      p2_unique_site_start, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_unique_site_end = lag(accumulate(
      p2_unique_site_end, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")
  ) %>% 
  rowwise() %>% 
  mutate(
    p2_unique_active_site_name = preserve_setdiff(str_split(cum_p2_unique_site_start, ", ")[[1]], 
                                                    str_split(cum_p2_unique_site_end, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_site_non_eu_w_collab = p2_unique_active_site_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_site_non_eu_w_collab = ifelse(p2_unique_active_site_name == "", 0, p2_unique_active_site_non_eu_w_collab)
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, disease_id, year, p2_unique_active_site_non_eu_w_collab)



# Add these variables to the fdy panel
firm_disease_year_data_def2_10 = firm_disease_year_data_def2_9 %>% 
  left_join(p2_unique_active_site_w_collab_fdy2, by = c("sponsor_id", "disease_id", "year")) %>% 
  left_join(p2_unique_active_site_eu_w_collab_fdy2, by = c("sponsor_id", "disease_id", "year")) %>% 
  left_join(p2_unique_active_site_non_eu_w_collab_fdy2, by = c("sponsor_id", "disease_id", "year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))


```


######Add unique collab count

  p2_unique_active_collab, p2_unique_old_collab, p2_unique_new_collab, p2_unique_old_recent_collab, p2_unique_old_estab_collab
  
```{r}
# Create variables p2*unique*ongoing/new/old*collab
p2_total_start_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, disease_id, start_year, collab_num, collaborator) %>% 
  filter(collab_num > 0) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_total_new_collab = sum(collab_num), p2_total_new_collab_name = str_c(collaborator, collapse = ", "))

p2_total_end_collab_fdy2 = trial_firm_detail_3 %>% 
  mutate(end_year = as.numeric(end_year)) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, disease_id, end_year, collab_num, collaborator) %>% 
  filter(collab_num > 0) %>% 
  group_by(sponsor_id, disease_id, end_year) %>% 
  summarize(p2_total_end_collab = sum(collab_num), p2_total_end_collab_name = str_c(collaborator, collapse = ", "))

p2_collab_fdy2 = firm_disease_year_data_def2_10 %>% 
  select(-p2_total_new_collab) %>% 
  left_join(p2_total_start_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_total_end_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "end_year")) %>% 
  select(sponsor_id, disease_id, year, p2_total_new_collab, p2_total_new_collab_name, p2_total_end_collab, p2_total_end_collab_name) %>% 
  group_by(sponsor_id, disease_id) %>% 
  mutate(p2_total_new_collab = ifelse(is.na(p2_total_new_collab), 0, p2_total_new_collab)) %>% 
  mutate(p2_total_end_collab = ifelse(is.na(p2_total_end_collab), 0, p2_total_end_collab)) %>% 
  mutate(p2_total_new_collab_name = ifelse(is.na(p2_total_new_collab_name), "", p2_total_new_collab_name)) %>%
  mutate(p2_total_end_collab_name = ifelse(is.na(p2_total_end_collab_name), "", p2_total_end_collab_name)) %>%
  mutate(
    cum_p2_total_new_collab = cumsum(p2_total_new_collab),
    cum_p2_total_new_collab_name = accumulate(
      p2_total_new_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")),
    cum_p2_total_end_collab = lag(cumsum(p2_total_end_collab), default = 0),
    cum_p2_total_end_collab_name = lag(accumulate(
      p2_total_end_collab_name, ~ (c(.x[.x != "" & !is.na(.x)], .y[.y != "" & !is.na(.y)]))
      ) %>% map_chr(~ paste(.x, collapse = ", ")), default = "")) %>% 
  rowwise() %>% 
  mutate(
    p2_total_active_collab = cum_p2_total_new_collab - cum_p2_total_end_collab,
    p2_total_active_collab_name = preserve_setdiff(str_split(cum_p2_total_new_collab_name, ", ")[[1]], 
                                                    str_split(cum_p2_total_end_collab_name, ", ")[[1]]) %>% 
      paste(collapse = ", "),
    p2_unique_active_collab = p2_total_active_collab_name %>% str_split(", ") %>% map_int(~ length(unique(.x))),
    p2_unique_active_collab = ifelse(p2_total_active_collab_name == "", 0, p2_unique_active_collab)
    ) %>% 
  ungroup() %>% 
  mutate(
    # Convert active and new collaborators into lists (ignoring empty strings)
    active_total_collab_list = str_split(p2_total_active_collab_name, ",\\s*"),
    new_total_collab_list = str_split(p2_total_new_collab_name, ",\\s*"),
    
    # Fix: Apply unique per row instead of just for the first row
    active_unique_collab_list = map(active_total_collab_list, ~unique(.x[.x != ""])),
    new_unique_collab_list = map(new_total_collab_list, ~unique(.x[.x != ""])),
    
    # Fix: Apply preserve_setdiff per row
    old_total_collab_list = map2(
      active_total_collab_list, 
      new_total_collab_list, 
      ~preserve_setdiff(.x[.x != ""], .y[.y != ""])
    ),
    
    # Fix: Apply unique to each element in old_total_collab_list
    old_unique_collab_list = map(old_total_collab_list, ~unique(.x)),
    
    # Rest of your mutate code
    p2_unique_new_collab = map2_dbl(
      new_total_collab_list, 
      lag(active_total_collab_list, default = list(character(0))), 
      ~ length(unique(setdiff(.x[.x != ""], .y[.y != ""])))
    ),
    p2_total_old_collab = p2_total_active_collab - p2_total_new_collab,
    p2_unique_old_collab = p2_unique_active_collab - p2_unique_new_collab
  ) %>% 
  ungroup() %>% 
  group_by(sponsor_id, disease_id) %>% 
  mutate(
    active_total_collab_list_lag2 = lag(active_total_collab_list, n = 2, default = list(character(0))),
    
    p2_unique_active_estab_collab = map2_int(
      active_total_collab_list,
      active_total_collab_list_lag2,
      ~ length(intersect(.x[.x != ""], .y[.y != ""]))
    ),
    p2_unique_active_recent_collab = p2_unique_active_collab - p2_unique_active_estab_collab,
    
    # Fix: Properly handle list operations for established and recent collaborators
    old_estab_collab_list = map2(
      old_unique_collab_list, 
      active_total_collab_list_lag2,
      ~ intersect(.x, unlist(.y)[unlist(.y) != ""])
    ),
    
    old_recent_collab_list = map2(
      old_unique_collab_list, 
      old_estab_collab_list,
      ~ setdiff(.x, .y)
    ),
    
    # Calculate unique counts
    p2_unique_old_estab_collab = map_int(old_estab_collab_list, length),
    p2_unique_old_recent_collab = map_int(old_recent_collab_list, length),
    
    # Calculate total counts (occurrences, not just unique)
    p2_total_old_estab_collab = pmap_int(
      list(old_total_collab_list, old_estab_collab_list),
      function(total, estab) {
        sum(total %in% estab)
      }
    ),
    
    p2_total_old_recent_collab = pmap_int(
      list(old_total_collab_list, old_recent_collab_list),
      function(total, recent) {
        sum(total %in% recent)
      }
    )
  ) %>% 
  ungroup() %>% 
  select(sponsor_id, disease_id, year, p2_total_active_collab, p2_total_new_collab, p2_total_old_collab, 
         p2_unique_active_collab, p2_unique_new_collab, p2_unique_old_collab, 
         p2_unique_old_estab_collab, p2_unique_old_recent_collab, 
         p2_total_old_estab_collab, p2_total_old_recent_collab)



# Add these variables to the fdy panel
firm_disease_year_data_def2_11 = firm_disease_year_data_def2_10 %>% 
  left_join(p2_collab_fdy2, by = c("sponsor_id", "disease_id", "year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))


```


###### Add addiitonal collab information

  p2_start_w_large_collab, p2_start_w_small_collab, p2_start_w_large_collab_2, p2_start_w_small_collab_2

```{r}
# Since when we previously counted trial with sized collab without selecting disease_id, we here redo it including selecting disease_id
trial_firm_detail_w_collab_size = add_collab_count_by_size(
   trial_df = trial_firm_detail_3,
   collaborator_size_df = matched_collaborators_with_size
 ) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, disease_id, sponsor_name, start_year, end_year, large_collab, large_collab_count, small_collab, small_collab_count)

trial_firm_detail_w_collab_size_2 = add_collab_count_by_size(
   trial_df = trial_firm_detail_3,
   collaborator_size_df = matched_collaborators_with_size_2
 ) %>% 
  filter(phase_2 == 1) %>% 
  select(sponsor_id, disease_id, sponsor_name, start_year, end_year, large_collab, large_collab_count, small_collab, small_collab_count)


# p2_start_w_large_collab, p2_start_w_small_collab
p2_start_w_large_collab_fdy2 = trial_firm_detail_w_collab_size %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(large_collab_count > 0) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_w_large_collab = n())
p2_start_w_small_collab_fdy2 = trial_firm_detail_w_collab_size %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(small_collab_count > 0)%>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_w_small_collab = n())

# p2_start_w_large_collab_2, p2_start_w_small_collab_2 (use cutoff 0 instead of median)
p2_start_w_large_collab_2_fdy2 = trial_firm_detail_w_collab_size_2 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(large_collab_count > 0) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_w_large_collab_2 = n())
p2_start_w_small_collab_2_fdy2 = trial_firm_detail_w_collab_size_2 %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(small_collab_count > 0)%>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_w_small_collab_2 = n())

```

  p2_start_w_old_collab, p2_start_w_young_collab

```{r}
# p2_start_w_old_collab, p2_start_w_young_collab
p2_start_w_old_collab_fdy2 = trial_firm_detail_w_collab_age %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(old_collab_count > 0) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_w_old_collab = n())
p2_start_w_young_collab_fdy2 = trial_firm_detail_w_collab_age %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(young_collab_count > 0)%>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_w_young_collab = n())

```

  p2_start_w_us_collab, p2_start_w_eu_collab, p2_start_w_other_region_collab
  
```{r}
# p2_start_w_us_collab, p2_start_w_eu_collab, p2_start_w_other_region_collab
p2_start_w_us_collab_fdy2 = trial_firm_detail_w_collab_region %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(us_collab_count > 0) %>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_w_us_collab = n())
p2_start_w_eu_collab_fdy2 = trial_firm_detail_w_collab_region %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(eu_collab_count > 0)%>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_w_eu_collab = n())
p2_start_w_other_region_collab_fdy2 = trial_firm_detail_w_collab_region %>% 
  mutate(start_year = as.numeric(start_year)) %>% 
  filter(other_region_collab_count > 0)%>% 
  group_by(sponsor_id, disease_id, start_year) %>% 
  summarize(p2_start_w_other_region_collab = n())


```

  Combine all the additional trials with collab variable to the fdy panel 
  
```{r}

# Add these variables to the fdy panel
firm_disease_year_data_def2_12 = firm_disease_year_data_def2_11 %>% 
  left_join(p2_start_w_large_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_small_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_large_collab_2_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_small_collab_2_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_old_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_young_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_us_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_eu_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  left_join(p2_start_w_other_region_collab_fdy2, by = c("sponsor_id", "disease_id", "year" = "start_year")) %>% 
  mutate(across(everything(), ~ replace_na(., 0)))


```







variable check list:
  eu_porp_pre_2018_p2_industry *done*
  phase_2_start *done*
  patient_avg_start_allregion_p2 *done*
  p2_mean_length *done*
  p2_unique_disease_ongoing *should just look at p2_ongoing*
  p2_unique_active_site *done*
  p2_unique_active_site_eu *done*
  p2_start_ipd_share *done*
  p2_start_incapable_share *done*
  phase_2_startdate_comp *done*
  
Collab:
  p2_start_ipd_collab_share *done*
  p2_start_incapable_collab_share *done*
  p2_start_with_collab *done*
  p2_start_collab_existing *done*
  p2_start_collab_new *done*
  p2_start_collab_recent *done*
  p2_start_collab_established *done*
  p2_start_with_collab_industry *done*
  p2_start_with_collab_non_industr *done*
  p2_total_old_collab *done*
  patient_avg_start_allregion_p2_w_collab *done*
  p2_mean_length_w_collab *done*
  p2_unique_disease_ongoing_w_coll *should just look at p2_ongoing_w_collab*
  p2_unique_active_site_w_collab *done*
  p2_unique_active_site_eu_w_collab *done*
  p2_unique_active_site_non_eu_w_collab *done*
  p2_comp_with_collab *done*
  p2_unique_active_collab *done*
  p2_unique_old_collab *done*
  p2_unique_new_collab *done*
  p2_unique_old_recent_collab *done*
  p2_unique_old_estab_collab *done*
  p2_start_w_large_collab *done*
  p2_start_w_small_collab *done*
  p2_start_w_large_collab_2 *done*
  p2_start_w_small_collab_2 *done*
  p2_start_w_old_collab *done*
  p2_start_w_young_collab *done*
  p2_start_w_us_collab *done*
  p2_start_w_eu_collab *done*
  p2_start_w_other_region_collab *done*




 
     
     
## Export Datasets (Checkpoint)

```{r}
# Create csv files with unique company_id and unique country names and id
write.csv(trial_firm_detail_3, file = "trial_firm_detail_3.csv")
write.csv(firm_name_founding_year_id, file = "firm_name_founding_year_id.csv")
write.csv(firm_year_dataset_29, file = "firm_year_dataset_06082025.csv")


write.csv(unmatched_collaborators, file = "unmatched_collaborators.csv")
write.csv(firm_name_founding_year_id_source, file = "firm_name_founding_year_id_source.csv")
write.csv(nct_id_mesh_term_disease_code, file = "nct_id_mesh_term_disease_code.csv")
write.csv(master_sponsor_list, file = "master_sponsor_list.csv")
write.csv(master_sponsor_list_w_industry, file = "master_sponsor_list_w_industry.csv")


write.csv(firm_disease_year_data_def1_1, file = "firm_disease_year_data_def1.csv")
write.csv(firm_disease_year_data_def2_12, file = "firm_disease_year_data_def2_05302025.csv")

write.csv(top_10_sponsors_above_median_eu_pre_2018_p2_industry, file = "top_10_sponsors_above_median_eu_pre_2018_p2_industry.csv")
write.csv(top_10_sponsors_below_median_eu_pre_2018_p2_industry, file = "top_10_sponsors_below_median_eu_pre_2018_p2_industry.csv")

firm_year_dataset_29 %>% filter(year >= 2010, year < 2024, industry_dummy == 1)

```



## Notes with Deliverables
    
*week10*

deliverable:

a. i. Updated hq_location updated
  ii. Done, out of 258565 of the non_ind collabs, only 10827 (4%) matched with our master company list, this is imaginable because our master list consists of mostly companies which are in the industry. Moreover, out of the 10827 non ind collabs, only 4392 matched with the new hq list Jennifer privided. This poor matching is making the variable less insightful, but I still created teh variables p2_start_w_non_ind_us/eu/others_collab anyways.
b. Done, p2_start/end_result_1y/3y
c. Done, there are a lot of variables with recent/estab collab, so far I did p2_start/comp/term_collab_recent/established_(ind/non_ind)_5y
d. Done, p2_start/comp/term_collab_new/existing/recent/established_(ind/non_ind)_to_p2, note the recent and estab cutoff is 2y here.



*summer*

Master sponsor list:
 - The companies with source "FoundingYearData" were from the dropbox sent a while ago, they are not present in any seen clinical trials data therefore they have less information.
 - hq_country, hq_region are from upwork data, and hq_region_broad is from the data that Jennifer provided. For transparency sake I kept all these three columns as it is. 
 - matched_collaborator has value 1 if the corresponding sponsor got matched with any collaborators.
 - To account for the missing values, I'm assuming using ChatGPT API could work, but not sure how much will it cost with the size of the dataset. Accuracy shouldn't be a problem because human error could be larger than AI error when looking for information like hq_country and hq_location. *2 hr*
 
 
Less observations with new firm year panel:
 - We updated the year_founded from the upwork data. With the assumption that this is correct, we got rid of the observations with years before the funded year.
 - For example, company A has a previous founded year of 2010 and the upwork data updated it to 2015, then the observations between 2010-2014 would be deleted for company A. *1 hr*
 
 
Jennifer's variable clarification:
 - Hi Jennifer, sorry for getting back to you on this matter this late in. I took a look into the code and found that, since we previously only worked with industry collaborators, p2_start_w_eu_collab is actually p2_start_w_ind_eu_collab. After we decided to investigate non_ind collab as well I started to differentiate the naming by adding non_ind in variable names.
In short, p2_start_w_eu_collab are measuring industry collaborators, so having p2_start_w_non_ind_eu_collab > p2_start_w_eu_collab would make sense. This also apply to other collab variables, those without specific labeling about industry or not are all industry collaborators. Instead of going back to change all the names, I think it would be more efficient to specify this in our codebooks. But please let me know if you'd like to add an "ind" to all the previously created collaborator variables. *2 hr*
 

p2_similar_exp_all_phase_collab:
Done. Note that since we only have level 2 mesh code for AACT trials, and seeing the experience of level 1 is not good enough resolution. So we would only be focusing on the AACT trials with level 2 mesh codes here. *6 hr*

 









